<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>YRBS Logistical Trend Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="4 - Create YRBS Logistical Regression Trend Analysis Statewide_files/libs/clipboard/clipboard.min.js"></script>
<script src="4 - Create YRBS Logistical Regression Trend Analysis Statewide_files/libs/quarto-html/quarto.js"></script>
<script src="4 - Create YRBS Logistical Regression Trend Analysis Statewide_files/libs/quarto-html/popper.min.js"></script>
<script src="4 - Create YRBS Logistical Regression Trend Analysis Statewide_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="4 - Create YRBS Logistical Regression Trend Analysis Statewide_files/libs/quarto-html/anchor.min.js"></script>
<link href="4 - Create YRBS Logistical Regression Trend Analysis Statewide_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="4 - Create YRBS Logistical Regression Trend Analysis Statewide_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="4 - Create YRBS Logistical Regression Trend Analysis Statewide_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="4 - Create YRBS Logistical Regression Trend Analysis Statewide_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="4 - Create YRBS Logistical Regression Trend Analysis Statewide_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">YRBS Logistical Trend Analysis</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="statewide-traditional" class="level2">
<h2 class="anchored" data-anchor-id="statewide-traditional">Statewide Traditional</h2>
<section id="packages-working-directory" class="level3">
<h3 class="anchored" data-anchor-id="packages-working-directory">Packages &amp; Working Directory</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load Packages</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"pacman"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">"pacman"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  tidyr,      <span class="co"># for data tidying operations like 'spread' &amp; 'gather'</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  dplyr,      <span class="co"># data manipulation operations, filter/mutate/select/etc.</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  readxl,     <span class="co"># read data from Excel files (.xlsx and .xls)</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  openxlsx,   <span class="co"># reading, writing, &amp; editing Excel files without Java</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  srvyr,      <span class="co"># a helper for using dplyr and survey weighted analysis</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  survey,     <span class="co"># analysis of complex survey samples</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  stringr,    <span class="co"># consistent, simple tools to work with strings of chr</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  purrr       <span class="co"># Enhances programming for mapping/iterating over lists</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co">#options(scipen=999) # avoid the use of scientific notation (e.g., 1e+03) </span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">survey.lonely.psu=</span><span class="st">"adjust"</span>) <span class="co"># Adjust for Lonely PSU</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">survey.adjust.domain.lonely=</span><span class="cn">TRUE</span>) <span class="co"># Adjust for Lonely PSU</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="trend-by-overall" class="level3">
<h3 class="anchored" data-anchor-id="trend-by-overall">Trend by Overall</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Decided to perform trend Analysis from 2011 to 2023, and to include only 2011 to present on dashboards, highlights, etc. Can redo later for 2003 to 2023</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="do">######## Import Raw and Analyzed Excel Files ###############</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>yrbs_master_analysis_stwd_trend <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, </span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">sheet =</span> <span class="st">"Overall Trend"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(Trend_Category <span class="sc">==</span> <span class="st">"Overall"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="st">"Suppressed"</span>, <span class="cn">NA</span>, .)))</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the raw data set to be used in trend analyis</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>raw_stwd_general <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"raw_yrbs_allyears_statewide_trad_cleaned.xlsx"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Survey_Year <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2011</span>, <span class="dv">2013</span>, <span class="dv">2015</span>, <span class="dv">2017</span>, <span class="dv">2019</span>, <span class="dv">2023</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">2</span>, <span class="dv">0</span>, <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="cn">NA</span>))))</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify ROIs with data for 4 or more survey years of data (We decided as a YRBS team that only ROI's with 4 data points/4 years total of data between the trend years being used, would be acceptable to do trend analysis on. Such that an ROI that has 2011, 2013, and 2017 data/prevalence estimate, would not have trend anlaysis performed on it)</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>roi_years <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), Survey_Year) <span class="sc">%&gt;%</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>Survey_Year, <span class="at">names_to =</span> <span class="st">"ROI_Indicator_Code"</span>, <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ROI_Indicator_Code) <span class="sc">%&gt;%</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">unique_years =</span> <span class="fu">n_distinct</span>(Survey_Year), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(unique_years <span class="sc">&gt;=</span> <span class="dv">4</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(ROI_Indicator_Code)</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the main data set to include only those ROIs, also ensuring to keep necessary demographic variables</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>filtered_raw_stwd_general <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Survey_Year, <span class="fu">all_of</span>(roi_years), Sex, Race_Group_3, Grade,Primary_Samp_Unit,Stratum,Final_Weight)</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a><span class="do">############ Long Term Trend ###############</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a><span class="co">#Trend Analysis Function</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>analyze_trend_logistic <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>  data_wtd <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Survey Design for YRBS Statewide</span></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_survey_design</span>(<span class="at">ids =</span> Primary_Samp_Unit,</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>                     <span class="at">strata =</span> Stratum,</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>                     <span class="at">weights =</span> Final_Weight,</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nest =</span> <span class="cn">TRUE</span>,</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>                     )</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data_wtd <span class="sc">%&gt;%</span></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Sex =</span> <span class="fu">factor</span>(Sex), <span class="at">Race_Group_3 =</span> <span class="fu">factor</span>(Race_Group_3), <span class="at">Grade =</span> <span class="fu">factor</span>(Grade))</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(data_filtered) <span class="sc">&lt;</span> <span class="dv">4</span> <span class="sc">||</span> <span class="fu">length</span>(<span class="fu">unique</span>(data_filtered<span class="sc">$</span>variables<span class="sc">$</span>Survey_Year)) <span class="sc">&lt;</span> <span class="dv">4</span>) {</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>  base_formula <span class="ot">&lt;-</span> <span class="fu">paste</span>(column_name, <span class="st">"~ Sex + Race_Group_3 + Grade + Survey_Year"</span>)<span class="co"># fix to test for yearly linear trend</span></span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>  models <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>    <span class="st">"linear"</span> <span class="ot">=</span> base_formula,</span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>    <span class="st">"quadratic"</span> <span class="ot">=</span> <span class="fu">paste</span>(base_formula, <span class="st">"+ I(Survey_Year^2)"</span>),</span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>    <span class="st">"cubic"</span> <span class="ot">=</span> <span class="fu">paste</span>(base_formula, <span class="st">"+ I(Survey_Year^2) + I(Survey_Year^3)"</span>)</span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a><span class="co">#browser() #debugging tool</span></span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(models, <span class="cf">function</span>(f) {</span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>    model <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({ <span class="co">#Used to see where the model is failing</span></span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>      <span class="fu">svyglm</span>(<span class="fu">as.formula</span>(f), <span class="at">design =</span> data_filtered, <span class="at">family =</span> <span class="fu">quasibinomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"Error fitting model: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(model)) {</span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="st">"Model fitting error"</span>)</span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a>    coef_summary <span class="ot">=</span> <span class="fu">summary</span>(model)<span class="sc">$</span>coefficients</span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(coef_summary) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="st">"Model fitting error: No coefficients"</span>)</span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a><span class="co">#browser() # debug</span></span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a>    highest_order_term <span class="ot">&lt;-</span> <span class="fu">tail</span>(<span class="fu">rownames</span>(coef_summary), <span class="dv">1</span>)<span class="co">#  Changed to rownames() from names() - now runs</span></span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(highest_order_term) <span class="sc">&amp;&amp;</span> highest_order_term <span class="sc">%in%</span> <span class="fu">rownames</span>(coef_summary)) {</span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a>      p_value <span class="ot">=</span> coef_summary[highest_order_term, <span class="st">"Pr(&gt;|t|)"</span>]<span class="co"># statistic changed to |t| from |z|</span></span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a>      coefficient <span class="ot">=</span> <span class="fu">coef</span>(model)[highest_order_term]</span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (p_value <span class="sc">&lt;=</span> <span class="fl">0.05</span>) {</span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (coefficient <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a>          <span class="fu">return</span>(<span class="st">"Significant Increase"</span>)</span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a>          <span class="fu">return</span>(<span class="st">"Significant Decrease"</span>)</span>
<span id="cb2-93"><a href="#cb2-93" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb2-94"><a href="#cb2-94" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb2-95"><a href="#cb2-95" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="st">"No Change"</span>)</span>
<span id="cb2-96"><a href="#cb2-96" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb2-97"><a href="#cb2-97" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb2-98"><a href="#cb2-98" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="st">"Coefficient not available or model did not converge"</span>)</span>
<span id="cb2-99"><a href="#cb2-99" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-100"><a href="#cb2-100" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb2-101"><a href="#cb2-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-102"><a href="#cb2-102" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, </span>
<span id="cb2-103"><a href="#cb2-103" aria-hidden="true" tabindex="-1"></a>                    <span class="at">CUBIC_Term_Trend =</span> results<span class="sc">$</span>cubic,</span>
<span id="cb2-104"><a href="#cb2-104" aria-hidden="true" tabindex="-1"></a>                    <span class="at">QUAD_Term_Trend =</span> results<span class="sc">$</span>quadratic,</span>
<span id="cb2-105"><a href="#cb2-105" aria-hidden="true" tabindex="-1"></a>                    <span class="at">LIN_Term_Trend=</span>results<span class="sc">$</span>linear))</span>
<span id="cb2-106"><a href="#cb2-106" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-107"><a href="#cb2-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-108"><a href="#cb2-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-109"><a href="#cb2-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-110"><a href="#cb2-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-111"><a href="#cb2-111" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply function to each ROI_Indicator_Code that has sufficient data</span></span>
<span id="cb2-112"><a href="#cb2-112" aria-hidden="true" tabindex="-1"></a>long_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(filtered_raw_stwd_general)[<span class="sc">-</span><span class="dv">1</span>], <span class="cf">function</span>(column_name) {</span>
<span id="cb2-113"><a href="#cb2-113" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_trend_logistic</span>(filtered_raw_stwd_general, column_name)</span>
<span id="cb2-114"><a href="#cb2-114" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb2-115"><a href="#cb2-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-116"><a href="#cb2-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-117"><a href="#cb2-117" aria-hidden="true" tabindex="-1"></a>long_trend_results <span class="ot">&lt;-</span> long_trend_results <span class="sc">%&gt;%</span></span>
<span id="cb2-118"><a href="#cb2-118" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">Long_Term_Trend =</span> LIN_Term_Trend) <span class="sc">%&gt;%</span></span>
<span id="cb2-119"><a href="#cb2-119" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(ROI_Indicator_Code,</span>
<span id="cb2-120"><a href="#cb2-120" aria-hidden="true" tabindex="-1"></a>         Long_Term_Trend</span>
<span id="cb2-121"><a href="#cb2-121" aria-hidden="true" tabindex="-1"></a>         )</span>
<span id="cb2-122"><a href="#cb2-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-123"><a href="#cb2-123" aria-hidden="true" tabindex="-1"></a><span class="co"># Show results</span></span>
<span id="cb2-124"><a href="#cb2-124" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(long_trend_results)</span>
<span id="cb2-125"><a href="#cb2-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-126"><a href="#cb2-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-127"><a href="#cb2-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-128"><a href="#cb2-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-129"><a href="#cb2-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-130"><a href="#cb2-130" aria-hidden="true" tabindex="-1"></a><span class="do">######### Short Term Trend ###############</span></span>
<span id="cb2-131"><a href="#cb2-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-132"><a href="#cb2-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-133"><a href="#cb2-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-134"><a href="#cb2-134" aria-hidden="true" tabindex="-1"></a>analyze_short_term_trend_ttest <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb2-135"><a href="#cb2-135" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define the short-term years</span></span>
<span id="cb2-136"><a href="#cb2-136" aria-hidden="true" tabindex="-1"></a>  short_term_years <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2019</span>, <span class="dv">2023</span>)</span>
<span id="cb2-137"><a href="#cb2-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-138"><a href="#cb2-138" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filter for short-term years and ensure all necessary variables are selected</span></span>
<span id="cb2-139"><a href="#cb2-139" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb2-140"><a href="#cb2-140" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Survey_Year <span class="sc">%in%</span> short_term_years) <span class="sc">%&gt;%</span></span>
<span id="cb2-141"><a href="#cb2-141" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Primary_Samp_Unit, Stratum, Final_Weight, Survey_Year, <span class="fu">all_of</span>(column_name)) <span class="sc">%&gt;%</span></span>
<span id="cb2-142"><a href="#cb2-142" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">response =</span> <span class="fu">get</span>(column_name) <span class="sc">==</span> <span class="dv">1</span>)  <span class="co"># Create a binary response variable for the analysis</span></span>
<span id="cb2-143"><a href="#cb2-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-144"><a href="#cb2-144" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if data is available for both years</span></span>
<span id="cb2-145"><a href="#cb2-145" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(short_term_years <span class="sc">%in%</span> <span class="fu">unique</span>(data_filtered<span class="sc">$</span>Survey_Year[<span class="sc">!</span><span class="fu">is.na</span>(data_filtered[[column_name]])]))) {</span>
<span id="cb2-146"><a href="#cb2-146" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb2-147"><a href="#cb2-147" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-148"><a href="#cb2-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-149"><a href="#cb2-149" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Continue with data that doesn't have NA responses</span></span>
<span id="cb2-150"><a href="#cb2-150" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(response))</span>
<span id="cb2-151"><a href="#cb2-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-152"><a href="#cb2-152" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create survey design object including the response variable</span></span>
<span id="cb2-153"><a href="#cb2-153" aria-hidden="true" tabindex="-1"></a>  survey_design <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="sc">~</span>Primary_Samp_Unit,</span>
<span id="cb2-154"><a href="#cb2-154" aria-hidden="true" tabindex="-1"></a>                             <span class="at">strata =</span> <span class="sc">~</span>Stratum,</span>
<span id="cb2-155"><a href="#cb2-155" aria-hidden="true" tabindex="-1"></a>                             <span class="at">weights =</span> <span class="sc">~</span>Final_Weight,</span>
<span id="cb2-156"><a href="#cb2-156" aria-hidden="true" tabindex="-1"></a>                             <span class="at">data =</span> data_filtered,</span>
<span id="cb2-157"><a href="#cb2-157" aria-hidden="true" tabindex="-1"></a>                             <span class="at">nest =</span> <span class="cn">TRUE</span>) </span>
<span id="cb2-158"><a href="#cb2-158" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-159"><a href="#cb2-159" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Perform Welch's t-test using the survey design object</span></span>
<span id="cb2-160"><a href="#cb2-160" aria-hidden="true" tabindex="-1"></a>  ttest_result <span class="ot">&lt;-</span> <span class="fu">svyttest</span>(response <span class="sc">~</span> <span class="fu">as.factor</span>(Survey_Year), survey_design)</span>
<span id="cb2-161"><a href="#cb2-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-162"><a href="#cb2-162" aria-hidden="true" tabindex="-1"></a>  <span class="co"># head t-test results</span></span>
<span id="cb2-163"><a href="#cb2-163" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(ttest_result)</span>
<span id="cb2-164"><a href="#cb2-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-165"><a href="#cb2-165" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check significance and interpret the results</span></span>
<span id="cb2-166"><a href="#cb2-166" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (ttest_result<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>) {</span>
<span id="cb2-167"><a href="#cb2-167" aria-hidden="true" tabindex="-1"></a>    trend <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(ttest_result<span class="sc">$</span>estimate <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Significant Increase"</span>, <span class="st">"Significant Decrease"</span>)</span>
<span id="cb2-168"><a href="#cb2-168" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb2-169"><a href="#cb2-169" aria-hidden="true" tabindex="-1"></a>    trend <span class="ot">&lt;-</span> <span class="st">"No Change"</span></span>
<span id="cb2-170"><a href="#cb2-170" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-171"><a href="#cb2-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-172"><a href="#cb2-172" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> trend))</span>
<span id="cb2-173"><a href="#cb2-173" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-174"><a href="#cb2-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-175"><a href="#cb2-175" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the short-term function to each ROI_Indicator_Code</span></span>
<span id="cb2-176"><a href="#cb2-176" aria-hidden="true" tabindex="-1"></a>short_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(raw_stwd_general)[<span class="fu">grep</span>(<span class="st">"^(QN|V).*[RP]"</span>, <span class="fu">names</span>(raw_stwd_general))], <span class="cf">function</span>(column_name) {</span>
<span id="cb2-177"><a href="#cb2-177" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_short_term_trend_ttest</span>(raw_stwd_general, column_name)</span>
<span id="cb2-178"><a href="#cb2-178" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb2-179"><a href="#cb2-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-180"><a href="#cb2-180" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(short_trend_results)</span>
<span id="cb2-181"><a href="#cb2-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-182"><a href="#cb2-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-183"><a href="#cb2-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-184"><a href="#cb2-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-185"><a href="#cb2-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-186"><a href="#cb2-186" aria-hidden="true" tabindex="-1"></a><span class="do">################### Join Together with Trend Tables ############</span></span>
<span id="cb2-187"><a href="#cb2-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-188"><a href="#cb2-188" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine long-term and short-term results</span></span>
<span id="cb2-189"><a href="#cb2-189" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> <span class="fu">left_join</span>(long_trend_results, short_trend_results, <span class="at">by =</span> <span class="st">"ROI_Indicator_Code"</span>)</span>
<span id="cb2-190"><a href="#cb2-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-191"><a href="#cb2-191" aria-hidden="true" tabindex="-1"></a><span class="co">#head(combined_trend_results)</span></span>
<span id="cb2-192"><a href="#cb2-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-193"><a href="#cb2-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-194"><a href="#cb2-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-195"><a href="#cb2-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-196"><a href="#cb2-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-197"><a href="#cb2-197" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge Long_Term_Trend into yrbs_master_stwd_grade based on matching ROI_Indicator_Code and Trend_Category</span></span>
<span id="cb2-198"><a href="#cb2-198" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> yrbs_master_analysis_stwd_trend <span class="sc">%&gt;%</span></span>
<span id="cb2-199"><a href="#cb2-199" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(combined_trend_results <span class="sc">%&gt;%</span> <span class="fu">select</span>(ROI_Indicator_Code, Long_Term_Trend, Short_Term_Trend),</span>
<span id="cb2-200"><a href="#cb2-200" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ROI_Indicator_Code"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb2-201"><a href="#cb2-201" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(School_Type,</span>
<span id="cb2-202"><a href="#cb2-202" aria-hidden="true" tabindex="-1"></a>         Health_Topic, </span>
<span id="cb2-203"><a href="#cb2-203" aria-hidden="true" tabindex="-1"></a>         ROI_Indicator_Code, </span>
<span id="cb2-204"><a href="#cb2-204" aria-hidden="true" tabindex="-1"></a>         Indicator_Long_Description, </span>
<span id="cb2-205"><a href="#cb2-205" aria-hidden="true" tabindex="-1"></a>         Trend_Category, </span>
<span id="cb2-206"><a href="#cb2-206" aria-hidden="true" tabindex="-1"></a>         <span class="fu">everything</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb2-207"><a href="#cb2-207" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, ROI_Indicator_Code, Trend_Category)</span>
<span id="cb2-208"><a href="#cb2-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-209"><a href="#cb2-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-210"><a href="#cb2-210" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb2-211"><a href="#cb2-211" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">Long_Term_Trend =</span> Long_Term_Trend.x,</span>
<span id="cb2-212"><a href="#cb2-212" aria-hidden="true" tabindex="-1"></a>         <span class="at">Short_Term_Trend =</span> Short_Term_Trend.x) <span class="sc">%&gt;%</span></span>
<span id="cb2-213"><a href="#cb2-213" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(Long_Term_Trend.y,</span>
<span id="cb2-214"><a href="#cb2-214" aria-hidden="true" tabindex="-1"></a>            Short_Term_Trend.y))</span>
<span id="cb2-215"><a href="#cb2-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-216"><a href="#cb2-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-217"><a href="#cb2-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-218"><a href="#cb2-218" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to check for three consecutive NAs in a set of columns</span></span>
<span id="cb2-219"><a href="#cb2-219" aria-hidden="true" tabindex="-1"></a>check_consecutive_nas <span class="ot">&lt;-</span> <span class="cf">function</span>(year_values) {</span>
<span id="cb2-220"><a href="#cb2-220" aria-hidden="true" tabindex="-1"></a>  na_run_lengths <span class="ot">&lt;-</span> <span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>lengths[<span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>values]</span>
<span id="cb2-221"><a href="#cb2-221" aria-hidden="true" tabindex="-1"></a>  <span class="fu">any</span>(na_run_lengths <span class="sc">&gt;=</span> <span class="dv">3</span>)</span>
<span id="cb2-222"><a href="#cb2-222" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-223"><a href="#cb2-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-224"><a href="#cb2-224" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert all columns representing years to numeric</span></span>
<span id="cb2-225"><a href="#cb2-225" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb2-226"><a href="#cb2-226" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">d+$"</span>), as.numeric))</span>
<span id="cb2-227"><a href="#cb2-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-228"><a href="#cb2-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-229"><a href="#cb2-229" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results)</span>
<span id="cb2-230"><a href="#cb2-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-231"><a href="#cb2-231" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge and mutate Long_Term_Trend</span></span>
<span id="cb2-232"><a href="#cb2-232" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb2-233"><a href="#cb2-233" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb2-234"><a href="#cb2-234" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Long_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">check_consecutive_nas</span>(<span class="fu">c_across</span>(<span class="st">`</span><span class="at">2011</span><span class="st">`</span><span class="sc">:</span><span class="st">`</span><span class="at">2023</span><span class="st">`</span>)), </span>
<span id="cb2-235"><a href="#cb2-235" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb2-236"><a href="#cb2-236" aria-hidden="true" tabindex="-1"></a>                                  Long_Term_Trend),</span>
<span id="cb2-237"><a href="#cb2-237" aria-hidden="true" tabindex="-1"></a>         <span class="at">Short_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(<span class="st">`</span><span class="at">2019</span><span class="st">`</span>) <span class="sc">|</span> <span class="fu">is.na</span>(<span class="st">`</span><span class="at">2023</span><span class="st">`</span>), </span>
<span id="cb2-238"><a href="#cb2-238" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb2-239"><a href="#cb2-239" aria-hidden="true" tabindex="-1"></a>                                   Short_Term_Trend)) <span class="sc">%&gt;%</span></span>
<span id="cb2-240"><a href="#cb2-240" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb2-241"><a href="#cb2-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-242"><a href="#cb2-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-243"><a href="#cb2-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-244"><a href="#cb2-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-245"><a href="#cb2-245" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-246"><a href="#cb2-246" aria-hidden="true" tabindex="-1"></a>trend_results_overall <span class="ot">&lt;-</span> trend_results</span>
<span id="cb2-247"><a href="#cb2-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-248"><a href="#cb2-248" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-249"><a href="#cb2-249" aria-hidden="true" tabindex="-1"></a><span class="co"># View the updated dataframe</span></span>
<span id="cb2-250"><a href="#cb2-250" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results_overall)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="trend-by-grade" class="level3">
<h3 class="anchored" data-anchor-id="trend-by-grade">Trend by Grade</h3>
<section id="th" class="level4">
<h4 class="anchored" data-anchor-id="th">9th</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="do">######## Import Raw and Analyzed Excel Files ###############</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>yrbs_master_analysis_stwd_trend <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Grade Trend"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Trend_Category <span class="sc">==</span> <span class="st">"9th"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="st">"Suppressed"</span>, <span class="cn">NA</span>, .)))</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the raw data set to be used in trend analyis</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>raw_stwd_general <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"raw_yrbs_allyears_statewide_trad_cleaned.xlsx"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Grade <span class="sc">==</span> <span class="st">"9th"</span>,</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>         Survey_Year <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2011</span>, <span class="dv">2013</span>, <span class="dv">2015</span>, <span class="dv">2017</span>, <span class="dv">2019</span>, <span class="dv">2023</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">2</span>, <span class="dv">0</span>, <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="cn">NA</span>))))</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify ROIs with data for 4 or more survey years of data (We decided as a YRBS team that only ROI's with 4 data points/4 years total of data between the trend years being used, would be acceptable to do trend analysis on. Such that an ROI that has 2011, 2013, and 2017 data/prevalence estimate, would not have trend anlaysis performed on it)</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>roi_years <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), Survey_Year) <span class="sc">%&gt;%</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>Survey_Year, <span class="at">names_to =</span> <span class="st">"ROI_Indicator_Code"</span>, <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ROI_Indicator_Code) <span class="sc">%&gt;%</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">unique_years =</span> <span class="fu">n_distinct</span>(Survey_Year), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(unique_years <span class="sc">&gt;=</span> <span class="dv">4</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(ROI_Indicator_Code)</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the main data set to include only those ROIs, also ensuring to keep necessary demographic variables</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>filtered_raw_stwd_general <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Survey_Year, </span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>         <span class="fu">all_of</span>(roi_years),</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>         Sex,</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>         Race_Group_3,</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>         <span class="co">#Grade,</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>         Primary_Samp_Unit,</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>         Stratum,Final_Weight)</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a><span class="do">############ Long Term Trend ###############</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a><span class="co">#Trend Analysis Function</span></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>analyze_trend_logistic <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>  data_wtd <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Survey Design for YRBS Statewide</span></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_survey_design</span>(<span class="at">ids =</span> Primary_Samp_Unit,</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>                     <span class="at">strata =</span> Stratum,</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>                     <span class="at">weights =</span> Final_Weight,</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nest =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>                     )</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data_wtd <span class="sc">%&gt;%</span></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Sex =</span> <span class="fu">factor</span>(Sex),</span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>           <span class="at">Race_Group_3 =</span> <span class="fu">factor</span>(Race_Group_3), </span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>           <span class="co">#Grade = factor(Grade)</span></span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>           )</span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(data_filtered) <span class="sc">&lt;</span> <span class="dv">4</span> <span class="sc">||</span> <span class="fu">length</span>(<span class="fu">unique</span>(data_filtered<span class="sc">$</span>variables<span class="sc">$</span>Survey_Year)) <span class="sc">&lt;</span> <span class="dv">4</span>) {</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>  base_formula <span class="ot">&lt;-</span> <span class="fu">paste</span>(column_name, <span class="st">"~ Sex + Race_Group_3 + Survey_Year"</span>)<span class="co"># fix to test for yearly linear trend</span></span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>  models <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>    <span class="st">"linear"</span> <span class="ot">=</span> base_formula,</span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>    <span class="st">"quadratic"</span> <span class="ot">=</span> <span class="fu">paste</span>(base_formula, <span class="st">"+ I(Survey_Year^2)"</span>),</span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>    <span class="st">"cubic"</span> <span class="ot">=</span> <span class="fu">paste</span>(base_formula, <span class="st">"+ I(Survey_Year^2) + I(Survey_Year^3)"</span>)</span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a><span class="co">#browser() #debugging tool</span></span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(models, <span class="cf">function</span>(f) {</span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>    model <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({ <span class="co">#Used to see where the model is failing</span></span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>      <span class="fu">svyglm</span>(<span class="fu">as.formula</span>(f), <span class="at">design =</span> data_filtered, <span class="at">family =</span> <span class="fu">quasibinomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"Error fitting model: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(model)) {</span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="st">"Model fitting error"</span>)</span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>    coef_summary <span class="ot">=</span> <span class="fu">summary</span>(model)<span class="sc">$</span>coefficients</span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(coef_summary) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="st">"Model fitting error: No coefficients"</span>)</span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a><span class="co">#browser() # debug</span></span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>    highest_order_term <span class="ot">&lt;-</span> <span class="fu">tail</span>(<span class="fu">rownames</span>(coef_summary), <span class="dv">1</span>)<span class="co">#  Changed to rownames() from names() - now runs</span></span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(highest_order_term) <span class="sc">&amp;&amp;</span> highest_order_term <span class="sc">%in%</span> <span class="fu">rownames</span>(coef_summary)) {</span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a>      p_value <span class="ot">=</span> coef_summary[highest_order_term, <span class="st">"Pr(&gt;|t|)"</span>]<span class="co"># statistic changed to |t| from |z|</span></span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a>      coefficient <span class="ot">=</span> <span class="fu">coef</span>(model)[highest_order_term]</span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (p_value <span class="sc">&lt;=</span> <span class="fl">0.05</span>) {</span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (coefficient <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a>          <span class="fu">return</span>(<span class="st">"Significant Increase"</span>)</span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a>          <span class="fu">return</span>(<span class="st">"Significant Decrease"</span>)</span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="st">"No Change"</span>)</span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb3-102"><a href="#cb3-102" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="st">"Coefficient not available or model did not converge"</span>)</span>
<span id="cb3-103"><a href="#cb3-103" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-104"><a href="#cb3-104" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb3-105"><a href="#cb3-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-106"><a href="#cb3-106" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, </span>
<span id="cb3-107"><a href="#cb3-107" aria-hidden="true" tabindex="-1"></a>                    <span class="at">CUBIC_Term_Trend =</span> results<span class="sc">$</span>cubic,</span>
<span id="cb3-108"><a href="#cb3-108" aria-hidden="true" tabindex="-1"></a>                    <span class="at">QUAD_Term_Trend =</span> results<span class="sc">$</span>quadratic,</span>
<span id="cb3-109"><a href="#cb3-109" aria-hidden="true" tabindex="-1"></a>                    <span class="at">LIN_Term_Trend=</span>results<span class="sc">$</span>linear))</span>
<span id="cb3-110"><a href="#cb3-110" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-111"><a href="#cb3-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-112"><a href="#cb3-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-113"><a href="#cb3-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-114"><a href="#cb3-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-115"><a href="#cb3-115" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply function to each ROI_Indicator_Code that has sufficient data</span></span>
<span id="cb3-116"><a href="#cb3-116" aria-hidden="true" tabindex="-1"></a>long_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(filtered_raw_stwd_general)[<span class="sc">-</span><span class="dv">1</span>], <span class="cf">function</span>(column_name) {</span>
<span id="cb3-117"><a href="#cb3-117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_trend_logistic</span>(filtered_raw_stwd_general, column_name)</span>
<span id="cb3-118"><a href="#cb3-118" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb3-119"><a href="#cb3-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-120"><a href="#cb3-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-121"><a href="#cb3-121" aria-hidden="true" tabindex="-1"></a>long_trend_results <span class="ot">&lt;-</span> long_trend_results <span class="sc">%&gt;%</span></span>
<span id="cb3-122"><a href="#cb3-122" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">Long_Term_Trend =</span> LIN_Term_Trend) <span class="sc">%&gt;%</span></span>
<span id="cb3-123"><a href="#cb3-123" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(ROI_Indicator_Code,</span>
<span id="cb3-124"><a href="#cb3-124" aria-hidden="true" tabindex="-1"></a>         Long_Term_Trend</span>
<span id="cb3-125"><a href="#cb3-125" aria-hidden="true" tabindex="-1"></a>         )</span>
<span id="cb3-126"><a href="#cb3-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-127"><a href="#cb3-127" aria-hidden="true" tabindex="-1"></a><span class="co"># Show results</span></span>
<span id="cb3-128"><a href="#cb3-128" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(long_trend_results)</span>
<span id="cb3-129"><a href="#cb3-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-130"><a href="#cb3-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-131"><a href="#cb3-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-132"><a href="#cb3-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-133"><a href="#cb3-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-134"><a href="#cb3-134" aria-hidden="true" tabindex="-1"></a><span class="do">######### Short Term Trend ###############</span></span>
<span id="cb3-135"><a href="#cb3-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-136"><a href="#cb3-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-137"><a href="#cb3-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-138"><a href="#cb3-138" aria-hidden="true" tabindex="-1"></a>analyze_short_term_trend_ttest <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb3-139"><a href="#cb3-139" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define the short-term years</span></span>
<span id="cb3-140"><a href="#cb3-140" aria-hidden="true" tabindex="-1"></a>  short_term_years <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2019</span>, <span class="dv">2023</span>)</span>
<span id="cb3-141"><a href="#cb3-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-142"><a href="#cb3-142" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filter for short-term years and ensure all necessary variables are selected</span></span>
<span id="cb3-143"><a href="#cb3-143" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb3-144"><a href="#cb3-144" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Survey_Year <span class="sc">%in%</span> short_term_years) <span class="sc">%&gt;%</span></span>
<span id="cb3-145"><a href="#cb3-145" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Primary_Samp_Unit, Stratum, Final_Weight, Survey_Year, <span class="fu">all_of</span>(column_name)) <span class="sc">%&gt;%</span></span>
<span id="cb3-146"><a href="#cb3-146" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">response =</span> <span class="fu">get</span>(column_name) <span class="sc">==</span> <span class="dv">1</span>)  <span class="co"># Create a binary response variable for the analysis</span></span>
<span id="cb3-147"><a href="#cb3-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-148"><a href="#cb3-148" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if data is available for both years</span></span>
<span id="cb3-149"><a href="#cb3-149" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(short_term_years <span class="sc">%in%</span> <span class="fu">unique</span>(data_filtered<span class="sc">$</span>Survey_Year[<span class="sc">!</span><span class="fu">is.na</span>(data_filtered[[column_name]])]))) {</span>
<span id="cb3-150"><a href="#cb3-150" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb3-151"><a href="#cb3-151" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-152"><a href="#cb3-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-153"><a href="#cb3-153" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Continue with data that doesn't have NA responses</span></span>
<span id="cb3-154"><a href="#cb3-154" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(response))</span>
<span id="cb3-155"><a href="#cb3-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-156"><a href="#cb3-156" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create survey design object including the response variable</span></span>
<span id="cb3-157"><a href="#cb3-157" aria-hidden="true" tabindex="-1"></a>  survey_design <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="sc">~</span>Primary_Samp_Unit,</span>
<span id="cb3-158"><a href="#cb3-158" aria-hidden="true" tabindex="-1"></a>                             <span class="at">strata =</span> <span class="sc">~</span>Stratum,</span>
<span id="cb3-159"><a href="#cb3-159" aria-hidden="true" tabindex="-1"></a>                             <span class="at">weights =</span> <span class="sc">~</span>Final_Weight,</span>
<span id="cb3-160"><a href="#cb3-160" aria-hidden="true" tabindex="-1"></a>                             <span class="at">data =</span> data_filtered,</span>
<span id="cb3-161"><a href="#cb3-161" aria-hidden="true" tabindex="-1"></a>                             <span class="at">nest =</span> <span class="cn">TRUE</span>) </span>
<span id="cb3-162"><a href="#cb3-162" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-163"><a href="#cb3-163" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Perform Welch's t-test using the survey design object</span></span>
<span id="cb3-164"><a href="#cb3-164" aria-hidden="true" tabindex="-1"></a>  ttest_result <span class="ot">&lt;-</span> <span class="fu">svyttest</span>(response <span class="sc">~</span> <span class="fu">as.factor</span>(Survey_Year), survey_design)</span>
<span id="cb3-165"><a href="#cb3-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-166"><a href="#cb3-166" aria-hidden="true" tabindex="-1"></a>  <span class="co"># head t-test results</span></span>
<span id="cb3-167"><a href="#cb3-167" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(ttest_result)</span>
<span id="cb3-168"><a href="#cb3-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-169"><a href="#cb3-169" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check significance and interpret the results</span></span>
<span id="cb3-170"><a href="#cb3-170" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (ttest_result<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>) {</span>
<span id="cb3-171"><a href="#cb3-171" aria-hidden="true" tabindex="-1"></a>    trend <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(ttest_result<span class="sc">$</span>estimate <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Significant Increase"</span>, <span class="st">"Significant Decrease"</span>)</span>
<span id="cb3-172"><a href="#cb3-172" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb3-173"><a href="#cb3-173" aria-hidden="true" tabindex="-1"></a>    trend <span class="ot">&lt;-</span> <span class="st">"No Change"</span></span>
<span id="cb3-174"><a href="#cb3-174" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-175"><a href="#cb3-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-176"><a href="#cb3-176" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> trend))</span>
<span id="cb3-177"><a href="#cb3-177" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-178"><a href="#cb3-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-179"><a href="#cb3-179" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the short-term function to each ROI_Indicator_Code</span></span>
<span id="cb3-180"><a href="#cb3-180" aria-hidden="true" tabindex="-1"></a>short_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(raw_stwd_general)[<span class="fu">grep</span>(<span class="st">"^(QN|V).*[RP]"</span>, <span class="fu">names</span>(raw_stwd_general))], <span class="cf">function</span>(column_name) {</span>
<span id="cb3-181"><a href="#cb3-181" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_short_term_trend_ttest</span>(raw_stwd_general, column_name)</span>
<span id="cb3-182"><a href="#cb3-182" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb3-183"><a href="#cb3-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-184"><a href="#cb3-184" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(short_trend_results)</span>
<span id="cb3-185"><a href="#cb3-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-186"><a href="#cb3-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-187"><a href="#cb3-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-188"><a href="#cb3-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-189"><a href="#cb3-189" aria-hidden="true" tabindex="-1"></a><span class="do">################### Join Together with Trend Tables ############</span></span>
<span id="cb3-190"><a href="#cb3-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-191"><a href="#cb3-191" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine long-term and short-term results</span></span>
<span id="cb3-192"><a href="#cb3-192" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> <span class="fu">left_join</span>(long_trend_results, short_trend_results, <span class="at">by =</span> <span class="st">"ROI_Indicator_Code"</span>)</span>
<span id="cb3-193"><a href="#cb3-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-194"><a href="#cb3-194" aria-hidden="true" tabindex="-1"></a><span class="co">#head(combined_trend_results)</span></span>
<span id="cb3-195"><a href="#cb3-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-196"><a href="#cb3-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-197"><a href="#cb3-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-198"><a href="#cb3-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-199"><a href="#cb3-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-200"><a href="#cb3-200" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge Long_Term_Trend into yrbs_master_stwd_grade based on matching ROI_Indicator_Code and Trend_Category</span></span>
<span id="cb3-201"><a href="#cb3-201" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> yrbs_master_analysis_stwd_trend <span class="sc">%&gt;%</span></span>
<span id="cb3-202"><a href="#cb3-202" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(combined_trend_results <span class="sc">%&gt;%</span> <span class="fu">select</span>(ROI_Indicator_Code, Long_Term_Trend, Short_Term_Trend),</span>
<span id="cb3-203"><a href="#cb3-203" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ROI_Indicator_Code"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb3-204"><a href="#cb3-204" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(School_Type,</span>
<span id="cb3-205"><a href="#cb3-205" aria-hidden="true" tabindex="-1"></a>         Health_Topic, </span>
<span id="cb3-206"><a href="#cb3-206" aria-hidden="true" tabindex="-1"></a>         ROI_Indicator_Code, </span>
<span id="cb3-207"><a href="#cb3-207" aria-hidden="true" tabindex="-1"></a>         Indicator_Long_Description, </span>
<span id="cb3-208"><a href="#cb3-208" aria-hidden="true" tabindex="-1"></a>         Trend_Category, </span>
<span id="cb3-209"><a href="#cb3-209" aria-hidden="true" tabindex="-1"></a>         <span class="fu">everything</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb3-210"><a href="#cb3-210" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, ROI_Indicator_Code, Trend_Category)</span>
<span id="cb3-211"><a href="#cb3-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-212"><a href="#cb3-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-213"><a href="#cb3-213" aria-hidden="true" tabindex="-1"></a><span class="co"># trend_results &lt;- trend_results %&gt;%</span></span>
<span id="cb3-214"><a href="#cb3-214" aria-hidden="true" tabindex="-1"></a><span class="co">#   rename(Long_Term_Trend = Long_Term_Trend.x,</span></span>
<span id="cb3-215"><a href="#cb3-215" aria-hidden="true" tabindex="-1"></a><span class="co">#          Short_Term_Trend = Short_Term_Trend.x) %&gt;%</span></span>
<span id="cb3-216"><a href="#cb3-216" aria-hidden="true" tabindex="-1"></a><span class="co">#   select(-c(Long_Term_Trend.y,</span></span>
<span id="cb3-217"><a href="#cb3-217" aria-hidden="true" tabindex="-1"></a><span class="co">#             Short_Term_Trend.y))</span></span>
<span id="cb3-218"><a href="#cb3-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-219"><a href="#cb3-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-220"><a href="#cb3-220" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to check for three consecutive NAs in a set of columns</span></span>
<span id="cb3-221"><a href="#cb3-221" aria-hidden="true" tabindex="-1"></a>check_consecutive_nas <span class="ot">&lt;-</span> <span class="cf">function</span>(year_values) {</span>
<span id="cb3-222"><a href="#cb3-222" aria-hidden="true" tabindex="-1"></a>  na_run_lengths <span class="ot">&lt;-</span> <span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>lengths[<span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>values]</span>
<span id="cb3-223"><a href="#cb3-223" aria-hidden="true" tabindex="-1"></a>  <span class="fu">any</span>(na_run_lengths <span class="sc">&gt;=</span> <span class="dv">3</span>)</span>
<span id="cb3-224"><a href="#cb3-224" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-225"><a href="#cb3-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-226"><a href="#cb3-226" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert all columns representing years to numeric</span></span>
<span id="cb3-227"><a href="#cb3-227" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb3-228"><a href="#cb3-228" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">d+$"</span>), as.numeric))</span>
<span id="cb3-229"><a href="#cb3-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-230"><a href="#cb3-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-231"><a href="#cb3-231" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results)</span>
<span id="cb3-232"><a href="#cb3-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-233"><a href="#cb3-233" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge and mutate Long_Term_Trend</span></span>
<span id="cb3-234"><a href="#cb3-234" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb3-235"><a href="#cb3-235" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb3-236"><a href="#cb3-236" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Long_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">check_consecutive_nas</span>(<span class="fu">c_across</span>(<span class="st">`</span><span class="at">2011</span><span class="st">`</span><span class="sc">:</span><span class="st">`</span><span class="at">2023</span><span class="st">`</span>)), </span>
<span id="cb3-237"><a href="#cb3-237" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb3-238"><a href="#cb3-238" aria-hidden="true" tabindex="-1"></a>                                  Long_Term_Trend),</span>
<span id="cb3-239"><a href="#cb3-239" aria-hidden="true" tabindex="-1"></a>         <span class="at">Short_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(<span class="st">`</span><span class="at">2019</span><span class="st">`</span>) <span class="sc">|</span> <span class="fu">is.na</span>(<span class="st">`</span><span class="at">2023</span><span class="st">`</span>), </span>
<span id="cb3-240"><a href="#cb3-240" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb3-241"><a href="#cb3-241" aria-hidden="true" tabindex="-1"></a>                                   Short_Term_Trend)) <span class="sc">%&gt;%</span></span>
<span id="cb3-242"><a href="#cb3-242" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb3-243"><a href="#cb3-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-244"><a href="#cb3-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-245"><a href="#cb3-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-246"><a href="#cb3-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-247"><a href="#cb3-247" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-248"><a href="#cb3-248" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-249"><a href="#cb3-249" aria-hidden="true" tabindex="-1"></a>trend_results_grade_09 <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb3-250"><a href="#cb3-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-251"><a href="#cb3-251" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-252"><a href="#cb3-252" aria-hidden="true" tabindex="-1"></a><span class="co"># View the updated dataframe</span></span>
<span id="cb3-253"><a href="#cb3-253" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results_grade_09)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="th-1" class="level4">
<h4 class="anchored" data-anchor-id="th-1">10th</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="do">######## Import Raw and Analyzed Excel Files ###############</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>yrbs_master_analysis_stwd_trend <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Grade Trend"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Trend_Category <span class="sc">==</span> <span class="st">"10th"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="st">"Suppressed"</span>, <span class="cn">NA</span>, .)))</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the raw data set to be used in trend analyis</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>raw_stwd_general <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"raw_yrbs_allyears_statewide_trad_cleaned.xlsx"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Grade <span class="sc">==</span> <span class="st">"10th"</span>,</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>         Survey_Year <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2011</span>, <span class="dv">2013</span>, <span class="dv">2015</span>, <span class="dv">2017</span>, <span class="dv">2019</span>, <span class="dv">2023</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">2</span>, <span class="dv">0</span>, <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="cn">NA</span>))))</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify ROIs with data for 4 or more survey years of data (We decided as a YRBS team that only ROI's with 4 data points/4 years total of data between the trend years being used, would be acceptable to do trend analysis on. Such that an ROI that has 2011, 2013, and 2017 data/prevalence estimate, would not have trend anlaysis performed on it)</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>roi_years <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), Survey_Year) <span class="sc">%&gt;%</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>Survey_Year, <span class="at">names_to =</span> <span class="st">"ROI_Indicator_Code"</span>, <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ROI_Indicator_Code) <span class="sc">%&gt;%</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">unique_years =</span> <span class="fu">n_distinct</span>(Survey_Year), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(unique_years <span class="sc">&gt;=</span> <span class="dv">4</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(ROI_Indicator_Code)</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the main data set to include only those ROIs, also ensuring to keep necessary demographic variables</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>filtered_raw_stwd_general <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Survey_Year, <span class="fu">all_of</span>(roi_years), Sex, Race_Group_3,Primary_Samp_Unit,Stratum,Final_Weight)</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a><span class="do">############ Long Term Trend ###############</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a><span class="co">#Trend Analysis Function</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>analyze_trend_logistic <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>  data_wtd <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Survey Design for YRBS Statewide</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_survey_design</span>(<span class="at">ids =</span> Primary_Samp_Unit,</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>                     <span class="at">strata =</span> Stratum,</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>                     <span class="at">weights =</span> Final_Weight,</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nest =</span> <span class="cn">TRUE</span>,</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>                     )</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data_wtd <span class="sc">%&gt;%</span></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Sex =</span> <span class="fu">factor</span>(Sex),</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>           <span class="at">Race_Group_3 =</span> <span class="fu">factor</span>(Race_Group_3), </span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>           <span class="co">#Grade = factor(Grade)</span></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>           )</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(data_filtered) <span class="sc">&lt;</span> <span class="dv">4</span> <span class="sc">||</span> <span class="fu">length</span>(<span class="fu">unique</span>(data_filtered<span class="sc">$</span>variables<span class="sc">$</span>Survey_Year)) <span class="sc">&lt;</span> <span class="dv">4</span>) {</span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>  base_formula <span class="ot">&lt;-</span> <span class="fu">paste</span>(column_name, <span class="st">"~ Sex + Race_Group_3 + Survey_Year"</span>)<span class="co"># fix to test for yearly linear trend</span></span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>  models <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>    <span class="st">"linear"</span> <span class="ot">=</span> base_formula,</span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>    <span class="st">"quadratic"</span> <span class="ot">=</span> <span class="fu">paste</span>(base_formula, <span class="st">"+ I(Survey_Year^2)"</span>),</span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>    <span class="st">"cubic"</span> <span class="ot">=</span> <span class="fu">paste</span>(base_formula, <span class="st">"+ I(Survey_Year^2) + I(Survey_Year^3)"</span>)</span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a><span class="co">#browser() #debugging tool</span></span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(models, <span class="cf">function</span>(f) {</span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>    model <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({ <span class="co">#Used to see where the model is failing</span></span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>      <span class="fu">svyglm</span>(<span class="fu">as.formula</span>(f), <span class="at">design =</span> data_filtered, <span class="at">family =</span> <span class="fu">quasibinomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"Error fitting model: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(model)) {</span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="st">"Model fitting error"</span>)</span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>    coef_summary <span class="ot">=</span> <span class="fu">summary</span>(model)<span class="sc">$</span>coefficients</span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(coef_summary) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="st">"Model fitting error: No coefficients"</span>)</span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a><span class="co">#browser() # debug</span></span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>    highest_order_term <span class="ot">&lt;-</span> <span class="fu">tail</span>(<span class="fu">rownames</span>(coef_summary), <span class="dv">1</span>)<span class="co">#  Changed to rownames() from names() - now runs</span></span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(highest_order_term) <span class="sc">&amp;&amp;</span> highest_order_term <span class="sc">%in%</span> <span class="fu">rownames</span>(coef_summary)) {</span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>      p_value <span class="ot">=</span> coef_summary[highest_order_term, <span class="st">"Pr(&gt;|t|)"</span>]<span class="co"># statistic changed to |t| from |z|</span></span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>      coefficient <span class="ot">=</span> <span class="fu">coef</span>(model)[highest_order_term]</span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (p_value <span class="sc">&lt;=</span> <span class="fl">0.05</span>) {</span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (coefficient <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>          <span class="fu">return</span>(<span class="st">"Significant Increase"</span>)</span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a>          <span class="fu">return</span>(<span class="st">"Significant Decrease"</span>)</span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="st">"No Change"</span>)</span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="st">"Coefficient not available or model did not converge"</span>)</span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, </span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a>                    <span class="at">CUBIC_Term_Trend =</span> results<span class="sc">$</span>cubic,</span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true" tabindex="-1"></a>                    <span class="at">QUAD_Term_Trend =</span> results<span class="sc">$</span>quadratic,</span>
<span id="cb4-108"><a href="#cb4-108" aria-hidden="true" tabindex="-1"></a>                    <span class="at">LIN_Term_Trend=</span>results<span class="sc">$</span>linear))</span>
<span id="cb4-109"><a href="#cb4-109" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-110"><a href="#cb4-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-111"><a href="#cb4-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-112"><a href="#cb4-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-113"><a href="#cb4-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-114"><a href="#cb4-114" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply function to each ROI_Indicator_Code that has sufficient data</span></span>
<span id="cb4-115"><a href="#cb4-115" aria-hidden="true" tabindex="-1"></a>long_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(filtered_raw_stwd_general)[<span class="sc">-</span><span class="dv">1</span>], <span class="cf">function</span>(column_name) {</span>
<span id="cb4-116"><a href="#cb4-116" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_trend_logistic</span>(filtered_raw_stwd_general, column_name)</span>
<span id="cb4-117"><a href="#cb4-117" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb4-118"><a href="#cb4-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-119"><a href="#cb4-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-120"><a href="#cb4-120" aria-hidden="true" tabindex="-1"></a>long_trend_results <span class="ot">&lt;-</span> long_trend_results <span class="sc">%&gt;%</span></span>
<span id="cb4-121"><a href="#cb4-121" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">Long_Term_Trend =</span> LIN_Term_Trend) <span class="sc">%&gt;%</span></span>
<span id="cb4-122"><a href="#cb4-122" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(ROI_Indicator_Code,</span>
<span id="cb4-123"><a href="#cb4-123" aria-hidden="true" tabindex="-1"></a>         Long_Term_Trend</span>
<span id="cb4-124"><a href="#cb4-124" aria-hidden="true" tabindex="-1"></a>         )</span>
<span id="cb4-125"><a href="#cb4-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-126"><a href="#cb4-126" aria-hidden="true" tabindex="-1"></a><span class="co"># Show results</span></span>
<span id="cb4-127"><a href="#cb4-127" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(long_trend_results)</span>
<span id="cb4-128"><a href="#cb4-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-129"><a href="#cb4-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-130"><a href="#cb4-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-131"><a href="#cb4-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-132"><a href="#cb4-132" aria-hidden="true" tabindex="-1"></a><span class="do">######### Short Term Trend ###############</span></span>
<span id="cb4-133"><a href="#cb4-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-134"><a href="#cb4-134" aria-hidden="true" tabindex="-1"></a>analyze_short_term_trend_ttest <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb4-135"><a href="#cb4-135" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define the short-term years</span></span>
<span id="cb4-136"><a href="#cb4-136" aria-hidden="true" tabindex="-1"></a>  short_term_years <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2019</span>, <span class="dv">2023</span>)</span>
<span id="cb4-137"><a href="#cb4-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-138"><a href="#cb4-138" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filter for short-term years and ensure all necessary variables are selected</span></span>
<span id="cb4-139"><a href="#cb4-139" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb4-140"><a href="#cb4-140" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Survey_Year <span class="sc">%in%</span> short_term_years) <span class="sc">%&gt;%</span></span>
<span id="cb4-141"><a href="#cb4-141" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Primary_Samp_Unit, Stratum, Final_Weight, Survey_Year, <span class="fu">all_of</span>(column_name)) <span class="sc">%&gt;%</span></span>
<span id="cb4-142"><a href="#cb4-142" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">response =</span> <span class="fu">get</span>(column_name) <span class="sc">==</span> <span class="dv">1</span>)  <span class="co"># Create a binary response variable for the analysis</span></span>
<span id="cb4-143"><a href="#cb4-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-144"><a href="#cb4-144" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if data is available for both years</span></span>
<span id="cb4-145"><a href="#cb4-145" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(short_term_years <span class="sc">%in%</span> <span class="fu">unique</span>(data_filtered<span class="sc">$</span>Survey_Year[<span class="sc">!</span><span class="fu">is.na</span>(data_filtered[[column_name]])]))) {</span>
<span id="cb4-146"><a href="#cb4-146" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb4-147"><a href="#cb4-147" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-148"><a href="#cb4-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-149"><a href="#cb4-149" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Continue with data that doesn't have NA responses</span></span>
<span id="cb4-150"><a href="#cb4-150" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(response))</span>
<span id="cb4-151"><a href="#cb4-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-152"><a href="#cb4-152" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create survey design object including the response variable</span></span>
<span id="cb4-153"><a href="#cb4-153" aria-hidden="true" tabindex="-1"></a>  survey_design <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="sc">~</span>Primary_Samp_Unit,</span>
<span id="cb4-154"><a href="#cb4-154" aria-hidden="true" tabindex="-1"></a>                             <span class="at">strata =</span> <span class="sc">~</span>Stratum,</span>
<span id="cb4-155"><a href="#cb4-155" aria-hidden="true" tabindex="-1"></a>                             <span class="at">weights =</span> <span class="sc">~</span>Final_Weight,</span>
<span id="cb4-156"><a href="#cb4-156" aria-hidden="true" tabindex="-1"></a>                             <span class="at">data =</span> data_filtered,</span>
<span id="cb4-157"><a href="#cb4-157" aria-hidden="true" tabindex="-1"></a>                             <span class="at">nest =</span> <span class="cn">TRUE</span>) </span>
<span id="cb4-158"><a href="#cb4-158" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-159"><a href="#cb4-159" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Perform Welch's t-test using the survey design object</span></span>
<span id="cb4-160"><a href="#cb4-160" aria-hidden="true" tabindex="-1"></a>  ttest_result <span class="ot">&lt;-</span> <span class="fu">svyttest</span>(response <span class="sc">~</span> <span class="fu">as.factor</span>(Survey_Year), survey_design)</span>
<span id="cb4-161"><a href="#cb4-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-162"><a href="#cb4-162" aria-hidden="true" tabindex="-1"></a>  <span class="co"># head t-test results</span></span>
<span id="cb4-163"><a href="#cb4-163" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(ttest_result)</span>
<span id="cb4-164"><a href="#cb4-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-165"><a href="#cb4-165" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check significance and interpret the results</span></span>
<span id="cb4-166"><a href="#cb4-166" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (ttest_result<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>) {</span>
<span id="cb4-167"><a href="#cb4-167" aria-hidden="true" tabindex="-1"></a>    trend <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(ttest_result<span class="sc">$</span>estimate <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Significant Increase"</span>, <span class="st">"Significant Decrease"</span>)</span>
<span id="cb4-168"><a href="#cb4-168" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb4-169"><a href="#cb4-169" aria-hidden="true" tabindex="-1"></a>    trend <span class="ot">&lt;-</span> <span class="st">"No Change"</span></span>
<span id="cb4-170"><a href="#cb4-170" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-171"><a href="#cb4-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-172"><a href="#cb4-172" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> trend))</span>
<span id="cb4-173"><a href="#cb4-173" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-174"><a href="#cb4-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-175"><a href="#cb4-175" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the short-term function to each ROI_Indicator_Code</span></span>
<span id="cb4-176"><a href="#cb4-176" aria-hidden="true" tabindex="-1"></a>short_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(raw_stwd_general)[<span class="fu">grep</span>(<span class="st">"^(QN|V).*[RP]"</span>, <span class="fu">names</span>(raw_stwd_general))], <span class="cf">function</span>(column_name) {</span>
<span id="cb4-177"><a href="#cb4-177" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_short_term_trend_ttest</span>(raw_stwd_general, column_name)</span>
<span id="cb4-178"><a href="#cb4-178" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb4-179"><a href="#cb4-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-180"><a href="#cb4-180" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(short_trend_results)</span>
<span id="cb4-181"><a href="#cb4-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-182"><a href="#cb4-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-183"><a href="#cb4-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-184"><a href="#cb4-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-185"><a href="#cb4-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-186"><a href="#cb4-186" aria-hidden="true" tabindex="-1"></a><span class="do">################### Join Together with Trend Tables ############</span></span>
<span id="cb4-187"><a href="#cb4-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-188"><a href="#cb4-188" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine long-term and short-term results</span></span>
<span id="cb4-189"><a href="#cb4-189" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> <span class="fu">left_join</span>(long_trend_results, short_trend_results, <span class="at">by =</span> <span class="st">"ROI_Indicator_Code"</span>)</span>
<span id="cb4-190"><a href="#cb4-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-191"><a href="#cb4-191" aria-hidden="true" tabindex="-1"></a><span class="co">#head(combined_trend_results)</span></span>
<span id="cb4-192"><a href="#cb4-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-193"><a href="#cb4-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-194"><a href="#cb4-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-195"><a href="#cb4-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-196"><a href="#cb4-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-197"><a href="#cb4-197" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge Long_Term_Trend into yrbs_master_stwd_grade based on matching ROI_Indicator_Code and Trend_Category</span></span>
<span id="cb4-198"><a href="#cb4-198" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> yrbs_master_analysis_stwd_trend <span class="sc">%&gt;%</span></span>
<span id="cb4-199"><a href="#cb4-199" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(combined_trend_results <span class="sc">%&gt;%</span> <span class="fu">select</span>(ROI_Indicator_Code, Long_Term_Trend, Short_Term_Trend),</span>
<span id="cb4-200"><a href="#cb4-200" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ROI_Indicator_Code"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb4-201"><a href="#cb4-201" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(School_Type,</span>
<span id="cb4-202"><a href="#cb4-202" aria-hidden="true" tabindex="-1"></a>         Health_Topic, </span>
<span id="cb4-203"><a href="#cb4-203" aria-hidden="true" tabindex="-1"></a>         ROI_Indicator_Code, </span>
<span id="cb4-204"><a href="#cb4-204" aria-hidden="true" tabindex="-1"></a>         Indicator_Long_Description, </span>
<span id="cb4-205"><a href="#cb4-205" aria-hidden="true" tabindex="-1"></a>         Trend_Category, </span>
<span id="cb4-206"><a href="#cb4-206" aria-hidden="true" tabindex="-1"></a>         <span class="fu">everything</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb4-207"><a href="#cb4-207" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, ROI_Indicator_Code, Trend_Category)</span>
<span id="cb4-208"><a href="#cb4-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-209"><a href="#cb4-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-210"><a href="#cb4-210" aria-hidden="true" tabindex="-1"></a><span class="co"># trend_results &lt;- trend_results %&gt;%</span></span>
<span id="cb4-211"><a href="#cb4-211" aria-hidden="true" tabindex="-1"></a><span class="co">#   rename(Long_Term_Trend = Long_Term_Trend.x,</span></span>
<span id="cb4-212"><a href="#cb4-212" aria-hidden="true" tabindex="-1"></a><span class="co">#          Short_Term_Trend = Short_Term_Trend.x) %&gt;%</span></span>
<span id="cb4-213"><a href="#cb4-213" aria-hidden="true" tabindex="-1"></a><span class="co">#   select(-c(Long_Term_Trend.y,</span></span>
<span id="cb4-214"><a href="#cb4-214" aria-hidden="true" tabindex="-1"></a><span class="co">#             Short_Term_Trend.y))</span></span>
<span id="cb4-215"><a href="#cb4-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-216"><a href="#cb4-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-217"><a href="#cb4-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-218"><a href="#cb4-218" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to check for three consecutive NAs in a set of columns</span></span>
<span id="cb4-219"><a href="#cb4-219" aria-hidden="true" tabindex="-1"></a>check_consecutive_nas <span class="ot">&lt;-</span> <span class="cf">function</span>(year_values) {</span>
<span id="cb4-220"><a href="#cb4-220" aria-hidden="true" tabindex="-1"></a>  na_run_lengths <span class="ot">&lt;-</span> <span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>lengths[<span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>values]</span>
<span id="cb4-221"><a href="#cb4-221" aria-hidden="true" tabindex="-1"></a>  <span class="fu">any</span>(na_run_lengths <span class="sc">&gt;=</span> <span class="dv">3</span>)</span>
<span id="cb4-222"><a href="#cb4-222" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-223"><a href="#cb4-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-224"><a href="#cb4-224" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert all columns representing years to numeric</span></span>
<span id="cb4-225"><a href="#cb4-225" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb4-226"><a href="#cb4-226" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">d+$"</span>), as.numeric))</span>
<span id="cb4-227"><a href="#cb4-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-228"><a href="#cb4-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-229"><a href="#cb4-229" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results)</span>
<span id="cb4-230"><a href="#cb4-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-231"><a href="#cb4-231" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge and mutate Long_Term_Trend</span></span>
<span id="cb4-232"><a href="#cb4-232" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb4-233"><a href="#cb4-233" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb4-234"><a href="#cb4-234" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Long_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">check_consecutive_nas</span>(<span class="fu">c_across</span>(<span class="st">`</span><span class="at">2011</span><span class="st">`</span><span class="sc">:</span><span class="st">`</span><span class="at">2023</span><span class="st">`</span>)), </span>
<span id="cb4-235"><a href="#cb4-235" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb4-236"><a href="#cb4-236" aria-hidden="true" tabindex="-1"></a>                                  Long_Term_Trend),</span>
<span id="cb4-237"><a href="#cb4-237" aria-hidden="true" tabindex="-1"></a>         <span class="at">Short_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(<span class="st">`</span><span class="at">2019</span><span class="st">`</span>) <span class="sc">|</span> <span class="fu">is.na</span>(<span class="st">`</span><span class="at">2023</span><span class="st">`</span>), </span>
<span id="cb4-238"><a href="#cb4-238" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb4-239"><a href="#cb4-239" aria-hidden="true" tabindex="-1"></a>                                   Short_Term_Trend)) <span class="sc">%&gt;%</span></span>
<span id="cb4-240"><a href="#cb4-240" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb4-241"><a href="#cb4-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-242"><a href="#cb4-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-243"><a href="#cb4-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-244"><a href="#cb4-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-245"><a href="#cb4-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-246"><a href="#cb4-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-247"><a href="#cb4-247" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-248"><a href="#cb4-248" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-249"><a href="#cb4-249" aria-hidden="true" tabindex="-1"></a>trend_results_grade_10 <span class="ot">&lt;-</span> trend_results </span>
<span id="cb4-250"><a href="#cb4-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-251"><a href="#cb4-251" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-252"><a href="#cb4-252" aria-hidden="true" tabindex="-1"></a><span class="co"># View the updated dataframe</span></span>
<span id="cb4-253"><a href="#cb4-253" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results_grade_10)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="th-2" class="level4">
<h4 class="anchored" data-anchor-id="th-2">11th</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="do">######## Import Raw and Analyzed Excel Files ###############</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>yrbs_master_analysis_stwd_trend <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Grade Trend"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Trend_Category <span class="sc">==</span> <span class="st">"11th"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="st">"Suppressed"</span>, <span class="cn">NA</span>, .)))</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the raw data set to be used in trend analyis</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>raw_stwd_general <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"raw_yrbs_allyears_statewide_trad_cleaned.xlsx"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Grade <span class="sc">==</span> <span class="st">"11th"</span>,</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>         Survey_Year <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2011</span>, <span class="dv">2013</span>, <span class="dv">2015</span>, <span class="dv">2017</span>, <span class="dv">2019</span>, <span class="dv">2023</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">2</span>, <span class="dv">0</span>, <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="cn">NA</span>))))</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify ROIs with data for 4 or more survey years of data (We decided as a YRBS team that only ROI's with 4 data points/4 years total of data between the trend years being used, would be acceptable to do trend analysis on. Such that an ROI that has 2011, 2013, and 2017 data/prevalence estimate, would not have trend anlaysis performed on it)</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>roi_years <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), Survey_Year) <span class="sc">%&gt;%</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>Survey_Year, <span class="at">names_to =</span> <span class="st">"ROI_Indicator_Code"</span>, <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ROI_Indicator_Code) <span class="sc">%&gt;%</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">unique_years =</span> <span class="fu">n_distinct</span>(Survey_Year), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(unique_years <span class="sc">&gt;=</span> <span class="dv">4</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(ROI_Indicator_Code)</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the main data set to include only those ROIs, also ensuring to keep necessary demographic variables</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>filtered_raw_stwd_general <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Survey_Year, <span class="fu">all_of</span>(roi_years), Sex, Race_Group_3,Primary_Samp_Unit,Stratum,Final_Weight)</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a><span class="do">############ Long Term Trend ###############</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a><span class="co">#Trend Analysis Function</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>analyze_trend_logistic <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>  data_wtd <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Survey Design for YRBS Statewide</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_survey_design</span>(<span class="at">ids =</span> Primary_Samp_Unit,</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>                     <span class="at">strata =</span> Stratum,</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>                     <span class="at">weights =</span> Final_Weight,</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nest =</span> <span class="cn">TRUE</span>,</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>                     )</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data_wtd <span class="sc">%&gt;%</span></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Sex =</span> <span class="fu">factor</span>(Sex),</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>           <span class="at">Race_Group_3 =</span> <span class="fu">factor</span>(Race_Group_3), </span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>           <span class="co">#Grade = factor(Grade)</span></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>           )</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(data_filtered) <span class="sc">&lt;</span> <span class="dv">4</span> <span class="sc">||</span> <span class="fu">length</span>(<span class="fu">unique</span>(data_filtered<span class="sc">$</span>variables<span class="sc">$</span>Survey_Year)) <span class="sc">&lt;</span> <span class="dv">4</span>) {</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>  base_formula <span class="ot">&lt;-</span> <span class="fu">paste</span>(column_name, <span class="st">"~ Sex + Race_Group_3 + Survey_Year"</span>)<span class="co"># fix to test for yearly linear trend</span></span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>  models <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>    <span class="st">"linear"</span> <span class="ot">=</span> base_formula,</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>    <span class="st">"quadratic"</span> <span class="ot">=</span> <span class="fu">paste</span>(base_formula, <span class="st">"+ I(Survey_Year^2)"</span>),</span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>    <span class="st">"cubic"</span> <span class="ot">=</span> <span class="fu">paste</span>(base_formula, <span class="st">"+ I(Survey_Year^2) + I(Survey_Year^3)"</span>)</span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a><span class="co">#browser() #debugging tool</span></span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(models, <span class="cf">function</span>(f) {</span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>    model <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({ <span class="co">#Used to see where the model is failing</span></span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>      <span class="fu">svyglm</span>(<span class="fu">as.formula</span>(f), <span class="at">design =</span> data_filtered, <span class="at">family =</span> <span class="fu">quasibinomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"Error fitting model: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(model)) {</span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="st">"Model fitting error"</span>)</span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>    coef_summary <span class="ot">=</span> <span class="fu">summary</span>(model)<span class="sc">$</span>coefficients</span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(coef_summary) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="st">"Model fitting error: No coefficients"</span>)</span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a><span class="co">#browser() # debug</span></span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a>    highest_order_term <span class="ot">&lt;-</span> <span class="fu">tail</span>(<span class="fu">rownames</span>(coef_summary), <span class="dv">1</span>)<span class="co">#  Changed to rownames() from names() - now runs</span></span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(highest_order_term) <span class="sc">&amp;&amp;</span> highest_order_term <span class="sc">%in%</span> <span class="fu">rownames</span>(coef_summary)) {</span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a>      p_value <span class="ot">=</span> coef_summary[highest_order_term, <span class="st">"Pr(&gt;|t|)"</span>]<span class="co"># statistic changed to |t| from |z|</span></span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>      coefficient <span class="ot">=</span> <span class="fu">coef</span>(model)[highest_order_term]</span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (p_value <span class="sc">&lt;=</span> <span class="fl">0.05</span>) {</span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (coefficient <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a>          <span class="fu">return</span>(<span class="st">"Significant Increase"</span>)</span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a>          <span class="fu">return</span>(<span class="st">"Significant Decrease"</span>)</span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="st">"No Change"</span>)</span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="st">"Coefficient not available or model did not converge"</span>)</span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, </span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true" tabindex="-1"></a>                    <span class="at">CUBIC_Term_Trend =</span> results<span class="sc">$</span>cubic,</span>
<span id="cb5-99"><a href="#cb5-99" aria-hidden="true" tabindex="-1"></a>                    <span class="at">QUAD_Term_Trend =</span> results<span class="sc">$</span>quadratic,</span>
<span id="cb5-100"><a href="#cb5-100" aria-hidden="true" tabindex="-1"></a>                    <span class="at">LIN_Term_Trend=</span>results<span class="sc">$</span>linear))</span>
<span id="cb5-101"><a href="#cb5-101" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-102"><a href="#cb5-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-103"><a href="#cb5-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-104"><a href="#cb5-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-105"><a href="#cb5-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-106"><a href="#cb5-106" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply function to each ROI_Indicator_Code that has sufficient data</span></span>
<span id="cb5-107"><a href="#cb5-107" aria-hidden="true" tabindex="-1"></a>long_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(filtered_raw_stwd_general)[<span class="sc">-</span><span class="dv">1</span>], <span class="cf">function</span>(column_name) {</span>
<span id="cb5-108"><a href="#cb5-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_trend_logistic</span>(filtered_raw_stwd_general, column_name)</span>
<span id="cb5-109"><a href="#cb5-109" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb5-110"><a href="#cb5-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-111"><a href="#cb5-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-112"><a href="#cb5-112" aria-hidden="true" tabindex="-1"></a>long_trend_results <span class="ot">&lt;-</span> long_trend_results <span class="sc">%&gt;%</span></span>
<span id="cb5-113"><a href="#cb5-113" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">Long_Term_Trend =</span> LIN_Term_Trend) <span class="sc">%&gt;%</span></span>
<span id="cb5-114"><a href="#cb5-114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(ROI_Indicator_Code,</span>
<span id="cb5-115"><a href="#cb5-115" aria-hidden="true" tabindex="-1"></a>         Long_Term_Trend</span>
<span id="cb5-116"><a href="#cb5-116" aria-hidden="true" tabindex="-1"></a>         )</span>
<span id="cb5-117"><a href="#cb5-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-118"><a href="#cb5-118" aria-hidden="true" tabindex="-1"></a><span class="co"># Show results</span></span>
<span id="cb5-119"><a href="#cb5-119" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(long_trend_results)</span>
<span id="cb5-120"><a href="#cb5-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-121"><a href="#cb5-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-122"><a href="#cb5-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-123"><a href="#cb5-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-124"><a href="#cb5-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-125"><a href="#cb5-125" aria-hidden="true" tabindex="-1"></a><span class="do">######### Short Term Trend ###############</span></span>
<span id="cb5-126"><a href="#cb5-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-127"><a href="#cb5-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-128"><a href="#cb5-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-129"><a href="#cb5-129" aria-hidden="true" tabindex="-1"></a>analyze_short_term_trend_ttest <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb5-130"><a href="#cb5-130" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define the short-term years</span></span>
<span id="cb5-131"><a href="#cb5-131" aria-hidden="true" tabindex="-1"></a>  short_term_years <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2019</span>, <span class="dv">2023</span>)</span>
<span id="cb5-132"><a href="#cb5-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-133"><a href="#cb5-133" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filter for short-term years and ensure all necessary variables are selected</span></span>
<span id="cb5-134"><a href="#cb5-134" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb5-135"><a href="#cb5-135" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Survey_Year <span class="sc">%in%</span> short_term_years) <span class="sc">%&gt;%</span></span>
<span id="cb5-136"><a href="#cb5-136" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Primary_Samp_Unit, Stratum, Final_Weight, Survey_Year, <span class="fu">all_of</span>(column_name)) <span class="sc">%&gt;%</span></span>
<span id="cb5-137"><a href="#cb5-137" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">response =</span> <span class="fu">get</span>(column_name) <span class="sc">==</span> <span class="dv">1</span>)  <span class="co"># Create a binary response variable for the analysis</span></span>
<span id="cb5-138"><a href="#cb5-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-139"><a href="#cb5-139" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if data is available for both years</span></span>
<span id="cb5-140"><a href="#cb5-140" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(short_term_years <span class="sc">%in%</span> <span class="fu">unique</span>(data_filtered<span class="sc">$</span>Survey_Year[<span class="sc">!</span><span class="fu">is.na</span>(data_filtered[[column_name]])]))) {</span>
<span id="cb5-141"><a href="#cb5-141" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb5-142"><a href="#cb5-142" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-143"><a href="#cb5-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-144"><a href="#cb5-144" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Continue with data that doesn't have NA responses</span></span>
<span id="cb5-145"><a href="#cb5-145" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(response))</span>
<span id="cb5-146"><a href="#cb5-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-147"><a href="#cb5-147" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create survey design object including the response variable</span></span>
<span id="cb5-148"><a href="#cb5-148" aria-hidden="true" tabindex="-1"></a>  survey_design <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="sc">~</span>Primary_Samp_Unit,</span>
<span id="cb5-149"><a href="#cb5-149" aria-hidden="true" tabindex="-1"></a>                             <span class="at">strata =</span> <span class="sc">~</span>Stratum,</span>
<span id="cb5-150"><a href="#cb5-150" aria-hidden="true" tabindex="-1"></a>                             <span class="at">weights =</span> <span class="sc">~</span>Final_Weight,</span>
<span id="cb5-151"><a href="#cb5-151" aria-hidden="true" tabindex="-1"></a>                             <span class="at">data =</span> data_filtered,</span>
<span id="cb5-152"><a href="#cb5-152" aria-hidden="true" tabindex="-1"></a>                             <span class="at">nest =</span> <span class="cn">TRUE</span>) </span>
<span id="cb5-153"><a href="#cb5-153" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-154"><a href="#cb5-154" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Perform Welch's t-test using the survey design object</span></span>
<span id="cb5-155"><a href="#cb5-155" aria-hidden="true" tabindex="-1"></a>  ttest_result <span class="ot">&lt;-</span> <span class="fu">svyttest</span>(response <span class="sc">~</span> <span class="fu">as.factor</span>(Survey_Year), survey_design)</span>
<span id="cb5-156"><a href="#cb5-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-157"><a href="#cb5-157" aria-hidden="true" tabindex="-1"></a>  <span class="co"># head t-test results</span></span>
<span id="cb5-158"><a href="#cb5-158" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(ttest_result)</span>
<span id="cb5-159"><a href="#cb5-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-160"><a href="#cb5-160" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check significance and interpret the results</span></span>
<span id="cb5-161"><a href="#cb5-161" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (ttest_result<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>) {</span>
<span id="cb5-162"><a href="#cb5-162" aria-hidden="true" tabindex="-1"></a>    trend <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(ttest_result<span class="sc">$</span>estimate <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Significant Increase"</span>, <span class="st">"Significant Decrease"</span>)</span>
<span id="cb5-163"><a href="#cb5-163" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb5-164"><a href="#cb5-164" aria-hidden="true" tabindex="-1"></a>    trend <span class="ot">&lt;-</span> <span class="st">"No Change"</span></span>
<span id="cb5-165"><a href="#cb5-165" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-166"><a href="#cb5-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-167"><a href="#cb5-167" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> trend))</span>
<span id="cb5-168"><a href="#cb5-168" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-169"><a href="#cb5-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-170"><a href="#cb5-170" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the short-term function to each ROI_Indicator_Code</span></span>
<span id="cb5-171"><a href="#cb5-171" aria-hidden="true" tabindex="-1"></a>short_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(raw_stwd_general)[<span class="fu">grep</span>(<span class="st">"^(QN|V).*[RP]"</span>, <span class="fu">names</span>(raw_stwd_general))], <span class="cf">function</span>(column_name) {</span>
<span id="cb5-172"><a href="#cb5-172" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_short_term_trend_ttest</span>(raw_stwd_general, column_name)</span>
<span id="cb5-173"><a href="#cb5-173" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb5-174"><a href="#cb5-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-175"><a href="#cb5-175" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(short_trend_results)</span>
<span id="cb5-176"><a href="#cb5-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-177"><a href="#cb5-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-178"><a href="#cb5-178" aria-hidden="true" tabindex="-1"></a><span class="do">################### Join Together with Trend Tables ############</span></span>
<span id="cb5-179"><a href="#cb5-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-180"><a href="#cb5-180" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine long-term and short-term results</span></span>
<span id="cb5-181"><a href="#cb5-181" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> <span class="fu">left_join</span>(long_trend_results, short_trend_results, <span class="at">by =</span> <span class="st">"ROI_Indicator_Code"</span>)</span>
<span id="cb5-182"><a href="#cb5-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-183"><a href="#cb5-183" aria-hidden="true" tabindex="-1"></a><span class="co">#head(combined_trend_results)</span></span>
<span id="cb5-184"><a href="#cb5-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-185"><a href="#cb5-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-186"><a href="#cb5-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-187"><a href="#cb5-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-188"><a href="#cb5-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-189"><a href="#cb5-189" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge Long_Term_Trend into yrbs_master_stwd_grade based on matching ROI_Indicator_Code and Trend_Category</span></span>
<span id="cb5-190"><a href="#cb5-190" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> yrbs_master_analysis_stwd_trend <span class="sc">%&gt;%</span></span>
<span id="cb5-191"><a href="#cb5-191" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(combined_trend_results <span class="sc">%&gt;%</span> <span class="fu">select</span>(ROI_Indicator_Code, Long_Term_Trend, Short_Term_Trend),</span>
<span id="cb5-192"><a href="#cb5-192" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ROI_Indicator_Code"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb5-193"><a href="#cb5-193" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(School_Type,</span>
<span id="cb5-194"><a href="#cb5-194" aria-hidden="true" tabindex="-1"></a>         Health_Topic, </span>
<span id="cb5-195"><a href="#cb5-195" aria-hidden="true" tabindex="-1"></a>         ROI_Indicator_Code, </span>
<span id="cb5-196"><a href="#cb5-196" aria-hidden="true" tabindex="-1"></a>         Indicator_Long_Description, </span>
<span id="cb5-197"><a href="#cb5-197" aria-hidden="true" tabindex="-1"></a>         Trend_Category, </span>
<span id="cb5-198"><a href="#cb5-198" aria-hidden="true" tabindex="-1"></a>         <span class="fu">everything</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb5-199"><a href="#cb5-199" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, ROI_Indicator_Code, Trend_Category)</span>
<span id="cb5-200"><a href="#cb5-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-201"><a href="#cb5-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-202"><a href="#cb5-202" aria-hidden="true" tabindex="-1"></a><span class="co"># trend_results &lt;- trend_results %&gt;%</span></span>
<span id="cb5-203"><a href="#cb5-203" aria-hidden="true" tabindex="-1"></a><span class="co">#   rename(Long_Term_Trend = Long_Term_Trend.x,</span></span>
<span id="cb5-204"><a href="#cb5-204" aria-hidden="true" tabindex="-1"></a><span class="co">#          Short_Term_Trend = Short_Term_Trend.x) %&gt;%</span></span>
<span id="cb5-205"><a href="#cb5-205" aria-hidden="true" tabindex="-1"></a><span class="co">#   select(-c(Long_Term_Trend.y,</span></span>
<span id="cb5-206"><a href="#cb5-206" aria-hidden="true" tabindex="-1"></a><span class="co">#             Short_Term_Trend.y))</span></span>
<span id="cb5-207"><a href="#cb5-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-208"><a href="#cb5-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-209"><a href="#cb5-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-210"><a href="#cb5-210" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to check for three consecutive NAs in a set of columns</span></span>
<span id="cb5-211"><a href="#cb5-211" aria-hidden="true" tabindex="-1"></a>check_consecutive_nas <span class="ot">&lt;-</span> <span class="cf">function</span>(year_values) {</span>
<span id="cb5-212"><a href="#cb5-212" aria-hidden="true" tabindex="-1"></a>  na_run_lengths <span class="ot">&lt;-</span> <span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>lengths[<span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>values]</span>
<span id="cb5-213"><a href="#cb5-213" aria-hidden="true" tabindex="-1"></a>  <span class="fu">any</span>(na_run_lengths <span class="sc">&gt;=</span> <span class="dv">3</span>)</span>
<span id="cb5-214"><a href="#cb5-214" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-215"><a href="#cb5-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-216"><a href="#cb5-216" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert all columns representing years to numeric</span></span>
<span id="cb5-217"><a href="#cb5-217" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb5-218"><a href="#cb5-218" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">d+$"</span>), as.numeric))</span>
<span id="cb5-219"><a href="#cb5-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-220"><a href="#cb5-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-221"><a href="#cb5-221" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results)</span>
<span id="cb5-222"><a href="#cb5-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-223"><a href="#cb5-223" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge and mutate Long_Term_Trend</span></span>
<span id="cb5-224"><a href="#cb5-224" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb5-225"><a href="#cb5-225" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb5-226"><a href="#cb5-226" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Long_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">check_consecutive_nas</span>(<span class="fu">c_across</span>(<span class="st">`</span><span class="at">2011</span><span class="st">`</span><span class="sc">:</span><span class="st">`</span><span class="at">2023</span><span class="st">`</span>)), </span>
<span id="cb5-227"><a href="#cb5-227" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb5-228"><a href="#cb5-228" aria-hidden="true" tabindex="-1"></a>                                  Long_Term_Trend),</span>
<span id="cb5-229"><a href="#cb5-229" aria-hidden="true" tabindex="-1"></a>         <span class="at">Short_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(<span class="st">`</span><span class="at">2019</span><span class="st">`</span>) <span class="sc">|</span> <span class="fu">is.na</span>(<span class="st">`</span><span class="at">2023</span><span class="st">`</span>), </span>
<span id="cb5-230"><a href="#cb5-230" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb5-231"><a href="#cb5-231" aria-hidden="true" tabindex="-1"></a>                                   Short_Term_Trend)) <span class="sc">%&gt;%</span></span>
<span id="cb5-232"><a href="#cb5-232" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb5-233"><a href="#cb5-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-234"><a href="#cb5-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-235"><a href="#cb5-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-236"><a href="#cb5-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-237"><a href="#cb5-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-238"><a href="#cb5-238" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-239"><a href="#cb5-239" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-240"><a href="#cb5-240" aria-hidden="true" tabindex="-1"></a>trend_results_grade_11 <span class="ot">&lt;-</span> trend_results</span>
<span id="cb5-241"><a href="#cb5-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-242"><a href="#cb5-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-243"><a href="#cb5-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-244"><a href="#cb5-244" aria-hidden="true" tabindex="-1"></a><span class="co"># View the updated dataframe</span></span>
<span id="cb5-245"><a href="#cb5-245" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results_grade_11)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="th-3" class="level4">
<h4 class="anchored" data-anchor-id="th-3">12th</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="do">######## Import Raw and Analyzed Excel Files ###############</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>yrbs_master_analysis_stwd_trend <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Grade Trend"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Trend_Category <span class="sc">==</span> <span class="st">"12th"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="st">"Suppressed"</span>, <span class="cn">NA</span>, .)))</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the raw data set to be used in trend analyis</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>raw_stwd_general <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"raw_yrbs_allyears_statewide_trad_cleaned.xlsx"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Grade <span class="sc">==</span> <span class="st">"12th"</span>,</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>         Survey_Year <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2011</span>, <span class="dv">2013</span>, <span class="dv">2015</span>, <span class="dv">2017</span>, <span class="dv">2019</span>, <span class="dv">2023</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">2</span>, <span class="dv">0</span>, <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="cn">NA</span>))))</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify ROIs with data for 4 or more survey years of data (We decided as a YRBS team that only ROI's with 4 data points/4 years total of data between the trend years being used, would be acceptable to do trend analysis on. Such that an ROI that has 2011, 2013, and 2017 data/prevalence estimate, would not have trend anlaysis performed on it)</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>roi_years <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), Survey_Year) <span class="sc">%&gt;%</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>Survey_Year, <span class="at">names_to =</span> <span class="st">"ROI_Indicator_Code"</span>, <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ROI_Indicator_Code) <span class="sc">%&gt;%</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">unique_years =</span> <span class="fu">n_distinct</span>(Survey_Year), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(unique_years <span class="sc">&gt;=</span> <span class="dv">4</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(ROI_Indicator_Code)</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the main data set to include only those ROIs, also ensuring to keep necessary demographic variables</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>filtered_raw_stwd_general <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Survey_Year, <span class="fu">all_of</span>(roi_years), Sex, Race_Group_3,Primary_Samp_Unit,Stratum,Final_Weight)</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a><span class="do">############ Long Term Trend ###############</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a><span class="co">#Trend Analysis Function</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>analyze_trend_logistic <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>  data_wtd <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Survey Design for YRBS Statewide</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_survey_design</span>(<span class="at">ids =</span> Primary_Samp_Unit,</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>                     <span class="at">strata =</span> Stratum,</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>                     <span class="at">weights =</span> Final_Weight,</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nest =</span> <span class="cn">TRUE</span>,</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>                     )</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data_wtd <span class="sc">%&gt;%</span></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Sex =</span> <span class="fu">factor</span>(Sex),</span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>           <span class="at">Race_Group_3 =</span> <span class="fu">factor</span>(Race_Group_3), </span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>           <span class="co">#Grade = factor(Grade)</span></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>           )</span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(data_filtered) <span class="sc">&lt;</span> <span class="dv">4</span> <span class="sc">||</span> <span class="fu">length</span>(<span class="fu">unique</span>(data_filtered<span class="sc">$</span>variables<span class="sc">$</span>Survey_Year)) <span class="sc">&lt;</span> <span class="dv">4</span>) {</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>  base_formula <span class="ot">&lt;-</span> <span class="fu">paste</span>(column_name, <span class="st">"~ Sex + Race_Group_3 + Survey_Year"</span>)<span class="co"># fix to test for yearly linear trend</span></span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>  models <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>    <span class="st">"linear"</span> <span class="ot">=</span> base_formula,</span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>    <span class="st">"quadratic"</span> <span class="ot">=</span> <span class="fu">paste</span>(base_formula, <span class="st">"+ I(Survey_Year^2)"</span>),</span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>    <span class="st">"cubic"</span> <span class="ot">=</span> <span class="fu">paste</span>(base_formula, <span class="st">"+ I(Survey_Year^2) + I(Survey_Year^3)"</span>)</span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a><span class="co">#browser() #debugging tool</span></span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(models, <span class="cf">function</span>(f) {</span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>    model <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({ <span class="co">#Used to see where the model is failing</span></span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>      <span class="fu">svyglm</span>(<span class="fu">as.formula</span>(f), <span class="at">design =</span> data_filtered, <span class="at">family =</span> <span class="fu">quasibinomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"Error fitting model: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(model)) {</span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="st">"Model fitting error"</span>)</span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>    coef_summary <span class="ot">=</span> <span class="fu">summary</span>(model)<span class="sc">$</span>coefficients</span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(coef_summary) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="st">"Model fitting error: No coefficients"</span>)</span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a><span class="co">#browser() # debug</span></span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a>    highest_order_term <span class="ot">&lt;-</span> <span class="fu">tail</span>(<span class="fu">rownames</span>(coef_summary), <span class="dv">1</span>)<span class="co">#  Changed to rownames() from names() - now runs</span></span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(highest_order_term) <span class="sc">&amp;&amp;</span> highest_order_term <span class="sc">%in%</span> <span class="fu">rownames</span>(coef_summary)) {</span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a>      p_value <span class="ot">=</span> coef_summary[highest_order_term, <span class="st">"Pr(&gt;|t|)"</span>]<span class="co"># statistic changed to |t| from |z|</span></span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a>      coefficient <span class="ot">=</span> <span class="fu">coef</span>(model)[highest_order_term]</span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (p_value <span class="sc">&lt;=</span> <span class="fl">0.05</span>) {</span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (coefficient <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true" tabindex="-1"></a>          <span class="fu">return</span>(<span class="st">"Significant Increase"</span>)</span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true" tabindex="-1"></a>          <span class="fu">return</span>(<span class="st">"Significant Decrease"</span>)</span>
<span id="cb6-89"><a href="#cb6-89" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb6-90"><a href="#cb6-90" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb6-91"><a href="#cb6-91" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="st">"No Change"</span>)</span>
<span id="cb6-92"><a href="#cb6-92" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb6-93"><a href="#cb6-93" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb6-94"><a href="#cb6-94" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="st">"Coefficient not available or model did not converge"</span>)</span>
<span id="cb6-95"><a href="#cb6-95" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-96"><a href="#cb6-96" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb6-97"><a href="#cb6-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-98"><a href="#cb6-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, </span>
<span id="cb6-99"><a href="#cb6-99" aria-hidden="true" tabindex="-1"></a>                    <span class="at">CUBIC_Term_Trend =</span> results<span class="sc">$</span>cubic,</span>
<span id="cb6-100"><a href="#cb6-100" aria-hidden="true" tabindex="-1"></a>                    <span class="at">QUAD_Term_Trend =</span> results<span class="sc">$</span>quadratic,</span>
<span id="cb6-101"><a href="#cb6-101" aria-hidden="true" tabindex="-1"></a>                    <span class="at">LIN_Term_Trend=</span>results<span class="sc">$</span>linear))</span>
<span id="cb6-102"><a href="#cb6-102" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-103"><a href="#cb6-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-104"><a href="#cb6-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-105"><a href="#cb6-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-106"><a href="#cb6-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-107"><a href="#cb6-107" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply function to each ROI_Indicator_Code that has sufficient data</span></span>
<span id="cb6-108"><a href="#cb6-108" aria-hidden="true" tabindex="-1"></a>long_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(filtered_raw_stwd_general)[<span class="sc">-</span><span class="dv">1</span>], <span class="cf">function</span>(column_name) {</span>
<span id="cb6-109"><a href="#cb6-109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_trend_logistic</span>(filtered_raw_stwd_general, column_name)</span>
<span id="cb6-110"><a href="#cb6-110" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb6-111"><a href="#cb6-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-112"><a href="#cb6-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-113"><a href="#cb6-113" aria-hidden="true" tabindex="-1"></a>long_trend_results <span class="ot">&lt;-</span> long_trend_results <span class="sc">%&gt;%</span></span>
<span id="cb6-114"><a href="#cb6-114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">Long_Term_Trend =</span> LIN_Term_Trend) <span class="sc">%&gt;%</span></span>
<span id="cb6-115"><a href="#cb6-115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(ROI_Indicator_Code,</span>
<span id="cb6-116"><a href="#cb6-116" aria-hidden="true" tabindex="-1"></a>         Long_Term_Trend</span>
<span id="cb6-117"><a href="#cb6-117" aria-hidden="true" tabindex="-1"></a>         )</span>
<span id="cb6-118"><a href="#cb6-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-119"><a href="#cb6-119" aria-hidden="true" tabindex="-1"></a><span class="co"># Show results</span></span>
<span id="cb6-120"><a href="#cb6-120" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(long_trend_results)</span>
<span id="cb6-121"><a href="#cb6-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-122"><a href="#cb6-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-123"><a href="#cb6-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-124"><a href="#cb6-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-125"><a href="#cb6-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-126"><a href="#cb6-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-127"><a href="#cb6-127" aria-hidden="true" tabindex="-1"></a><span class="do">######### Short Term Trend ###############</span></span>
<span id="cb6-128"><a href="#cb6-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-129"><a href="#cb6-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-130"><a href="#cb6-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-131"><a href="#cb6-131" aria-hidden="true" tabindex="-1"></a>analyze_short_term_trend_ttest <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb6-132"><a href="#cb6-132" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define the short-term years</span></span>
<span id="cb6-133"><a href="#cb6-133" aria-hidden="true" tabindex="-1"></a>  short_term_years <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2019</span>, <span class="dv">2023</span>)</span>
<span id="cb6-134"><a href="#cb6-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-135"><a href="#cb6-135" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filter for short-term years and ensure all necessary variables are selected</span></span>
<span id="cb6-136"><a href="#cb6-136" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb6-137"><a href="#cb6-137" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Survey_Year <span class="sc">%in%</span> short_term_years) <span class="sc">%&gt;%</span></span>
<span id="cb6-138"><a href="#cb6-138" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Primary_Samp_Unit, Stratum, Final_Weight, Survey_Year, <span class="fu">all_of</span>(column_name)) <span class="sc">%&gt;%</span></span>
<span id="cb6-139"><a href="#cb6-139" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">response =</span> <span class="fu">get</span>(column_name) <span class="sc">==</span> <span class="dv">1</span>)  <span class="co"># Create a binary response variable for the analysis</span></span>
<span id="cb6-140"><a href="#cb6-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-141"><a href="#cb6-141" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if data is available for both years</span></span>
<span id="cb6-142"><a href="#cb6-142" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(short_term_years <span class="sc">%in%</span> <span class="fu">unique</span>(data_filtered<span class="sc">$</span>Survey_Year[<span class="sc">!</span><span class="fu">is.na</span>(data_filtered[[column_name]])]))) {</span>
<span id="cb6-143"><a href="#cb6-143" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb6-144"><a href="#cb6-144" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-145"><a href="#cb6-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-146"><a href="#cb6-146" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Continue with data that doesn't have NA responses</span></span>
<span id="cb6-147"><a href="#cb6-147" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(response))</span>
<span id="cb6-148"><a href="#cb6-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-149"><a href="#cb6-149" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create survey design object including the response variable</span></span>
<span id="cb6-150"><a href="#cb6-150" aria-hidden="true" tabindex="-1"></a>  survey_design <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="sc">~</span>Primary_Samp_Unit,</span>
<span id="cb6-151"><a href="#cb6-151" aria-hidden="true" tabindex="-1"></a>                             <span class="at">strata =</span> <span class="sc">~</span>Stratum,</span>
<span id="cb6-152"><a href="#cb6-152" aria-hidden="true" tabindex="-1"></a>                             <span class="at">weights =</span> <span class="sc">~</span>Final_Weight,</span>
<span id="cb6-153"><a href="#cb6-153" aria-hidden="true" tabindex="-1"></a>                             <span class="at">data =</span> data_filtered,</span>
<span id="cb6-154"><a href="#cb6-154" aria-hidden="true" tabindex="-1"></a>                             <span class="at">nest =</span> <span class="cn">TRUE</span>) </span>
<span id="cb6-155"><a href="#cb6-155" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-156"><a href="#cb6-156" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Perform Welch's t-test using the survey design object</span></span>
<span id="cb6-157"><a href="#cb6-157" aria-hidden="true" tabindex="-1"></a>  ttest_result <span class="ot">&lt;-</span> <span class="fu">svyttest</span>(response <span class="sc">~</span> <span class="fu">as.factor</span>(Survey_Year), survey_design)</span>
<span id="cb6-158"><a href="#cb6-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-159"><a href="#cb6-159" aria-hidden="true" tabindex="-1"></a>  <span class="co"># head t-test results</span></span>
<span id="cb6-160"><a href="#cb6-160" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(ttest_result)</span>
<span id="cb6-161"><a href="#cb6-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-162"><a href="#cb6-162" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check significance and interpret the results</span></span>
<span id="cb6-163"><a href="#cb6-163" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (ttest_result<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>) {</span>
<span id="cb6-164"><a href="#cb6-164" aria-hidden="true" tabindex="-1"></a>    trend <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(ttest_result<span class="sc">$</span>estimate <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Significant Increase"</span>, <span class="st">"Significant Decrease"</span>)</span>
<span id="cb6-165"><a href="#cb6-165" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb6-166"><a href="#cb6-166" aria-hidden="true" tabindex="-1"></a>    trend <span class="ot">&lt;-</span> <span class="st">"No Change"</span></span>
<span id="cb6-167"><a href="#cb6-167" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-168"><a href="#cb6-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-169"><a href="#cb6-169" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> trend))</span>
<span id="cb6-170"><a href="#cb6-170" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-171"><a href="#cb6-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-172"><a href="#cb6-172" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the short-term function to each ROI_Indicator_Code</span></span>
<span id="cb6-173"><a href="#cb6-173" aria-hidden="true" tabindex="-1"></a>short_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(raw_stwd_general)[<span class="fu">grep</span>(<span class="st">"^(QN|V).*[RP]"</span>, <span class="fu">names</span>(raw_stwd_general))], <span class="cf">function</span>(column_name) {</span>
<span id="cb6-174"><a href="#cb6-174" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_short_term_trend_ttest</span>(raw_stwd_general, column_name)</span>
<span id="cb6-175"><a href="#cb6-175" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb6-176"><a href="#cb6-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-177"><a href="#cb6-177" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(short_trend_results)</span>
<span id="cb6-178"><a href="#cb6-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-179"><a href="#cb6-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-180"><a href="#cb6-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-181"><a href="#cb6-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-182"><a href="#cb6-182" aria-hidden="true" tabindex="-1"></a><span class="do">################### Join Together with Trend Tables ############</span></span>
<span id="cb6-183"><a href="#cb6-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-184"><a href="#cb6-184" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine long-term and short-term results</span></span>
<span id="cb6-185"><a href="#cb6-185" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> <span class="fu">left_join</span>(long_trend_results, short_trend_results, <span class="at">by =</span> <span class="st">"ROI_Indicator_Code"</span>)</span>
<span id="cb6-186"><a href="#cb6-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-187"><a href="#cb6-187" aria-hidden="true" tabindex="-1"></a><span class="co">#head(combined_trend_results)</span></span>
<span id="cb6-188"><a href="#cb6-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-189"><a href="#cb6-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-190"><a href="#cb6-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-191"><a href="#cb6-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-192"><a href="#cb6-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-193"><a href="#cb6-193" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge Long_Term_Trend into yrbs_master_stwd_grade based on matching ROI_Indicator_Code and Trend_Category</span></span>
<span id="cb6-194"><a href="#cb6-194" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> yrbs_master_analysis_stwd_trend <span class="sc">%&gt;%</span></span>
<span id="cb6-195"><a href="#cb6-195" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(combined_trend_results <span class="sc">%&gt;%</span> <span class="fu">select</span>(ROI_Indicator_Code, Long_Term_Trend, Short_Term_Trend),</span>
<span id="cb6-196"><a href="#cb6-196" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ROI_Indicator_Code"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb6-197"><a href="#cb6-197" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(School_Type,</span>
<span id="cb6-198"><a href="#cb6-198" aria-hidden="true" tabindex="-1"></a>         Health_Topic, </span>
<span id="cb6-199"><a href="#cb6-199" aria-hidden="true" tabindex="-1"></a>         ROI_Indicator_Code, </span>
<span id="cb6-200"><a href="#cb6-200" aria-hidden="true" tabindex="-1"></a>         Indicator_Long_Description, </span>
<span id="cb6-201"><a href="#cb6-201" aria-hidden="true" tabindex="-1"></a>         Trend_Category, </span>
<span id="cb6-202"><a href="#cb6-202" aria-hidden="true" tabindex="-1"></a>         <span class="fu">everything</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb6-203"><a href="#cb6-203" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, ROI_Indicator_Code, Trend_Category)</span>
<span id="cb6-204"><a href="#cb6-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-205"><a href="#cb6-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-206"><a href="#cb6-206" aria-hidden="true" tabindex="-1"></a><span class="co"># trend_results &lt;- trend_results %&gt;%</span></span>
<span id="cb6-207"><a href="#cb6-207" aria-hidden="true" tabindex="-1"></a><span class="co">#   rename(Long_Term_Trend = Long_Term_Trend.x,</span></span>
<span id="cb6-208"><a href="#cb6-208" aria-hidden="true" tabindex="-1"></a><span class="co">#          Short_Term_Trend = Short_Term_Trend.x) %&gt;%</span></span>
<span id="cb6-209"><a href="#cb6-209" aria-hidden="true" tabindex="-1"></a><span class="co">#   select(-c(Long_Term_Trend.y,</span></span>
<span id="cb6-210"><a href="#cb6-210" aria-hidden="true" tabindex="-1"></a><span class="co">#             Short_Term_Trend.y))</span></span>
<span id="cb6-211"><a href="#cb6-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-212"><a href="#cb6-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-213"><a href="#cb6-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-214"><a href="#cb6-214" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to check for three consecutive NAs in a set of columns</span></span>
<span id="cb6-215"><a href="#cb6-215" aria-hidden="true" tabindex="-1"></a>check_consecutive_nas <span class="ot">&lt;-</span> <span class="cf">function</span>(year_values) {</span>
<span id="cb6-216"><a href="#cb6-216" aria-hidden="true" tabindex="-1"></a>  na_run_lengths <span class="ot">&lt;-</span> <span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>lengths[<span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>values]</span>
<span id="cb6-217"><a href="#cb6-217" aria-hidden="true" tabindex="-1"></a>  <span class="fu">any</span>(na_run_lengths <span class="sc">&gt;=</span> <span class="dv">3</span>)</span>
<span id="cb6-218"><a href="#cb6-218" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-219"><a href="#cb6-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-220"><a href="#cb6-220" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert all columns representing years to numeric</span></span>
<span id="cb6-221"><a href="#cb6-221" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb6-222"><a href="#cb6-222" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">d+$"</span>), as.numeric))</span>
<span id="cb6-223"><a href="#cb6-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-224"><a href="#cb6-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-225"><a href="#cb6-225" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results)</span>
<span id="cb6-226"><a href="#cb6-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-227"><a href="#cb6-227" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge and mutate Long_Term_Trend</span></span>
<span id="cb6-228"><a href="#cb6-228" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb6-229"><a href="#cb6-229" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb6-230"><a href="#cb6-230" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Long_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">check_consecutive_nas</span>(<span class="fu">c_across</span>(<span class="st">`</span><span class="at">2011</span><span class="st">`</span><span class="sc">:</span><span class="st">`</span><span class="at">2023</span><span class="st">`</span>)), </span>
<span id="cb6-231"><a href="#cb6-231" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb6-232"><a href="#cb6-232" aria-hidden="true" tabindex="-1"></a>                                  Long_Term_Trend),</span>
<span id="cb6-233"><a href="#cb6-233" aria-hidden="true" tabindex="-1"></a>         <span class="at">Short_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(<span class="st">`</span><span class="at">2019</span><span class="st">`</span>) <span class="sc">|</span> <span class="fu">is.na</span>(<span class="st">`</span><span class="at">2023</span><span class="st">`</span>), </span>
<span id="cb6-234"><a href="#cb6-234" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb6-235"><a href="#cb6-235" aria-hidden="true" tabindex="-1"></a>                                   Short_Term_Trend)) <span class="sc">%&gt;%</span></span>
<span id="cb6-236"><a href="#cb6-236" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb6-237"><a href="#cb6-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-238"><a href="#cb6-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-239"><a href="#cb6-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-240"><a href="#cb6-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-241"><a href="#cb6-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-242"><a href="#cb6-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-243"><a href="#cb6-243" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-244"><a href="#cb6-244" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-245"><a href="#cb6-245" aria-hidden="true" tabindex="-1"></a>trend_results_grade_12 <span class="ot">&lt;-</span> trend_results</span>
<span id="cb6-246"><a href="#cb6-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-247"><a href="#cb6-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-248"><a href="#cb6-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-249"><a href="#cb6-249" aria-hidden="true" tabindex="-1"></a><span class="co"># View the updated dataframe</span></span>
<span id="cb6-250"><a href="#cb6-250" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results_grade_12)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="trend-by-sex" class="level3">
<h3 class="anchored" data-anchor-id="trend-by-sex">Trend by Sex</h3>
<section id="female" class="level4">
<h4 class="anchored" data-anchor-id="female">Female</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="do">######## Import Raw and Analyzed Excel Files ###############</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>yrbs_master_analysis_stwd_trend <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Sex Trend"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Trend_Category <span class="sc">==</span> <span class="st">"Female"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="st">"Suppressed"</span>, <span class="cn">NA</span>, .)))</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the raw data set to be used in trend analyis</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>raw_stwd_general <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"raw_yrbs_allyears_statewide_trad_cleaned.xlsx"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Sex <span class="sc">==</span> <span class="st">"Female"</span>,</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>         Survey_Year <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2011</span>, <span class="dv">2013</span>, <span class="dv">2015</span>, <span class="dv">2017</span>, <span class="dv">2019</span>, <span class="dv">2023</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">2</span>, <span class="dv">0</span>, <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="cn">NA</span>))))</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify ROIs with data for 4 or more survey years of data (We decided as a YRBS team that only ROI's with 4 data points/4 years total of data between the trend years being used, would be acceptable to do trend analysis on. Such that an ROI that has 2011, 2013, and 2017 data/prevalence estimate, would not have trend anlaysis performed on it)</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>roi_years <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), Survey_Year) <span class="sc">%&gt;%</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>Survey_Year, <span class="at">names_to =</span> <span class="st">"ROI_Indicator_Code"</span>, <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ROI_Indicator_Code) <span class="sc">%&gt;%</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">unique_years =</span> <span class="fu">n_distinct</span>(Survey_Year), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(unique_years <span class="sc">&gt;=</span> <span class="dv">4</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(ROI_Indicator_Code)</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the main data set to include only those ROIs, also ensuring to keep necessary demographic variables</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>filtered_raw_stwd_general <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Survey_Year, <span class="fu">all_of</span>(roi_years), Race_Group_3, Grade,Primary_Samp_Unit,Stratum,Final_Weight)</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a><span class="do">############ Long Term Trend ###############</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a><span class="co">#Trend Analysis Function</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>analyze_trend_logistic <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>  data_wtd <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Survey Design for YRBS Statewide</span></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_survey_design</span>(<span class="at">ids =</span> Primary_Samp_Unit,</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>                     <span class="at">strata =</span> Stratum,</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>                     <span class="at">weights =</span> Final_Weight,</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nest =</span> <span class="cn">TRUE</span>,</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>                     )</span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data_wtd <span class="sc">%&gt;%</span></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>           <span class="co">#Sex = factor(Sex),</span></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>           <span class="at">Race_Group_3 =</span> <span class="fu">factor</span>(Race_Group_3), </span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>           <span class="at">Grade =</span> <span class="fu">factor</span>(Grade))</span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(data_filtered) <span class="sc">&lt;</span> <span class="dv">4</span> <span class="sc">||</span> <span class="fu">length</span>(<span class="fu">unique</span>(data_filtered<span class="sc">$</span>variables<span class="sc">$</span>Survey_Year)) <span class="sc">&lt;</span> <span class="dv">4</span>) {</span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>  base_formula <span class="ot">&lt;-</span> <span class="fu">paste</span>(column_name, <span class="st">"~Race_Group_3 + Grade + Survey_Year"</span>)<span class="co"># fix to test for yearly linear trend</span></span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>  models <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>    <span class="st">"linear"</span> <span class="ot">=</span> base_formula,</span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>    <span class="st">"quadratic"</span> <span class="ot">=</span> <span class="fu">paste</span>(base_formula, <span class="st">"+ I(Survey_Year^2)"</span>),</span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>    <span class="st">"cubic"</span> <span class="ot">=</span> <span class="fu">paste</span>(base_formula, <span class="st">"+ I(Survey_Year^2) + I(Survey_Year^3)"</span>)</span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a><span class="co">#browser() #debugging tool</span></span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(models, <span class="cf">function</span>(f) {</span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>    model <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({ <span class="co">#Used to see where the model is failing</span></span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>      <span class="fu">svyglm</span>(<span class="fu">as.formula</span>(f), <span class="at">design =</span> data_filtered, <span class="at">family =</span> <span class="fu">quasibinomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"Error fitting model: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(model)) {</span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="st">"Model fitting error"</span>)</span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>    coef_summary <span class="ot">=</span> <span class="fu">summary</span>(model)<span class="sc">$</span>coefficients</span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(coef_summary) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="st">"Model fitting error: No coefficients"</span>)</span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a><span class="co">#browser() # debug</span></span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a>    highest_order_term <span class="ot">&lt;-</span> <span class="fu">tail</span>(<span class="fu">rownames</span>(coef_summary), <span class="dv">1</span>)<span class="co">#  Changed to rownames() from names() - now runs</span></span>
<span id="cb7-80"><a href="#cb7-80" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-81"><a href="#cb7-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(highest_order_term) <span class="sc">&amp;&amp;</span> highest_order_term <span class="sc">%in%</span> <span class="fu">rownames</span>(coef_summary)) {</span>
<span id="cb7-82"><a href="#cb7-82" aria-hidden="true" tabindex="-1"></a>      p_value <span class="ot">=</span> coef_summary[highest_order_term, <span class="st">"Pr(&gt;|t|)"</span>]<span class="co"># statistic changed to |t| from |z|</span></span>
<span id="cb7-83"><a href="#cb7-83" aria-hidden="true" tabindex="-1"></a>      coefficient <span class="ot">=</span> <span class="fu">coef</span>(model)[highest_order_term]</span>
<span id="cb7-84"><a href="#cb7-84" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (p_value <span class="sc">&lt;=</span> <span class="fl">0.05</span>) {</span>
<span id="cb7-85"><a href="#cb7-85" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (coefficient <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb7-86"><a href="#cb7-86" aria-hidden="true" tabindex="-1"></a>          <span class="fu">return</span>(<span class="st">"Significant Increase"</span>)</span>
<span id="cb7-87"><a href="#cb7-87" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb7-88"><a href="#cb7-88" aria-hidden="true" tabindex="-1"></a>          <span class="fu">return</span>(<span class="st">"Significant Decrease"</span>)</span>
<span id="cb7-89"><a href="#cb7-89" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb7-90"><a href="#cb7-90" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb7-91"><a href="#cb7-91" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="st">"No Change"</span>)</span>
<span id="cb7-92"><a href="#cb7-92" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb7-93"><a href="#cb7-93" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb7-94"><a href="#cb7-94" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="st">"Coefficient not available or model did not converge"</span>)</span>
<span id="cb7-95"><a href="#cb7-95" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-96"><a href="#cb7-96" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb7-97"><a href="#cb7-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-98"><a href="#cb7-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, </span>
<span id="cb7-99"><a href="#cb7-99" aria-hidden="true" tabindex="-1"></a>                    <span class="at">CUBIC_Term_Trend =</span> results<span class="sc">$</span>cubic,</span>
<span id="cb7-100"><a href="#cb7-100" aria-hidden="true" tabindex="-1"></a>                    <span class="at">QUAD_Term_Trend =</span> results<span class="sc">$</span>quadratic,</span>
<span id="cb7-101"><a href="#cb7-101" aria-hidden="true" tabindex="-1"></a>                    <span class="at">LIN_Term_Trend=</span>results<span class="sc">$</span>linear))</span>
<span id="cb7-102"><a href="#cb7-102" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-103"><a href="#cb7-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-104"><a href="#cb7-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-105"><a href="#cb7-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-106"><a href="#cb7-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-107"><a href="#cb7-107" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply function to each ROI_Indicator_Code that has sufficient data</span></span>
<span id="cb7-108"><a href="#cb7-108" aria-hidden="true" tabindex="-1"></a>long_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(filtered_raw_stwd_general)[<span class="sc">-</span><span class="dv">1</span>], <span class="cf">function</span>(column_name) {</span>
<span id="cb7-109"><a href="#cb7-109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_trend_logistic</span>(filtered_raw_stwd_general, column_name)</span>
<span id="cb7-110"><a href="#cb7-110" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb7-111"><a href="#cb7-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-112"><a href="#cb7-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-113"><a href="#cb7-113" aria-hidden="true" tabindex="-1"></a>long_trend_results <span class="ot">&lt;-</span> long_trend_results <span class="sc">%&gt;%</span></span>
<span id="cb7-114"><a href="#cb7-114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">Long_Term_Trend =</span> LIN_Term_Trend) <span class="sc">%&gt;%</span></span>
<span id="cb7-115"><a href="#cb7-115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(ROI_Indicator_Code,</span>
<span id="cb7-116"><a href="#cb7-116" aria-hidden="true" tabindex="-1"></a>         Long_Term_Trend</span>
<span id="cb7-117"><a href="#cb7-117" aria-hidden="true" tabindex="-1"></a>         )</span>
<span id="cb7-118"><a href="#cb7-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-119"><a href="#cb7-119" aria-hidden="true" tabindex="-1"></a><span class="co"># Show results</span></span>
<span id="cb7-120"><a href="#cb7-120" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(long_trend_results)</span>
<span id="cb7-121"><a href="#cb7-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-122"><a href="#cb7-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-123"><a href="#cb7-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-124"><a href="#cb7-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-125"><a href="#cb7-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-126"><a href="#cb7-126" aria-hidden="true" tabindex="-1"></a><span class="do">######### Short Term Trend ###############</span></span>
<span id="cb7-127"><a href="#cb7-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-128"><a href="#cb7-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-129"><a href="#cb7-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-130"><a href="#cb7-130" aria-hidden="true" tabindex="-1"></a>analyze_short_term_trend_ttest <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb7-131"><a href="#cb7-131" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define the short-term years</span></span>
<span id="cb7-132"><a href="#cb7-132" aria-hidden="true" tabindex="-1"></a>  short_term_years <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2019</span>, <span class="dv">2023</span>)</span>
<span id="cb7-133"><a href="#cb7-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-134"><a href="#cb7-134" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filter for short-term years and ensure all necessary variables are selected</span></span>
<span id="cb7-135"><a href="#cb7-135" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb7-136"><a href="#cb7-136" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Survey_Year <span class="sc">%in%</span> short_term_years) <span class="sc">%&gt;%</span></span>
<span id="cb7-137"><a href="#cb7-137" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Primary_Samp_Unit, Stratum, Final_Weight, Survey_Year, <span class="fu">all_of</span>(column_name)) <span class="sc">%&gt;%</span></span>
<span id="cb7-138"><a href="#cb7-138" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">response =</span> <span class="fu">get</span>(column_name) <span class="sc">==</span> <span class="dv">1</span>)  <span class="co"># Create a binary response variable for the analysis</span></span>
<span id="cb7-139"><a href="#cb7-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-140"><a href="#cb7-140" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if data is available for both years</span></span>
<span id="cb7-141"><a href="#cb7-141" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(short_term_years <span class="sc">%in%</span> <span class="fu">unique</span>(data_filtered<span class="sc">$</span>Survey_Year[<span class="sc">!</span><span class="fu">is.na</span>(data_filtered[[column_name]])]))) {</span>
<span id="cb7-142"><a href="#cb7-142" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb7-143"><a href="#cb7-143" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-144"><a href="#cb7-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-145"><a href="#cb7-145" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Continue with data that doesn't have NA responses</span></span>
<span id="cb7-146"><a href="#cb7-146" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(response))</span>
<span id="cb7-147"><a href="#cb7-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-148"><a href="#cb7-148" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create survey design object including the response variable</span></span>
<span id="cb7-149"><a href="#cb7-149" aria-hidden="true" tabindex="-1"></a>  survey_design <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="sc">~</span>Primary_Samp_Unit,</span>
<span id="cb7-150"><a href="#cb7-150" aria-hidden="true" tabindex="-1"></a>                             <span class="at">strata =</span> <span class="sc">~</span>Stratum,</span>
<span id="cb7-151"><a href="#cb7-151" aria-hidden="true" tabindex="-1"></a>                             <span class="at">weights =</span> <span class="sc">~</span>Final_Weight,</span>
<span id="cb7-152"><a href="#cb7-152" aria-hidden="true" tabindex="-1"></a>                             <span class="at">data =</span> data_filtered,</span>
<span id="cb7-153"><a href="#cb7-153" aria-hidden="true" tabindex="-1"></a>                             <span class="at">nest =</span> <span class="cn">TRUE</span>) </span>
<span id="cb7-154"><a href="#cb7-154" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-155"><a href="#cb7-155" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Perform Welch's t-test using the survey design object</span></span>
<span id="cb7-156"><a href="#cb7-156" aria-hidden="true" tabindex="-1"></a>  ttest_result <span class="ot">&lt;-</span> <span class="fu">svyttest</span>(response <span class="sc">~</span> <span class="fu">as.factor</span>(Survey_Year), survey_design)</span>
<span id="cb7-157"><a href="#cb7-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-158"><a href="#cb7-158" aria-hidden="true" tabindex="-1"></a>  <span class="co"># head t-test results</span></span>
<span id="cb7-159"><a href="#cb7-159" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(ttest_result)</span>
<span id="cb7-160"><a href="#cb7-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-161"><a href="#cb7-161" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check significance and interpret the results</span></span>
<span id="cb7-162"><a href="#cb7-162" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (ttest_result<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>) {</span>
<span id="cb7-163"><a href="#cb7-163" aria-hidden="true" tabindex="-1"></a>    trend <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(ttest_result<span class="sc">$</span>estimate <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Significant Increase"</span>, <span class="st">"Significant Decrease"</span>)</span>
<span id="cb7-164"><a href="#cb7-164" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb7-165"><a href="#cb7-165" aria-hidden="true" tabindex="-1"></a>    trend <span class="ot">&lt;-</span> <span class="st">"No Change"</span></span>
<span id="cb7-166"><a href="#cb7-166" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-167"><a href="#cb7-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-168"><a href="#cb7-168" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> trend))</span>
<span id="cb7-169"><a href="#cb7-169" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-170"><a href="#cb7-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-171"><a href="#cb7-171" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the short-term function to each ROI_Indicator_Code</span></span>
<span id="cb7-172"><a href="#cb7-172" aria-hidden="true" tabindex="-1"></a>short_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(raw_stwd_general)[<span class="fu">grep</span>(<span class="st">"^(QN|V).*[RP]"</span>, <span class="fu">names</span>(raw_stwd_general))], <span class="cf">function</span>(column_name) {</span>
<span id="cb7-173"><a href="#cb7-173" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_short_term_trend_ttest</span>(raw_stwd_general, column_name)</span>
<span id="cb7-174"><a href="#cb7-174" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb7-175"><a href="#cb7-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-176"><a href="#cb7-176" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(short_trend_results)</span>
<span id="cb7-177"><a href="#cb7-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-178"><a href="#cb7-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-179"><a href="#cb7-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-180"><a href="#cb7-180" aria-hidden="true" tabindex="-1"></a><span class="do">################### Join Together with Trend Tables ############</span></span>
<span id="cb7-181"><a href="#cb7-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-182"><a href="#cb7-182" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine long-term and short-term results</span></span>
<span id="cb7-183"><a href="#cb7-183" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> <span class="fu">left_join</span>(long_trend_results, short_trend_results, <span class="at">by =</span> <span class="st">"ROI_Indicator_Code"</span>)</span>
<span id="cb7-184"><a href="#cb7-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-185"><a href="#cb7-185" aria-hidden="true" tabindex="-1"></a><span class="co">#head(combined_trend_results)</span></span>
<span id="cb7-186"><a href="#cb7-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-187"><a href="#cb7-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-188"><a href="#cb7-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-189"><a href="#cb7-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-190"><a href="#cb7-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-191"><a href="#cb7-191" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge Long_Term_Trend into yrbs_master_stwd_grade based on matching ROI_Indicator_Code and Trend_Category</span></span>
<span id="cb7-192"><a href="#cb7-192" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> yrbs_master_analysis_stwd_trend <span class="sc">%&gt;%</span></span>
<span id="cb7-193"><a href="#cb7-193" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(combined_trend_results <span class="sc">%&gt;%</span> <span class="fu">select</span>(ROI_Indicator_Code, Long_Term_Trend, Short_Term_Trend),</span>
<span id="cb7-194"><a href="#cb7-194" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ROI_Indicator_Code"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb7-195"><a href="#cb7-195" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(School_Type,</span>
<span id="cb7-196"><a href="#cb7-196" aria-hidden="true" tabindex="-1"></a>         Health_Topic, </span>
<span id="cb7-197"><a href="#cb7-197" aria-hidden="true" tabindex="-1"></a>         ROI_Indicator_Code, </span>
<span id="cb7-198"><a href="#cb7-198" aria-hidden="true" tabindex="-1"></a>         Indicator_Long_Description, </span>
<span id="cb7-199"><a href="#cb7-199" aria-hidden="true" tabindex="-1"></a>         Trend_Category, </span>
<span id="cb7-200"><a href="#cb7-200" aria-hidden="true" tabindex="-1"></a>         <span class="fu">everything</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb7-201"><a href="#cb7-201" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, ROI_Indicator_Code, Trend_Category)</span>
<span id="cb7-202"><a href="#cb7-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-203"><a href="#cb7-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-204"><a href="#cb7-204" aria-hidden="true" tabindex="-1"></a><span class="co"># trend_results &lt;- trend_results %&gt;%</span></span>
<span id="cb7-205"><a href="#cb7-205" aria-hidden="true" tabindex="-1"></a><span class="co">#   rename(Long_Term_Trend = Long_Term_Trend.x,</span></span>
<span id="cb7-206"><a href="#cb7-206" aria-hidden="true" tabindex="-1"></a><span class="co">#          Short_Term_Trend = Short_Term_Trend.x) %&gt;%</span></span>
<span id="cb7-207"><a href="#cb7-207" aria-hidden="true" tabindex="-1"></a><span class="co">#   select(-c(Long_Term_Trend.y,</span></span>
<span id="cb7-208"><a href="#cb7-208" aria-hidden="true" tabindex="-1"></a><span class="co">#             Short_Term_Trend.y))</span></span>
<span id="cb7-209"><a href="#cb7-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-210"><a href="#cb7-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-211"><a href="#cb7-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-212"><a href="#cb7-212" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to check for three consecutive NAs in a set of columns</span></span>
<span id="cb7-213"><a href="#cb7-213" aria-hidden="true" tabindex="-1"></a>check_consecutive_nas <span class="ot">&lt;-</span> <span class="cf">function</span>(year_values) {</span>
<span id="cb7-214"><a href="#cb7-214" aria-hidden="true" tabindex="-1"></a>  na_run_lengths <span class="ot">&lt;-</span> <span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>lengths[<span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>values]</span>
<span id="cb7-215"><a href="#cb7-215" aria-hidden="true" tabindex="-1"></a>  <span class="fu">any</span>(na_run_lengths <span class="sc">&gt;=</span> <span class="dv">3</span>)</span>
<span id="cb7-216"><a href="#cb7-216" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-217"><a href="#cb7-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-218"><a href="#cb7-218" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert all columns representing years to numeric</span></span>
<span id="cb7-219"><a href="#cb7-219" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb7-220"><a href="#cb7-220" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">d+$"</span>), as.numeric))</span>
<span id="cb7-221"><a href="#cb7-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-222"><a href="#cb7-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-223"><a href="#cb7-223" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results)</span>
<span id="cb7-224"><a href="#cb7-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-225"><a href="#cb7-225" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge and mutate Long_Term_Trend</span></span>
<span id="cb7-226"><a href="#cb7-226" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb7-227"><a href="#cb7-227" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb7-228"><a href="#cb7-228" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Long_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">check_consecutive_nas</span>(<span class="fu">c_across</span>(<span class="st">`</span><span class="at">2011</span><span class="st">`</span><span class="sc">:</span><span class="st">`</span><span class="at">2023</span><span class="st">`</span>)), </span>
<span id="cb7-229"><a href="#cb7-229" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb7-230"><a href="#cb7-230" aria-hidden="true" tabindex="-1"></a>                                  Long_Term_Trend),</span>
<span id="cb7-231"><a href="#cb7-231" aria-hidden="true" tabindex="-1"></a>         <span class="at">Short_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(<span class="st">`</span><span class="at">2019</span><span class="st">`</span>) <span class="sc">|</span> <span class="fu">is.na</span>(<span class="st">`</span><span class="at">2023</span><span class="st">`</span>), </span>
<span id="cb7-232"><a href="#cb7-232" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb7-233"><a href="#cb7-233" aria-hidden="true" tabindex="-1"></a>                                   Short_Term_Trend)) <span class="sc">%&gt;%</span></span>
<span id="cb7-234"><a href="#cb7-234" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb7-235"><a href="#cb7-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-236"><a href="#cb7-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-237"><a href="#cb7-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-238"><a href="#cb7-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-239"><a href="#cb7-239" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-240"><a href="#cb7-240" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-241"><a href="#cb7-241" aria-hidden="true" tabindex="-1"></a>trend_results_sex_female <span class="ot">&lt;-</span> trend_results</span>
<span id="cb7-242"><a href="#cb7-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-243"><a href="#cb7-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-244"><a href="#cb7-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-245"><a href="#cb7-245" aria-hidden="true" tabindex="-1"></a><span class="co"># View the updated dataframe</span></span>
<span id="cb7-246"><a href="#cb7-246" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results_sex_female)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="male" class="level4">
<h4 class="anchored" data-anchor-id="male">Male</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="do">######## Import Raw and Analyzed Excel Files ###############</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>yrbs_master_analysis_stwd_trend <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Sex Trend"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Trend_Category <span class="sc">==</span> <span class="st">"Male"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="st">"Suppressed"</span>, <span class="cn">NA</span>, .)))</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the raw data set to be used in trend analyis</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>raw_stwd_general <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"raw_yrbs_allyears_statewide_trad_cleaned.xlsx"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Sex <span class="sc">==</span> <span class="st">"Male"</span>,</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>         Survey_Year <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2011</span>, <span class="dv">2013</span>, <span class="dv">2015</span>, <span class="dv">2017</span>, <span class="dv">2019</span>, <span class="dv">2023</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">2</span>, <span class="dv">0</span>, <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="cn">NA</span>))))</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify ROIs with data for 4 or more survey years of data (We decided as a YRBS team that only ROI's with 4 data points/4 years total of data between the trend years being used, would be acceptable to do trend analysis on. Such that an ROI that has 2011, 2013, and 2017 data/prevalence estimate, would not have trend anlaysis performed on it)</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>roi_years <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), Survey_Year) <span class="sc">%&gt;%</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>Survey_Year, <span class="at">names_to =</span> <span class="st">"ROI_Indicator_Code"</span>, <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ROI_Indicator_Code) <span class="sc">%&gt;%</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">unique_years =</span> <span class="fu">n_distinct</span>(Survey_Year), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(unique_years <span class="sc">&gt;=</span> <span class="dv">4</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(ROI_Indicator_Code)</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the main data set to include only those ROIs, also ensuring to keep necessary demographic variables</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>filtered_raw_stwd_general <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Survey_Year, <span class="fu">all_of</span>(roi_years), Race_Group_3, Grade,Primary_Samp_Unit,Stratum,Final_Weight)</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a><span class="do">############ Long Term Trend ###############</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a><span class="co">#Trend Analysis Function</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>analyze_trend_logistic <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>  data_wtd <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Survey Design for YRBS Statewide</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_survey_design</span>(<span class="at">ids =</span> Primary_Samp_Unit,</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>                     <span class="at">strata =</span> Stratum,</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>                     <span class="at">weights =</span> Final_Weight,</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nest =</span> <span class="cn">TRUE</span>,</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>                     )</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data_wtd <span class="sc">%&gt;%</span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Race_Group_3 =</span> <span class="fu">factor</span>(Race_Group_3), <span class="at">Grade =</span> <span class="fu">factor</span>(Grade))</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(data_filtered) <span class="sc">&lt;</span> <span class="dv">4</span> <span class="sc">||</span> <span class="fu">length</span>(<span class="fu">unique</span>(data_filtered<span class="sc">$</span>variables<span class="sc">$</span>Survey_Year)) <span class="sc">&lt;</span> <span class="dv">4</span>) {</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>  base_formula <span class="ot">&lt;-</span> <span class="fu">paste</span>(column_name, <span class="st">"~Race_Group_3 + Grade + Survey_Year"</span>)<span class="co"># fix to test for yearly linear trend</span></span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>  models <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>    <span class="st">"linear"</span> <span class="ot">=</span> base_formula,</span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>    <span class="st">"quadratic"</span> <span class="ot">=</span> <span class="fu">paste</span>(base_formula, <span class="st">"+ I(Survey_Year^2)"</span>),</span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>    <span class="st">"cubic"</span> <span class="ot">=</span> <span class="fu">paste</span>(base_formula, <span class="st">"+ I(Survey_Year^2) + I(Survey_Year^3)"</span>)</span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a><span class="co">#browser() #debugging tool</span></span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(models, <span class="cf">function</span>(f) {</span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a>    model <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({ <span class="co">#Used to see where the model is failing</span></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>      <span class="fu">svyglm</span>(<span class="fu">as.formula</span>(f), <span class="at">design =</span> data_filtered, <span class="at">family =</span> <span class="fu">quasibinomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"Error fitting model: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(model)) {</span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="st">"Model fitting error"</span>)</span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>    coef_summary <span class="ot">=</span> <span class="fu">summary</span>(model)<span class="sc">$</span>coefficients</span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(coef_summary) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="st">"Model fitting error: No coefficients"</span>)</span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a><span class="co">#browser() # debug</span></span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a>    highest_order_term <span class="ot">&lt;-</span> <span class="fu">tail</span>(<span class="fu">rownames</span>(coef_summary), <span class="dv">1</span>)<span class="co">#  Changed to rownames() from names() - now runs</span></span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(highest_order_term) <span class="sc">&amp;&amp;</span> highest_order_term <span class="sc">%in%</span> <span class="fu">rownames</span>(coef_summary)) {</span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a>      p_value <span class="ot">=</span> coef_summary[highest_order_term, <span class="st">"Pr(&gt;|t|)"</span>]<span class="co"># statistic changed to |t| from |z|</span></span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a>      coefficient <span class="ot">=</span> <span class="fu">coef</span>(model)[highest_order_term]</span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (p_value <span class="sc">&lt;=</span> <span class="fl">0.05</span>) {</span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (coefficient <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a>          <span class="fu">return</span>(<span class="st">"Significant Increase"</span>)</span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a>          <span class="fu">return</span>(<span class="st">"Significant Decrease"</span>)</span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="st">"No Change"</span>)</span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="st">"Coefficient not available or model did not converge"</span>)</span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, </span>
<span id="cb8-96"><a href="#cb8-96" aria-hidden="true" tabindex="-1"></a>                    <span class="at">CUBIC_Term_Trend =</span> results<span class="sc">$</span>cubic,</span>
<span id="cb8-97"><a href="#cb8-97" aria-hidden="true" tabindex="-1"></a>                    <span class="at">QUAD_Term_Trend =</span> results<span class="sc">$</span>quadratic,</span>
<span id="cb8-98"><a href="#cb8-98" aria-hidden="true" tabindex="-1"></a>                    <span class="at">LIN_Term_Trend=</span>results<span class="sc">$</span>linear))</span>
<span id="cb8-99"><a href="#cb8-99" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-100"><a href="#cb8-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-101"><a href="#cb8-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-102"><a href="#cb8-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-103"><a href="#cb8-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-104"><a href="#cb8-104" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply function to each ROI_Indicator_Code that has sufficient data</span></span>
<span id="cb8-105"><a href="#cb8-105" aria-hidden="true" tabindex="-1"></a>long_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(filtered_raw_stwd_general)[<span class="sc">-</span><span class="dv">1</span>], <span class="cf">function</span>(column_name) {</span>
<span id="cb8-106"><a href="#cb8-106" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_trend_logistic</span>(filtered_raw_stwd_general, column_name)</span>
<span id="cb8-107"><a href="#cb8-107" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb8-108"><a href="#cb8-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-109"><a href="#cb8-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-110"><a href="#cb8-110" aria-hidden="true" tabindex="-1"></a>long_trend_results <span class="ot">&lt;-</span> long_trend_results <span class="sc">%&gt;%</span></span>
<span id="cb8-111"><a href="#cb8-111" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">Long_Term_Trend =</span> LIN_Term_Trend) <span class="sc">%&gt;%</span></span>
<span id="cb8-112"><a href="#cb8-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(ROI_Indicator_Code,</span>
<span id="cb8-113"><a href="#cb8-113" aria-hidden="true" tabindex="-1"></a>         Long_Term_Trend</span>
<span id="cb8-114"><a href="#cb8-114" aria-hidden="true" tabindex="-1"></a>         )</span>
<span id="cb8-115"><a href="#cb8-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-116"><a href="#cb8-116" aria-hidden="true" tabindex="-1"></a><span class="co"># Show results</span></span>
<span id="cb8-117"><a href="#cb8-117" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(long_trend_results)</span>
<span id="cb8-118"><a href="#cb8-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-119"><a href="#cb8-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-120"><a href="#cb8-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-121"><a href="#cb8-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-122"><a href="#cb8-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-123"><a href="#cb8-123" aria-hidden="true" tabindex="-1"></a><span class="do">######### Short Term Trend ###############</span></span>
<span id="cb8-124"><a href="#cb8-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-125"><a href="#cb8-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-126"><a href="#cb8-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-127"><a href="#cb8-127" aria-hidden="true" tabindex="-1"></a>analyze_short_term_trend_ttest <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb8-128"><a href="#cb8-128" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define the short-term years</span></span>
<span id="cb8-129"><a href="#cb8-129" aria-hidden="true" tabindex="-1"></a>  short_term_years <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2019</span>, <span class="dv">2023</span>)</span>
<span id="cb8-130"><a href="#cb8-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-131"><a href="#cb8-131" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filter for short-term years and ensure all necessary variables are selected</span></span>
<span id="cb8-132"><a href="#cb8-132" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb8-133"><a href="#cb8-133" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Survey_Year <span class="sc">%in%</span> short_term_years) <span class="sc">%&gt;%</span></span>
<span id="cb8-134"><a href="#cb8-134" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Primary_Samp_Unit, Stratum, Final_Weight, Survey_Year, <span class="fu">all_of</span>(column_name)) <span class="sc">%&gt;%</span></span>
<span id="cb8-135"><a href="#cb8-135" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">response =</span> <span class="fu">get</span>(column_name) <span class="sc">==</span> <span class="dv">1</span>)  <span class="co"># Create a binary response variable for the analysis</span></span>
<span id="cb8-136"><a href="#cb8-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-137"><a href="#cb8-137" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if data is available for both years</span></span>
<span id="cb8-138"><a href="#cb8-138" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(short_term_years <span class="sc">%in%</span> <span class="fu">unique</span>(data_filtered<span class="sc">$</span>Survey_Year[<span class="sc">!</span><span class="fu">is.na</span>(data_filtered[[column_name]])]))) {</span>
<span id="cb8-139"><a href="#cb8-139" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb8-140"><a href="#cb8-140" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-141"><a href="#cb8-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-142"><a href="#cb8-142" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Continue with data that doesn't have NA responses</span></span>
<span id="cb8-143"><a href="#cb8-143" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(response))</span>
<span id="cb8-144"><a href="#cb8-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-145"><a href="#cb8-145" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create survey design object including the response variable</span></span>
<span id="cb8-146"><a href="#cb8-146" aria-hidden="true" tabindex="-1"></a>  survey_design <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="sc">~</span>Primary_Samp_Unit,</span>
<span id="cb8-147"><a href="#cb8-147" aria-hidden="true" tabindex="-1"></a>                             <span class="at">strata =</span> <span class="sc">~</span>Stratum,</span>
<span id="cb8-148"><a href="#cb8-148" aria-hidden="true" tabindex="-1"></a>                             <span class="at">weights =</span> <span class="sc">~</span>Final_Weight,</span>
<span id="cb8-149"><a href="#cb8-149" aria-hidden="true" tabindex="-1"></a>                             <span class="at">data =</span> data_filtered,</span>
<span id="cb8-150"><a href="#cb8-150" aria-hidden="true" tabindex="-1"></a>                             <span class="at">nest =</span> <span class="cn">TRUE</span>) </span>
<span id="cb8-151"><a href="#cb8-151" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-152"><a href="#cb8-152" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Perform Welch's t-test using the survey design object</span></span>
<span id="cb8-153"><a href="#cb8-153" aria-hidden="true" tabindex="-1"></a>  ttest_result <span class="ot">&lt;-</span> <span class="fu">svyttest</span>(response <span class="sc">~</span> <span class="fu">as.factor</span>(Survey_Year), survey_design)</span>
<span id="cb8-154"><a href="#cb8-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-155"><a href="#cb8-155" aria-hidden="true" tabindex="-1"></a>  <span class="co"># head t-test results</span></span>
<span id="cb8-156"><a href="#cb8-156" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(ttest_result)</span>
<span id="cb8-157"><a href="#cb8-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-158"><a href="#cb8-158" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check significance and interpret the results</span></span>
<span id="cb8-159"><a href="#cb8-159" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (ttest_result<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>) {</span>
<span id="cb8-160"><a href="#cb8-160" aria-hidden="true" tabindex="-1"></a>    trend <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(ttest_result<span class="sc">$</span>estimate <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Significant Increase"</span>, <span class="st">"Significant Decrease"</span>)</span>
<span id="cb8-161"><a href="#cb8-161" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb8-162"><a href="#cb8-162" aria-hidden="true" tabindex="-1"></a>    trend <span class="ot">&lt;-</span> <span class="st">"No Change"</span></span>
<span id="cb8-163"><a href="#cb8-163" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-164"><a href="#cb8-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-165"><a href="#cb8-165" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> trend))</span>
<span id="cb8-166"><a href="#cb8-166" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-167"><a href="#cb8-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-168"><a href="#cb8-168" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the short-term function to each ROI_Indicator_Code</span></span>
<span id="cb8-169"><a href="#cb8-169" aria-hidden="true" tabindex="-1"></a>short_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(raw_stwd_general)[<span class="fu">grep</span>(<span class="st">"^(QN|V).*[RP]"</span>, <span class="fu">names</span>(raw_stwd_general))], <span class="cf">function</span>(column_name) {</span>
<span id="cb8-170"><a href="#cb8-170" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_short_term_trend_ttest</span>(raw_stwd_general, column_name)</span>
<span id="cb8-171"><a href="#cb8-171" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb8-172"><a href="#cb8-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-173"><a href="#cb8-173" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(short_trend_results)</span>
<span id="cb8-174"><a href="#cb8-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-175"><a href="#cb8-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-176"><a href="#cb8-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-177"><a href="#cb8-177" aria-hidden="true" tabindex="-1"></a><span class="do">################### Join Together with Trend Tables ############</span></span>
<span id="cb8-178"><a href="#cb8-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-179"><a href="#cb8-179" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine long-term and short-term results</span></span>
<span id="cb8-180"><a href="#cb8-180" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> <span class="fu">left_join</span>(long_trend_results, short_trend_results, <span class="at">by =</span> <span class="st">"ROI_Indicator_Code"</span>)</span>
<span id="cb8-181"><a href="#cb8-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-182"><a href="#cb8-182" aria-hidden="true" tabindex="-1"></a><span class="co">#head(combined_trend_results)</span></span>
<span id="cb8-183"><a href="#cb8-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-184"><a href="#cb8-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-185"><a href="#cb8-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-186"><a href="#cb8-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-187"><a href="#cb8-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-188"><a href="#cb8-188" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge Long_Term_Trend into yrbs_master_stwd_grade based on matching ROI_Indicator_Code and Trend_Category</span></span>
<span id="cb8-189"><a href="#cb8-189" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> yrbs_master_analysis_stwd_trend <span class="sc">%&gt;%</span></span>
<span id="cb8-190"><a href="#cb8-190" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(combined_trend_results <span class="sc">%&gt;%</span> <span class="fu">select</span>(ROI_Indicator_Code, Long_Term_Trend, Short_Term_Trend),</span>
<span id="cb8-191"><a href="#cb8-191" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ROI_Indicator_Code"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb8-192"><a href="#cb8-192" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(School_Type,</span>
<span id="cb8-193"><a href="#cb8-193" aria-hidden="true" tabindex="-1"></a>         Health_Topic, </span>
<span id="cb8-194"><a href="#cb8-194" aria-hidden="true" tabindex="-1"></a>         ROI_Indicator_Code, </span>
<span id="cb8-195"><a href="#cb8-195" aria-hidden="true" tabindex="-1"></a>         Indicator_Long_Description, </span>
<span id="cb8-196"><a href="#cb8-196" aria-hidden="true" tabindex="-1"></a>         Trend_Category, </span>
<span id="cb8-197"><a href="#cb8-197" aria-hidden="true" tabindex="-1"></a>         <span class="fu">everything</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb8-198"><a href="#cb8-198" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, ROI_Indicator_Code, Trend_Category)</span>
<span id="cb8-199"><a href="#cb8-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-200"><a href="#cb8-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-201"><a href="#cb8-201" aria-hidden="true" tabindex="-1"></a><span class="co"># trend_results &lt;- trend_results %&gt;%</span></span>
<span id="cb8-202"><a href="#cb8-202" aria-hidden="true" tabindex="-1"></a><span class="co">#   rename(Long_Term_Trend = Long_Term_Trend.x,</span></span>
<span id="cb8-203"><a href="#cb8-203" aria-hidden="true" tabindex="-1"></a><span class="co">#          Short_Term_Trend = Short_Term_Trend.x) %&gt;%</span></span>
<span id="cb8-204"><a href="#cb8-204" aria-hidden="true" tabindex="-1"></a><span class="co">#   select(-c(Long_Term_Trend.y,</span></span>
<span id="cb8-205"><a href="#cb8-205" aria-hidden="true" tabindex="-1"></a><span class="co">#             Short_Term_Trend.y))</span></span>
<span id="cb8-206"><a href="#cb8-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-207"><a href="#cb8-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-208"><a href="#cb8-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-209"><a href="#cb8-209" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to check for three consecutive NAs in a set of columns</span></span>
<span id="cb8-210"><a href="#cb8-210" aria-hidden="true" tabindex="-1"></a>check_consecutive_nas <span class="ot">&lt;-</span> <span class="cf">function</span>(year_values) {</span>
<span id="cb8-211"><a href="#cb8-211" aria-hidden="true" tabindex="-1"></a>  na_run_lengths <span class="ot">&lt;-</span> <span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>lengths[<span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>values]</span>
<span id="cb8-212"><a href="#cb8-212" aria-hidden="true" tabindex="-1"></a>  <span class="fu">any</span>(na_run_lengths <span class="sc">&gt;=</span> <span class="dv">3</span>)</span>
<span id="cb8-213"><a href="#cb8-213" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-214"><a href="#cb8-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-215"><a href="#cb8-215" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert all columns representing years to numeric</span></span>
<span id="cb8-216"><a href="#cb8-216" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb8-217"><a href="#cb8-217" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">d+$"</span>), as.numeric))</span>
<span id="cb8-218"><a href="#cb8-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-219"><a href="#cb8-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-220"><a href="#cb8-220" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results)</span>
<span id="cb8-221"><a href="#cb8-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-222"><a href="#cb8-222" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge and mutate Long_Term_Trend</span></span>
<span id="cb8-223"><a href="#cb8-223" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb8-224"><a href="#cb8-224" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb8-225"><a href="#cb8-225" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Long_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">check_consecutive_nas</span>(<span class="fu">c_across</span>(<span class="st">`</span><span class="at">2011</span><span class="st">`</span><span class="sc">:</span><span class="st">`</span><span class="at">2023</span><span class="st">`</span>)), </span>
<span id="cb8-226"><a href="#cb8-226" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb8-227"><a href="#cb8-227" aria-hidden="true" tabindex="-1"></a>                                  Long_Term_Trend),</span>
<span id="cb8-228"><a href="#cb8-228" aria-hidden="true" tabindex="-1"></a>         <span class="at">Short_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(<span class="st">`</span><span class="at">2019</span><span class="st">`</span>) <span class="sc">|</span> <span class="fu">is.na</span>(<span class="st">`</span><span class="at">2023</span><span class="st">`</span>), </span>
<span id="cb8-229"><a href="#cb8-229" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb8-230"><a href="#cb8-230" aria-hidden="true" tabindex="-1"></a>                                   Short_Term_Trend)) <span class="sc">%&gt;%</span></span>
<span id="cb8-231"><a href="#cb8-231" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb8-232"><a href="#cb8-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-233"><a href="#cb8-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-234"><a href="#cb8-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-235"><a href="#cb8-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-236"><a href="#cb8-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-237"><a href="#cb8-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-238"><a href="#cb8-238" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-239"><a href="#cb8-239" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-240"><a href="#cb8-240" aria-hidden="true" tabindex="-1"></a>trend_results_sex_male <span class="ot">&lt;-</span> trend_results</span>
<span id="cb8-241"><a href="#cb8-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-242"><a href="#cb8-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-243"><a href="#cb8-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-244"><a href="#cb8-244" aria-hidden="true" tabindex="-1"></a><span class="co"># View the updated dataframe</span></span>
<span id="cb8-245"><a href="#cb8-245" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results_sex_male)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="trend-by-race_group_6" class="level3">
<h3 class="anchored" data-anchor-id="trend-by-race_group_6">Trend By Race_Group_6</h3>
<section id="alaska-nativeamerican-indian" class="level4">
<h4 class="anchored" data-anchor-id="alaska-nativeamerican-indian">6.1 - Alaska Native/American Indian</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="do">######## Import Raw and Analyzed Excel Files ###############</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Import trend data from a specific Excel sheet. Replace any occurrences of "Suppressed" with NA.</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>yrbs_master_analysis_stwd_trend <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Race_Group_6 Trend"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Trend_Category <span class="sc">==</span> <span class="st">"Alaska Native/American Indian"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="st">"Suppressed"</span>, <span class="cn">NA</span>, .)))</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a> <span class="co"># Load raw statewide survey data, filtering correctly and specific years. Recode certain survey responses for analysis as it needs 0,1 not 1,2</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>raw_stwd_general <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"raw_yrbs_allyears_statewide_trad_cleaned.xlsx"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Race_Group_6 <span class="sc">==</span> <span class="st">"Alaska Native/American Indian"</span>,</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>         Survey_Year <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2011</span>,</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2013</span>, </span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2015</span>, </span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2017</span>,</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2019</span>, </span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2023</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>                            )) <span class="sc">%&gt;%</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">2</span>, <span class="dv">0</span>, <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="cn">NA</span>))))</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine which survey questions (ROI - Response of Interest) have data across at least two distinct survey years</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>roi_years <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), Survey_Year) <span class="sc">%&gt;%</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>Survey_Year, </span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"ROI_Indicator_Code"</span>, </span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ROI_Indicator_Code) <span class="sc">%&gt;%</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">unique_years =</span> <span class="fu">n_distinct</span>(Survey_Year), </span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(unique_years <span class="sc">&gt;=</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(ROI_Indicator_Code)</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the main data set to include only those ROIs, also ensuring to keep necessary demographic variables</span></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>filtered_raw_stwd_general <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Survey_Year, <span class="fu">all_of</span>(roi_years), Sex, Grade, Primary_Samp_Unit,Stratum,Final_Weight)</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a><span class="do">############ Long Term Trend ###############</span></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a><span class="co">#Trend Analysis Function</span></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>analyze_trend_logistic <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Survey Design for YRBS Statewide</span></span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_survey_design</span>(<span class="at">ids =</span> Primary_Samp_Unit,</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>                     <span class="at">strata =</span> Stratum,</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>                     <span class="at">weights =</span> Final_Weight,</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span></span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Sex =</span> <span class="fu">factor</span>(Sex), <span class="at">Grade =</span> <span class="fu">factor</span>(Grade))</span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(data_filtered) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">length</span>(<span class="fu">unique</span>(data_filtered<span class="sc">$</span>variables<span class="sc">$</span>Survey_Year)) <span class="sc">&lt;</span> <span class="dv">4</span>) {</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>  base_formula <span class="ot">&lt;-</span> <span class="fu">paste</span>(column_name, <span class="st">"~ Sex + Grade + Survey_Year"</span>) </span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit the model using logistic regression</span></span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>    <span class="fu">svyglm</span>(<span class="fu">as.formula</span>(base_formula), <span class="at">design =</span> data_filtered, <span class="at">family =</span> <span class="fu">quasibinomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Error fitting model: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if model fitting was successful</span></span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(model)) {</span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error"</span>))</span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check for coefficients</span></span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>(<span class="st">"Survey_Year"</span> <span class="sc">%in%</span> <span class="fu">names</span>(<span class="fu">coef</span>(model)))) {</span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No valid coefficient for Survey_Year"</span>))</span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a>  coef_summary <span class="ot">=</span> <span class="fu">summary</span>(model)<span class="sc">$</span>coefficients</span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(coef_summary) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error: No coefficients"</span>))</span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Determine the significance and direction of the trend</span></span>
<span id="cb9-84"><a href="#cb9-84" aria-hidden="true" tabindex="-1"></a>  p_value <span class="ot">=</span> coef_summary[<span class="st">"Survey_Year"</span>, <span class="st">"Pr(&gt;|t|)"</span>]</span>
<span id="cb9-85"><a href="#cb9-85" aria-hidden="true" tabindex="-1"></a>  coefficient <span class="ot">=</span> <span class="fu">coef</span>(model)[<span class="st">"Survey_Year"</span>]</span>
<span id="cb9-86"><a href="#cb9-86" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-87"><a href="#cb9-87" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(p_value)) {</span>
<span id="cb9-88"><a href="#cb9-88" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"P-value is NA"</span>))</span>
<span id="cb9-89"><a href="#cb9-89" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-90"><a href="#cb9-90" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-91"><a href="#cb9-91" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (p_value <span class="sc">&lt;=</span> <span class="fl">0.05</span>) {</span>
<span id="cb9-92"><a href="#cb9-92" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (coefficient <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb9-93"><a href="#cb9-93" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Increase"</span>))</span>
<span id="cb9-94"><a href="#cb9-94" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb9-95"><a href="#cb9-95" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Decrease"</span>))</span>
<span id="cb9-96"><a href="#cb9-96" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-97"><a href="#cb9-97" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb9-98"><a href="#cb9-98" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No Change"</span>))</span>
<span id="cb9-99"><a href="#cb9-99" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-100"><a href="#cb9-100" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-101"><a href="#cb9-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-102"><a href="#cb9-102" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the function to each ROI_Indicator_Code that has sufficient data</span></span>
<span id="cb9-103"><a href="#cb9-103" aria-hidden="true" tabindex="-1"></a>long_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(filtered_raw_stwd_general)[<span class="sc">-</span><span class="dv">1</span>], <span class="cf">function</span>(column_name) {</span>
<span id="cb9-104"><a href="#cb9-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_trend_logistic</span>(filtered_raw_stwd_general, column_name)</span>
<span id="cb9-105"><a href="#cb9-105" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb9-106"><a href="#cb9-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-107"><a href="#cb9-107" aria-hidden="true" tabindex="-1"></a><span class="co"># Show results</span></span>
<span id="cb9-108"><a href="#cb9-108" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(long_trend_results)</span>
<span id="cb9-109"><a href="#cb9-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-110"><a href="#cb9-110" aria-hidden="true" tabindex="-1"></a><span class="co"># Show results</span></span>
<span id="cb9-111"><a href="#cb9-111" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(long_trend_results)</span>
<span id="cb9-112"><a href="#cb9-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-113"><a href="#cb9-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-114"><a href="#cb9-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-115"><a href="#cb9-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-116"><a href="#cb9-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-117"><a href="#cb9-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-118"><a href="#cb9-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-119"><a href="#cb9-119" aria-hidden="true" tabindex="-1"></a><span class="do">######### Short Term Trend ###############</span></span>
<span id="cb9-120"><a href="#cb9-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-121"><a href="#cb9-121" aria-hidden="true" tabindex="-1"></a>analyze_short_term_trend_ttest <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb9-122"><a href="#cb9-122" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the short-term years</span></span>
<span id="cb9-123"><a href="#cb9-123" aria-hidden="true" tabindex="-1"></a>    short_term_years <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2019</span>, <span class="dv">2023</span>)</span>
<span id="cb9-124"><a href="#cb9-124" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-125"><a href="#cb9-125" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter for short-term years and ensure all necessary variables are selected</span></span>
<span id="cb9-126"><a href="#cb9-126" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb9-127"><a href="#cb9-127" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(Survey_Year <span class="sc">%in%</span> short_term_years) <span class="sc">%&gt;%</span></span>
<span id="cb9-128"><a href="#cb9-128" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(Primary_Samp_Unit, Stratum, Final_Weight, Survey_Year, <span class="fu">all_of</span>(column_name)) <span class="sc">%&gt;%</span></span>
<span id="cb9-129"><a href="#cb9-129" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">response =</span> <span class="fu">get</span>(column_name) <span class="sc">==</span> <span class="dv">1</span>)  <span class="co"># Create a binary response variable for the analysis</span></span>
<span id="cb9-130"><a href="#cb9-130" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-131"><a href="#cb9-131" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if data is available for both years</span></span>
<span id="cb9-132"><a href="#cb9-132" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(short_term_years <span class="sc">%in%</span> <span class="fu">unique</span>(data_filtered<span class="sc">$</span>Survey_Year[<span class="sc">!</span><span class="fu">is.na</span>(data_filtered<span class="sc">$</span>response)]))) {</span>
<span id="cb9-133"><a href="#cb9-133" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb9-134"><a href="#cb9-134" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-135"><a href="#cb9-135" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-136"><a href="#cb9-136" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Continue with data that doesn't have NA responses</span></span>
<span id="cb9-137"><a href="#cb9-137" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(response))</span>
<span id="cb9-138"><a href="#cb9-138" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-139"><a href="#cb9-139" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create survey design object including the response variable</span></span>
<span id="cb9-140"><a href="#cb9-140" aria-hidden="true" tabindex="-1"></a>    survey_design <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="sc">~</span>Primary_Samp_Unit,</span>
<span id="cb9-141"><a href="#cb9-141" aria-hidden="true" tabindex="-1"></a>                               <span class="at">strata =</span> <span class="sc">~</span>Stratum,</span>
<span id="cb9-142"><a href="#cb9-142" aria-hidden="true" tabindex="-1"></a>                               <span class="at">weights =</span> <span class="sc">~</span>Final_Weight,</span>
<span id="cb9-143"><a href="#cb9-143" aria-hidden="true" tabindex="-1"></a>                               <span class="at">data =</span> data_filtered,</span>
<span id="cb9-144"><a href="#cb9-144" aria-hidden="true" tabindex="-1"></a>                               <span class="at">nest =</span> <span class="cn">TRUE</span>) </span>
<span id="cb9-145"><a href="#cb9-145" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-146"><a href="#cb9-146" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Perform Welch's t-test using the survey design object</span></span>
<span id="cb9-147"><a href="#cb9-147" aria-hidden="true" tabindex="-1"></a>    ttest_result <span class="ot">&lt;-</span> <span class="fu">svyttest</span>(response <span class="sc">~</span> <span class="fu">as.factor</span>(Survey_Year), survey_design)</span>
<span id="cb9-148"><a href="#cb9-148" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-149"><a href="#cb9-149" aria-hidden="true" tabindex="-1"></a>    <span class="co"># head t-test results</span></span>
<span id="cb9-150"><a href="#cb9-150" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(ttest_result)</span>
<span id="cb9-151"><a href="#cb9-151" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-152"><a href="#cb9-152" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check significance and interpret the results</span></span>
<span id="cb9-153"><a href="#cb9-153" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(ttest_result<span class="sc">$</span>p.value) <span class="sc">&amp;&amp;</span> ttest_result<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>) {</span>
<span id="cb9-154"><a href="#cb9-154" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(ttest_result<span class="sc">$</span>estimate <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Significant Increase"</span>, <span class="st">"Significant Decrease"</span>)</span>
<span id="cb9-155"><a href="#cb9-155" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb9-156"><a href="#cb9-156" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="st">"No Change"</span></span>
<span id="cb9-157"><a href="#cb9-157" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-158"><a href="#cb9-158" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-159"><a href="#cb9-159" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> trend))</span>
<span id="cb9-160"><a href="#cb9-160" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-161"><a href="#cb9-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-162"><a href="#cb9-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-163"><a href="#cb9-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-164"><a href="#cb9-164" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the short-term function to each ROI_Indicator_Code</span></span>
<span id="cb9-165"><a href="#cb9-165" aria-hidden="true" tabindex="-1"></a>short_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(raw_stwd_general)[<span class="fu">grep</span>(<span class="st">"^(QN|V).*[RP]"</span>, <span class="fu">names</span>(raw_stwd_general))], <span class="cf">function</span>(column_name) {</span>
<span id="cb9-166"><a href="#cb9-166" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_short_term_trend_ttest</span>(raw_stwd_general, column_name)</span>
<span id="cb9-167"><a href="#cb9-167" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb9-168"><a href="#cb9-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-169"><a href="#cb9-169" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(short_trend_results)</span>
<span id="cb9-170"><a href="#cb9-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-171"><a href="#cb9-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-172"><a href="#cb9-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-173"><a href="#cb9-173" aria-hidden="true" tabindex="-1"></a><span class="do">################### Join Together with Trend Tables ############</span></span>
<span id="cb9-174"><a href="#cb9-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-175"><a href="#cb9-175" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine long-term and short-term results</span></span>
<span id="cb9-176"><a href="#cb9-176" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> <span class="fu">left_join</span>(long_trend_results, </span>
<span id="cb9-177"><a href="#cb9-177" aria-hidden="true" tabindex="-1"></a>                                    short_trend_results, </span>
<span id="cb9-178"><a href="#cb9-178" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">by =</span> <span class="st">"ROI_Indicator_Code"</span>)</span>
<span id="cb9-179"><a href="#cb9-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-180"><a href="#cb9-180" aria-hidden="true" tabindex="-1"></a><span class="co">#head(combined_trend_results)</span></span>
<span id="cb9-181"><a href="#cb9-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-182"><a href="#cb9-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-183"><a href="#cb9-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-184"><a href="#cb9-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-185"><a href="#cb9-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-186"><a href="#cb9-186" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge Long_Term_Trend into yrbs_master_stwd_grade based on matching ROI_Indicator_Code and Trend_Category</span></span>
<span id="cb9-187"><a href="#cb9-187" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> yrbs_master_analysis_stwd_trend <span class="sc">%&gt;%</span></span>
<span id="cb9-188"><a href="#cb9-188" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(combined_trend_results <span class="sc">%&gt;%</span> <span class="fu">select</span>(ROI_Indicator_Code, Long_Term_Trend, Short_Term_Trend),</span>
<span id="cb9-189"><a href="#cb9-189" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ROI_Indicator_Code"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb9-190"><a href="#cb9-190" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(School_Type,</span>
<span id="cb9-191"><a href="#cb9-191" aria-hidden="true" tabindex="-1"></a>         Health_Topic, </span>
<span id="cb9-192"><a href="#cb9-192" aria-hidden="true" tabindex="-1"></a>         ROI_Indicator_Code, </span>
<span id="cb9-193"><a href="#cb9-193" aria-hidden="true" tabindex="-1"></a>         Indicator_Long_Description, </span>
<span id="cb9-194"><a href="#cb9-194" aria-hidden="true" tabindex="-1"></a>         Trend_Category, </span>
<span id="cb9-195"><a href="#cb9-195" aria-hidden="true" tabindex="-1"></a>         <span class="fu">everything</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb9-196"><a href="#cb9-196" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, </span>
<span id="cb9-197"><a href="#cb9-197" aria-hidden="true" tabindex="-1"></a>          ROI_Indicator_Code, </span>
<span id="cb9-198"><a href="#cb9-198" aria-hidden="true" tabindex="-1"></a>          Trend_Category)</span>
<span id="cb9-199"><a href="#cb9-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-200"><a href="#cb9-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-201"><a href="#cb9-201" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to check for three consecutive NAs in a set of columns</span></span>
<span id="cb9-202"><a href="#cb9-202" aria-hidden="true" tabindex="-1"></a>check_consecutive_nas <span class="ot">&lt;-</span> <span class="cf">function</span>(year_values) {</span>
<span id="cb9-203"><a href="#cb9-203" aria-hidden="true" tabindex="-1"></a>  na_run_lengths <span class="ot">&lt;-</span> <span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>lengths[<span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>values]</span>
<span id="cb9-204"><a href="#cb9-204" aria-hidden="true" tabindex="-1"></a>  <span class="fu">any</span>(na_run_lengths <span class="sc">&gt;=</span> <span class="dv">3</span>)</span>
<span id="cb9-205"><a href="#cb9-205" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-206"><a href="#cb9-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-207"><a href="#cb9-207" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert all columns representing years to numeric</span></span>
<span id="cb9-208"><a href="#cb9-208" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb9-209"><a href="#cb9-209" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">d+$"</span>), as.numeric))</span>
<span id="cb9-210"><a href="#cb9-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-211"><a href="#cb9-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-212"><a href="#cb9-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-213"><a href="#cb9-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-214"><a href="#cb9-214" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge and mutate Long_Term_Trend</span></span>
<span id="cb9-215"><a href="#cb9-215" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb9-216"><a href="#cb9-216" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb9-217"><a href="#cb9-217" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Long_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">check_consecutive_nas</span>(<span class="fu">c_across</span>(<span class="st">`</span><span class="at">2011</span><span class="st">`</span><span class="sc">:</span><span class="st">`</span><span class="at">2023</span><span class="st">`</span>)), </span>
<span id="cb9-218"><a href="#cb9-218" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb9-219"><a href="#cb9-219" aria-hidden="true" tabindex="-1"></a>                                  Long_Term_Trend),</span>
<span id="cb9-220"><a href="#cb9-220" aria-hidden="true" tabindex="-1"></a>         <span class="at">Short_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(<span class="st">`</span><span class="at">2019</span><span class="st">`</span>) <span class="sc">|</span> <span class="fu">is.na</span>(<span class="st">`</span><span class="at">2023</span><span class="st">`</span>), </span>
<span id="cb9-221"><a href="#cb9-221" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb9-222"><a href="#cb9-222" aria-hidden="true" tabindex="-1"></a>                                   Short_Term_Trend)) <span class="sc">%&gt;%</span></span>
<span id="cb9-223"><a href="#cb9-223" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb9-224"><a href="#cb9-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-225"><a href="#cb9-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-226"><a href="#cb9-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-227"><a href="#cb9-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-228"><a href="#cb9-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-229"><a href="#cb9-229" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results)</span>
<span id="cb9-230"><a href="#cb9-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-231"><a href="#cb9-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-232"><a href="#cb9-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-233"><a href="#cb9-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-234"><a href="#cb9-234" aria-hidden="true" tabindex="-1"></a>trend_results_race_6_ANAI <span class="ot">&lt;-</span> trend_results</span>
<span id="cb9-235"><a href="#cb9-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-236"><a href="#cb9-236" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results_race_6_ANAI)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="blackafrican-american" class="level4">
<h4 class="anchored" data-anchor-id="blackafrican-american">6.2 - Black/African American</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Please note for this demographic, the sample size was too small and is only adjusted for sex and NOT grade, as the rest are. </span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="do">######## Import Raw and Analyzed Excel Files ###############</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>yrbs_master_analysis_stwd_trend <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Race_Group_6 Trend"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Trend_Category <span class="sc">==</span> <span class="st">"Black/African American"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="st">"Suppressed"</span>, <span class="cn">NA</span>, .)))</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the raw data set to be used in trend analysis</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>raw_stwd_general <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"raw_yrbs_allyears_statewide_trad_cleaned.xlsx"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Race_Group_6 <span class="sc">==</span> <span class="st">"Black/African American"</span>,</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>         Survey_Year <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2011</span>, <span class="dv">2013</span>, <span class="dv">2015</span>, <span class="dv">2017</span>, <span class="dv">2019</span>, <span class="dv">2023</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">2</span>, <span class="dv">0</span>, <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="cn">NA</span>))))</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine which survey questions (ROI - Response of Interest) have data across at least two distinct survey years</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>roi_years <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), Survey_Year) <span class="sc">%&gt;%</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>Survey_Year, </span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"ROI_Indicator_Code"</span>, </span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ROI_Indicator_Code) <span class="sc">%&gt;%</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">unique_years =</span> <span class="fu">n_distinct</span>(Survey_Year), </span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(unique_years <span class="sc">&gt;=</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(ROI_Indicator_Code)</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the main data set to include only those ROIs, also ensuring to keep necessary demographic variables</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>filtered_raw_stwd_general <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Survey_Year, <span class="fu">all_of</span>(roi_years), Sex, Grade, Primary_Samp_Unit,Stratum,Final_Weight)</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a><span class="do">############ Long Term Trend ###############</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a><span class="co">#Trend Analysis Function</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>analyze_trend_logistic <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Survey Design for YRBS Statewide</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_survey_design</span>(<span class="at">ids =</span> Primary_Samp_Unit,</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>                     <span class="at">strata =</span> Stratum,</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>                     <span class="at">weights =</span> Final_Weight,</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span></span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Sex =</span> <span class="fu">factor</span>(Sex), <span class="at">Grade =</span> <span class="fu">factor</span>(Grade))</span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(data_filtered) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">length</span>(<span class="fu">unique</span>(data_filtered<span class="sc">$</span>variables<span class="sc">$</span>Survey_Year)) <span class="sc">&lt;</span> <span class="dv">4</span>) {</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>  base_formula <span class="ot">&lt;-</span> <span class="fu">paste</span>(column_name, <span class="st">"~ Sex + Grade + Survey_Year"</span>) </span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit the model using logistic regression</span></span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">svyglm</span>(<span class="fu">as.formula</span>(base_formula), <span class="at">design =</span> data_filtered, <span class="at">family =</span> <span class="fu">quasibinomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Error fitting model: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if model fitting was successful</span></span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(model)) {</span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error"</span>))</span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check for coefficients</span></span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>(<span class="st">"Survey_Year"</span> <span class="sc">%in%</span> <span class="fu">names</span>(<span class="fu">coef</span>(model)))) {</span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No valid coefficient for Survey_Year"</span>))</span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a>  coef_summary <span class="ot">=</span> <span class="fu">summary</span>(model)<span class="sc">$</span>coefficients</span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(coef_summary) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error: No coefficients"</span>))</span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Determine the significance and direction of the trend</span></span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a>  p_value <span class="ot">=</span> coef_summary[<span class="st">"Survey_Year"</span>, <span class="st">"Pr(&gt;|t|)"</span>]</span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a>  coefficient <span class="ot">=</span> <span class="fu">coef</span>(model)[<span class="st">"Survey_Year"</span>]</span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-81"><a href="#cb10-81" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(p_value)) {</span>
<span id="cb10-82"><a href="#cb10-82" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"P-value is NA"</span>))</span>
<span id="cb10-83"><a href="#cb10-83" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-84"><a href="#cb10-84" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-85"><a href="#cb10-85" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (p_value <span class="sc">&lt;=</span> <span class="fl">0.05</span>) {</span>
<span id="cb10-86"><a href="#cb10-86" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (coefficient <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb10-87"><a href="#cb10-87" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Increase"</span>))</span>
<span id="cb10-88"><a href="#cb10-88" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb10-89"><a href="#cb10-89" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Decrease"</span>))</span>
<span id="cb10-90"><a href="#cb10-90" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-91"><a href="#cb10-91" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb10-92"><a href="#cb10-92" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No Change"</span>))</span>
<span id="cb10-93"><a href="#cb10-93" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-94"><a href="#cb10-94" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-95"><a href="#cb10-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-96"><a href="#cb10-96" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the function to each ROI_Indicator_Code that has sufficient data</span></span>
<span id="cb10-97"><a href="#cb10-97" aria-hidden="true" tabindex="-1"></a>long_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(filtered_raw_stwd_general)[<span class="sc">-</span><span class="dv">1</span>], <span class="cf">function</span>(column_name) {</span>
<span id="cb10-98"><a href="#cb10-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_trend_logistic</span>(filtered_raw_stwd_general, column_name)</span>
<span id="cb10-99"><a href="#cb10-99" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb10-100"><a href="#cb10-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-101"><a href="#cb10-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-102"><a href="#cb10-102" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(long_trend_results)</span>
<span id="cb10-103"><a href="#cb10-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-104"><a href="#cb10-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-105"><a href="#cb10-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-106"><a href="#cb10-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-107"><a href="#cb10-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-108"><a href="#cb10-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-109"><a href="#cb10-109" aria-hidden="true" tabindex="-1"></a><span class="do">######### Short Term Trend ###############</span></span>
<span id="cb10-110"><a href="#cb10-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-111"><a href="#cb10-111" aria-hidden="true" tabindex="-1"></a>analyze_short_term_trend_ttest <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb10-112"><a href="#cb10-112" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the short-term years</span></span>
<span id="cb10-113"><a href="#cb10-113" aria-hidden="true" tabindex="-1"></a>    short_term_years <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2019</span>, <span class="dv">2023</span>)</span>
<span id="cb10-114"><a href="#cb10-114" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-115"><a href="#cb10-115" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter for short-term years and ensure all necessary variables are selected</span></span>
<span id="cb10-116"><a href="#cb10-116" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb10-117"><a href="#cb10-117" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(Survey_Year <span class="sc">%in%</span> short_term_years) <span class="sc">%&gt;%</span></span>
<span id="cb10-118"><a href="#cb10-118" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(Primary_Samp_Unit, Stratum, Final_Weight, Survey_Year, <span class="fu">all_of</span>(column_name)) <span class="sc">%&gt;%</span></span>
<span id="cb10-119"><a href="#cb10-119" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">response =</span> <span class="fu">get</span>(column_name) <span class="sc">==</span> <span class="dv">1</span>)  <span class="co"># Create a binary response variable for the analysis</span></span>
<span id="cb10-120"><a href="#cb10-120" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-121"><a href="#cb10-121" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if data is available for both years</span></span>
<span id="cb10-122"><a href="#cb10-122" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(short_term_years <span class="sc">%in%</span> <span class="fu">unique</span>(data_filtered<span class="sc">$</span>Survey_Year[<span class="sc">!</span><span class="fu">is.na</span>(data_filtered<span class="sc">$</span>response)]))) {</span>
<span id="cb10-123"><a href="#cb10-123" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb10-124"><a href="#cb10-124" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-125"><a href="#cb10-125" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-126"><a href="#cb10-126" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Continue with data that doesn't have NA responses</span></span>
<span id="cb10-127"><a href="#cb10-127" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(response))</span>
<span id="cb10-128"><a href="#cb10-128" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-129"><a href="#cb10-129" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create survey design object including the response variable</span></span>
<span id="cb10-130"><a href="#cb10-130" aria-hidden="true" tabindex="-1"></a>    survey_design <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="sc">~</span>Primary_Samp_Unit,</span>
<span id="cb10-131"><a href="#cb10-131" aria-hidden="true" tabindex="-1"></a>                               <span class="at">strata =</span> <span class="sc">~</span>Stratum,</span>
<span id="cb10-132"><a href="#cb10-132" aria-hidden="true" tabindex="-1"></a>                               <span class="at">weights =</span> <span class="sc">~</span>Final_Weight,</span>
<span id="cb10-133"><a href="#cb10-133" aria-hidden="true" tabindex="-1"></a>                               <span class="at">data =</span> data_filtered,</span>
<span id="cb10-134"><a href="#cb10-134" aria-hidden="true" tabindex="-1"></a>                               <span class="at">nest =</span> <span class="cn">TRUE</span>) </span>
<span id="cb10-135"><a href="#cb10-135" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-136"><a href="#cb10-136" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Perform Welch's t-test using the survey design object</span></span>
<span id="cb10-137"><a href="#cb10-137" aria-hidden="true" tabindex="-1"></a>    ttest_result <span class="ot">&lt;-</span> <span class="fu">svyttest</span>(response <span class="sc">~</span> <span class="fu">as.factor</span>(Survey_Year), survey_design)</span>
<span id="cb10-138"><a href="#cb10-138" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-139"><a href="#cb10-139" aria-hidden="true" tabindex="-1"></a>    <span class="co"># head t-test results</span></span>
<span id="cb10-140"><a href="#cb10-140" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(ttest_result)</span>
<span id="cb10-141"><a href="#cb10-141" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-142"><a href="#cb10-142" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check significance and interpret the results</span></span>
<span id="cb10-143"><a href="#cb10-143" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(ttest_result<span class="sc">$</span>p.value) <span class="sc">&amp;&amp;</span> ttest_result<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>) {</span>
<span id="cb10-144"><a href="#cb10-144" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(ttest_result<span class="sc">$</span>estimate <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Significant Increase"</span>, <span class="st">"Significant Decrease"</span>)</span>
<span id="cb10-145"><a href="#cb10-145" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb10-146"><a href="#cb10-146" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="st">"No Change"</span></span>
<span id="cb10-147"><a href="#cb10-147" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-148"><a href="#cb10-148" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-149"><a href="#cb10-149" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> trend))</span>
<span id="cb10-150"><a href="#cb10-150" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-151"><a href="#cb10-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-152"><a href="#cb10-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-153"><a href="#cb10-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-154"><a href="#cb10-154" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the short-term function to each ROI_Indicator_Code</span></span>
<span id="cb10-155"><a href="#cb10-155" aria-hidden="true" tabindex="-1"></a>short_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(raw_stwd_general)[<span class="fu">grep</span>(<span class="st">"^(QN|V).*[RP]"</span>, <span class="fu">names</span>(raw_stwd_general))], <span class="cf">function</span>(column_name) {</span>
<span id="cb10-156"><a href="#cb10-156" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_short_term_trend_ttest</span>(raw_stwd_general, column_name)</span>
<span id="cb10-157"><a href="#cb10-157" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb10-158"><a href="#cb10-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-159"><a href="#cb10-159" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(short_trend_results)</span>
<span id="cb10-160"><a href="#cb10-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-161"><a href="#cb10-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-162"><a href="#cb10-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-163"><a href="#cb10-163" aria-hidden="true" tabindex="-1"></a><span class="do">################### Join Together with Trend Tables ############</span></span>
<span id="cb10-164"><a href="#cb10-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-165"><a href="#cb10-165" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine long-term and short-term results</span></span>
<span id="cb10-166"><a href="#cb10-166" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> <span class="fu">left_join</span>(long_trend_results, </span>
<span id="cb10-167"><a href="#cb10-167" aria-hidden="true" tabindex="-1"></a>                                    short_trend_results, </span>
<span id="cb10-168"><a href="#cb10-168" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">by =</span> <span class="st">"ROI_Indicator_Code"</span>)</span>
<span id="cb10-169"><a href="#cb10-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-170"><a href="#cb10-170" aria-hidden="true" tabindex="-1"></a><span class="co">#head(combined_trend_results)</span></span>
<span id="cb10-171"><a href="#cb10-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-172"><a href="#cb10-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-173"><a href="#cb10-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-174"><a href="#cb10-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-175"><a href="#cb10-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-176"><a href="#cb10-176" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge Long_Term_Trend into yrbs_master_stwd_grade based on matching ROI_Indicator_Code and Trend_Category</span></span>
<span id="cb10-177"><a href="#cb10-177" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> yrbs_master_analysis_stwd_trend <span class="sc">%&gt;%</span></span>
<span id="cb10-178"><a href="#cb10-178" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(combined_trend_results <span class="sc">%&gt;%</span> <span class="fu">select</span>(ROI_Indicator_Code, Long_Term_Trend, Short_Term_Trend),</span>
<span id="cb10-179"><a href="#cb10-179" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ROI_Indicator_Code"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb10-180"><a href="#cb10-180" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(School_Type,</span>
<span id="cb10-181"><a href="#cb10-181" aria-hidden="true" tabindex="-1"></a>         Health_Topic, </span>
<span id="cb10-182"><a href="#cb10-182" aria-hidden="true" tabindex="-1"></a>         ROI_Indicator_Code, </span>
<span id="cb10-183"><a href="#cb10-183" aria-hidden="true" tabindex="-1"></a>         Indicator_Long_Description, </span>
<span id="cb10-184"><a href="#cb10-184" aria-hidden="true" tabindex="-1"></a>         Trend_Category, </span>
<span id="cb10-185"><a href="#cb10-185" aria-hidden="true" tabindex="-1"></a>         <span class="fu">everything</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb10-186"><a href="#cb10-186" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, </span>
<span id="cb10-187"><a href="#cb10-187" aria-hidden="true" tabindex="-1"></a>          ROI_Indicator_Code, </span>
<span id="cb10-188"><a href="#cb10-188" aria-hidden="true" tabindex="-1"></a>          Trend_Category)</span>
<span id="cb10-189"><a href="#cb10-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-190"><a href="#cb10-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-191"><a href="#cb10-191" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to check for three consecutive NAs in a set of columns</span></span>
<span id="cb10-192"><a href="#cb10-192" aria-hidden="true" tabindex="-1"></a>check_consecutive_nas <span class="ot">&lt;-</span> <span class="cf">function</span>(year_values) {</span>
<span id="cb10-193"><a href="#cb10-193" aria-hidden="true" tabindex="-1"></a>  na_run_lengths <span class="ot">&lt;-</span> <span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>lengths[<span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>values]</span>
<span id="cb10-194"><a href="#cb10-194" aria-hidden="true" tabindex="-1"></a>  <span class="fu">any</span>(na_run_lengths <span class="sc">&gt;=</span> <span class="dv">3</span>)</span>
<span id="cb10-195"><a href="#cb10-195" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-196"><a href="#cb10-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-197"><a href="#cb10-197" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert all columns representing years to numeric</span></span>
<span id="cb10-198"><a href="#cb10-198" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb10-199"><a href="#cb10-199" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">d+$"</span>), as.numeric))</span>
<span id="cb10-200"><a href="#cb10-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-201"><a href="#cb10-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-202"><a href="#cb10-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-203"><a href="#cb10-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-204"><a href="#cb10-204" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge and mutate Long_Term_Trend</span></span>
<span id="cb10-205"><a href="#cb10-205" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb10-206"><a href="#cb10-206" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb10-207"><a href="#cb10-207" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Long_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">check_consecutive_nas</span>(<span class="fu">c_across</span>(<span class="st">`</span><span class="at">2011</span><span class="st">`</span><span class="sc">:</span><span class="st">`</span><span class="at">2023</span><span class="st">`</span>)), </span>
<span id="cb10-208"><a href="#cb10-208" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb10-209"><a href="#cb10-209" aria-hidden="true" tabindex="-1"></a>                                  Long_Term_Trend),</span>
<span id="cb10-210"><a href="#cb10-210" aria-hidden="true" tabindex="-1"></a>         <span class="at">Short_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(<span class="st">`</span><span class="at">2019</span><span class="st">`</span>) <span class="sc">|</span> <span class="fu">is.na</span>(<span class="st">`</span><span class="at">2023</span><span class="st">`</span>), </span>
<span id="cb10-211"><a href="#cb10-211" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb10-212"><a href="#cb10-212" aria-hidden="true" tabindex="-1"></a>                                   Short_Term_Trend)) <span class="sc">%&gt;%</span></span>
<span id="cb10-213"><a href="#cb10-213" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb10-214"><a href="#cb10-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-215"><a href="#cb10-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-216"><a href="#cb10-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-217"><a href="#cb10-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-218"><a href="#cb10-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-219"><a href="#cb10-219" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results)</span>
<span id="cb10-220"><a href="#cb10-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-221"><a href="#cb10-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-222"><a href="#cb10-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-223"><a href="#cb10-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-224"><a href="#cb10-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-225"><a href="#cb10-225" aria-hidden="true" tabindex="-1"></a>trend_results_race_6_BlkAA <span class="ot">&lt;-</span> trend_results</span>
<span id="cb10-226"><a href="#cb10-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-227"><a href="#cb10-227" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results_race_6_BlkAA)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="white" class="level4">
<h4 class="anchored" data-anchor-id="white">6.3 - White</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="do">######## Import Raw and Analyzed Excel Files ###############</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>yrbs_master_analysis_stwd_trend <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Race_Group_6 Trend"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Trend_Category <span class="sc">==</span> <span class="st">"White"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="st">"Suppressed"</span>, <span class="cn">NA</span>, .)))</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a> <span class="co"># Load the raw data set to be used in trend analyis</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>raw_stwd_general <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"raw_yrbs_allyears_statewide_trad_cleaned.xlsx"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Race_Group_6 <span class="sc">==</span> <span class="st">"White"</span>,</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>         Survey_Year <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2011</span>,</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2013</span>, </span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2015</span>, </span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2017</span>,</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2019</span>, </span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2023</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>                            )) <span class="sc">%&gt;%</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">2</span>, <span class="dv">0</span>, <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="cn">NA</span>))))</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine which survey questions (ROI - Response of Interest) have data across at least two distinct survey years</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>roi_years <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), Survey_Year) <span class="sc">%&gt;%</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>Survey_Year, </span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"ROI_Indicator_Code"</span>, </span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ROI_Indicator_Code) <span class="sc">%&gt;%</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">unique_years =</span> <span class="fu">n_distinct</span>(Survey_Year), </span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(unique_years <span class="sc">&gt;=</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(ROI_Indicator_Code)</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the main data set to include only those ROIs, also ensuring to keep necessary demographic variables</span></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>filtered_raw_stwd_general <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Survey_Year, <span class="fu">all_of</span>(roi_years), Sex, Grade, Primary_Samp_Unit,Stratum,Final_Weight)</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a><span class="do">############ Long Term Trend ###############</span></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a><span class="co">#Trend Analysis Function</span></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>analyze_trend_logistic <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Survey Design for YRBS Statewide</span></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_survey_design</span>(<span class="at">ids =</span> Primary_Samp_Unit,</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>                     <span class="at">strata =</span> Stratum,</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>                     <span class="at">weights =</span> Final_Weight,</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span></span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Sex =</span> <span class="fu">factor</span>(Sex), <span class="at">Grade =</span> <span class="fu">factor</span>(Grade))</span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(data_filtered) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">length</span>(<span class="fu">unique</span>(data_filtered<span class="sc">$</span>variables<span class="sc">$</span>Survey_Year)) <span class="sc">&lt;</span> <span class="dv">4</span>) {</span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>  base_formula <span class="ot">&lt;-</span> <span class="fu">paste</span>(column_name, <span class="st">"~ Sex + Grade + Survey_Year"</span>) </span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit the model using logistic regression</span></span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a>    <span class="fu">svyglm</span>(<span class="fu">as.formula</span>(base_formula), <span class="at">design =</span> data_filtered, <span class="at">family =</span> <span class="fu">quasibinomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Error fitting model: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if model fitting was successful</span></span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(model)) {</span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error"</span>))</span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check for coefficients</span></span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>(<span class="st">"Survey_Year"</span> <span class="sc">%in%</span> <span class="fu">names</span>(<span class="fu">coef</span>(model)))) {</span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No valid coefficient for Survey_Year"</span>))</span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-79"><a href="#cb11-79" aria-hidden="true" tabindex="-1"></a>  coef_summary <span class="ot">=</span> <span class="fu">summary</span>(model)<span class="sc">$</span>coefficients</span>
<span id="cb11-80"><a href="#cb11-80" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(coef_summary) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb11-81"><a href="#cb11-81" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error: No coefficients"</span>))</span>
<span id="cb11-82"><a href="#cb11-82" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-83"><a href="#cb11-83" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-84"><a href="#cb11-84" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Determine the significance and direction of the trend</span></span>
<span id="cb11-85"><a href="#cb11-85" aria-hidden="true" tabindex="-1"></a>  p_value <span class="ot">=</span> coef_summary[<span class="st">"Survey_Year"</span>, <span class="st">"Pr(&gt;|t|)"</span>]</span>
<span id="cb11-86"><a href="#cb11-86" aria-hidden="true" tabindex="-1"></a>  coefficient <span class="ot">=</span> <span class="fu">coef</span>(model)[<span class="st">"Survey_Year"</span>]</span>
<span id="cb11-87"><a href="#cb11-87" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-88"><a href="#cb11-88" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(p_value)) {</span>
<span id="cb11-89"><a href="#cb11-89" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"P-value is NA"</span>))</span>
<span id="cb11-90"><a href="#cb11-90" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-91"><a href="#cb11-91" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-92"><a href="#cb11-92" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (p_value <span class="sc">&lt;=</span> <span class="fl">0.05</span>) {</span>
<span id="cb11-93"><a href="#cb11-93" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (coefficient <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb11-94"><a href="#cb11-94" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Increase"</span>))</span>
<span id="cb11-95"><a href="#cb11-95" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb11-96"><a href="#cb11-96" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Decrease"</span>))</span>
<span id="cb11-97"><a href="#cb11-97" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb11-98"><a href="#cb11-98" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb11-99"><a href="#cb11-99" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No Change"</span>))</span>
<span id="cb11-100"><a href="#cb11-100" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-101"><a href="#cb11-101" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-102"><a href="#cb11-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-103"><a href="#cb11-103" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the function to each ROI_Indicator_Code that has sufficient data</span></span>
<span id="cb11-104"><a href="#cb11-104" aria-hidden="true" tabindex="-1"></a>long_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(filtered_raw_stwd_general)[<span class="sc">-</span><span class="dv">1</span>], <span class="cf">function</span>(column_name) {</span>
<span id="cb11-105"><a href="#cb11-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_trend_logistic</span>(filtered_raw_stwd_general, column_name)</span>
<span id="cb11-106"><a href="#cb11-106" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb11-107"><a href="#cb11-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-108"><a href="#cb11-108" aria-hidden="true" tabindex="-1"></a><span class="co"># Show results</span></span>
<span id="cb11-109"><a href="#cb11-109" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(long_trend_results)</span>
<span id="cb11-110"><a href="#cb11-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-111"><a href="#cb11-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-112"><a href="#cb11-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-113"><a href="#cb11-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-114"><a href="#cb11-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-115"><a href="#cb11-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-116"><a href="#cb11-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-117"><a href="#cb11-117" aria-hidden="true" tabindex="-1"></a><span class="do">######### Short Term Trend ###############</span></span>
<span id="cb11-118"><a href="#cb11-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-119"><a href="#cb11-119" aria-hidden="true" tabindex="-1"></a>analyze_short_term_trend_ttest <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb11-120"><a href="#cb11-120" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the short-term years</span></span>
<span id="cb11-121"><a href="#cb11-121" aria-hidden="true" tabindex="-1"></a>    short_term_years <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2019</span>, <span class="dv">2023</span>)</span>
<span id="cb11-122"><a href="#cb11-122" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-123"><a href="#cb11-123" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter for short-term years and ensure all necessary variables are selected</span></span>
<span id="cb11-124"><a href="#cb11-124" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb11-125"><a href="#cb11-125" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(Survey_Year <span class="sc">%in%</span> short_term_years) <span class="sc">%&gt;%</span></span>
<span id="cb11-126"><a href="#cb11-126" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(Primary_Samp_Unit, Stratum, Final_Weight, Survey_Year, <span class="fu">all_of</span>(column_name)) <span class="sc">%&gt;%</span></span>
<span id="cb11-127"><a href="#cb11-127" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">response =</span> <span class="fu">get</span>(column_name) <span class="sc">==</span> <span class="dv">1</span>)  <span class="co"># Create a binary response variable for the analysis</span></span>
<span id="cb11-128"><a href="#cb11-128" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-129"><a href="#cb11-129" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if data is available for both years</span></span>
<span id="cb11-130"><a href="#cb11-130" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(short_term_years <span class="sc">%in%</span> <span class="fu">unique</span>(data_filtered<span class="sc">$</span>Survey_Year[<span class="sc">!</span><span class="fu">is.na</span>(data_filtered<span class="sc">$</span>response)]))) {</span>
<span id="cb11-131"><a href="#cb11-131" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb11-132"><a href="#cb11-132" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb11-133"><a href="#cb11-133" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-134"><a href="#cb11-134" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Continue with data that doesn't have NA responses</span></span>
<span id="cb11-135"><a href="#cb11-135" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(response))</span>
<span id="cb11-136"><a href="#cb11-136" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-137"><a href="#cb11-137" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create survey design object including the response variable</span></span>
<span id="cb11-138"><a href="#cb11-138" aria-hidden="true" tabindex="-1"></a>    survey_design <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="sc">~</span>Primary_Samp_Unit,</span>
<span id="cb11-139"><a href="#cb11-139" aria-hidden="true" tabindex="-1"></a>                               <span class="at">strata =</span> <span class="sc">~</span>Stratum,</span>
<span id="cb11-140"><a href="#cb11-140" aria-hidden="true" tabindex="-1"></a>                               <span class="at">weights =</span> <span class="sc">~</span>Final_Weight,</span>
<span id="cb11-141"><a href="#cb11-141" aria-hidden="true" tabindex="-1"></a>                               <span class="at">data =</span> data_filtered,</span>
<span id="cb11-142"><a href="#cb11-142" aria-hidden="true" tabindex="-1"></a>                               <span class="at">nest =</span> <span class="cn">TRUE</span>) </span>
<span id="cb11-143"><a href="#cb11-143" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-144"><a href="#cb11-144" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Perform Welch's t-test using the survey design object</span></span>
<span id="cb11-145"><a href="#cb11-145" aria-hidden="true" tabindex="-1"></a>    ttest_result <span class="ot">&lt;-</span> <span class="fu">svyttest</span>(response <span class="sc">~</span> <span class="fu">as.factor</span>(Survey_Year), survey_design)</span>
<span id="cb11-146"><a href="#cb11-146" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-147"><a href="#cb11-147" aria-hidden="true" tabindex="-1"></a>    <span class="co"># head t-test results</span></span>
<span id="cb11-148"><a href="#cb11-148" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(ttest_result)</span>
<span id="cb11-149"><a href="#cb11-149" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-150"><a href="#cb11-150" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check significance and interpret the results</span></span>
<span id="cb11-151"><a href="#cb11-151" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(ttest_result<span class="sc">$</span>p.value) <span class="sc">&amp;&amp;</span> ttest_result<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>) {</span>
<span id="cb11-152"><a href="#cb11-152" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(ttest_result<span class="sc">$</span>estimate <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Significant Increase"</span>, <span class="st">"Significant Decrease"</span>)</span>
<span id="cb11-153"><a href="#cb11-153" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb11-154"><a href="#cb11-154" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="st">"No Change"</span></span>
<span id="cb11-155"><a href="#cb11-155" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb11-156"><a href="#cb11-156" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-157"><a href="#cb11-157" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> trend))</span>
<span id="cb11-158"><a href="#cb11-158" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-159"><a href="#cb11-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-160"><a href="#cb11-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-161"><a href="#cb11-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-162"><a href="#cb11-162" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the short-term function to each ROI_Indicator_Code</span></span>
<span id="cb11-163"><a href="#cb11-163" aria-hidden="true" tabindex="-1"></a>short_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(raw_stwd_general)[<span class="fu">grep</span>(<span class="st">"^(QN|V).*[RP]"</span>, <span class="fu">names</span>(raw_stwd_general))], <span class="cf">function</span>(column_name) {</span>
<span id="cb11-164"><a href="#cb11-164" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_short_term_trend_ttest</span>(raw_stwd_general, column_name)</span>
<span id="cb11-165"><a href="#cb11-165" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb11-166"><a href="#cb11-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-167"><a href="#cb11-167" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(short_trend_results)</span>
<span id="cb11-168"><a href="#cb11-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-169"><a href="#cb11-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-170"><a href="#cb11-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-171"><a href="#cb11-171" aria-hidden="true" tabindex="-1"></a><span class="do">################### Join Together with Trend Tables ############</span></span>
<span id="cb11-172"><a href="#cb11-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-173"><a href="#cb11-173" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine long-term and short-term results</span></span>
<span id="cb11-174"><a href="#cb11-174" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> <span class="fu">left_join</span>(long_trend_results, </span>
<span id="cb11-175"><a href="#cb11-175" aria-hidden="true" tabindex="-1"></a>                                    short_trend_results, </span>
<span id="cb11-176"><a href="#cb11-176" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">by =</span> <span class="st">"ROI_Indicator_Code"</span>)</span>
<span id="cb11-177"><a href="#cb11-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-178"><a href="#cb11-178" aria-hidden="true" tabindex="-1"></a><span class="co">#head(combined_trend_results)</span></span>
<span id="cb11-179"><a href="#cb11-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-180"><a href="#cb11-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-181"><a href="#cb11-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-182"><a href="#cb11-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-183"><a href="#cb11-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-184"><a href="#cb11-184" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge Long_Term_Trend into yrbs_master_stwd_grade based on matching ROI_Indicator_Code and Trend_Category</span></span>
<span id="cb11-185"><a href="#cb11-185" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> yrbs_master_analysis_stwd_trend <span class="sc">%&gt;%</span></span>
<span id="cb11-186"><a href="#cb11-186" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(combined_trend_results <span class="sc">%&gt;%</span> <span class="fu">select</span>(ROI_Indicator_Code, Long_Term_Trend, Short_Term_Trend),</span>
<span id="cb11-187"><a href="#cb11-187" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ROI_Indicator_Code"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb11-188"><a href="#cb11-188" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(School_Type,</span>
<span id="cb11-189"><a href="#cb11-189" aria-hidden="true" tabindex="-1"></a>         Health_Topic, </span>
<span id="cb11-190"><a href="#cb11-190" aria-hidden="true" tabindex="-1"></a>         ROI_Indicator_Code, </span>
<span id="cb11-191"><a href="#cb11-191" aria-hidden="true" tabindex="-1"></a>         Indicator_Long_Description, </span>
<span id="cb11-192"><a href="#cb11-192" aria-hidden="true" tabindex="-1"></a>         Trend_Category, </span>
<span id="cb11-193"><a href="#cb11-193" aria-hidden="true" tabindex="-1"></a>         <span class="fu">everything</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb11-194"><a href="#cb11-194" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, </span>
<span id="cb11-195"><a href="#cb11-195" aria-hidden="true" tabindex="-1"></a>          ROI_Indicator_Code, </span>
<span id="cb11-196"><a href="#cb11-196" aria-hidden="true" tabindex="-1"></a>          Trend_Category)</span>
<span id="cb11-197"><a href="#cb11-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-198"><a href="#cb11-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-199"><a href="#cb11-199" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to check for three consecutive NAs in a set of columns</span></span>
<span id="cb11-200"><a href="#cb11-200" aria-hidden="true" tabindex="-1"></a>check_consecutive_nas <span class="ot">&lt;-</span> <span class="cf">function</span>(year_values) {</span>
<span id="cb11-201"><a href="#cb11-201" aria-hidden="true" tabindex="-1"></a>  na_run_lengths <span class="ot">&lt;-</span> <span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>lengths[<span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>values]</span>
<span id="cb11-202"><a href="#cb11-202" aria-hidden="true" tabindex="-1"></a>  <span class="fu">any</span>(na_run_lengths <span class="sc">&gt;=</span> <span class="dv">3</span>)</span>
<span id="cb11-203"><a href="#cb11-203" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-204"><a href="#cb11-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-205"><a href="#cb11-205" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert all columns representing years to numeric</span></span>
<span id="cb11-206"><a href="#cb11-206" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb11-207"><a href="#cb11-207" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">d+$"</span>), as.numeric))</span>
<span id="cb11-208"><a href="#cb11-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-209"><a href="#cb11-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-210"><a href="#cb11-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-211"><a href="#cb11-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-212"><a href="#cb11-212" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge and mutate Long_Term_Trend</span></span>
<span id="cb11-213"><a href="#cb11-213" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb11-214"><a href="#cb11-214" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb11-215"><a href="#cb11-215" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Long_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">check_consecutive_nas</span>(<span class="fu">c_across</span>(<span class="st">`</span><span class="at">2011</span><span class="st">`</span><span class="sc">:</span><span class="st">`</span><span class="at">2023</span><span class="st">`</span>)), </span>
<span id="cb11-216"><a href="#cb11-216" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb11-217"><a href="#cb11-217" aria-hidden="true" tabindex="-1"></a>                                  Long_Term_Trend),</span>
<span id="cb11-218"><a href="#cb11-218" aria-hidden="true" tabindex="-1"></a>         <span class="at">Short_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(<span class="st">`</span><span class="at">2019</span><span class="st">`</span>) <span class="sc">|</span> <span class="fu">is.na</span>(<span class="st">`</span><span class="at">2023</span><span class="st">`</span>), </span>
<span id="cb11-219"><a href="#cb11-219" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb11-220"><a href="#cb11-220" aria-hidden="true" tabindex="-1"></a>                                   Short_Term_Trend)) <span class="sc">%&gt;%</span></span>
<span id="cb11-221"><a href="#cb11-221" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb11-222"><a href="#cb11-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-223"><a href="#cb11-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-224"><a href="#cb11-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-225"><a href="#cb11-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-226"><a href="#cb11-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-227"><a href="#cb11-227" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results)</span>
<span id="cb11-228"><a href="#cb11-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-229"><a href="#cb11-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-230"><a href="#cb11-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-231"><a href="#cb11-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-232"><a href="#cb11-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-233"><a href="#cb11-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-234"><a href="#cb11-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-235"><a href="#cb11-235" aria-hidden="true" tabindex="-1"></a>trend_results_race_6_white <span class="ot">&lt;-</span> trend_results</span>
<span id="cb11-236"><a href="#cb11-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-237"><a href="#cb11-237" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results_race_6_white)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="hispaniclatino" class="level4">
<h4 class="anchored" data-anchor-id="hispaniclatino">6.4 - Hispanic/Latino</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="do">######## Import Raw and Analyzed Excel Files ###############</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>yrbs_master_analysis_stwd_trend <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Race_Group_6 Trend"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Trend_Category <span class="sc">==</span> <span class="st">"Hispanic/Latino"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="st">"Suppressed"</span>, <span class="cn">NA</span>, .)))</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a> <span class="co"># Load the raw data set to be used in trend analyis</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>raw_stwd_general <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"raw_yrbs_allyears_statewide_trad_cleaned.xlsx"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Race_Group_6 <span class="sc">==</span> <span class="st">"Hispanic/Latino"</span>,</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>         Survey_Year <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2011</span>,</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2013</span>, </span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2015</span>, </span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2017</span>,</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2019</span>, </span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2023</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>                            )) <span class="sc">%&gt;%</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">2</span>, <span class="dv">0</span>, <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="cn">NA</span>))))</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine which survey questions (ROI - Response of Interest) have data across at least two distinct survey years</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>roi_years <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), Survey_Year) <span class="sc">%&gt;%</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>Survey_Year, </span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"ROI_Indicator_Code"</span>, </span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ROI_Indicator_Code) <span class="sc">%&gt;%</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">unique_years =</span> <span class="fu">n_distinct</span>(Survey_Year), </span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(unique_years <span class="sc">&gt;=</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(ROI_Indicator_Code)</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the main data set to include only those ROIs, also ensuring to keep necessary demographic variables</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>filtered_raw_stwd_general <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Survey_Year, <span class="fu">all_of</span>(roi_years), Sex, Grade, Primary_Samp_Unit,Stratum,Final_Weight)</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a><span class="do">############ Long Term Trend ###############</span></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a><span class="co">#Trend Analysis Function</span></span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>analyze_trend_logistic <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Survey Design for YRBS Statewide</span></span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_survey_design</span>(<span class="at">ids =</span> Primary_Samp_Unit,</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>                     <span class="at">strata =</span> Stratum,</span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>                     <span class="at">weights =</span> Final_Weight,</span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span></span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Sex =</span> <span class="fu">factor</span>(Sex), <span class="at">Grade =</span> <span class="fu">factor</span>(Grade))</span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(data_filtered) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">length</span>(<span class="fu">unique</span>(data_filtered<span class="sc">$</span>variables<span class="sc">$</span>Survey_Year)) <span class="sc">&lt;</span> <span class="dv">4</span>) {</span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a>  base_formula <span class="ot">&lt;-</span> <span class="fu">paste</span>(column_name, <span class="st">"~ Sex + Grade + Survey_Year"</span>) </span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit the model using logistic regression</span></span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">svyglm</span>(<span class="fu">as.formula</span>(base_formula), <span class="at">design =</span> data_filtered, <span class="at">family =</span> <span class="fu">quasibinomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Error fitting model: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if model fitting was successful</span></span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(model)) {</span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error"</span>))</span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check for coefficients</span></span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>(<span class="st">"Survey_Year"</span> <span class="sc">%in%</span> <span class="fu">names</span>(<span class="fu">coef</span>(model)))) {</span>
<span id="cb12-78"><a href="#cb12-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No valid coefficient for Survey_Year"</span>))</span>
<span id="cb12-79"><a href="#cb12-79" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-80"><a href="#cb12-80" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-81"><a href="#cb12-81" aria-hidden="true" tabindex="-1"></a>  coef_summary <span class="ot">=</span> <span class="fu">summary</span>(model)<span class="sc">$</span>coefficients</span>
<span id="cb12-82"><a href="#cb12-82" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(coef_summary) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb12-83"><a href="#cb12-83" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error: No coefficients"</span>))</span>
<span id="cb12-84"><a href="#cb12-84" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-85"><a href="#cb12-85" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-86"><a href="#cb12-86" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Determine the significance and direction of the trend</span></span>
<span id="cb12-87"><a href="#cb12-87" aria-hidden="true" tabindex="-1"></a>  p_value <span class="ot">=</span> coef_summary[<span class="st">"Survey_Year"</span>, <span class="st">"Pr(&gt;|t|)"</span>]</span>
<span id="cb12-88"><a href="#cb12-88" aria-hidden="true" tabindex="-1"></a>  coefficient <span class="ot">=</span> <span class="fu">coef</span>(model)[<span class="st">"Survey_Year"</span>]</span>
<span id="cb12-89"><a href="#cb12-89" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-90"><a href="#cb12-90" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(p_value)) {</span>
<span id="cb12-91"><a href="#cb12-91" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"P-value is NA"</span>))</span>
<span id="cb12-92"><a href="#cb12-92" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-93"><a href="#cb12-93" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-94"><a href="#cb12-94" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (p_value <span class="sc">&lt;=</span> <span class="fl">0.05</span>) {</span>
<span id="cb12-95"><a href="#cb12-95" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (coefficient <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb12-96"><a href="#cb12-96" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Increase"</span>))</span>
<span id="cb12-97"><a href="#cb12-97" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb12-98"><a href="#cb12-98" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Decrease"</span>))</span>
<span id="cb12-99"><a href="#cb12-99" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-100"><a href="#cb12-100" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb12-101"><a href="#cb12-101" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No Change"</span>))</span>
<span id="cb12-102"><a href="#cb12-102" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-103"><a href="#cb12-103" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-104"><a href="#cb12-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-105"><a href="#cb12-105" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the function to each ROI_Indicator_Code that has sufficient data</span></span>
<span id="cb12-106"><a href="#cb12-106" aria-hidden="true" tabindex="-1"></a>long_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(filtered_raw_stwd_general)[<span class="sc">-</span><span class="dv">1</span>], <span class="cf">function</span>(column_name) {</span>
<span id="cb12-107"><a href="#cb12-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_trend_logistic</span>(filtered_raw_stwd_general, column_name)</span>
<span id="cb12-108"><a href="#cb12-108" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb12-109"><a href="#cb12-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-110"><a href="#cb12-110" aria-hidden="true" tabindex="-1"></a><span class="co"># Show results</span></span>
<span id="cb12-111"><a href="#cb12-111" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(long_trend_results)</span>
<span id="cb12-112"><a href="#cb12-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-113"><a href="#cb12-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-114"><a href="#cb12-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-115"><a href="#cb12-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-116"><a href="#cb12-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-117"><a href="#cb12-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-118"><a href="#cb12-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-119"><a href="#cb12-119" aria-hidden="true" tabindex="-1"></a><span class="do">######### Short Term Trend ###############</span></span>
<span id="cb12-120"><a href="#cb12-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-121"><a href="#cb12-121" aria-hidden="true" tabindex="-1"></a>analyze_short_term_trend_ttest <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb12-122"><a href="#cb12-122" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the short-term years</span></span>
<span id="cb12-123"><a href="#cb12-123" aria-hidden="true" tabindex="-1"></a>    short_term_years <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2019</span>, <span class="dv">2023</span>)</span>
<span id="cb12-124"><a href="#cb12-124" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-125"><a href="#cb12-125" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter for short-term years and ensure all necessary variables are selected</span></span>
<span id="cb12-126"><a href="#cb12-126" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb12-127"><a href="#cb12-127" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(Survey_Year <span class="sc">%in%</span> short_term_years) <span class="sc">%&gt;%</span></span>
<span id="cb12-128"><a href="#cb12-128" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(Primary_Samp_Unit, Stratum, Final_Weight, Survey_Year, <span class="fu">all_of</span>(column_name)) <span class="sc">%&gt;%</span></span>
<span id="cb12-129"><a href="#cb12-129" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">response =</span> <span class="fu">get</span>(column_name) <span class="sc">==</span> <span class="dv">1</span>)  <span class="co"># Create a binary response variable for the analysis</span></span>
<span id="cb12-130"><a href="#cb12-130" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-131"><a href="#cb12-131" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if data is available for both years</span></span>
<span id="cb12-132"><a href="#cb12-132" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(short_term_years <span class="sc">%in%</span> <span class="fu">unique</span>(data_filtered<span class="sc">$</span>Survey_Year[<span class="sc">!</span><span class="fu">is.na</span>(data_filtered<span class="sc">$</span>response)]))) {</span>
<span id="cb12-133"><a href="#cb12-133" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb12-134"><a href="#cb12-134" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-135"><a href="#cb12-135" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-136"><a href="#cb12-136" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Continue with data that doesn't have NA responses</span></span>
<span id="cb12-137"><a href="#cb12-137" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(response))</span>
<span id="cb12-138"><a href="#cb12-138" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-139"><a href="#cb12-139" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create survey design object including the response variable</span></span>
<span id="cb12-140"><a href="#cb12-140" aria-hidden="true" tabindex="-1"></a>    survey_design <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="sc">~</span>Primary_Samp_Unit,</span>
<span id="cb12-141"><a href="#cb12-141" aria-hidden="true" tabindex="-1"></a>                               <span class="at">strata =</span> <span class="sc">~</span>Stratum,</span>
<span id="cb12-142"><a href="#cb12-142" aria-hidden="true" tabindex="-1"></a>                               <span class="at">weights =</span> <span class="sc">~</span>Final_Weight,</span>
<span id="cb12-143"><a href="#cb12-143" aria-hidden="true" tabindex="-1"></a>                               <span class="at">data =</span> data_filtered,</span>
<span id="cb12-144"><a href="#cb12-144" aria-hidden="true" tabindex="-1"></a>                               <span class="at">nest =</span> <span class="cn">TRUE</span>) </span>
<span id="cb12-145"><a href="#cb12-145" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-146"><a href="#cb12-146" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Perform Welch's t-test using the survey design object</span></span>
<span id="cb12-147"><a href="#cb12-147" aria-hidden="true" tabindex="-1"></a>    ttest_result <span class="ot">&lt;-</span> <span class="fu">svyttest</span>(response <span class="sc">~</span> <span class="fu">as.factor</span>(Survey_Year), survey_design)</span>
<span id="cb12-148"><a href="#cb12-148" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-149"><a href="#cb12-149" aria-hidden="true" tabindex="-1"></a>    <span class="co"># head t-test results</span></span>
<span id="cb12-150"><a href="#cb12-150" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(ttest_result)</span>
<span id="cb12-151"><a href="#cb12-151" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-152"><a href="#cb12-152" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check significance and interpret the results</span></span>
<span id="cb12-153"><a href="#cb12-153" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(ttest_result<span class="sc">$</span>p.value) <span class="sc">&amp;&amp;</span> ttest_result<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>) {</span>
<span id="cb12-154"><a href="#cb12-154" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(ttest_result<span class="sc">$</span>estimate <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Significant Increase"</span>, <span class="st">"Significant Decrease"</span>)</span>
<span id="cb12-155"><a href="#cb12-155" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb12-156"><a href="#cb12-156" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="st">"No Change"</span></span>
<span id="cb12-157"><a href="#cb12-157" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-158"><a href="#cb12-158" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-159"><a href="#cb12-159" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> trend))</span>
<span id="cb12-160"><a href="#cb12-160" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-161"><a href="#cb12-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-162"><a href="#cb12-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-163"><a href="#cb12-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-164"><a href="#cb12-164" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the short-term function to each ROI_Indicator_Code</span></span>
<span id="cb12-165"><a href="#cb12-165" aria-hidden="true" tabindex="-1"></a>short_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(raw_stwd_general)[<span class="fu">grep</span>(<span class="st">"^(QN|V).*[RP]"</span>, <span class="fu">names</span>(raw_stwd_general))], <span class="cf">function</span>(column_name) {</span>
<span id="cb12-166"><a href="#cb12-166" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_short_term_trend_ttest</span>(raw_stwd_general, column_name)</span>
<span id="cb12-167"><a href="#cb12-167" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb12-168"><a href="#cb12-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-169"><a href="#cb12-169" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(short_trend_results)</span>
<span id="cb12-170"><a href="#cb12-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-171"><a href="#cb12-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-172"><a href="#cb12-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-173"><a href="#cb12-173" aria-hidden="true" tabindex="-1"></a><span class="do">################### Join Together with Trend Tables ############</span></span>
<span id="cb12-174"><a href="#cb12-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-175"><a href="#cb12-175" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine long-term and short-term results</span></span>
<span id="cb12-176"><a href="#cb12-176" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> <span class="fu">left_join</span>(long_trend_results, </span>
<span id="cb12-177"><a href="#cb12-177" aria-hidden="true" tabindex="-1"></a>                                    short_trend_results, </span>
<span id="cb12-178"><a href="#cb12-178" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">by =</span> <span class="st">"ROI_Indicator_Code"</span>)</span>
<span id="cb12-179"><a href="#cb12-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-180"><a href="#cb12-180" aria-hidden="true" tabindex="-1"></a><span class="co">#head(combined_trend_results)</span></span>
<span id="cb12-181"><a href="#cb12-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-182"><a href="#cb12-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-183"><a href="#cb12-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-184"><a href="#cb12-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-185"><a href="#cb12-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-186"><a href="#cb12-186" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge Long_Term_Trend into yrbs_master_stwd_grade based on matching ROI_Indicator_Code and Trend_Category</span></span>
<span id="cb12-187"><a href="#cb12-187" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> yrbs_master_analysis_stwd_trend <span class="sc">%&gt;%</span></span>
<span id="cb12-188"><a href="#cb12-188" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(combined_trend_results <span class="sc">%&gt;%</span> <span class="fu">select</span>(ROI_Indicator_Code, Long_Term_Trend, Short_Term_Trend),</span>
<span id="cb12-189"><a href="#cb12-189" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ROI_Indicator_Code"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb12-190"><a href="#cb12-190" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(School_Type,</span>
<span id="cb12-191"><a href="#cb12-191" aria-hidden="true" tabindex="-1"></a>         Health_Topic, </span>
<span id="cb12-192"><a href="#cb12-192" aria-hidden="true" tabindex="-1"></a>         ROI_Indicator_Code, </span>
<span id="cb12-193"><a href="#cb12-193" aria-hidden="true" tabindex="-1"></a>         Indicator_Long_Description, </span>
<span id="cb12-194"><a href="#cb12-194" aria-hidden="true" tabindex="-1"></a>         Trend_Category, </span>
<span id="cb12-195"><a href="#cb12-195" aria-hidden="true" tabindex="-1"></a>         <span class="fu">everything</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb12-196"><a href="#cb12-196" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, </span>
<span id="cb12-197"><a href="#cb12-197" aria-hidden="true" tabindex="-1"></a>          ROI_Indicator_Code, </span>
<span id="cb12-198"><a href="#cb12-198" aria-hidden="true" tabindex="-1"></a>          Trend_Category)</span>
<span id="cb12-199"><a href="#cb12-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-200"><a href="#cb12-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-201"><a href="#cb12-201" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to check for three consecutive NAs in a set of columns</span></span>
<span id="cb12-202"><a href="#cb12-202" aria-hidden="true" tabindex="-1"></a>check_consecutive_nas <span class="ot">&lt;-</span> <span class="cf">function</span>(year_values) {</span>
<span id="cb12-203"><a href="#cb12-203" aria-hidden="true" tabindex="-1"></a>  na_run_lengths <span class="ot">&lt;-</span> <span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>lengths[<span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>values]</span>
<span id="cb12-204"><a href="#cb12-204" aria-hidden="true" tabindex="-1"></a>  <span class="fu">any</span>(na_run_lengths <span class="sc">&gt;=</span> <span class="dv">3</span>)</span>
<span id="cb12-205"><a href="#cb12-205" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-206"><a href="#cb12-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-207"><a href="#cb12-207" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert all columns representing years to numeric</span></span>
<span id="cb12-208"><a href="#cb12-208" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb12-209"><a href="#cb12-209" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">d+$"</span>), as.numeric))</span>
<span id="cb12-210"><a href="#cb12-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-211"><a href="#cb12-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-212"><a href="#cb12-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-213"><a href="#cb12-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-214"><a href="#cb12-214" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge and mutate Long_Term_Trend</span></span>
<span id="cb12-215"><a href="#cb12-215" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb12-216"><a href="#cb12-216" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb12-217"><a href="#cb12-217" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Long_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">check_consecutive_nas</span>(<span class="fu">c_across</span>(<span class="st">`</span><span class="at">2011</span><span class="st">`</span><span class="sc">:</span><span class="st">`</span><span class="at">2023</span><span class="st">`</span>)), </span>
<span id="cb12-218"><a href="#cb12-218" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb12-219"><a href="#cb12-219" aria-hidden="true" tabindex="-1"></a>                                  Long_Term_Trend),</span>
<span id="cb12-220"><a href="#cb12-220" aria-hidden="true" tabindex="-1"></a>         <span class="at">Short_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(<span class="st">`</span><span class="at">2019</span><span class="st">`</span>) <span class="sc">|</span> <span class="fu">is.na</span>(<span class="st">`</span><span class="at">2023</span><span class="st">`</span>), </span>
<span id="cb12-221"><a href="#cb12-221" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb12-222"><a href="#cb12-222" aria-hidden="true" tabindex="-1"></a>                                   Short_Term_Trend)) <span class="sc">%&gt;%</span></span>
<span id="cb12-223"><a href="#cb12-223" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb12-224"><a href="#cb12-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-225"><a href="#cb12-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-226"><a href="#cb12-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-227"><a href="#cb12-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-228"><a href="#cb12-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-229"><a href="#cb12-229" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results)</span>
<span id="cb12-230"><a href="#cb12-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-231"><a href="#cb12-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-232"><a href="#cb12-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-233"><a href="#cb12-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-234"><a href="#cb12-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-235"><a href="#cb12-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-236"><a href="#cb12-236" aria-hidden="true" tabindex="-1"></a>trend_results_race_6_HispLat <span class="ot">&lt;-</span> trend_results</span>
<span id="cb12-237"><a href="#cb12-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-238"><a href="#cb12-238" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results_race_6_HispLat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="other-races" class="level4">
<h4 class="anchored" data-anchor-id="other-races">6.5 - Other Races</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="do">######## Import Raw and Analyzed Excel Files ###############</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co"># *** If this code is not working, check analysis excel file to see if it says "Other Race" with no "s"</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>yrbs_master_analysis_stwd_trend <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Race_Group_6 Trend"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ROI_Indicator_Code =</span> <span class="fu">as.character</span>(ROI_Indicator_Code)) <span class="sc">%&gt;%</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Trend_Category <span class="sc">==</span> <span class="st">"Other Races"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="st">"Suppressed"</span>, <span class="cn">NA</span>, .)))</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a> <span class="co"># Load the raw data set to be used in trend analyis</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>raw_stwd_general <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"raw_yrbs_allyears_statewide_trad_cleaned.xlsx"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Race_Group_6 <span class="sc">==</span> <span class="st">"Other Races"</span>,</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>         Survey_Year <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2011</span>,</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2013</span>, </span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2015</span>, </span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2017</span>,</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2019</span>, </span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2023</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>                            )) <span class="sc">%&gt;%</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">2</span>, <span class="dv">0</span>, <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="cn">NA</span>))))</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine which survey questions (ROI - Response of Interest) have data across at least two distinct survey years</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>roi_years <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), Survey_Year) <span class="sc">%&gt;%</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>Survey_Year, </span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"ROI_Indicator_Code"</span>, </span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ROI_Indicator_Code) <span class="sc">%&gt;%</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">unique_years =</span> <span class="fu">n_distinct</span>(Survey_Year), </span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(unique_years <span class="sc">&gt;=</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(ROI_Indicator_Code)</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the main data set to include only those ROIs, also ensuring to keep necessary demographic variables</span></span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>filtered_raw_stwd_general <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Survey_Year, <span class="fu">all_of</span>(roi_years), Sex, Grade, Primary_Samp_Unit,Stratum,Final_Weight)</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a><span class="do">############ Long Term Trend ###############</span></span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a><span class="co">#Trend Analysis Function</span></span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>analyze_trend_logistic <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Survey Design for YRBS Statewide</span></span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_survey_design</span>(<span class="at">ids =</span> Primary_Samp_Unit,</span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a>                     <span class="at">strata =</span> Stratum,</span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a>                     <span class="at">weights =</span> Final_Weight,</span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span></span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Sex =</span> <span class="fu">factor</span>(Sex), <span class="at">Grade =</span> <span class="fu">factor</span>(Grade))</span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(data_filtered) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">length</span>(<span class="fu">unique</span>(data_filtered<span class="sc">$</span>variables<span class="sc">$</span>Survey_Year)) <span class="sc">&lt;</span> <span class="dv">4</span>) {</span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a>  base_formula <span class="ot">&lt;-</span> <span class="fu">paste</span>(column_name, <span class="st">"~ Sex + Grade + Survey_Year"</span>) </span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit the model using logistic regression</span></span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb13-65"><a href="#cb13-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">svyglm</span>(<span class="fu">as.formula</span>(base_formula), <span class="at">design =</span> data_filtered, <span class="at">family =</span> <span class="fu">quasibinomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb13-66"><a href="#cb13-66" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb13-67"><a href="#cb13-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Error fitting model: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb13-68"><a href="#cb13-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb13-69"><a href="#cb13-69" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb13-70"><a href="#cb13-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-71"><a href="#cb13-71" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if model fitting was successful</span></span>
<span id="cb13-72"><a href="#cb13-72" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(model)) {</span>
<span id="cb13-73"><a href="#cb13-73" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error"</span>))</span>
<span id="cb13-74"><a href="#cb13-74" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb13-75"><a href="#cb13-75" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-76"><a href="#cb13-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check for coefficients</span></span>
<span id="cb13-77"><a href="#cb13-77" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>(<span class="st">"Survey_Year"</span> <span class="sc">%in%</span> <span class="fu">names</span>(<span class="fu">coef</span>(model)))) {</span>
<span id="cb13-78"><a href="#cb13-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No valid coefficient for Survey_Year"</span>))</span>
<span id="cb13-79"><a href="#cb13-79" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb13-80"><a href="#cb13-80" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-81"><a href="#cb13-81" aria-hidden="true" tabindex="-1"></a>  coef_summary <span class="ot">=</span> <span class="fu">summary</span>(model)<span class="sc">$</span>coefficients</span>
<span id="cb13-82"><a href="#cb13-82" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(coef_summary) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb13-83"><a href="#cb13-83" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error: No coefficients"</span>))</span>
<span id="cb13-84"><a href="#cb13-84" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb13-85"><a href="#cb13-85" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-86"><a href="#cb13-86" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Determine the significance and direction of the trend</span></span>
<span id="cb13-87"><a href="#cb13-87" aria-hidden="true" tabindex="-1"></a>  p_value <span class="ot">=</span> coef_summary[<span class="st">"Survey_Year"</span>, <span class="st">"Pr(&gt;|t|)"</span>]</span>
<span id="cb13-88"><a href="#cb13-88" aria-hidden="true" tabindex="-1"></a>  coefficient <span class="ot">=</span> <span class="fu">coef</span>(model)[<span class="st">"Survey_Year"</span>]</span>
<span id="cb13-89"><a href="#cb13-89" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-90"><a href="#cb13-90" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(p_value)) {</span>
<span id="cb13-91"><a href="#cb13-91" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"P-value is NA"</span>))</span>
<span id="cb13-92"><a href="#cb13-92" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb13-93"><a href="#cb13-93" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-94"><a href="#cb13-94" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (p_value <span class="sc">&lt;=</span> <span class="fl">0.05</span>) {</span>
<span id="cb13-95"><a href="#cb13-95" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (coefficient <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb13-96"><a href="#cb13-96" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Increase"</span>))</span>
<span id="cb13-97"><a href="#cb13-97" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb13-98"><a href="#cb13-98" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Decrease"</span>))</span>
<span id="cb13-99"><a href="#cb13-99" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb13-100"><a href="#cb13-100" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb13-101"><a href="#cb13-101" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No Change"</span>))</span>
<span id="cb13-102"><a href="#cb13-102" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb13-103"><a href="#cb13-103" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-104"><a href="#cb13-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-105"><a href="#cb13-105" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the function to each ROI_Indicator_Code that has sufficient data</span></span>
<span id="cb13-106"><a href="#cb13-106" aria-hidden="true" tabindex="-1"></a>long_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(filtered_raw_stwd_general)[<span class="sc">-</span><span class="dv">1</span>], <span class="cf">function</span>(column_name) {</span>
<span id="cb13-107"><a href="#cb13-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_trend_logistic</span>(filtered_raw_stwd_general, column_name)</span>
<span id="cb13-108"><a href="#cb13-108" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb13-109"><a href="#cb13-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-110"><a href="#cb13-110" aria-hidden="true" tabindex="-1"></a><span class="co"># Show results</span></span>
<span id="cb13-111"><a href="#cb13-111" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(long_trend_results)</span>
<span id="cb13-112"><a href="#cb13-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-113"><a href="#cb13-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-114"><a href="#cb13-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-115"><a href="#cb13-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-116"><a href="#cb13-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-117"><a href="#cb13-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-118"><a href="#cb13-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-119"><a href="#cb13-119" aria-hidden="true" tabindex="-1"></a><span class="do">######### Short Term Trend ###############</span></span>
<span id="cb13-120"><a href="#cb13-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-121"><a href="#cb13-121" aria-hidden="true" tabindex="-1"></a>analyze_short_term_trend_ttest <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb13-122"><a href="#cb13-122" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the short-term years</span></span>
<span id="cb13-123"><a href="#cb13-123" aria-hidden="true" tabindex="-1"></a>    short_term_years <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2019</span>, <span class="dv">2023</span>)</span>
<span id="cb13-124"><a href="#cb13-124" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-125"><a href="#cb13-125" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter for short-term years and ensure all necessary variables are selected</span></span>
<span id="cb13-126"><a href="#cb13-126" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb13-127"><a href="#cb13-127" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(Survey_Year <span class="sc">%in%</span> short_term_years) <span class="sc">%&gt;%</span></span>
<span id="cb13-128"><a href="#cb13-128" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(Primary_Samp_Unit, Stratum, Final_Weight, Survey_Year, <span class="fu">all_of</span>(column_name)) <span class="sc">%&gt;%</span></span>
<span id="cb13-129"><a href="#cb13-129" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">response =</span> <span class="fu">get</span>(column_name) <span class="sc">==</span> <span class="dv">1</span>)  <span class="co"># Create a binary response variable for the analysis</span></span>
<span id="cb13-130"><a href="#cb13-130" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-131"><a href="#cb13-131" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if data is available for both years</span></span>
<span id="cb13-132"><a href="#cb13-132" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(short_term_years <span class="sc">%in%</span> <span class="fu">unique</span>(data_filtered<span class="sc">$</span>Survey_Year[<span class="sc">!</span><span class="fu">is.na</span>(data_filtered<span class="sc">$</span>response)]))) {</span>
<span id="cb13-133"><a href="#cb13-133" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb13-134"><a href="#cb13-134" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb13-135"><a href="#cb13-135" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-136"><a href="#cb13-136" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Continue with data that doesn't have NA responses</span></span>
<span id="cb13-137"><a href="#cb13-137" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(response))</span>
<span id="cb13-138"><a href="#cb13-138" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-139"><a href="#cb13-139" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create survey design object including the response variable</span></span>
<span id="cb13-140"><a href="#cb13-140" aria-hidden="true" tabindex="-1"></a>    survey_design <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="sc">~</span>Primary_Samp_Unit,</span>
<span id="cb13-141"><a href="#cb13-141" aria-hidden="true" tabindex="-1"></a>                               <span class="at">strata =</span> <span class="sc">~</span>Stratum,</span>
<span id="cb13-142"><a href="#cb13-142" aria-hidden="true" tabindex="-1"></a>                               <span class="at">weights =</span> <span class="sc">~</span>Final_Weight,</span>
<span id="cb13-143"><a href="#cb13-143" aria-hidden="true" tabindex="-1"></a>                               <span class="at">data =</span> data_filtered,</span>
<span id="cb13-144"><a href="#cb13-144" aria-hidden="true" tabindex="-1"></a>                               <span class="at">nest =</span> <span class="cn">TRUE</span>) </span>
<span id="cb13-145"><a href="#cb13-145" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-146"><a href="#cb13-146" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Perform Welch's t-test using the survey design object</span></span>
<span id="cb13-147"><a href="#cb13-147" aria-hidden="true" tabindex="-1"></a>    ttest_result <span class="ot">&lt;-</span> <span class="fu">svyttest</span>(response <span class="sc">~</span> <span class="fu">as.factor</span>(Survey_Year), survey_design)</span>
<span id="cb13-148"><a href="#cb13-148" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-149"><a href="#cb13-149" aria-hidden="true" tabindex="-1"></a>    <span class="co"># head t-test results</span></span>
<span id="cb13-150"><a href="#cb13-150" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(ttest_result)</span>
<span id="cb13-151"><a href="#cb13-151" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-152"><a href="#cb13-152" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check significance and interpret the results</span></span>
<span id="cb13-153"><a href="#cb13-153" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(ttest_result<span class="sc">$</span>p.value) <span class="sc">&amp;&amp;</span> ttest_result<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>) {</span>
<span id="cb13-154"><a href="#cb13-154" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(ttest_result<span class="sc">$</span>estimate <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Significant Increase"</span>, <span class="st">"Significant Decrease"</span>)</span>
<span id="cb13-155"><a href="#cb13-155" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb13-156"><a href="#cb13-156" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="st">"No Change"</span></span>
<span id="cb13-157"><a href="#cb13-157" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb13-158"><a href="#cb13-158" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-159"><a href="#cb13-159" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> trend))</span>
<span id="cb13-160"><a href="#cb13-160" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-161"><a href="#cb13-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-162"><a href="#cb13-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-163"><a href="#cb13-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-164"><a href="#cb13-164" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the short-term function to each ROI_Indicator_Code</span></span>
<span id="cb13-165"><a href="#cb13-165" aria-hidden="true" tabindex="-1"></a>short_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(raw_stwd_general)[<span class="fu">grep</span>(<span class="st">"^(QN|V).*[RP]"</span>, <span class="fu">names</span>(raw_stwd_general))], <span class="cf">function</span>(column_name) {</span>
<span id="cb13-166"><a href="#cb13-166" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_short_term_trend_ttest</span>(raw_stwd_general, column_name)</span>
<span id="cb13-167"><a href="#cb13-167" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb13-168"><a href="#cb13-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-169"><a href="#cb13-169" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(short_trend_results)</span>
<span id="cb13-170"><a href="#cb13-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-171"><a href="#cb13-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-172"><a href="#cb13-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-173"><a href="#cb13-173" aria-hidden="true" tabindex="-1"></a><span class="do">################### Join Together with Trend Tables ############</span></span>
<span id="cb13-174"><a href="#cb13-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-175"><a href="#cb13-175" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine long-term and short-term results</span></span>
<span id="cb13-176"><a href="#cb13-176" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> <span class="fu">left_join</span>(long_trend_results, </span>
<span id="cb13-177"><a href="#cb13-177" aria-hidden="true" tabindex="-1"></a>                                    short_trend_results, </span>
<span id="cb13-178"><a href="#cb13-178" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">by =</span> <span class="st">"ROI_Indicator_Code"</span>)</span>
<span id="cb13-179"><a href="#cb13-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-180"><a href="#cb13-180" aria-hidden="true" tabindex="-1"></a><span class="co">#head(combined_trend_results)</span></span>
<span id="cb13-181"><a href="#cb13-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-182"><a href="#cb13-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-183"><a href="#cb13-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-184"><a href="#cb13-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-185"><a href="#cb13-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-186"><a href="#cb13-186" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge Long_Term_Trend into yrbs_master_stwd_grade based on matching ROI_Indicator_Code and Trend_Category</span></span>
<span id="cb13-187"><a href="#cb13-187" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> yrbs_master_analysis_stwd_trend <span class="sc">%&gt;%</span></span>
<span id="cb13-188"><a href="#cb13-188" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ROI_Indicator_Code =</span> <span class="fu">as.character</span>(ROI_Indicator_Code)) <span class="sc">%&gt;%</span></span>
<span id="cb13-189"><a href="#cb13-189" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(combined_trend_results <span class="sc">%&gt;%</span> <span class="fu">select</span>(ROI_Indicator_Code, Long_Term_Trend, Short_Term_Trend),</span>
<span id="cb13-190"><a href="#cb13-190" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ROI_Indicator_Code"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb13-191"><a href="#cb13-191" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(School_Type,</span>
<span id="cb13-192"><a href="#cb13-192" aria-hidden="true" tabindex="-1"></a>         Health_Topic, </span>
<span id="cb13-193"><a href="#cb13-193" aria-hidden="true" tabindex="-1"></a>         ROI_Indicator_Code, </span>
<span id="cb13-194"><a href="#cb13-194" aria-hidden="true" tabindex="-1"></a>         Indicator_Long_Description, </span>
<span id="cb13-195"><a href="#cb13-195" aria-hidden="true" tabindex="-1"></a>         Trend_Category, </span>
<span id="cb13-196"><a href="#cb13-196" aria-hidden="true" tabindex="-1"></a>         <span class="fu">everything</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb13-197"><a href="#cb13-197" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, </span>
<span id="cb13-198"><a href="#cb13-198" aria-hidden="true" tabindex="-1"></a>          ROI_Indicator_Code, </span>
<span id="cb13-199"><a href="#cb13-199" aria-hidden="true" tabindex="-1"></a>          Trend_Category)</span>
<span id="cb13-200"><a href="#cb13-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-201"><a href="#cb13-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-202"><a href="#cb13-202" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to check for three consecutive NAs in a set of columns</span></span>
<span id="cb13-203"><a href="#cb13-203" aria-hidden="true" tabindex="-1"></a>check_consecutive_nas <span class="ot">&lt;-</span> <span class="cf">function</span>(year_values) {</span>
<span id="cb13-204"><a href="#cb13-204" aria-hidden="true" tabindex="-1"></a>  na_run_lengths <span class="ot">&lt;-</span> <span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>lengths[<span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>values]</span>
<span id="cb13-205"><a href="#cb13-205" aria-hidden="true" tabindex="-1"></a>  <span class="fu">any</span>(na_run_lengths <span class="sc">&gt;=</span> <span class="dv">3</span>)</span>
<span id="cb13-206"><a href="#cb13-206" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-207"><a href="#cb13-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-208"><a href="#cb13-208" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert all columns representing years to numeric</span></span>
<span id="cb13-209"><a href="#cb13-209" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb13-210"><a href="#cb13-210" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">d+$"</span>), as.numeric))</span>
<span id="cb13-211"><a href="#cb13-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-212"><a href="#cb13-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-213"><a href="#cb13-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-214"><a href="#cb13-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-215"><a href="#cb13-215" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge and mutate Long_Term_Trend</span></span>
<span id="cb13-216"><a href="#cb13-216" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb13-217"><a href="#cb13-217" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb13-218"><a href="#cb13-218" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Long_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">check_consecutive_nas</span>(<span class="fu">c_across</span>(<span class="st">`</span><span class="at">2011</span><span class="st">`</span><span class="sc">:</span><span class="st">`</span><span class="at">2023</span><span class="st">`</span>)), </span>
<span id="cb13-219"><a href="#cb13-219" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb13-220"><a href="#cb13-220" aria-hidden="true" tabindex="-1"></a>                                  Long_Term_Trend),</span>
<span id="cb13-221"><a href="#cb13-221" aria-hidden="true" tabindex="-1"></a>         <span class="at">Short_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(<span class="st">`</span><span class="at">2019</span><span class="st">`</span>) <span class="sc">|</span> <span class="fu">is.na</span>(<span class="st">`</span><span class="at">2023</span><span class="st">`</span>), </span>
<span id="cb13-222"><a href="#cb13-222" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb13-223"><a href="#cb13-223" aria-hidden="true" tabindex="-1"></a>                                   Short_Term_Trend)) <span class="sc">%&gt;%</span></span>
<span id="cb13-224"><a href="#cb13-224" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb13-225"><a href="#cb13-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-226"><a href="#cb13-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-227"><a href="#cb13-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-228"><a href="#cb13-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-229"><a href="#cb13-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-230"><a href="#cb13-230" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results)</span>
<span id="cb13-231"><a href="#cb13-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-232"><a href="#cb13-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-233"><a href="#cb13-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-234"><a href="#cb13-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-235"><a href="#cb13-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-236"><a href="#cb13-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-237"><a href="#cb13-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-238"><a href="#cb13-238" aria-hidden="true" tabindex="-1"></a>trend_results_race_6_other_race <span class="ot">&lt;-</span> trend_results</span>
<span id="cb13-239"><a href="#cb13-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-240"><a href="#cb13-240" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results_race_6_other_race)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="multiple-races" class="level4">
<h4 class="anchored" data-anchor-id="multiple-races">6.6 - Multiple Races</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># *** If this code is not working, check analysis excel file to see if it says "Multiple Race" with no "s"</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="do">######## Import Raw and Analyzed Excel Files ###############</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>yrbs_master_analysis_stwd_trend <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Race_Group_6 Trend"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Trend_Category <span class="sc">==</span> <span class="st">"Multiple Races"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="st">"Suppressed"</span>, <span class="cn">NA</span>, .)))</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a> <span class="co"># Load the raw data set to be used in trend analyis</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>raw_stwd_general <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"raw_yrbs_allyears_statewide_trad_cleaned.xlsx"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Race_Group_6 <span class="sc">==</span> <span class="st">"Multiple Races"</span>,</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>         Survey_Year <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2011</span>,</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2013</span>, </span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2015</span>, </span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2017</span>,</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2019</span>, </span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2023</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>                            )) <span class="sc">%&gt;%</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">2</span>, <span class="dv">0</span>, <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="cn">NA</span>))))</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine which survey questions (ROI - Response of Interest) have data across at least two distinct survey years</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>roi_years <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), Survey_Year) <span class="sc">%&gt;%</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>Survey_Year, </span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"ROI_Indicator_Code"</span>, </span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ROI_Indicator_Code) <span class="sc">%&gt;%</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">unique_years =</span> <span class="fu">n_distinct</span>(Survey_Year), </span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(unique_years <span class="sc">&gt;=</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(ROI_Indicator_Code)</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the main data set to include only those ROIs, also ensuring to keep necessary demographic variables</span></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>filtered_raw_stwd_general <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Survey_Year, <span class="fu">all_of</span>(roi_years), Sex, Grade, Primary_Samp_Unit,Stratum,Final_Weight)</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a><span class="do">############ Long Term Trend ###############</span></span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a><span class="co">#Trend Analysis Function</span></span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>analyze_trend_logistic <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Survey Design for YRBS Statewide</span></span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_survey_design</span>(<span class="at">ids =</span> Primary_Samp_Unit,</span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>                     <span class="at">strata =</span> Stratum,</span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>                     <span class="at">weights =</span> Final_Weight,</span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span></span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Sex =</span> <span class="fu">factor</span>(Sex), <span class="at">Grade =</span> <span class="fu">factor</span>(Grade))</span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(data_filtered) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">length</span>(<span class="fu">unique</span>(data_filtered<span class="sc">$</span>variables<span class="sc">$</span>Survey_Year)) <span class="sc">&lt;</span> <span class="dv">4</span>) {</span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a>  base_formula <span class="ot">&lt;-</span> <span class="fu">paste</span>(column_name, <span class="st">"~ Sex + Grade + Survey_Year"</span>) </span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit the model using logistic regression</span></span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">svyglm</span>(<span class="fu">as.formula</span>(base_formula), <span class="at">design =</span> data_filtered, <span class="at">family =</span> <span class="fu">quasibinomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Error fitting model: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if model fitting was successful</span></span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(model)) {</span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error"</span>))</span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check for coefficients</span></span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>(<span class="st">"Survey_Year"</span> <span class="sc">%in%</span> <span class="fu">names</span>(<span class="fu">coef</span>(model)))) {</span>
<span id="cb14-80"><a href="#cb14-80" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No valid coefficient for Survey_Year"</span>))</span>
<span id="cb14-81"><a href="#cb14-81" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-82"><a href="#cb14-82" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-83"><a href="#cb14-83" aria-hidden="true" tabindex="-1"></a>  coef_summary <span class="ot">=</span> <span class="fu">summary</span>(model)<span class="sc">$</span>coefficients</span>
<span id="cb14-84"><a href="#cb14-84" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(coef_summary) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb14-85"><a href="#cb14-85" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error: No coefficients"</span>))</span>
<span id="cb14-86"><a href="#cb14-86" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-87"><a href="#cb14-87" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-88"><a href="#cb14-88" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Determine the significance and direction of the trend</span></span>
<span id="cb14-89"><a href="#cb14-89" aria-hidden="true" tabindex="-1"></a>  p_value <span class="ot">=</span> coef_summary[<span class="st">"Survey_Year"</span>, <span class="st">"Pr(&gt;|t|)"</span>]</span>
<span id="cb14-90"><a href="#cb14-90" aria-hidden="true" tabindex="-1"></a>  coefficient <span class="ot">=</span> <span class="fu">coef</span>(model)[<span class="st">"Survey_Year"</span>]</span>
<span id="cb14-91"><a href="#cb14-91" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-92"><a href="#cb14-92" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(p_value)) {</span>
<span id="cb14-93"><a href="#cb14-93" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"P-value is NA"</span>))</span>
<span id="cb14-94"><a href="#cb14-94" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-95"><a href="#cb14-95" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-96"><a href="#cb14-96" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (p_value <span class="sc">&lt;=</span> <span class="fl">0.05</span>) {</span>
<span id="cb14-97"><a href="#cb14-97" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (coefficient <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb14-98"><a href="#cb14-98" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Increase"</span>))</span>
<span id="cb14-99"><a href="#cb14-99" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb14-100"><a href="#cb14-100" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Decrease"</span>))</span>
<span id="cb14-101"><a href="#cb14-101" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-102"><a href="#cb14-102" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb14-103"><a href="#cb14-103" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No Change"</span>))</span>
<span id="cb14-104"><a href="#cb14-104" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-105"><a href="#cb14-105" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-106"><a href="#cb14-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-107"><a href="#cb14-107" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the function to each ROI_Indicator_Code that has sufficient data</span></span>
<span id="cb14-108"><a href="#cb14-108" aria-hidden="true" tabindex="-1"></a>long_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(filtered_raw_stwd_general)[<span class="sc">-</span><span class="dv">1</span>], <span class="cf">function</span>(column_name) {</span>
<span id="cb14-109"><a href="#cb14-109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_trend_logistic</span>(filtered_raw_stwd_general, column_name)</span>
<span id="cb14-110"><a href="#cb14-110" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb14-111"><a href="#cb14-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-112"><a href="#cb14-112" aria-hidden="true" tabindex="-1"></a><span class="co"># Show results</span></span>
<span id="cb14-113"><a href="#cb14-113" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(long_trend_results)</span>
<span id="cb14-114"><a href="#cb14-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-115"><a href="#cb14-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-116"><a href="#cb14-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-117"><a href="#cb14-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-118"><a href="#cb14-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-119"><a href="#cb14-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-120"><a href="#cb14-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-121"><a href="#cb14-121" aria-hidden="true" tabindex="-1"></a><span class="do">######### Short Term Trend ###############</span></span>
<span id="cb14-122"><a href="#cb14-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-123"><a href="#cb14-123" aria-hidden="true" tabindex="-1"></a>analyze_short_term_trend_ttest <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb14-124"><a href="#cb14-124" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the short-term years</span></span>
<span id="cb14-125"><a href="#cb14-125" aria-hidden="true" tabindex="-1"></a>    short_term_years <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2019</span>, <span class="dv">2023</span>)</span>
<span id="cb14-126"><a href="#cb14-126" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-127"><a href="#cb14-127" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter for short-term years and ensure all necessary variables are selected</span></span>
<span id="cb14-128"><a href="#cb14-128" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb14-129"><a href="#cb14-129" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(Survey_Year <span class="sc">%in%</span> short_term_years) <span class="sc">%&gt;%</span></span>
<span id="cb14-130"><a href="#cb14-130" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(Primary_Samp_Unit, Stratum, Final_Weight, Survey_Year, <span class="fu">all_of</span>(column_name)) <span class="sc">%&gt;%</span></span>
<span id="cb14-131"><a href="#cb14-131" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">response =</span> <span class="fu">get</span>(column_name) <span class="sc">==</span> <span class="dv">1</span>)  <span class="co"># Create a binary response variable for the analysis</span></span>
<span id="cb14-132"><a href="#cb14-132" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-133"><a href="#cb14-133" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if data is available for both years</span></span>
<span id="cb14-134"><a href="#cb14-134" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(short_term_years <span class="sc">%in%</span> <span class="fu">unique</span>(data_filtered<span class="sc">$</span>Survey_Year[<span class="sc">!</span><span class="fu">is.na</span>(data_filtered<span class="sc">$</span>response)]))) {</span>
<span id="cb14-135"><a href="#cb14-135" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb14-136"><a href="#cb14-136" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-137"><a href="#cb14-137" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-138"><a href="#cb14-138" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Continue with data that doesn't have NA responses</span></span>
<span id="cb14-139"><a href="#cb14-139" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(response))</span>
<span id="cb14-140"><a href="#cb14-140" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-141"><a href="#cb14-141" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create survey design object including the response variable</span></span>
<span id="cb14-142"><a href="#cb14-142" aria-hidden="true" tabindex="-1"></a>    survey_design <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="sc">~</span>Primary_Samp_Unit,</span>
<span id="cb14-143"><a href="#cb14-143" aria-hidden="true" tabindex="-1"></a>                               <span class="at">strata =</span> <span class="sc">~</span>Stratum,</span>
<span id="cb14-144"><a href="#cb14-144" aria-hidden="true" tabindex="-1"></a>                               <span class="at">weights =</span> <span class="sc">~</span>Final_Weight,</span>
<span id="cb14-145"><a href="#cb14-145" aria-hidden="true" tabindex="-1"></a>                               <span class="at">data =</span> data_filtered,</span>
<span id="cb14-146"><a href="#cb14-146" aria-hidden="true" tabindex="-1"></a>                               <span class="at">nest =</span> <span class="cn">TRUE</span>) </span>
<span id="cb14-147"><a href="#cb14-147" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-148"><a href="#cb14-148" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Perform Welch's t-test using the survey design object</span></span>
<span id="cb14-149"><a href="#cb14-149" aria-hidden="true" tabindex="-1"></a>    ttest_result <span class="ot">&lt;-</span> <span class="fu">svyttest</span>(response <span class="sc">~</span> <span class="fu">as.factor</span>(Survey_Year), survey_design)</span>
<span id="cb14-150"><a href="#cb14-150" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-151"><a href="#cb14-151" aria-hidden="true" tabindex="-1"></a>    <span class="co"># head t-test results</span></span>
<span id="cb14-152"><a href="#cb14-152" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(ttest_result)</span>
<span id="cb14-153"><a href="#cb14-153" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-154"><a href="#cb14-154" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check significance and interpret the results</span></span>
<span id="cb14-155"><a href="#cb14-155" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(ttest_result<span class="sc">$</span>p.value) <span class="sc">&amp;&amp;</span> ttest_result<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>) {</span>
<span id="cb14-156"><a href="#cb14-156" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(ttest_result<span class="sc">$</span>estimate <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Significant Increase"</span>, <span class="st">"Significant Decrease"</span>)</span>
<span id="cb14-157"><a href="#cb14-157" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb14-158"><a href="#cb14-158" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="st">"No Change"</span></span>
<span id="cb14-159"><a href="#cb14-159" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-160"><a href="#cb14-160" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-161"><a href="#cb14-161" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> trend))</span>
<span id="cb14-162"><a href="#cb14-162" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-163"><a href="#cb14-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-164"><a href="#cb14-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-165"><a href="#cb14-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-166"><a href="#cb14-166" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the short-term function to each ROI_Indicator_Code</span></span>
<span id="cb14-167"><a href="#cb14-167" aria-hidden="true" tabindex="-1"></a>short_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(raw_stwd_general)[<span class="fu">grep</span>(<span class="st">"^(QN|V).*[RP]"</span>, <span class="fu">names</span>(raw_stwd_general))], <span class="cf">function</span>(column_name) {</span>
<span id="cb14-168"><a href="#cb14-168" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_short_term_trend_ttest</span>(raw_stwd_general, column_name)</span>
<span id="cb14-169"><a href="#cb14-169" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb14-170"><a href="#cb14-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-171"><a href="#cb14-171" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(short_trend_results)</span>
<span id="cb14-172"><a href="#cb14-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-173"><a href="#cb14-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-174"><a href="#cb14-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-175"><a href="#cb14-175" aria-hidden="true" tabindex="-1"></a><span class="do">################### Join Together with Trend Tables ############</span></span>
<span id="cb14-176"><a href="#cb14-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-177"><a href="#cb14-177" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine long-term and short-term results</span></span>
<span id="cb14-178"><a href="#cb14-178" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> <span class="fu">left_join</span>(long_trend_results, </span>
<span id="cb14-179"><a href="#cb14-179" aria-hidden="true" tabindex="-1"></a>                                    short_trend_results, </span>
<span id="cb14-180"><a href="#cb14-180" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">by =</span> <span class="st">"ROI_Indicator_Code"</span>)</span>
<span id="cb14-181"><a href="#cb14-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-182"><a href="#cb14-182" aria-hidden="true" tabindex="-1"></a><span class="co">#head(combined_trend_results)</span></span>
<span id="cb14-183"><a href="#cb14-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-184"><a href="#cb14-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-185"><a href="#cb14-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-186"><a href="#cb14-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-187"><a href="#cb14-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-188"><a href="#cb14-188" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge Long_Term_Trend into yrbs_master_stwd_grade based on matching ROI_Indicator_Code and Trend_Category</span></span>
<span id="cb14-189"><a href="#cb14-189" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> yrbs_master_analysis_stwd_trend <span class="sc">%&gt;%</span></span>
<span id="cb14-190"><a href="#cb14-190" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(combined_trend_results <span class="sc">%&gt;%</span> <span class="fu">select</span>(ROI_Indicator_Code, Long_Term_Trend, Short_Term_Trend),</span>
<span id="cb14-191"><a href="#cb14-191" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ROI_Indicator_Code"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb14-192"><a href="#cb14-192" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(School_Type,</span>
<span id="cb14-193"><a href="#cb14-193" aria-hidden="true" tabindex="-1"></a>         Health_Topic, </span>
<span id="cb14-194"><a href="#cb14-194" aria-hidden="true" tabindex="-1"></a>         ROI_Indicator_Code, </span>
<span id="cb14-195"><a href="#cb14-195" aria-hidden="true" tabindex="-1"></a>         Indicator_Long_Description, </span>
<span id="cb14-196"><a href="#cb14-196" aria-hidden="true" tabindex="-1"></a>         Trend_Category, </span>
<span id="cb14-197"><a href="#cb14-197" aria-hidden="true" tabindex="-1"></a>         <span class="fu">everything</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb14-198"><a href="#cb14-198" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, </span>
<span id="cb14-199"><a href="#cb14-199" aria-hidden="true" tabindex="-1"></a>          ROI_Indicator_Code, </span>
<span id="cb14-200"><a href="#cb14-200" aria-hidden="true" tabindex="-1"></a>          Trend_Category)</span>
<span id="cb14-201"><a href="#cb14-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-202"><a href="#cb14-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-203"><a href="#cb14-203" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to check for three consecutive NAs in a set of columns</span></span>
<span id="cb14-204"><a href="#cb14-204" aria-hidden="true" tabindex="-1"></a>check_consecutive_nas <span class="ot">&lt;-</span> <span class="cf">function</span>(year_values) {</span>
<span id="cb14-205"><a href="#cb14-205" aria-hidden="true" tabindex="-1"></a>  na_run_lengths <span class="ot">&lt;-</span> <span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>lengths[<span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>values]</span>
<span id="cb14-206"><a href="#cb14-206" aria-hidden="true" tabindex="-1"></a>  <span class="fu">any</span>(na_run_lengths <span class="sc">&gt;=</span> <span class="dv">3</span>)</span>
<span id="cb14-207"><a href="#cb14-207" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-208"><a href="#cb14-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-209"><a href="#cb14-209" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert all columns representing years to numeric</span></span>
<span id="cb14-210"><a href="#cb14-210" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb14-211"><a href="#cb14-211" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">d+$"</span>), as.numeric))</span>
<span id="cb14-212"><a href="#cb14-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-213"><a href="#cb14-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-214"><a href="#cb14-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-215"><a href="#cb14-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-216"><a href="#cb14-216" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge and mutate Long_Term_Trend</span></span>
<span id="cb14-217"><a href="#cb14-217" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb14-218"><a href="#cb14-218" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb14-219"><a href="#cb14-219" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Long_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">check_consecutive_nas</span>(<span class="fu">c_across</span>(<span class="st">`</span><span class="at">2011</span><span class="st">`</span><span class="sc">:</span><span class="st">`</span><span class="at">2023</span><span class="st">`</span>)), </span>
<span id="cb14-220"><a href="#cb14-220" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb14-221"><a href="#cb14-221" aria-hidden="true" tabindex="-1"></a>                                  Long_Term_Trend),</span>
<span id="cb14-222"><a href="#cb14-222" aria-hidden="true" tabindex="-1"></a>         <span class="at">Short_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(<span class="st">`</span><span class="at">2019</span><span class="st">`</span>) <span class="sc">|</span> <span class="fu">is.na</span>(<span class="st">`</span><span class="at">2023</span><span class="st">`</span>), </span>
<span id="cb14-223"><a href="#cb14-223" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb14-224"><a href="#cb14-224" aria-hidden="true" tabindex="-1"></a>                                   Short_Term_Trend)) <span class="sc">%&gt;%</span></span>
<span id="cb14-225"><a href="#cb14-225" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb14-226"><a href="#cb14-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-227"><a href="#cb14-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-228"><a href="#cb14-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-229"><a href="#cb14-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-230"><a href="#cb14-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-231"><a href="#cb14-231" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results)</span>
<span id="cb14-232"><a href="#cb14-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-233"><a href="#cb14-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-234"><a href="#cb14-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-235"><a href="#cb14-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-236"><a href="#cb14-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-237"><a href="#cb14-237" aria-hidden="true" tabindex="-1"></a>trend_results_race_6_mult_race <span class="ot">&lt;-</span> trend_results</span>
<span id="cb14-238"><a href="#cb14-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-239"><a href="#cb14-239" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results_race_6_mult_race)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="trend-by-race_group_3" class="level3">
<h3 class="anchored" data-anchor-id="trend-by-race_group_3">Trend By Race_Group_3</h3>
<section id="alaska-nativeamerican-indian-1" class="level4">
<h4 class="anchored" data-anchor-id="alaska-nativeamerican-indian-1">3.1 - Alaska Native/American Indian</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="do">######## Import Raw and Analyzed Excel Files ###############</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>yrbs_master_analysis_stwd_trend <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Race_Group_3 Trend"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Trend_Category <span class="sc">==</span> <span class="st">"Alaska Native/American Indian"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="st">"Suppressed"</span>, <span class="cn">NA</span>, .)))</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a> <span class="co"># Load the raw data set to be used in trend analyis</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>raw_stwd_general <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"raw_yrbs_allyears_statewide_trad_cleaned.xlsx"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Race_Group_3 <span class="sc">==</span> <span class="st">"Alaska Native/American Indian"</span>,</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>         Survey_Year <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2011</span>,</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2013</span>, </span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2015</span>, </span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2017</span>,</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2019</span>, </span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2023</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>                            )) <span class="sc">%&gt;%</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">2</span>, <span class="dv">0</span>, <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="cn">NA</span>))))</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine which survey questions (ROI - Response of Interest) have data across at least two distinct survey years</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>roi_years <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), Survey_Year) <span class="sc">%&gt;%</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>Survey_Year, </span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"ROI_Indicator_Code"</span>, </span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ROI_Indicator_Code) <span class="sc">%&gt;%</span></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">unique_years =</span> <span class="fu">n_distinct</span>(Survey_Year), </span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(unique_years <span class="sc">&gt;=</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(ROI_Indicator_Code)</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the main data set to include only those ROIs, also ensuring to keep necessary demographic variables</span></span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>filtered_raw_stwd_general <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Survey_Year, <span class="fu">all_of</span>(roi_years), Sex, Grade, Primary_Samp_Unit,Stratum,Final_Weight)</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a><span class="do">############ Long Term Trend ###############</span></span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a><span class="co">#Trend Analysis Function</span></span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>analyze_trend_logistic <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Survey Design for YRBS Statewide</span></span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_survey_design</span>(<span class="at">ids =</span> Primary_Samp_Unit,</span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>                     <span class="at">strata =</span> Stratum,</span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>                     <span class="at">weights =</span> Final_Weight,</span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span></span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Sex =</span> <span class="fu">factor</span>(Sex), <span class="at">Grade =</span> <span class="fu">factor</span>(Grade))</span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(data_filtered) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">length</span>(<span class="fu">unique</span>(data_filtered<span class="sc">$</span>variables<span class="sc">$</span>Survey_Year)) <span class="sc">&lt;</span> <span class="dv">4</span>) {</span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a>  base_formula <span class="ot">&lt;-</span> <span class="fu">paste</span>(column_name, <span class="st">"~ Sex + Grade + Survey_Year"</span>) </span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit the model using logistic regression</span></span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">svyglm</span>(<span class="fu">as.formula</span>(base_formula), <span class="at">design =</span> data_filtered, <span class="at">family =</span> <span class="fu">quasibinomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb15-66"><a href="#cb15-66" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Error fitting model: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb15-67"><a href="#cb15-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb15-68"><a href="#cb15-68" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb15-69"><a href="#cb15-69" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-70"><a href="#cb15-70" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if model fitting was successful</span></span>
<span id="cb15-71"><a href="#cb15-71" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(model)) {</span>
<span id="cb15-72"><a href="#cb15-72" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error"</span>))</span>
<span id="cb15-73"><a href="#cb15-73" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-74"><a href="#cb15-74" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-75"><a href="#cb15-75" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check for coefficients</span></span>
<span id="cb15-76"><a href="#cb15-76" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>(<span class="st">"Survey_Year"</span> <span class="sc">%in%</span> <span class="fu">names</span>(<span class="fu">coef</span>(model)))) {</span>
<span id="cb15-77"><a href="#cb15-77" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No valid coefficient for Survey_Year"</span>))</span>
<span id="cb15-78"><a href="#cb15-78" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-79"><a href="#cb15-79" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-80"><a href="#cb15-80" aria-hidden="true" tabindex="-1"></a>  coef_summary <span class="ot">=</span> <span class="fu">summary</span>(model)<span class="sc">$</span>coefficients</span>
<span id="cb15-81"><a href="#cb15-81" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(coef_summary) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb15-82"><a href="#cb15-82" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error: No coefficients"</span>))</span>
<span id="cb15-83"><a href="#cb15-83" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-84"><a href="#cb15-84" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-85"><a href="#cb15-85" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Determine the significance and direction of the trend</span></span>
<span id="cb15-86"><a href="#cb15-86" aria-hidden="true" tabindex="-1"></a>  p_value <span class="ot">=</span> coef_summary[<span class="st">"Survey_Year"</span>, <span class="st">"Pr(&gt;|t|)"</span>]</span>
<span id="cb15-87"><a href="#cb15-87" aria-hidden="true" tabindex="-1"></a>  coefficient <span class="ot">=</span> <span class="fu">coef</span>(model)[<span class="st">"Survey_Year"</span>]</span>
<span id="cb15-88"><a href="#cb15-88" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-89"><a href="#cb15-89" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(p_value)) {</span>
<span id="cb15-90"><a href="#cb15-90" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"P-value is NA"</span>))</span>
<span id="cb15-91"><a href="#cb15-91" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-92"><a href="#cb15-92" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-93"><a href="#cb15-93" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (p_value <span class="sc">&lt;=</span> <span class="fl">0.05</span>) {</span>
<span id="cb15-94"><a href="#cb15-94" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (coefficient <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb15-95"><a href="#cb15-95" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Increase"</span>))</span>
<span id="cb15-96"><a href="#cb15-96" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb15-97"><a href="#cb15-97" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Decrease"</span>))</span>
<span id="cb15-98"><a href="#cb15-98" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb15-99"><a href="#cb15-99" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb15-100"><a href="#cb15-100" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No Change"</span>))</span>
<span id="cb15-101"><a href="#cb15-101" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-102"><a href="#cb15-102" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-103"><a href="#cb15-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-104"><a href="#cb15-104" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the function to each ROI_Indicator_Code that has sufficient data</span></span>
<span id="cb15-105"><a href="#cb15-105" aria-hidden="true" tabindex="-1"></a>long_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(filtered_raw_stwd_general)[<span class="sc">-</span><span class="dv">1</span>], <span class="cf">function</span>(column_name) {</span>
<span id="cb15-106"><a href="#cb15-106" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_trend_logistic</span>(filtered_raw_stwd_general, column_name)</span>
<span id="cb15-107"><a href="#cb15-107" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb15-108"><a href="#cb15-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-109"><a href="#cb15-109" aria-hidden="true" tabindex="-1"></a><span class="co"># Show results</span></span>
<span id="cb15-110"><a href="#cb15-110" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(long_trend_results)</span>
<span id="cb15-111"><a href="#cb15-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-112"><a href="#cb15-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-113"><a href="#cb15-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-114"><a href="#cb15-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-115"><a href="#cb15-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-116"><a href="#cb15-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-117"><a href="#cb15-117" aria-hidden="true" tabindex="-1"></a><span class="do">######### Short Term Trend ###############</span></span>
<span id="cb15-118"><a href="#cb15-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-119"><a href="#cb15-119" aria-hidden="true" tabindex="-1"></a>analyze_short_term_trend_ttest <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb15-120"><a href="#cb15-120" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the short-term years</span></span>
<span id="cb15-121"><a href="#cb15-121" aria-hidden="true" tabindex="-1"></a>    short_term_years <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2019</span>, <span class="dv">2023</span>)</span>
<span id="cb15-122"><a href="#cb15-122" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-123"><a href="#cb15-123" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter for short-term years and ensure all necessary variables are selected</span></span>
<span id="cb15-124"><a href="#cb15-124" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb15-125"><a href="#cb15-125" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(Survey_Year <span class="sc">%in%</span> short_term_years) <span class="sc">%&gt;%</span></span>
<span id="cb15-126"><a href="#cb15-126" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(Primary_Samp_Unit, Stratum, Final_Weight, Survey_Year, <span class="fu">all_of</span>(column_name)) <span class="sc">%&gt;%</span></span>
<span id="cb15-127"><a href="#cb15-127" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">response =</span> <span class="fu">get</span>(column_name) <span class="sc">==</span> <span class="dv">1</span>)  <span class="co"># Create a binary response variable for the analysis</span></span>
<span id="cb15-128"><a href="#cb15-128" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-129"><a href="#cb15-129" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if data is available for both years</span></span>
<span id="cb15-130"><a href="#cb15-130" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(short_term_years <span class="sc">%in%</span> <span class="fu">unique</span>(data_filtered<span class="sc">$</span>Survey_Year[<span class="sc">!</span><span class="fu">is.na</span>(data_filtered<span class="sc">$</span>response)]))) {</span>
<span id="cb15-131"><a href="#cb15-131" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb15-132"><a href="#cb15-132" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb15-133"><a href="#cb15-133" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-134"><a href="#cb15-134" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Continue with data that doesn't have NA responses</span></span>
<span id="cb15-135"><a href="#cb15-135" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(response))</span>
<span id="cb15-136"><a href="#cb15-136" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-137"><a href="#cb15-137" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create survey design object including the response variable</span></span>
<span id="cb15-138"><a href="#cb15-138" aria-hidden="true" tabindex="-1"></a>    survey_design <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="sc">~</span>Primary_Samp_Unit,</span>
<span id="cb15-139"><a href="#cb15-139" aria-hidden="true" tabindex="-1"></a>                               <span class="at">strata =</span> <span class="sc">~</span>Stratum,</span>
<span id="cb15-140"><a href="#cb15-140" aria-hidden="true" tabindex="-1"></a>                               <span class="at">weights =</span> <span class="sc">~</span>Final_Weight,</span>
<span id="cb15-141"><a href="#cb15-141" aria-hidden="true" tabindex="-1"></a>                               <span class="at">data =</span> data_filtered,</span>
<span id="cb15-142"><a href="#cb15-142" aria-hidden="true" tabindex="-1"></a>                               <span class="at">nest =</span> <span class="cn">TRUE</span>) </span>
<span id="cb15-143"><a href="#cb15-143" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-144"><a href="#cb15-144" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Perform Welch's t-test using the survey design object</span></span>
<span id="cb15-145"><a href="#cb15-145" aria-hidden="true" tabindex="-1"></a>    ttest_result <span class="ot">&lt;-</span> <span class="fu">svyttest</span>(response <span class="sc">~</span> <span class="fu">as.factor</span>(Survey_Year), survey_design)</span>
<span id="cb15-146"><a href="#cb15-146" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-147"><a href="#cb15-147" aria-hidden="true" tabindex="-1"></a>    <span class="co"># head t-test results</span></span>
<span id="cb15-148"><a href="#cb15-148" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(ttest_result)</span>
<span id="cb15-149"><a href="#cb15-149" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-150"><a href="#cb15-150" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check significance and interpret the results</span></span>
<span id="cb15-151"><a href="#cb15-151" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(ttest_result<span class="sc">$</span>p.value) <span class="sc">&amp;&amp;</span> ttest_result<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>) {</span>
<span id="cb15-152"><a href="#cb15-152" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(ttest_result<span class="sc">$</span>estimate <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Significant Increase"</span>, <span class="st">"Significant Decrease"</span>)</span>
<span id="cb15-153"><a href="#cb15-153" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb15-154"><a href="#cb15-154" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="st">"No Change"</span></span>
<span id="cb15-155"><a href="#cb15-155" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb15-156"><a href="#cb15-156" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-157"><a href="#cb15-157" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> trend))</span>
<span id="cb15-158"><a href="#cb15-158" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-159"><a href="#cb15-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-160"><a href="#cb15-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-161"><a href="#cb15-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-162"><a href="#cb15-162" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the short-term function to each ROI_Indicator_Code</span></span>
<span id="cb15-163"><a href="#cb15-163" aria-hidden="true" tabindex="-1"></a>short_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(raw_stwd_general)[<span class="fu">grep</span>(<span class="st">"^(QN|V).*[RP]"</span>, <span class="fu">names</span>(raw_stwd_general))], <span class="cf">function</span>(column_name) {</span>
<span id="cb15-164"><a href="#cb15-164" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_short_term_trend_ttest</span>(raw_stwd_general, column_name)</span>
<span id="cb15-165"><a href="#cb15-165" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb15-166"><a href="#cb15-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-167"><a href="#cb15-167" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(short_trend_results)</span>
<span id="cb15-168"><a href="#cb15-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-169"><a href="#cb15-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-170"><a href="#cb15-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-171"><a href="#cb15-171" aria-hidden="true" tabindex="-1"></a><span class="do">################### Join Together with Trend Tables ############</span></span>
<span id="cb15-172"><a href="#cb15-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-173"><a href="#cb15-173" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine long-term and short-term results</span></span>
<span id="cb15-174"><a href="#cb15-174" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> <span class="fu">left_join</span>(long_trend_results, </span>
<span id="cb15-175"><a href="#cb15-175" aria-hidden="true" tabindex="-1"></a>                                    short_trend_results, </span>
<span id="cb15-176"><a href="#cb15-176" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">by =</span> <span class="st">"ROI_Indicator_Code"</span>)</span>
<span id="cb15-177"><a href="#cb15-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-178"><a href="#cb15-178" aria-hidden="true" tabindex="-1"></a><span class="co">#head(combined_trend_results)</span></span>
<span id="cb15-179"><a href="#cb15-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-180"><a href="#cb15-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-181"><a href="#cb15-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-182"><a href="#cb15-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-183"><a href="#cb15-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-184"><a href="#cb15-184" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge Long_Term_Trend into yrbs_master_stwd_grade based on matching ROI_Indicator_Code and Trend_Category</span></span>
<span id="cb15-185"><a href="#cb15-185" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> yrbs_master_analysis_stwd_trend <span class="sc">%&gt;%</span></span>
<span id="cb15-186"><a href="#cb15-186" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(combined_trend_results <span class="sc">%&gt;%</span> <span class="fu">select</span>(ROI_Indicator_Code, Long_Term_Trend, Short_Term_Trend),</span>
<span id="cb15-187"><a href="#cb15-187" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ROI_Indicator_Code"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb15-188"><a href="#cb15-188" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(School_Type,</span>
<span id="cb15-189"><a href="#cb15-189" aria-hidden="true" tabindex="-1"></a>         Health_Topic, </span>
<span id="cb15-190"><a href="#cb15-190" aria-hidden="true" tabindex="-1"></a>         ROI_Indicator_Code, </span>
<span id="cb15-191"><a href="#cb15-191" aria-hidden="true" tabindex="-1"></a>         Indicator_Long_Description, </span>
<span id="cb15-192"><a href="#cb15-192" aria-hidden="true" tabindex="-1"></a>         Trend_Category, </span>
<span id="cb15-193"><a href="#cb15-193" aria-hidden="true" tabindex="-1"></a>         <span class="fu">everything</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb15-194"><a href="#cb15-194" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, </span>
<span id="cb15-195"><a href="#cb15-195" aria-hidden="true" tabindex="-1"></a>          ROI_Indicator_Code, </span>
<span id="cb15-196"><a href="#cb15-196" aria-hidden="true" tabindex="-1"></a>          Trend_Category)</span>
<span id="cb15-197"><a href="#cb15-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-198"><a href="#cb15-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-199"><a href="#cb15-199" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to check for three consecutive NAs in a set of columns</span></span>
<span id="cb15-200"><a href="#cb15-200" aria-hidden="true" tabindex="-1"></a>check_consecutive_nas <span class="ot">&lt;-</span> <span class="cf">function</span>(year_values) {</span>
<span id="cb15-201"><a href="#cb15-201" aria-hidden="true" tabindex="-1"></a>  na_run_lengths <span class="ot">&lt;-</span> <span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>lengths[<span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>values]</span>
<span id="cb15-202"><a href="#cb15-202" aria-hidden="true" tabindex="-1"></a>  <span class="fu">any</span>(na_run_lengths <span class="sc">&gt;=</span> <span class="dv">3</span>)</span>
<span id="cb15-203"><a href="#cb15-203" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-204"><a href="#cb15-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-205"><a href="#cb15-205" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert all columns representing years to numeric</span></span>
<span id="cb15-206"><a href="#cb15-206" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb15-207"><a href="#cb15-207" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">d+$"</span>), as.numeric))</span>
<span id="cb15-208"><a href="#cb15-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-209"><a href="#cb15-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-210"><a href="#cb15-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-211"><a href="#cb15-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-212"><a href="#cb15-212" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge and mutate Long_Term_Trend</span></span>
<span id="cb15-213"><a href="#cb15-213" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb15-214"><a href="#cb15-214" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb15-215"><a href="#cb15-215" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Long_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">check_consecutive_nas</span>(<span class="fu">c_across</span>(<span class="st">`</span><span class="at">2011</span><span class="st">`</span><span class="sc">:</span><span class="st">`</span><span class="at">2023</span><span class="st">`</span>)), </span>
<span id="cb15-216"><a href="#cb15-216" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb15-217"><a href="#cb15-217" aria-hidden="true" tabindex="-1"></a>                                  Long_Term_Trend),</span>
<span id="cb15-218"><a href="#cb15-218" aria-hidden="true" tabindex="-1"></a>         <span class="at">Short_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(<span class="st">`</span><span class="at">2019</span><span class="st">`</span>) <span class="sc">|</span> <span class="fu">is.na</span>(<span class="st">`</span><span class="at">2023</span><span class="st">`</span>), </span>
<span id="cb15-219"><a href="#cb15-219" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb15-220"><a href="#cb15-220" aria-hidden="true" tabindex="-1"></a>                                   Short_Term_Trend)) <span class="sc">%&gt;%</span></span>
<span id="cb15-221"><a href="#cb15-221" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb15-222"><a href="#cb15-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-223"><a href="#cb15-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-224"><a href="#cb15-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-225"><a href="#cb15-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-226"><a href="#cb15-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-227"><a href="#cb15-227" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results)</span>
<span id="cb15-228"><a href="#cb15-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-229"><a href="#cb15-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-230"><a href="#cb15-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-231"><a href="#cb15-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-232"><a href="#cb15-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-233"><a href="#cb15-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-234"><a href="#cb15-234" aria-hidden="true" tabindex="-1"></a>trend_results_race_3_ANAI <span class="ot">&lt;-</span> trend_results</span>
<span id="cb15-235"><a href="#cb15-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-236"><a href="#cb15-236" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results_race_3_ANAI)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="white-1" class="level4">
<h4 class="anchored" data-anchor-id="white-1">3.2 - White</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="do">######## Import Raw and Analyzed Excel Files ###############</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>yrbs_master_analysis_stwd_trend <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Race_Group_3 Trend"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Trend_Category <span class="sc">==</span> <span class="st">"White"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="st">"Suppressed"</span>, <span class="cn">NA</span>, .)))</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the raw data set to be used in trend analyis</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>raw_stwd_general <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"raw_yrbs_allyears_statewide_trad_cleaned.xlsx"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Race_Group_3 <span class="sc">==</span> <span class="st">"White"</span>,</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>         Survey_Year <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2011</span>,</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2013</span>, </span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2015</span>, </span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2017</span>,</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2019</span>, </span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2023</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>                            )) <span class="sc">%&gt;%</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">2</span>, <span class="dv">0</span>, <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="cn">NA</span>))))</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine which survey questions (ROI - Response of Interest) have data across at least two distinct survey years</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>roi_years <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), Survey_Year) <span class="sc">%&gt;%</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>Survey_Year, </span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"ROI_Indicator_Code"</span>, </span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ROI_Indicator_Code) <span class="sc">%&gt;%</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">unique_years =</span> <span class="fu">n_distinct</span>(Survey_Year), </span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(unique_years <span class="sc">&gt;=</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(ROI_Indicator_Code)</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the main data set to include only those ROIs, also ensuring to keep necessary demographic variables</span></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>filtered_raw_stwd_general <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Survey_Year, <span class="fu">all_of</span>(roi_years), Sex, Grade, Primary_Samp_Unit,Stratum,Final_Weight)</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a><span class="do">############ Long Term Trend ###############</span></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a><span class="co">#Trend Analysis Function</span></span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>analyze_trend_logistic <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Survey Design for YRBS Statewide</span></span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_survey_design</span>(<span class="at">ids =</span> Primary_Samp_Unit,</span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>                     <span class="at">strata =</span> Stratum,</span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>                     <span class="at">weights =</span> Final_Weight,</span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span></span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Sex =</span> <span class="fu">factor</span>(Sex), <span class="at">Grade =</span> <span class="fu">factor</span>(Grade))</span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(data_filtered) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">length</span>(<span class="fu">unique</span>(data_filtered<span class="sc">$</span>variables<span class="sc">$</span>Survey_Year)) <span class="sc">&lt;</span> <span class="dv">4</span>) {</span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>  base_formula <span class="ot">&lt;-</span> <span class="fu">paste</span>(column_name, <span class="st">"~ Sex + Grade + Survey_Year"</span>) </span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit the model using logistic regression</span></span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a>    <span class="fu">svyglm</span>(<span class="fu">as.formula</span>(base_formula), <span class="at">design =</span> data_filtered, <span class="at">family =</span> <span class="fu">quasibinomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Error fitting model: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if model fitting was successful</span></span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(model)) {</span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error"</span>))</span>
<span id="cb16-72"><a href="#cb16-72" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-73"><a href="#cb16-73" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-74"><a href="#cb16-74" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check for coefficients</span></span>
<span id="cb16-75"><a href="#cb16-75" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>(<span class="st">"Survey_Year"</span> <span class="sc">%in%</span> <span class="fu">names</span>(<span class="fu">coef</span>(model)))) {</span>
<span id="cb16-76"><a href="#cb16-76" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No valid coefficient for Survey_Year"</span>))</span>
<span id="cb16-77"><a href="#cb16-77" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-78"><a href="#cb16-78" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-79"><a href="#cb16-79" aria-hidden="true" tabindex="-1"></a>  coef_summary <span class="ot">=</span> <span class="fu">summary</span>(model)<span class="sc">$</span>coefficients</span>
<span id="cb16-80"><a href="#cb16-80" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(coef_summary) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb16-81"><a href="#cb16-81" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error: No coefficients"</span>))</span>
<span id="cb16-82"><a href="#cb16-82" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-83"><a href="#cb16-83" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-84"><a href="#cb16-84" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Determine the significance and direction of the trend</span></span>
<span id="cb16-85"><a href="#cb16-85" aria-hidden="true" tabindex="-1"></a>  p_value <span class="ot">=</span> coef_summary[<span class="st">"Survey_Year"</span>, <span class="st">"Pr(&gt;|t|)"</span>]</span>
<span id="cb16-86"><a href="#cb16-86" aria-hidden="true" tabindex="-1"></a>  coefficient <span class="ot">=</span> <span class="fu">coef</span>(model)[<span class="st">"Survey_Year"</span>]</span>
<span id="cb16-87"><a href="#cb16-87" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-88"><a href="#cb16-88" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(p_value)) {</span>
<span id="cb16-89"><a href="#cb16-89" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"P-value is NA"</span>))</span>
<span id="cb16-90"><a href="#cb16-90" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-91"><a href="#cb16-91" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-92"><a href="#cb16-92" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (p_value <span class="sc">&lt;=</span> <span class="fl">0.05</span>) {</span>
<span id="cb16-93"><a href="#cb16-93" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (coefficient <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb16-94"><a href="#cb16-94" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Increase"</span>))</span>
<span id="cb16-95"><a href="#cb16-95" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb16-96"><a href="#cb16-96" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Decrease"</span>))</span>
<span id="cb16-97"><a href="#cb16-97" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb16-98"><a href="#cb16-98" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb16-99"><a href="#cb16-99" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No Change"</span>))</span>
<span id="cb16-100"><a href="#cb16-100" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-101"><a href="#cb16-101" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-102"><a href="#cb16-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-103"><a href="#cb16-103" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the function to each ROI_Indicator_Code that has sufficient data</span></span>
<span id="cb16-104"><a href="#cb16-104" aria-hidden="true" tabindex="-1"></a>long_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(filtered_raw_stwd_general)[<span class="sc">-</span><span class="dv">1</span>], <span class="cf">function</span>(column_name) {</span>
<span id="cb16-105"><a href="#cb16-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_trend_logistic</span>(filtered_raw_stwd_general, column_name)</span>
<span id="cb16-106"><a href="#cb16-106" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb16-107"><a href="#cb16-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-108"><a href="#cb16-108" aria-hidden="true" tabindex="-1"></a><span class="co"># Show results</span></span>
<span id="cb16-109"><a href="#cb16-109" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(long_trend_results)</span>
<span id="cb16-110"><a href="#cb16-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-111"><a href="#cb16-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-112"><a href="#cb16-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-113"><a href="#cb16-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-114"><a href="#cb16-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-115"><a href="#cb16-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-116"><a href="#cb16-116" aria-hidden="true" tabindex="-1"></a><span class="do">######### Short Term Trend ###############</span></span>
<span id="cb16-117"><a href="#cb16-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-118"><a href="#cb16-118" aria-hidden="true" tabindex="-1"></a>analyze_short_term_trend_ttest <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb16-119"><a href="#cb16-119" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the short-term years</span></span>
<span id="cb16-120"><a href="#cb16-120" aria-hidden="true" tabindex="-1"></a>    short_term_years <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2019</span>, <span class="dv">2023</span>)</span>
<span id="cb16-121"><a href="#cb16-121" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-122"><a href="#cb16-122" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter for short-term years and ensure all necessary variables are selected</span></span>
<span id="cb16-123"><a href="#cb16-123" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb16-124"><a href="#cb16-124" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(Survey_Year <span class="sc">%in%</span> short_term_years) <span class="sc">%&gt;%</span></span>
<span id="cb16-125"><a href="#cb16-125" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(Primary_Samp_Unit, Stratum, Final_Weight, Survey_Year, <span class="fu">all_of</span>(column_name)) <span class="sc">%&gt;%</span></span>
<span id="cb16-126"><a href="#cb16-126" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">response =</span> <span class="fu">get</span>(column_name) <span class="sc">==</span> <span class="dv">1</span>)  <span class="co"># Create a binary response variable for the analysis</span></span>
<span id="cb16-127"><a href="#cb16-127" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-128"><a href="#cb16-128" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if data is available for both years</span></span>
<span id="cb16-129"><a href="#cb16-129" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(short_term_years <span class="sc">%in%</span> <span class="fu">unique</span>(data_filtered<span class="sc">$</span>Survey_Year[<span class="sc">!</span><span class="fu">is.na</span>(data_filtered<span class="sc">$</span>response)]))) {</span>
<span id="cb16-130"><a href="#cb16-130" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb16-131"><a href="#cb16-131" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb16-132"><a href="#cb16-132" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-133"><a href="#cb16-133" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Continue with data that doesn't have NA responses</span></span>
<span id="cb16-134"><a href="#cb16-134" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(response))</span>
<span id="cb16-135"><a href="#cb16-135" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-136"><a href="#cb16-136" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create survey design object including the response variable</span></span>
<span id="cb16-137"><a href="#cb16-137" aria-hidden="true" tabindex="-1"></a>    survey_design <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="sc">~</span>Primary_Samp_Unit,</span>
<span id="cb16-138"><a href="#cb16-138" aria-hidden="true" tabindex="-1"></a>                               <span class="at">strata =</span> <span class="sc">~</span>Stratum,</span>
<span id="cb16-139"><a href="#cb16-139" aria-hidden="true" tabindex="-1"></a>                               <span class="at">weights =</span> <span class="sc">~</span>Final_Weight,</span>
<span id="cb16-140"><a href="#cb16-140" aria-hidden="true" tabindex="-1"></a>                               <span class="at">data =</span> data_filtered,</span>
<span id="cb16-141"><a href="#cb16-141" aria-hidden="true" tabindex="-1"></a>                               <span class="at">nest =</span> <span class="cn">TRUE</span>) </span>
<span id="cb16-142"><a href="#cb16-142" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-143"><a href="#cb16-143" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Perform Welch's t-test using the survey design object</span></span>
<span id="cb16-144"><a href="#cb16-144" aria-hidden="true" tabindex="-1"></a>    ttest_result <span class="ot">&lt;-</span> <span class="fu">svyttest</span>(response <span class="sc">~</span> <span class="fu">as.factor</span>(Survey_Year), survey_design)</span>
<span id="cb16-145"><a href="#cb16-145" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-146"><a href="#cb16-146" aria-hidden="true" tabindex="-1"></a>    <span class="co"># head t-test results</span></span>
<span id="cb16-147"><a href="#cb16-147" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(ttest_result)</span>
<span id="cb16-148"><a href="#cb16-148" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-149"><a href="#cb16-149" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check significance and interpret the results</span></span>
<span id="cb16-150"><a href="#cb16-150" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(ttest_result<span class="sc">$</span>p.value) <span class="sc">&amp;&amp;</span> ttest_result<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>) {</span>
<span id="cb16-151"><a href="#cb16-151" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(ttest_result<span class="sc">$</span>estimate <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Significant Increase"</span>, <span class="st">"Significant Decrease"</span>)</span>
<span id="cb16-152"><a href="#cb16-152" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb16-153"><a href="#cb16-153" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="st">"No Change"</span></span>
<span id="cb16-154"><a href="#cb16-154" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb16-155"><a href="#cb16-155" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-156"><a href="#cb16-156" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> trend))</span>
<span id="cb16-157"><a href="#cb16-157" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-158"><a href="#cb16-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-159"><a href="#cb16-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-160"><a href="#cb16-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-161"><a href="#cb16-161" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the short-term function to each ROI_Indicator_Code</span></span>
<span id="cb16-162"><a href="#cb16-162" aria-hidden="true" tabindex="-1"></a>short_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(raw_stwd_general)[<span class="fu">grep</span>(<span class="st">"^(QN|V).*[RP]"</span>, <span class="fu">names</span>(raw_stwd_general))], <span class="cf">function</span>(column_name) {</span>
<span id="cb16-163"><a href="#cb16-163" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_short_term_trend_ttest</span>(raw_stwd_general, column_name)</span>
<span id="cb16-164"><a href="#cb16-164" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb16-165"><a href="#cb16-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-166"><a href="#cb16-166" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(short_trend_results)</span>
<span id="cb16-167"><a href="#cb16-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-168"><a href="#cb16-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-169"><a href="#cb16-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-170"><a href="#cb16-170" aria-hidden="true" tabindex="-1"></a><span class="do">################### Join Together with Trend Tables ############</span></span>
<span id="cb16-171"><a href="#cb16-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-172"><a href="#cb16-172" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine long-term and short-term results</span></span>
<span id="cb16-173"><a href="#cb16-173" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> <span class="fu">left_join</span>(long_trend_results, </span>
<span id="cb16-174"><a href="#cb16-174" aria-hidden="true" tabindex="-1"></a>                                    short_trend_results, </span>
<span id="cb16-175"><a href="#cb16-175" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">by =</span> <span class="st">"ROI_Indicator_Code"</span>)</span>
<span id="cb16-176"><a href="#cb16-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-177"><a href="#cb16-177" aria-hidden="true" tabindex="-1"></a><span class="co">#head(combined_trend_results)</span></span>
<span id="cb16-178"><a href="#cb16-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-179"><a href="#cb16-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-180"><a href="#cb16-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-181"><a href="#cb16-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-182"><a href="#cb16-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-183"><a href="#cb16-183" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge Long_Term_Trend into yrbs_master_stwd_grade based on matching ROI_Indicator_Code and Trend_Category</span></span>
<span id="cb16-184"><a href="#cb16-184" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> yrbs_master_analysis_stwd_trend <span class="sc">%&gt;%</span></span>
<span id="cb16-185"><a href="#cb16-185" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(combined_trend_results <span class="sc">%&gt;%</span> <span class="fu">select</span>(ROI_Indicator_Code, Long_Term_Trend, Short_Term_Trend),</span>
<span id="cb16-186"><a href="#cb16-186" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ROI_Indicator_Code"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb16-187"><a href="#cb16-187" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(School_Type,</span>
<span id="cb16-188"><a href="#cb16-188" aria-hidden="true" tabindex="-1"></a>         Health_Topic, </span>
<span id="cb16-189"><a href="#cb16-189" aria-hidden="true" tabindex="-1"></a>         ROI_Indicator_Code, </span>
<span id="cb16-190"><a href="#cb16-190" aria-hidden="true" tabindex="-1"></a>         Indicator_Long_Description, </span>
<span id="cb16-191"><a href="#cb16-191" aria-hidden="true" tabindex="-1"></a>         Trend_Category, </span>
<span id="cb16-192"><a href="#cb16-192" aria-hidden="true" tabindex="-1"></a>         <span class="fu">everything</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb16-193"><a href="#cb16-193" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, </span>
<span id="cb16-194"><a href="#cb16-194" aria-hidden="true" tabindex="-1"></a>          ROI_Indicator_Code, </span>
<span id="cb16-195"><a href="#cb16-195" aria-hidden="true" tabindex="-1"></a>          Trend_Category)</span>
<span id="cb16-196"><a href="#cb16-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-197"><a href="#cb16-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-198"><a href="#cb16-198" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to check for three consecutive NAs in a set of columns</span></span>
<span id="cb16-199"><a href="#cb16-199" aria-hidden="true" tabindex="-1"></a>check_consecutive_nas <span class="ot">&lt;-</span> <span class="cf">function</span>(year_values) {</span>
<span id="cb16-200"><a href="#cb16-200" aria-hidden="true" tabindex="-1"></a>  na_run_lengths <span class="ot">&lt;-</span> <span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>lengths[<span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>values]</span>
<span id="cb16-201"><a href="#cb16-201" aria-hidden="true" tabindex="-1"></a>  <span class="fu">any</span>(na_run_lengths <span class="sc">&gt;=</span> <span class="dv">3</span>)</span>
<span id="cb16-202"><a href="#cb16-202" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-203"><a href="#cb16-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-204"><a href="#cb16-204" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert all columns representing years to numeric</span></span>
<span id="cb16-205"><a href="#cb16-205" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb16-206"><a href="#cb16-206" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">d+$"</span>), as.numeric))</span>
<span id="cb16-207"><a href="#cb16-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-208"><a href="#cb16-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-209"><a href="#cb16-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-210"><a href="#cb16-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-211"><a href="#cb16-211" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge and mutate Long_Term_Trend</span></span>
<span id="cb16-212"><a href="#cb16-212" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb16-213"><a href="#cb16-213" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb16-214"><a href="#cb16-214" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Long_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">check_consecutive_nas</span>(<span class="fu">c_across</span>(<span class="st">`</span><span class="at">2011</span><span class="st">`</span><span class="sc">:</span><span class="st">`</span><span class="at">2023</span><span class="st">`</span>)), </span>
<span id="cb16-215"><a href="#cb16-215" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb16-216"><a href="#cb16-216" aria-hidden="true" tabindex="-1"></a>                                  Long_Term_Trend),</span>
<span id="cb16-217"><a href="#cb16-217" aria-hidden="true" tabindex="-1"></a>         <span class="at">Short_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(<span class="st">`</span><span class="at">2019</span><span class="st">`</span>) <span class="sc">|</span> <span class="fu">is.na</span>(<span class="st">`</span><span class="at">2023</span><span class="st">`</span>), </span>
<span id="cb16-218"><a href="#cb16-218" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb16-219"><a href="#cb16-219" aria-hidden="true" tabindex="-1"></a>                                   Short_Term_Trend)) <span class="sc">%&gt;%</span></span>
<span id="cb16-220"><a href="#cb16-220" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb16-221"><a href="#cb16-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-222"><a href="#cb16-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-223"><a href="#cb16-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-224"><a href="#cb16-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-225"><a href="#cb16-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-226"><a href="#cb16-226" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results)</span>
<span id="cb16-227"><a href="#cb16-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-228"><a href="#cb16-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-229"><a href="#cb16-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-230"><a href="#cb16-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-231"><a href="#cb16-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-232"><a href="#cb16-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-233"><a href="#cb16-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-234"><a href="#cb16-234" aria-hidden="true" tabindex="-1"></a>trend_results_race_3_white <span class="ot">&lt;-</span> trend_results</span>
<span id="cb16-235"><a href="#cb16-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-236"><a href="#cb16-236" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results_race_3_white)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="othermultiple" class="level4">
<h4 class="anchored" data-anchor-id="othermultiple">3.3 - Other/Multiple</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="do">######## Import Raw and Analyzed Excel Files ###############</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>yrbs_master_analysis_stwd_trend <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Race_Group_3 Trend"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Trend_Category <span class="sc">==</span> <span class="st">"Other/Multiple"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="st">"Suppressed"</span>, <span class="cn">NA</span>, .)))</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the raw data set to be used in trend analyis</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>raw_stwd_general <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"raw_yrbs_allyears_statewide_trad_cleaned.xlsx"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Race_Group_3 <span class="sc">==</span> <span class="st">"Other/Multiple"</span>,</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>         Survey_Year <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2011</span>,</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2013</span>, </span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2015</span>, </span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2017</span>,</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2019</span>, </span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2023</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>                            )) <span class="sc">%&gt;%</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">2</span>, <span class="dv">0</span>, <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="cn">NA</span>))))</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine which survey questions (ROI - Response of Interest) have data across at least two distinct survey years</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>roi_years <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), Survey_Year) <span class="sc">%&gt;%</span></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>Survey_Year, </span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"ROI_Indicator_Code"</span>, </span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ROI_Indicator_Code) <span class="sc">%&gt;%</span></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">unique_years =</span> <span class="fu">n_distinct</span>(Survey_Year), </span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(unique_years <span class="sc">&gt;=</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(ROI_Indicator_Code)</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the main data set to include only those ROIs, also ensuring to keep necessary demographic variables</span></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>filtered_raw_stwd_general <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Survey_Year, <span class="fu">all_of</span>(roi_years), Sex, Grade, Primary_Samp_Unit,Stratum,Final_Weight)</span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a><span class="do">############ Long Term Trend ###############</span></span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a><span class="co">#Trend Analysis Function</span></span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>analyze_trend_logistic <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Survey Design for YRBS Statewide</span></span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_survey_design</span>(<span class="at">ids =</span> Primary_Samp_Unit,</span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>                     <span class="at">strata =</span> Stratum,</span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>                     <span class="at">weights =</span> Final_Weight,</span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span></span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Sex =</span> <span class="fu">factor</span>(Sex), <span class="at">Grade =</span> <span class="fu">factor</span>(Grade))</span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(data_filtered) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">length</span>(<span class="fu">unique</span>(data_filtered<span class="sc">$</span>variables<span class="sc">$</span>Survey_Year)) <span class="sc">&lt;</span> <span class="dv">4</span>) {</span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a>  base_formula <span class="ot">&lt;-</span> <span class="fu">paste</span>(column_name, <span class="st">"~ Sex + Grade + Survey_Year"</span>) </span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit the model using logistic regression</span></span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb17-66"><a href="#cb17-66" aria-hidden="true" tabindex="-1"></a>    <span class="fu">svyglm</span>(<span class="fu">as.formula</span>(base_formula), <span class="at">design =</span> data_filtered, <span class="at">family =</span> <span class="fu">quasibinomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb17-67"><a href="#cb17-67" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb17-68"><a href="#cb17-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Error fitting model: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb17-69"><a href="#cb17-69" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb17-70"><a href="#cb17-70" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb17-71"><a href="#cb17-71" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-72"><a href="#cb17-72" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if model fitting was successful</span></span>
<span id="cb17-73"><a href="#cb17-73" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(model)) {</span>
<span id="cb17-74"><a href="#cb17-74" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error"</span>))</span>
<span id="cb17-75"><a href="#cb17-75" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb17-76"><a href="#cb17-76" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-77"><a href="#cb17-77" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check for coefficients</span></span>
<span id="cb17-78"><a href="#cb17-78" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>(<span class="st">"Survey_Year"</span> <span class="sc">%in%</span> <span class="fu">names</span>(<span class="fu">coef</span>(model)))) {</span>
<span id="cb17-79"><a href="#cb17-79" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No valid coefficient for Survey_Year"</span>))</span>
<span id="cb17-80"><a href="#cb17-80" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb17-81"><a href="#cb17-81" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-82"><a href="#cb17-82" aria-hidden="true" tabindex="-1"></a>  coef_summary <span class="ot">=</span> <span class="fu">summary</span>(model)<span class="sc">$</span>coefficients</span>
<span id="cb17-83"><a href="#cb17-83" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(coef_summary) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb17-84"><a href="#cb17-84" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error: No coefficients"</span>))</span>
<span id="cb17-85"><a href="#cb17-85" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb17-86"><a href="#cb17-86" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-87"><a href="#cb17-87" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Determine the significance and direction of the trend</span></span>
<span id="cb17-88"><a href="#cb17-88" aria-hidden="true" tabindex="-1"></a>  p_value <span class="ot">=</span> coef_summary[<span class="st">"Survey_Year"</span>, <span class="st">"Pr(&gt;|t|)"</span>]</span>
<span id="cb17-89"><a href="#cb17-89" aria-hidden="true" tabindex="-1"></a>  coefficient <span class="ot">=</span> <span class="fu">coef</span>(model)[<span class="st">"Survey_Year"</span>]</span>
<span id="cb17-90"><a href="#cb17-90" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-91"><a href="#cb17-91" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(p_value)) {</span>
<span id="cb17-92"><a href="#cb17-92" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"P-value is NA"</span>))</span>
<span id="cb17-93"><a href="#cb17-93" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb17-94"><a href="#cb17-94" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-95"><a href="#cb17-95" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (p_value <span class="sc">&lt;=</span> <span class="fl">0.05</span>) {</span>
<span id="cb17-96"><a href="#cb17-96" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (coefficient <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb17-97"><a href="#cb17-97" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Increase"</span>))</span>
<span id="cb17-98"><a href="#cb17-98" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb17-99"><a href="#cb17-99" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Decrease"</span>))</span>
<span id="cb17-100"><a href="#cb17-100" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-101"><a href="#cb17-101" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb17-102"><a href="#cb17-102" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No Change"</span>))</span>
<span id="cb17-103"><a href="#cb17-103" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb17-104"><a href="#cb17-104" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-105"><a href="#cb17-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-106"><a href="#cb17-106" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the function to each ROI_Indicator_Code that has sufficient data</span></span>
<span id="cb17-107"><a href="#cb17-107" aria-hidden="true" tabindex="-1"></a>long_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(filtered_raw_stwd_general)[<span class="sc">-</span><span class="dv">1</span>], <span class="cf">function</span>(column_name) {</span>
<span id="cb17-108"><a href="#cb17-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_trend_logistic</span>(filtered_raw_stwd_general, column_name)</span>
<span id="cb17-109"><a href="#cb17-109" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb17-110"><a href="#cb17-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-111"><a href="#cb17-111" aria-hidden="true" tabindex="-1"></a><span class="co"># Show results</span></span>
<span id="cb17-112"><a href="#cb17-112" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(long_trend_results)</span>
<span id="cb17-113"><a href="#cb17-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-114"><a href="#cb17-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-115"><a href="#cb17-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-116"><a href="#cb17-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-117"><a href="#cb17-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-118"><a href="#cb17-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-119"><a href="#cb17-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-120"><a href="#cb17-120" aria-hidden="true" tabindex="-1"></a><span class="do">######### Short Term Trend ###############</span></span>
<span id="cb17-121"><a href="#cb17-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-122"><a href="#cb17-122" aria-hidden="true" tabindex="-1"></a>analyze_short_term_trend_ttest <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb17-123"><a href="#cb17-123" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the short-term years</span></span>
<span id="cb17-124"><a href="#cb17-124" aria-hidden="true" tabindex="-1"></a>    short_term_years <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2019</span>, <span class="dv">2023</span>)</span>
<span id="cb17-125"><a href="#cb17-125" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-126"><a href="#cb17-126" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter for short-term years and ensure all necessary variables are selected</span></span>
<span id="cb17-127"><a href="#cb17-127" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb17-128"><a href="#cb17-128" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(Survey_Year <span class="sc">%in%</span> short_term_years) <span class="sc">%&gt;%</span></span>
<span id="cb17-129"><a href="#cb17-129" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(Primary_Samp_Unit, Stratum, Final_Weight, Survey_Year, <span class="fu">all_of</span>(column_name)) <span class="sc">%&gt;%</span></span>
<span id="cb17-130"><a href="#cb17-130" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">response =</span> <span class="fu">get</span>(column_name) <span class="sc">==</span> <span class="dv">1</span>)  <span class="co"># Create a binary response variable for the analysis</span></span>
<span id="cb17-131"><a href="#cb17-131" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-132"><a href="#cb17-132" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if data is available for both years</span></span>
<span id="cb17-133"><a href="#cb17-133" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(short_term_years <span class="sc">%in%</span> <span class="fu">unique</span>(data_filtered<span class="sc">$</span>Survey_Year[<span class="sc">!</span><span class="fu">is.na</span>(data_filtered<span class="sc">$</span>response)]))) {</span>
<span id="cb17-134"><a href="#cb17-134" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb17-135"><a href="#cb17-135" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-136"><a href="#cb17-136" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-137"><a href="#cb17-137" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Continue with data that doesn't have NA responses</span></span>
<span id="cb17-138"><a href="#cb17-138" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(response))</span>
<span id="cb17-139"><a href="#cb17-139" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-140"><a href="#cb17-140" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create survey design object including the response variable</span></span>
<span id="cb17-141"><a href="#cb17-141" aria-hidden="true" tabindex="-1"></a>    survey_design <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="sc">~</span>Primary_Samp_Unit,</span>
<span id="cb17-142"><a href="#cb17-142" aria-hidden="true" tabindex="-1"></a>                               <span class="at">strata =</span> <span class="sc">~</span>Stratum,</span>
<span id="cb17-143"><a href="#cb17-143" aria-hidden="true" tabindex="-1"></a>                               <span class="at">weights =</span> <span class="sc">~</span>Final_Weight,</span>
<span id="cb17-144"><a href="#cb17-144" aria-hidden="true" tabindex="-1"></a>                               <span class="at">data =</span> data_filtered,</span>
<span id="cb17-145"><a href="#cb17-145" aria-hidden="true" tabindex="-1"></a>                               <span class="at">nest =</span> <span class="cn">TRUE</span>) </span>
<span id="cb17-146"><a href="#cb17-146" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-147"><a href="#cb17-147" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Perform Welch's t-test using the survey design object</span></span>
<span id="cb17-148"><a href="#cb17-148" aria-hidden="true" tabindex="-1"></a>    ttest_result <span class="ot">&lt;-</span> <span class="fu">svyttest</span>(response <span class="sc">~</span> <span class="fu">as.factor</span>(Survey_Year), survey_design)</span>
<span id="cb17-149"><a href="#cb17-149" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-150"><a href="#cb17-150" aria-hidden="true" tabindex="-1"></a>    <span class="co"># head t-test results</span></span>
<span id="cb17-151"><a href="#cb17-151" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(ttest_result)</span>
<span id="cb17-152"><a href="#cb17-152" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-153"><a href="#cb17-153" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check significance and interpret the results</span></span>
<span id="cb17-154"><a href="#cb17-154" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(ttest_result<span class="sc">$</span>p.value) <span class="sc">&amp;&amp;</span> ttest_result<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>) {</span>
<span id="cb17-155"><a href="#cb17-155" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(ttest_result<span class="sc">$</span>estimate <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Significant Increase"</span>, <span class="st">"Significant Decrease"</span>)</span>
<span id="cb17-156"><a href="#cb17-156" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb17-157"><a href="#cb17-157" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="st">"No Change"</span></span>
<span id="cb17-158"><a href="#cb17-158" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-159"><a href="#cb17-159" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-160"><a href="#cb17-160" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> trend))</span>
<span id="cb17-161"><a href="#cb17-161" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-162"><a href="#cb17-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-163"><a href="#cb17-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-164"><a href="#cb17-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-165"><a href="#cb17-165" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the short-term function to each ROI_Indicator_Code</span></span>
<span id="cb17-166"><a href="#cb17-166" aria-hidden="true" tabindex="-1"></a>short_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(raw_stwd_general)[<span class="fu">grep</span>(<span class="st">"^(QN|V).*[RP]"</span>, <span class="fu">names</span>(raw_stwd_general))], <span class="cf">function</span>(column_name) {</span>
<span id="cb17-167"><a href="#cb17-167" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_short_term_trend_ttest</span>(raw_stwd_general, column_name)</span>
<span id="cb17-168"><a href="#cb17-168" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb17-169"><a href="#cb17-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-170"><a href="#cb17-170" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(short_trend_results)</span>
<span id="cb17-171"><a href="#cb17-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-172"><a href="#cb17-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-173"><a href="#cb17-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-174"><a href="#cb17-174" aria-hidden="true" tabindex="-1"></a><span class="do">################### Join Together with Trend Tables ############</span></span>
<span id="cb17-175"><a href="#cb17-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-176"><a href="#cb17-176" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine long-term and short-term results</span></span>
<span id="cb17-177"><a href="#cb17-177" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> <span class="fu">left_join</span>(long_trend_results, </span>
<span id="cb17-178"><a href="#cb17-178" aria-hidden="true" tabindex="-1"></a>                                    short_trend_results, </span>
<span id="cb17-179"><a href="#cb17-179" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">by =</span> <span class="st">"ROI_Indicator_Code"</span>)</span>
<span id="cb17-180"><a href="#cb17-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-181"><a href="#cb17-181" aria-hidden="true" tabindex="-1"></a><span class="co">#head(combined_trend_results)</span></span>
<span id="cb17-182"><a href="#cb17-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-183"><a href="#cb17-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-184"><a href="#cb17-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-185"><a href="#cb17-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-186"><a href="#cb17-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-187"><a href="#cb17-187" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge Long_Term_Trend into yrbs_master_stwd_grade based on matching ROI_Indicator_Code and Trend_Category</span></span>
<span id="cb17-188"><a href="#cb17-188" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> yrbs_master_analysis_stwd_trend <span class="sc">%&gt;%</span></span>
<span id="cb17-189"><a href="#cb17-189" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(combined_trend_results <span class="sc">%&gt;%</span> <span class="fu">select</span>(ROI_Indicator_Code, Long_Term_Trend, Short_Term_Trend),</span>
<span id="cb17-190"><a href="#cb17-190" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ROI_Indicator_Code"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb17-191"><a href="#cb17-191" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(School_Type,</span>
<span id="cb17-192"><a href="#cb17-192" aria-hidden="true" tabindex="-1"></a>         Health_Topic, </span>
<span id="cb17-193"><a href="#cb17-193" aria-hidden="true" tabindex="-1"></a>         ROI_Indicator_Code, </span>
<span id="cb17-194"><a href="#cb17-194" aria-hidden="true" tabindex="-1"></a>         Indicator_Long_Description, </span>
<span id="cb17-195"><a href="#cb17-195" aria-hidden="true" tabindex="-1"></a>         Trend_Category, </span>
<span id="cb17-196"><a href="#cb17-196" aria-hidden="true" tabindex="-1"></a>         <span class="fu">everything</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb17-197"><a href="#cb17-197" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, </span>
<span id="cb17-198"><a href="#cb17-198" aria-hidden="true" tabindex="-1"></a>          ROI_Indicator_Code, </span>
<span id="cb17-199"><a href="#cb17-199" aria-hidden="true" tabindex="-1"></a>          Trend_Category)</span>
<span id="cb17-200"><a href="#cb17-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-201"><a href="#cb17-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-202"><a href="#cb17-202" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to check for three consecutive NAs in a set of columns</span></span>
<span id="cb17-203"><a href="#cb17-203" aria-hidden="true" tabindex="-1"></a>check_consecutive_nas <span class="ot">&lt;-</span> <span class="cf">function</span>(year_values) {</span>
<span id="cb17-204"><a href="#cb17-204" aria-hidden="true" tabindex="-1"></a>  na_run_lengths <span class="ot">&lt;-</span> <span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>lengths[<span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>values]</span>
<span id="cb17-205"><a href="#cb17-205" aria-hidden="true" tabindex="-1"></a>  <span class="fu">any</span>(na_run_lengths <span class="sc">&gt;=</span> <span class="dv">3</span>)</span>
<span id="cb17-206"><a href="#cb17-206" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-207"><a href="#cb17-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-208"><a href="#cb17-208" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert all columns representing years to numeric</span></span>
<span id="cb17-209"><a href="#cb17-209" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb17-210"><a href="#cb17-210" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">d+$"</span>), as.numeric))</span>
<span id="cb17-211"><a href="#cb17-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-212"><a href="#cb17-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-213"><a href="#cb17-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-214"><a href="#cb17-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-215"><a href="#cb17-215" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge and mutate Long_Term_Trend</span></span>
<span id="cb17-216"><a href="#cb17-216" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb17-217"><a href="#cb17-217" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb17-218"><a href="#cb17-218" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Long_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">check_consecutive_nas</span>(<span class="fu">c_across</span>(<span class="st">`</span><span class="at">2011</span><span class="st">`</span><span class="sc">:</span><span class="st">`</span><span class="at">2023</span><span class="st">`</span>)), </span>
<span id="cb17-219"><a href="#cb17-219" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb17-220"><a href="#cb17-220" aria-hidden="true" tabindex="-1"></a>                                  Long_Term_Trend),</span>
<span id="cb17-221"><a href="#cb17-221" aria-hidden="true" tabindex="-1"></a>         <span class="at">Short_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(<span class="st">`</span><span class="at">2019</span><span class="st">`</span>) <span class="sc">|</span> <span class="fu">is.na</span>(<span class="st">`</span><span class="at">2023</span><span class="st">`</span>), </span>
<span id="cb17-222"><a href="#cb17-222" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb17-223"><a href="#cb17-223" aria-hidden="true" tabindex="-1"></a>                                   Short_Term_Trend)) <span class="sc">%&gt;%</span></span>
<span id="cb17-224"><a href="#cb17-224" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb17-225"><a href="#cb17-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-226"><a href="#cb17-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-227"><a href="#cb17-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-228"><a href="#cb17-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-229"><a href="#cb17-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-230"><a href="#cb17-230" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results)</span>
<span id="cb17-231"><a href="#cb17-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-232"><a href="#cb17-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-233"><a href="#cb17-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-234"><a href="#cb17-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-235"><a href="#cb17-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-236"><a href="#cb17-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-237"><a href="#cb17-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-238"><a href="#cb17-238" aria-hidden="true" tabindex="-1"></a>trend_results_race_3_other_race_mult <span class="ot">&lt;-</span> trend_results</span>
<span id="cb17-239"><a href="#cb17-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-240"><a href="#cb17-240" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results_race_3_other_race_mult)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="trend-by-race_group_4" class="level3">
<h3 class="anchored" data-anchor-id="trend-by-race_group_4">Trend By Race_Group_4</h3>
<section id="alaska-nativeamerican-indian-2" class="level4">
<h4 class="anchored" data-anchor-id="alaska-nativeamerican-indian-2">4.1 - Alaska Native/American Indian</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="do">######## Import Raw and Analyzed Excel Files ###############</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>yrbs_master_analysis_stwd_trend <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Race_Group_4 Trend"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Trend_Category <span class="sc">==</span> <span class="st">"Alaska Native/American Indian"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="st">"Suppressed"</span>, <span class="cn">NA</span>, .)))</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the raw data set to be used in trend analyis</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>raw_stwd_general <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"raw_yrbs_allyears_statewide_trad_cleaned.xlsx"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Race_Group_4 <span class="sc">==</span> <span class="st">"Alaska Native/American Indian"</span>,</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>         Survey_Year <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2011</span>,</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2013</span>, </span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2015</span>, </span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2017</span>,</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2019</span>, </span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2023</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>                            )) <span class="sc">%&gt;%</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">2</span>, <span class="dv">0</span>, <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="cn">NA</span>))))</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine which survey questions (ROI - Response of Interest) have data across at least two distinct survey years</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>roi_years <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), Survey_Year) <span class="sc">%&gt;%</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>Survey_Year, </span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"ROI_Indicator_Code"</span>, </span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ROI_Indicator_Code) <span class="sc">%&gt;%</span></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">unique_years =</span> <span class="fu">n_distinct</span>(Survey_Year), </span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(unique_years <span class="sc">&gt;=</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(ROI_Indicator_Code)</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the main data set to include only those ROIs, also ensuring to keep necessary demographic variables</span></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>filtered_raw_stwd_general <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Survey_Year, <span class="fu">all_of</span>(roi_years), Sex, Grade, Primary_Samp_Unit,Stratum,Final_Weight)</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a><span class="do">############ Long Term Trend ###############</span></span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a><span class="co">#Trend Analysis Function</span></span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>analyze_trend_logistic <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Survey Design for YRBS Statewide</span></span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_survey_design</span>(<span class="at">ids =</span> Primary_Samp_Unit,</span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>                     <span class="at">strata =</span> Stratum,</span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>                     <span class="at">weights =</span> Final_Weight,</span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span></span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Sex =</span> <span class="fu">factor</span>(Sex), <span class="at">Grade =</span> <span class="fu">factor</span>(Grade))</span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(data_filtered) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">length</span>(<span class="fu">unique</span>(data_filtered<span class="sc">$</span>variables<span class="sc">$</span>Survey_Year)) <span class="sc">&lt;</span> <span class="dv">4</span>) {</span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a>  base_formula <span class="ot">&lt;-</span> <span class="fu">paste</span>(column_name, <span class="st">"~ Sex + Grade + Survey_Year"</span>) </span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit the model using logistic regression</span></span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a>    <span class="fu">svyglm</span>(<span class="fu">as.formula</span>(base_formula), <span class="at">design =</span> data_filtered, <span class="at">family =</span> <span class="fu">quasibinomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Error fitting model: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb18-66"><a href="#cb18-66" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb18-67"><a href="#cb18-67" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb18-68"><a href="#cb18-68" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-69"><a href="#cb18-69" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if model fitting was successful</span></span>
<span id="cb18-70"><a href="#cb18-70" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(model)) {</span>
<span id="cb18-71"><a href="#cb18-71" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error"</span>))</span>
<span id="cb18-72"><a href="#cb18-72" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb18-73"><a href="#cb18-73" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-74"><a href="#cb18-74" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check for coefficients</span></span>
<span id="cb18-75"><a href="#cb18-75" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>(<span class="st">"Survey_Year"</span> <span class="sc">%in%</span> <span class="fu">names</span>(<span class="fu">coef</span>(model)))) {</span>
<span id="cb18-76"><a href="#cb18-76" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No valid coefficient for Survey_Year"</span>))</span>
<span id="cb18-77"><a href="#cb18-77" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb18-78"><a href="#cb18-78" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-79"><a href="#cb18-79" aria-hidden="true" tabindex="-1"></a>  coef_summary <span class="ot">=</span> <span class="fu">summary</span>(model)<span class="sc">$</span>coefficients</span>
<span id="cb18-80"><a href="#cb18-80" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(coef_summary) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb18-81"><a href="#cb18-81" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error: No coefficients"</span>))</span>
<span id="cb18-82"><a href="#cb18-82" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb18-83"><a href="#cb18-83" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-84"><a href="#cb18-84" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Determine the significance and direction of the trend</span></span>
<span id="cb18-85"><a href="#cb18-85" aria-hidden="true" tabindex="-1"></a>  p_value <span class="ot">=</span> coef_summary[<span class="st">"Survey_Year"</span>, <span class="st">"Pr(&gt;|t|)"</span>]</span>
<span id="cb18-86"><a href="#cb18-86" aria-hidden="true" tabindex="-1"></a>  coefficient <span class="ot">=</span> <span class="fu">coef</span>(model)[<span class="st">"Survey_Year"</span>]</span>
<span id="cb18-87"><a href="#cb18-87" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-88"><a href="#cb18-88" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(p_value)) {</span>
<span id="cb18-89"><a href="#cb18-89" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"P-value is NA"</span>))</span>
<span id="cb18-90"><a href="#cb18-90" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb18-91"><a href="#cb18-91" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-92"><a href="#cb18-92" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (p_value <span class="sc">&lt;=</span> <span class="fl">0.05</span>) {</span>
<span id="cb18-93"><a href="#cb18-93" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (coefficient <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb18-94"><a href="#cb18-94" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Increase"</span>))</span>
<span id="cb18-95"><a href="#cb18-95" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb18-96"><a href="#cb18-96" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Decrease"</span>))</span>
<span id="cb18-97"><a href="#cb18-97" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb18-98"><a href="#cb18-98" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb18-99"><a href="#cb18-99" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No Change"</span>))</span>
<span id="cb18-100"><a href="#cb18-100" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb18-101"><a href="#cb18-101" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-102"><a href="#cb18-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-103"><a href="#cb18-103" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the function to each ROI_Indicator_Code that has sufficient data</span></span>
<span id="cb18-104"><a href="#cb18-104" aria-hidden="true" tabindex="-1"></a>long_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(filtered_raw_stwd_general)[<span class="sc">-</span><span class="dv">1</span>], <span class="cf">function</span>(column_name) {</span>
<span id="cb18-105"><a href="#cb18-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_trend_logistic</span>(filtered_raw_stwd_general, column_name)</span>
<span id="cb18-106"><a href="#cb18-106" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb18-107"><a href="#cb18-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-108"><a href="#cb18-108" aria-hidden="true" tabindex="-1"></a><span class="co"># Show results</span></span>
<span id="cb18-109"><a href="#cb18-109" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(long_trend_results)</span>
<span id="cb18-110"><a href="#cb18-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-111"><a href="#cb18-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-112"><a href="#cb18-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-113"><a href="#cb18-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-114"><a href="#cb18-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-115"><a href="#cb18-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-116"><a href="#cb18-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-117"><a href="#cb18-117" aria-hidden="true" tabindex="-1"></a><span class="do">######### Short Term Trend ###############</span></span>
<span id="cb18-118"><a href="#cb18-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-119"><a href="#cb18-119" aria-hidden="true" tabindex="-1"></a>analyze_short_term_trend_ttest <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb18-120"><a href="#cb18-120" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the short-term years</span></span>
<span id="cb18-121"><a href="#cb18-121" aria-hidden="true" tabindex="-1"></a>    short_term_years <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2019</span>, <span class="dv">2023</span>)</span>
<span id="cb18-122"><a href="#cb18-122" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-123"><a href="#cb18-123" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter for short-term years and ensure all necessary variables are selected</span></span>
<span id="cb18-124"><a href="#cb18-124" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb18-125"><a href="#cb18-125" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(Survey_Year <span class="sc">%in%</span> short_term_years) <span class="sc">%&gt;%</span></span>
<span id="cb18-126"><a href="#cb18-126" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(Primary_Samp_Unit, Stratum, Final_Weight, Survey_Year, <span class="fu">all_of</span>(column_name)) <span class="sc">%&gt;%</span></span>
<span id="cb18-127"><a href="#cb18-127" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">response =</span> <span class="fu">get</span>(column_name) <span class="sc">==</span> <span class="dv">1</span>)  <span class="co"># Create a binary response variable for the analysis</span></span>
<span id="cb18-128"><a href="#cb18-128" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-129"><a href="#cb18-129" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if data is available for both years</span></span>
<span id="cb18-130"><a href="#cb18-130" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(short_term_years <span class="sc">%in%</span> <span class="fu">unique</span>(data_filtered<span class="sc">$</span>Survey_Year[<span class="sc">!</span><span class="fu">is.na</span>(data_filtered<span class="sc">$</span>response)]))) {</span>
<span id="cb18-131"><a href="#cb18-131" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb18-132"><a href="#cb18-132" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb18-133"><a href="#cb18-133" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-134"><a href="#cb18-134" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Continue with data that doesn't have NA responses</span></span>
<span id="cb18-135"><a href="#cb18-135" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(response))</span>
<span id="cb18-136"><a href="#cb18-136" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-137"><a href="#cb18-137" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create survey design object including the response variable</span></span>
<span id="cb18-138"><a href="#cb18-138" aria-hidden="true" tabindex="-1"></a>    survey_design <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="sc">~</span>Primary_Samp_Unit,</span>
<span id="cb18-139"><a href="#cb18-139" aria-hidden="true" tabindex="-1"></a>                               <span class="at">strata =</span> <span class="sc">~</span>Stratum,</span>
<span id="cb18-140"><a href="#cb18-140" aria-hidden="true" tabindex="-1"></a>                               <span class="at">weights =</span> <span class="sc">~</span>Final_Weight,</span>
<span id="cb18-141"><a href="#cb18-141" aria-hidden="true" tabindex="-1"></a>                               <span class="at">data =</span> data_filtered,</span>
<span id="cb18-142"><a href="#cb18-142" aria-hidden="true" tabindex="-1"></a>                               <span class="at">nest =</span> <span class="cn">TRUE</span>) </span>
<span id="cb18-143"><a href="#cb18-143" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-144"><a href="#cb18-144" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Perform Welch's t-test using the survey design object</span></span>
<span id="cb18-145"><a href="#cb18-145" aria-hidden="true" tabindex="-1"></a>    ttest_result <span class="ot">&lt;-</span> <span class="fu">svyttest</span>(response <span class="sc">~</span> <span class="fu">as.factor</span>(Survey_Year), survey_design)</span>
<span id="cb18-146"><a href="#cb18-146" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-147"><a href="#cb18-147" aria-hidden="true" tabindex="-1"></a>    <span class="co"># head t-test results</span></span>
<span id="cb18-148"><a href="#cb18-148" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(ttest_result)</span>
<span id="cb18-149"><a href="#cb18-149" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-150"><a href="#cb18-150" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check significance and interpret the results</span></span>
<span id="cb18-151"><a href="#cb18-151" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(ttest_result<span class="sc">$</span>p.value) <span class="sc">&amp;&amp;</span> ttest_result<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>) {</span>
<span id="cb18-152"><a href="#cb18-152" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(ttest_result<span class="sc">$</span>estimate <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Significant Increase"</span>, <span class="st">"Significant Decrease"</span>)</span>
<span id="cb18-153"><a href="#cb18-153" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb18-154"><a href="#cb18-154" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="st">"No Change"</span></span>
<span id="cb18-155"><a href="#cb18-155" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb18-156"><a href="#cb18-156" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-157"><a href="#cb18-157" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> trend))</span>
<span id="cb18-158"><a href="#cb18-158" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-159"><a href="#cb18-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-160"><a href="#cb18-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-161"><a href="#cb18-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-162"><a href="#cb18-162" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the short-term function to each ROI_Indicator_Code</span></span>
<span id="cb18-163"><a href="#cb18-163" aria-hidden="true" tabindex="-1"></a>short_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(raw_stwd_general)[<span class="fu">grep</span>(<span class="st">"^(QN|V).*[RP]"</span>, <span class="fu">names</span>(raw_stwd_general))], <span class="cf">function</span>(column_name) {</span>
<span id="cb18-164"><a href="#cb18-164" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_short_term_trend_ttest</span>(raw_stwd_general, column_name)</span>
<span id="cb18-165"><a href="#cb18-165" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb18-166"><a href="#cb18-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-167"><a href="#cb18-167" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(short_trend_results)</span>
<span id="cb18-168"><a href="#cb18-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-169"><a href="#cb18-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-170"><a href="#cb18-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-171"><a href="#cb18-171" aria-hidden="true" tabindex="-1"></a><span class="do">################### Join Together with Trend Tables ############</span></span>
<span id="cb18-172"><a href="#cb18-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-173"><a href="#cb18-173" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine long-term and short-term results</span></span>
<span id="cb18-174"><a href="#cb18-174" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> <span class="fu">left_join</span>(long_trend_results, </span>
<span id="cb18-175"><a href="#cb18-175" aria-hidden="true" tabindex="-1"></a>                                    short_trend_results, </span>
<span id="cb18-176"><a href="#cb18-176" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">by =</span> <span class="st">"ROI_Indicator_Code"</span>)</span>
<span id="cb18-177"><a href="#cb18-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-178"><a href="#cb18-178" aria-hidden="true" tabindex="-1"></a><span class="co">#head(combined_trend_results)</span></span>
<span id="cb18-179"><a href="#cb18-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-180"><a href="#cb18-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-181"><a href="#cb18-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-182"><a href="#cb18-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-183"><a href="#cb18-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-184"><a href="#cb18-184" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge Long_Term_Trend into yrbs_master_stwd_grade based on matching ROI_Indicator_Code and Trend_Category</span></span>
<span id="cb18-185"><a href="#cb18-185" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> yrbs_master_analysis_stwd_trend <span class="sc">%&gt;%</span></span>
<span id="cb18-186"><a href="#cb18-186" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(combined_trend_results <span class="sc">%&gt;%</span> <span class="fu">select</span>(ROI_Indicator_Code, Long_Term_Trend, Short_Term_Trend),</span>
<span id="cb18-187"><a href="#cb18-187" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ROI_Indicator_Code"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb18-188"><a href="#cb18-188" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(School_Type,</span>
<span id="cb18-189"><a href="#cb18-189" aria-hidden="true" tabindex="-1"></a>         Health_Topic, </span>
<span id="cb18-190"><a href="#cb18-190" aria-hidden="true" tabindex="-1"></a>         ROI_Indicator_Code, </span>
<span id="cb18-191"><a href="#cb18-191" aria-hidden="true" tabindex="-1"></a>         Indicator_Long_Description, </span>
<span id="cb18-192"><a href="#cb18-192" aria-hidden="true" tabindex="-1"></a>         Trend_Category, </span>
<span id="cb18-193"><a href="#cb18-193" aria-hidden="true" tabindex="-1"></a>         <span class="fu">everything</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb18-194"><a href="#cb18-194" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, </span>
<span id="cb18-195"><a href="#cb18-195" aria-hidden="true" tabindex="-1"></a>          ROI_Indicator_Code, </span>
<span id="cb18-196"><a href="#cb18-196" aria-hidden="true" tabindex="-1"></a>          Trend_Category)</span>
<span id="cb18-197"><a href="#cb18-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-198"><a href="#cb18-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-199"><a href="#cb18-199" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to check for three consecutive NAs in a set of columns</span></span>
<span id="cb18-200"><a href="#cb18-200" aria-hidden="true" tabindex="-1"></a>check_consecutive_nas <span class="ot">&lt;-</span> <span class="cf">function</span>(year_values) {</span>
<span id="cb18-201"><a href="#cb18-201" aria-hidden="true" tabindex="-1"></a>  na_run_lengths <span class="ot">&lt;-</span> <span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>lengths[<span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>values]</span>
<span id="cb18-202"><a href="#cb18-202" aria-hidden="true" tabindex="-1"></a>  <span class="fu">any</span>(na_run_lengths <span class="sc">&gt;=</span> <span class="dv">3</span>)</span>
<span id="cb18-203"><a href="#cb18-203" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-204"><a href="#cb18-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-205"><a href="#cb18-205" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert all columns representing years to numeric</span></span>
<span id="cb18-206"><a href="#cb18-206" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb18-207"><a href="#cb18-207" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">d+$"</span>), as.numeric))</span>
<span id="cb18-208"><a href="#cb18-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-209"><a href="#cb18-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-210"><a href="#cb18-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-211"><a href="#cb18-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-212"><a href="#cb18-212" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge and mutate Long_Term_Trend</span></span>
<span id="cb18-213"><a href="#cb18-213" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb18-214"><a href="#cb18-214" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb18-215"><a href="#cb18-215" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Long_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">check_consecutive_nas</span>(<span class="fu">c_across</span>(<span class="st">`</span><span class="at">2011</span><span class="st">`</span><span class="sc">:</span><span class="st">`</span><span class="at">2023</span><span class="st">`</span>)), </span>
<span id="cb18-216"><a href="#cb18-216" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb18-217"><a href="#cb18-217" aria-hidden="true" tabindex="-1"></a>                                  Long_Term_Trend),</span>
<span id="cb18-218"><a href="#cb18-218" aria-hidden="true" tabindex="-1"></a>         <span class="at">Short_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(<span class="st">`</span><span class="at">2019</span><span class="st">`</span>) <span class="sc">|</span> <span class="fu">is.na</span>(<span class="st">`</span><span class="at">2023</span><span class="st">`</span>), </span>
<span id="cb18-219"><a href="#cb18-219" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb18-220"><a href="#cb18-220" aria-hidden="true" tabindex="-1"></a>                                   Short_Term_Trend)) <span class="sc">%&gt;%</span></span>
<span id="cb18-221"><a href="#cb18-221" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb18-222"><a href="#cb18-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-223"><a href="#cb18-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-224"><a href="#cb18-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-225"><a href="#cb18-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-226"><a href="#cb18-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-227"><a href="#cb18-227" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results)</span>
<span id="cb18-228"><a href="#cb18-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-229"><a href="#cb18-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-230"><a href="#cb18-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-231"><a href="#cb18-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-232"><a href="#cb18-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-233"><a href="#cb18-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-234"><a href="#cb18-234" aria-hidden="true" tabindex="-1"></a>trend_results_race_4_ANAI <span class="ot">&lt;-</span> trend_results</span>
<span id="cb18-235"><a href="#cb18-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-236"><a href="#cb18-236" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results_race_4_ANAI)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="hispaniclatino-1" class="level4">
<h4 class="anchored" data-anchor-id="hispaniclatino-1">4.2 - Hispanic/Latino</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="do">######## Import Raw and Analyzed Excel Files ###############</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>yrbs_master_analysis_stwd_trend <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Race_Group_4 Trend"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Trend_Category <span class="sc">==</span> <span class="st">"Hispanic/Latino"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="st">"Suppressed"</span>, <span class="cn">NA</span>, .)))</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the raw data set to be used in trend analyis</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>raw_stwd_general <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"raw_yrbs_allyears_statewide_trad_cleaned.xlsx"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Race_Group_4 <span class="sc">==</span> <span class="st">"Hispanic/Latino"</span>,</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>         Survey_Year <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2011</span>,</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2013</span>, </span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2015</span>, </span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2017</span>,</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2019</span>, </span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2023</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>                            )) <span class="sc">%&gt;%</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">2</span>, <span class="dv">0</span>, <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="cn">NA</span>))))</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine which survey questions (ROI - Response of Interest) have data across at least two distinct survey years</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>roi_years <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), Survey_Year) <span class="sc">%&gt;%</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>Survey_Year, </span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"ROI_Indicator_Code"</span>, </span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ROI_Indicator_Code) <span class="sc">%&gt;%</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">unique_years =</span> <span class="fu">n_distinct</span>(Survey_Year), </span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(unique_years <span class="sc">&gt;=</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(ROI_Indicator_Code)</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the main data set to include only those ROIs, also ensuring to keep necessary demographic variables</span></span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>filtered_raw_stwd_general <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Survey_Year, <span class="fu">all_of</span>(roi_years), Sex, Grade, Primary_Samp_Unit,Stratum,Final_Weight)</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a><span class="do">############ Long Term Trend ###############</span></span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a><span class="co">#Trend Analysis Function</span></span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>analyze_trend_logistic <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Survey Design for YRBS Statewide</span></span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_survey_design</span>(<span class="at">ids =</span> Primary_Samp_Unit,</span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>                     <span class="at">strata =</span> Stratum,</span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>                     <span class="at">weights =</span> Final_Weight,</span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span></span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Sex =</span> <span class="fu">factor</span>(Sex), <span class="at">Grade =</span> <span class="fu">factor</span>(Grade))</span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(data_filtered) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">length</span>(<span class="fu">unique</span>(data_filtered<span class="sc">$</span>variables<span class="sc">$</span>Survey_Year)) <span class="sc">&lt;</span> <span class="dv">4</span>) {</span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a>  base_formula <span class="ot">&lt;-</span> <span class="fu">paste</span>(column_name, <span class="st">"~ Sex + Grade + Survey_Year"</span>) </span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit the model using logistic regression</span></span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb19-65"><a href="#cb19-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">svyglm</span>(<span class="fu">as.formula</span>(base_formula), <span class="at">design =</span> data_filtered, <span class="at">family =</span> <span class="fu">quasibinomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb19-66"><a href="#cb19-66" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb19-67"><a href="#cb19-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Error fitting model: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb19-68"><a href="#cb19-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb19-69"><a href="#cb19-69" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb19-70"><a href="#cb19-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-71"><a href="#cb19-71" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if model fitting was successful</span></span>
<span id="cb19-72"><a href="#cb19-72" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(model)) {</span>
<span id="cb19-73"><a href="#cb19-73" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error"</span>))</span>
<span id="cb19-74"><a href="#cb19-74" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb19-75"><a href="#cb19-75" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-76"><a href="#cb19-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check for coefficients</span></span>
<span id="cb19-77"><a href="#cb19-77" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>(<span class="st">"Survey_Year"</span> <span class="sc">%in%</span> <span class="fu">names</span>(<span class="fu">coef</span>(model)))) {</span>
<span id="cb19-78"><a href="#cb19-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No valid coefficient for Survey_Year"</span>))</span>
<span id="cb19-79"><a href="#cb19-79" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb19-80"><a href="#cb19-80" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-81"><a href="#cb19-81" aria-hidden="true" tabindex="-1"></a>  coef_summary <span class="ot">=</span> <span class="fu">summary</span>(model)<span class="sc">$</span>coefficients</span>
<span id="cb19-82"><a href="#cb19-82" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(coef_summary) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb19-83"><a href="#cb19-83" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error: No coefficients"</span>))</span>
<span id="cb19-84"><a href="#cb19-84" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb19-85"><a href="#cb19-85" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-86"><a href="#cb19-86" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Determine the significance and direction of the trend</span></span>
<span id="cb19-87"><a href="#cb19-87" aria-hidden="true" tabindex="-1"></a>  p_value <span class="ot">=</span> coef_summary[<span class="st">"Survey_Year"</span>, <span class="st">"Pr(&gt;|t|)"</span>]</span>
<span id="cb19-88"><a href="#cb19-88" aria-hidden="true" tabindex="-1"></a>  coefficient <span class="ot">=</span> <span class="fu">coef</span>(model)[<span class="st">"Survey_Year"</span>]</span>
<span id="cb19-89"><a href="#cb19-89" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-90"><a href="#cb19-90" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(p_value)) {</span>
<span id="cb19-91"><a href="#cb19-91" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"P-value is NA"</span>))</span>
<span id="cb19-92"><a href="#cb19-92" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb19-93"><a href="#cb19-93" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-94"><a href="#cb19-94" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (p_value <span class="sc">&lt;=</span> <span class="fl">0.05</span>) {</span>
<span id="cb19-95"><a href="#cb19-95" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (coefficient <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb19-96"><a href="#cb19-96" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Increase"</span>))</span>
<span id="cb19-97"><a href="#cb19-97" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb19-98"><a href="#cb19-98" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Decrease"</span>))</span>
<span id="cb19-99"><a href="#cb19-99" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb19-100"><a href="#cb19-100" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb19-101"><a href="#cb19-101" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No Change"</span>))</span>
<span id="cb19-102"><a href="#cb19-102" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb19-103"><a href="#cb19-103" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-104"><a href="#cb19-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-105"><a href="#cb19-105" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the function to each ROI_Indicator_Code that has sufficient data</span></span>
<span id="cb19-106"><a href="#cb19-106" aria-hidden="true" tabindex="-1"></a>long_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(filtered_raw_stwd_general)[<span class="sc">-</span><span class="dv">1</span>], <span class="cf">function</span>(column_name) {</span>
<span id="cb19-107"><a href="#cb19-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_trend_logistic</span>(filtered_raw_stwd_general, column_name)</span>
<span id="cb19-108"><a href="#cb19-108" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb19-109"><a href="#cb19-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-110"><a href="#cb19-110" aria-hidden="true" tabindex="-1"></a><span class="co"># Show results</span></span>
<span id="cb19-111"><a href="#cb19-111" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(long_trend_results)</span>
<span id="cb19-112"><a href="#cb19-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-113"><a href="#cb19-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-114"><a href="#cb19-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-115"><a href="#cb19-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-116"><a href="#cb19-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-117"><a href="#cb19-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-118"><a href="#cb19-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-119"><a href="#cb19-119" aria-hidden="true" tabindex="-1"></a><span class="do">######### Short Term Trend ###############</span></span>
<span id="cb19-120"><a href="#cb19-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-121"><a href="#cb19-121" aria-hidden="true" tabindex="-1"></a>analyze_short_term_trend_ttest <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb19-122"><a href="#cb19-122" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the short-term years</span></span>
<span id="cb19-123"><a href="#cb19-123" aria-hidden="true" tabindex="-1"></a>    short_term_years <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2019</span>, <span class="dv">2023</span>)</span>
<span id="cb19-124"><a href="#cb19-124" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-125"><a href="#cb19-125" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter for short-term years and ensure all necessary variables are selected</span></span>
<span id="cb19-126"><a href="#cb19-126" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb19-127"><a href="#cb19-127" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(Survey_Year <span class="sc">%in%</span> short_term_years) <span class="sc">%&gt;%</span></span>
<span id="cb19-128"><a href="#cb19-128" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(Primary_Samp_Unit, Stratum, Final_Weight, Survey_Year, <span class="fu">all_of</span>(column_name)) <span class="sc">%&gt;%</span></span>
<span id="cb19-129"><a href="#cb19-129" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">response =</span> <span class="fu">get</span>(column_name) <span class="sc">==</span> <span class="dv">1</span>)  <span class="co"># Create a binary response variable for the analysis</span></span>
<span id="cb19-130"><a href="#cb19-130" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-131"><a href="#cb19-131" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if data is available for both years</span></span>
<span id="cb19-132"><a href="#cb19-132" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(short_term_years <span class="sc">%in%</span> <span class="fu">unique</span>(data_filtered<span class="sc">$</span>Survey_Year[<span class="sc">!</span><span class="fu">is.na</span>(data_filtered<span class="sc">$</span>response)]))) {</span>
<span id="cb19-133"><a href="#cb19-133" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb19-134"><a href="#cb19-134" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb19-135"><a href="#cb19-135" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-136"><a href="#cb19-136" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Continue with data that doesn't have NA responses</span></span>
<span id="cb19-137"><a href="#cb19-137" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(response))</span>
<span id="cb19-138"><a href="#cb19-138" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-139"><a href="#cb19-139" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create survey design object including the response variable</span></span>
<span id="cb19-140"><a href="#cb19-140" aria-hidden="true" tabindex="-1"></a>    survey_design <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="sc">~</span>Primary_Samp_Unit,</span>
<span id="cb19-141"><a href="#cb19-141" aria-hidden="true" tabindex="-1"></a>                               <span class="at">strata =</span> <span class="sc">~</span>Stratum,</span>
<span id="cb19-142"><a href="#cb19-142" aria-hidden="true" tabindex="-1"></a>                               <span class="at">weights =</span> <span class="sc">~</span>Final_Weight,</span>
<span id="cb19-143"><a href="#cb19-143" aria-hidden="true" tabindex="-1"></a>                               <span class="at">data =</span> data_filtered,</span>
<span id="cb19-144"><a href="#cb19-144" aria-hidden="true" tabindex="-1"></a>                               <span class="at">nest =</span> <span class="cn">TRUE</span>) </span>
<span id="cb19-145"><a href="#cb19-145" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-146"><a href="#cb19-146" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Perform Welch's t-test using the survey design object</span></span>
<span id="cb19-147"><a href="#cb19-147" aria-hidden="true" tabindex="-1"></a>    ttest_result <span class="ot">&lt;-</span> <span class="fu">svyttest</span>(response <span class="sc">~</span> <span class="fu">as.factor</span>(Survey_Year), survey_design)</span>
<span id="cb19-148"><a href="#cb19-148" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-149"><a href="#cb19-149" aria-hidden="true" tabindex="-1"></a>    <span class="co"># head t-test results</span></span>
<span id="cb19-150"><a href="#cb19-150" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(ttest_result)</span>
<span id="cb19-151"><a href="#cb19-151" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-152"><a href="#cb19-152" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check significance and interpret the results</span></span>
<span id="cb19-153"><a href="#cb19-153" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(ttest_result<span class="sc">$</span>p.value) <span class="sc">&amp;&amp;</span> ttest_result<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>) {</span>
<span id="cb19-154"><a href="#cb19-154" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(ttest_result<span class="sc">$</span>estimate <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Significant Increase"</span>, <span class="st">"Significant Decrease"</span>)</span>
<span id="cb19-155"><a href="#cb19-155" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb19-156"><a href="#cb19-156" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="st">"No Change"</span></span>
<span id="cb19-157"><a href="#cb19-157" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb19-158"><a href="#cb19-158" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-159"><a href="#cb19-159" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> trend))</span>
<span id="cb19-160"><a href="#cb19-160" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-161"><a href="#cb19-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-162"><a href="#cb19-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-163"><a href="#cb19-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-164"><a href="#cb19-164" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the short-term function to each ROI_Indicator_Code</span></span>
<span id="cb19-165"><a href="#cb19-165" aria-hidden="true" tabindex="-1"></a>short_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(raw_stwd_general)[<span class="fu">grep</span>(<span class="st">"^(QN|V).*[RP]"</span>, <span class="fu">names</span>(raw_stwd_general))], <span class="cf">function</span>(column_name) {</span>
<span id="cb19-166"><a href="#cb19-166" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_short_term_trend_ttest</span>(raw_stwd_general, column_name)</span>
<span id="cb19-167"><a href="#cb19-167" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb19-168"><a href="#cb19-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-169"><a href="#cb19-169" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(short_trend_results)</span>
<span id="cb19-170"><a href="#cb19-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-171"><a href="#cb19-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-172"><a href="#cb19-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-173"><a href="#cb19-173" aria-hidden="true" tabindex="-1"></a><span class="do">################### Join Together with Trend Tables ############</span></span>
<span id="cb19-174"><a href="#cb19-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-175"><a href="#cb19-175" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine long-term and short-term results</span></span>
<span id="cb19-176"><a href="#cb19-176" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> <span class="fu">left_join</span>(long_trend_results, </span>
<span id="cb19-177"><a href="#cb19-177" aria-hidden="true" tabindex="-1"></a>                                    short_trend_results, </span>
<span id="cb19-178"><a href="#cb19-178" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">by =</span> <span class="st">"ROI_Indicator_Code"</span>)</span>
<span id="cb19-179"><a href="#cb19-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-180"><a href="#cb19-180" aria-hidden="true" tabindex="-1"></a><span class="co">#head(combined_trend_results)</span></span>
<span id="cb19-181"><a href="#cb19-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-182"><a href="#cb19-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-183"><a href="#cb19-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-184"><a href="#cb19-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-185"><a href="#cb19-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-186"><a href="#cb19-186" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge Long_Term_Trend into yrbs_master_stwd_grade based on matching ROI_Indicator_Code and Trend_Category</span></span>
<span id="cb19-187"><a href="#cb19-187" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> yrbs_master_analysis_stwd_trend <span class="sc">%&gt;%</span></span>
<span id="cb19-188"><a href="#cb19-188" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(combined_trend_results <span class="sc">%&gt;%</span> <span class="fu">select</span>(ROI_Indicator_Code, Long_Term_Trend, Short_Term_Trend),</span>
<span id="cb19-189"><a href="#cb19-189" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ROI_Indicator_Code"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb19-190"><a href="#cb19-190" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(School_Type,</span>
<span id="cb19-191"><a href="#cb19-191" aria-hidden="true" tabindex="-1"></a>         Health_Topic, </span>
<span id="cb19-192"><a href="#cb19-192" aria-hidden="true" tabindex="-1"></a>         ROI_Indicator_Code, </span>
<span id="cb19-193"><a href="#cb19-193" aria-hidden="true" tabindex="-1"></a>         Indicator_Long_Description, </span>
<span id="cb19-194"><a href="#cb19-194" aria-hidden="true" tabindex="-1"></a>         Trend_Category, </span>
<span id="cb19-195"><a href="#cb19-195" aria-hidden="true" tabindex="-1"></a>         <span class="fu">everything</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb19-196"><a href="#cb19-196" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, </span>
<span id="cb19-197"><a href="#cb19-197" aria-hidden="true" tabindex="-1"></a>          ROI_Indicator_Code, </span>
<span id="cb19-198"><a href="#cb19-198" aria-hidden="true" tabindex="-1"></a>          Trend_Category)</span>
<span id="cb19-199"><a href="#cb19-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-200"><a href="#cb19-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-201"><a href="#cb19-201" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to check for three consecutive NAs in a set of columns</span></span>
<span id="cb19-202"><a href="#cb19-202" aria-hidden="true" tabindex="-1"></a>check_consecutive_nas <span class="ot">&lt;-</span> <span class="cf">function</span>(year_values) {</span>
<span id="cb19-203"><a href="#cb19-203" aria-hidden="true" tabindex="-1"></a>  na_run_lengths <span class="ot">&lt;-</span> <span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>lengths[<span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>values]</span>
<span id="cb19-204"><a href="#cb19-204" aria-hidden="true" tabindex="-1"></a>  <span class="fu">any</span>(na_run_lengths <span class="sc">&gt;=</span> <span class="dv">3</span>)</span>
<span id="cb19-205"><a href="#cb19-205" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-206"><a href="#cb19-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-207"><a href="#cb19-207" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert all columns representing years to numeric</span></span>
<span id="cb19-208"><a href="#cb19-208" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb19-209"><a href="#cb19-209" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">d+$"</span>), as.numeric))</span>
<span id="cb19-210"><a href="#cb19-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-211"><a href="#cb19-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-212"><a href="#cb19-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-213"><a href="#cb19-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-214"><a href="#cb19-214" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge and mutate Long_Term_Trend</span></span>
<span id="cb19-215"><a href="#cb19-215" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb19-216"><a href="#cb19-216" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb19-217"><a href="#cb19-217" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Long_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">check_consecutive_nas</span>(<span class="fu">c_across</span>(<span class="st">`</span><span class="at">2011</span><span class="st">`</span><span class="sc">:</span><span class="st">`</span><span class="at">2023</span><span class="st">`</span>)), </span>
<span id="cb19-218"><a href="#cb19-218" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb19-219"><a href="#cb19-219" aria-hidden="true" tabindex="-1"></a>                                  Long_Term_Trend),</span>
<span id="cb19-220"><a href="#cb19-220" aria-hidden="true" tabindex="-1"></a>         <span class="at">Short_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(<span class="st">`</span><span class="at">2019</span><span class="st">`</span>) <span class="sc">|</span> <span class="fu">is.na</span>(<span class="st">`</span><span class="at">2023</span><span class="st">`</span>), </span>
<span id="cb19-221"><a href="#cb19-221" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb19-222"><a href="#cb19-222" aria-hidden="true" tabindex="-1"></a>                                   Short_Term_Trend)) <span class="sc">%&gt;%</span></span>
<span id="cb19-223"><a href="#cb19-223" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb19-224"><a href="#cb19-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-225"><a href="#cb19-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-226"><a href="#cb19-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-227"><a href="#cb19-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-228"><a href="#cb19-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-229"><a href="#cb19-229" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results)</span>
<span id="cb19-230"><a href="#cb19-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-231"><a href="#cb19-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-232"><a href="#cb19-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-233"><a href="#cb19-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-234"><a href="#cb19-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-235"><a href="#cb19-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-236"><a href="#cb19-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-237"><a href="#cb19-237" aria-hidden="true" tabindex="-1"></a>trend_results_race_4_HispLat <span class="ot">&lt;-</span> trend_results</span>
<span id="cb19-238"><a href="#cb19-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-239"><a href="#cb19-239" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results_race_4_HispLat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="white-2" class="level4">
<h4 class="anchored" data-anchor-id="white-2">4.3 - White</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="do">######## Import Raw and Analyzed Excel Files ###############</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>yrbs_master_analysis_stwd_trend <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Race_Group_4 Trend"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Trend_Category <span class="sc">==</span> <span class="st">"White"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="st">"Suppressed"</span>, <span class="cn">NA</span>, .)))</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the raw data set to be used in trend analyis</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>raw_stwd_general <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"raw_yrbs_allyears_statewide_trad_cleaned.xlsx"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Race_Group_4 <span class="sc">==</span> <span class="st">"White"</span>,</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>         Survey_Year <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2011</span>,</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2013</span>, </span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2015</span>, </span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2017</span>,</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2019</span>, </span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2023</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>                            )) <span class="sc">%&gt;%</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">2</span>, <span class="dv">0</span>, <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="cn">NA</span>))))</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine which survey questions (ROI - Response of Interest) have data across at least two distinct survey years</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>roi_years <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), Survey_Year) <span class="sc">%&gt;%</span></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>Survey_Year, </span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"ROI_Indicator_Code"</span>, </span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ROI_Indicator_Code) <span class="sc">%&gt;%</span></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">unique_years =</span> <span class="fu">n_distinct</span>(Survey_Year), </span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(unique_years <span class="sc">&gt;=</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(ROI_Indicator_Code)</span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the main data set to include only those ROIs, also ensuring to keep necessary demographic variables</span></span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>filtered_raw_stwd_general <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Survey_Year, <span class="fu">all_of</span>(roi_years), Sex, Grade, Primary_Samp_Unit,Stratum,Final_Weight)</span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a><span class="do">############ Long Term Trend ###############</span></span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a><span class="co">#Trend Analysis Function</span></span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a>analyze_trend_logistic <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Survey Design for YRBS Statewide</span></span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_survey_design</span>(<span class="at">ids =</span> Primary_Samp_Unit,</span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a>                     <span class="at">strata =</span> Stratum,</span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a>                     <span class="at">weights =</span> Final_Weight,</span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span></span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Sex =</span> <span class="fu">factor</span>(Sex), <span class="at">Grade =</span> <span class="fu">factor</span>(Grade))</span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(data_filtered) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">length</span>(<span class="fu">unique</span>(data_filtered<span class="sc">$</span>variables<span class="sc">$</span>Survey_Year)) <span class="sc">&lt;</span> <span class="dv">4</span>) {</span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb20-60"><a href="#cb20-60" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-61"><a href="#cb20-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-62"><a href="#cb20-62" aria-hidden="true" tabindex="-1"></a>  base_formula <span class="ot">&lt;-</span> <span class="fu">paste</span>(column_name, <span class="st">"~ Sex + Grade + Survey_Year"</span>) </span>
<span id="cb20-63"><a href="#cb20-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit the model using logistic regression</span></span>
<span id="cb20-64"><a href="#cb20-64" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb20-65"><a href="#cb20-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">svyglm</span>(<span class="fu">as.formula</span>(base_formula), <span class="at">design =</span> data_filtered, <span class="at">family =</span> <span class="fu">quasibinomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb20-66"><a href="#cb20-66" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb20-67"><a href="#cb20-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Error fitting model: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb20-68"><a href="#cb20-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb20-69"><a href="#cb20-69" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb20-70"><a href="#cb20-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-71"><a href="#cb20-71" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if model fitting was successful</span></span>
<span id="cb20-72"><a href="#cb20-72" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(model)) {</span>
<span id="cb20-73"><a href="#cb20-73" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error"</span>))</span>
<span id="cb20-74"><a href="#cb20-74" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-75"><a href="#cb20-75" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-76"><a href="#cb20-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check for coefficients</span></span>
<span id="cb20-77"><a href="#cb20-77" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>(<span class="st">"Survey_Year"</span> <span class="sc">%in%</span> <span class="fu">names</span>(<span class="fu">coef</span>(model)))) {</span>
<span id="cb20-78"><a href="#cb20-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No valid coefficient for Survey_Year"</span>))</span>
<span id="cb20-79"><a href="#cb20-79" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-80"><a href="#cb20-80" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-81"><a href="#cb20-81" aria-hidden="true" tabindex="-1"></a>  coef_summary <span class="ot">=</span> <span class="fu">summary</span>(model)<span class="sc">$</span>coefficients</span>
<span id="cb20-82"><a href="#cb20-82" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(coef_summary) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb20-83"><a href="#cb20-83" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error: No coefficients"</span>))</span>
<span id="cb20-84"><a href="#cb20-84" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-85"><a href="#cb20-85" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-86"><a href="#cb20-86" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Determine the significance and direction of the trend</span></span>
<span id="cb20-87"><a href="#cb20-87" aria-hidden="true" tabindex="-1"></a>  p_value <span class="ot">=</span> coef_summary[<span class="st">"Survey_Year"</span>, <span class="st">"Pr(&gt;|t|)"</span>]</span>
<span id="cb20-88"><a href="#cb20-88" aria-hidden="true" tabindex="-1"></a>  coefficient <span class="ot">=</span> <span class="fu">coef</span>(model)[<span class="st">"Survey_Year"</span>]</span>
<span id="cb20-89"><a href="#cb20-89" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-90"><a href="#cb20-90" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(p_value)) {</span>
<span id="cb20-91"><a href="#cb20-91" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"P-value is NA"</span>))</span>
<span id="cb20-92"><a href="#cb20-92" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-93"><a href="#cb20-93" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-94"><a href="#cb20-94" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (p_value <span class="sc">&lt;=</span> <span class="fl">0.05</span>) {</span>
<span id="cb20-95"><a href="#cb20-95" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (coefficient <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb20-96"><a href="#cb20-96" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Increase"</span>))</span>
<span id="cb20-97"><a href="#cb20-97" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb20-98"><a href="#cb20-98" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Decrease"</span>))</span>
<span id="cb20-99"><a href="#cb20-99" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-100"><a href="#cb20-100" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb20-101"><a href="#cb20-101" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No Change"</span>))</span>
<span id="cb20-102"><a href="#cb20-102" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-103"><a href="#cb20-103" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-104"><a href="#cb20-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-105"><a href="#cb20-105" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the function to each ROI_Indicator_Code that has sufficient data</span></span>
<span id="cb20-106"><a href="#cb20-106" aria-hidden="true" tabindex="-1"></a>long_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(filtered_raw_stwd_general)[<span class="sc">-</span><span class="dv">1</span>], <span class="cf">function</span>(column_name) {</span>
<span id="cb20-107"><a href="#cb20-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_trend_logistic</span>(filtered_raw_stwd_general, column_name)</span>
<span id="cb20-108"><a href="#cb20-108" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb20-109"><a href="#cb20-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-110"><a href="#cb20-110" aria-hidden="true" tabindex="-1"></a><span class="co"># Show results</span></span>
<span id="cb20-111"><a href="#cb20-111" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(long_trend_results)</span>
<span id="cb20-112"><a href="#cb20-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-113"><a href="#cb20-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-114"><a href="#cb20-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-115"><a href="#cb20-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-116"><a href="#cb20-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-117"><a href="#cb20-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-118"><a href="#cb20-118" aria-hidden="true" tabindex="-1"></a><span class="do">######### Short Term Trend ###############</span></span>
<span id="cb20-119"><a href="#cb20-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-120"><a href="#cb20-120" aria-hidden="true" tabindex="-1"></a>analyze_short_term_trend_ttest <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb20-121"><a href="#cb20-121" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the short-term years</span></span>
<span id="cb20-122"><a href="#cb20-122" aria-hidden="true" tabindex="-1"></a>    short_term_years <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2019</span>, <span class="dv">2023</span>)</span>
<span id="cb20-123"><a href="#cb20-123" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-124"><a href="#cb20-124" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter for short-term years and ensure all necessary variables are selected</span></span>
<span id="cb20-125"><a href="#cb20-125" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb20-126"><a href="#cb20-126" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(Survey_Year <span class="sc">%in%</span> short_term_years) <span class="sc">%&gt;%</span></span>
<span id="cb20-127"><a href="#cb20-127" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(Primary_Samp_Unit, Stratum, Final_Weight, Survey_Year, <span class="fu">all_of</span>(column_name)) <span class="sc">%&gt;%</span></span>
<span id="cb20-128"><a href="#cb20-128" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">response =</span> <span class="fu">get</span>(column_name) <span class="sc">==</span> <span class="dv">1</span>)  <span class="co"># Create a binary response variable for the analysis</span></span>
<span id="cb20-129"><a href="#cb20-129" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-130"><a href="#cb20-130" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if data is available for both years</span></span>
<span id="cb20-131"><a href="#cb20-131" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(short_term_years <span class="sc">%in%</span> <span class="fu">unique</span>(data_filtered<span class="sc">$</span>Survey_Year[<span class="sc">!</span><span class="fu">is.na</span>(data_filtered<span class="sc">$</span>response)]))) {</span>
<span id="cb20-132"><a href="#cb20-132" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb20-133"><a href="#cb20-133" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-134"><a href="#cb20-134" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-135"><a href="#cb20-135" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Continue with data that doesn't have NA responses</span></span>
<span id="cb20-136"><a href="#cb20-136" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(response))</span>
<span id="cb20-137"><a href="#cb20-137" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-138"><a href="#cb20-138" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create survey design object including the response variable</span></span>
<span id="cb20-139"><a href="#cb20-139" aria-hidden="true" tabindex="-1"></a>    survey_design <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="sc">~</span>Primary_Samp_Unit,</span>
<span id="cb20-140"><a href="#cb20-140" aria-hidden="true" tabindex="-1"></a>                               <span class="at">strata =</span> <span class="sc">~</span>Stratum,</span>
<span id="cb20-141"><a href="#cb20-141" aria-hidden="true" tabindex="-1"></a>                               <span class="at">weights =</span> <span class="sc">~</span>Final_Weight,</span>
<span id="cb20-142"><a href="#cb20-142" aria-hidden="true" tabindex="-1"></a>                               <span class="at">data =</span> data_filtered,</span>
<span id="cb20-143"><a href="#cb20-143" aria-hidden="true" tabindex="-1"></a>                               <span class="at">nest =</span> <span class="cn">TRUE</span>) </span>
<span id="cb20-144"><a href="#cb20-144" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-145"><a href="#cb20-145" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Perform Welch's t-test using the survey design object</span></span>
<span id="cb20-146"><a href="#cb20-146" aria-hidden="true" tabindex="-1"></a>    ttest_result <span class="ot">&lt;-</span> <span class="fu">svyttest</span>(response <span class="sc">~</span> <span class="fu">as.factor</span>(Survey_Year), survey_design)</span>
<span id="cb20-147"><a href="#cb20-147" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-148"><a href="#cb20-148" aria-hidden="true" tabindex="-1"></a>    <span class="co"># head t-test results</span></span>
<span id="cb20-149"><a href="#cb20-149" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(ttest_result)</span>
<span id="cb20-150"><a href="#cb20-150" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-151"><a href="#cb20-151" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check significance and interpret the results</span></span>
<span id="cb20-152"><a href="#cb20-152" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(ttest_result<span class="sc">$</span>p.value) <span class="sc">&amp;&amp;</span> ttest_result<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>) {</span>
<span id="cb20-153"><a href="#cb20-153" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(ttest_result<span class="sc">$</span>estimate <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Significant Increase"</span>, <span class="st">"Significant Decrease"</span>)</span>
<span id="cb20-154"><a href="#cb20-154" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb20-155"><a href="#cb20-155" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="st">"No Change"</span></span>
<span id="cb20-156"><a href="#cb20-156" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-157"><a href="#cb20-157" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-158"><a href="#cb20-158" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> trend))</span>
<span id="cb20-159"><a href="#cb20-159" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-160"><a href="#cb20-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-161"><a href="#cb20-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-162"><a href="#cb20-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-163"><a href="#cb20-163" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the short-term function to each ROI_Indicator_Code</span></span>
<span id="cb20-164"><a href="#cb20-164" aria-hidden="true" tabindex="-1"></a>short_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(raw_stwd_general)[<span class="fu">grep</span>(<span class="st">"^(QN|V).*[RP]"</span>, <span class="fu">names</span>(raw_stwd_general))], <span class="cf">function</span>(column_name) {</span>
<span id="cb20-165"><a href="#cb20-165" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_short_term_trend_ttest</span>(raw_stwd_general, column_name)</span>
<span id="cb20-166"><a href="#cb20-166" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb20-167"><a href="#cb20-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-168"><a href="#cb20-168" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(short_trend_results)</span>
<span id="cb20-169"><a href="#cb20-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-170"><a href="#cb20-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-171"><a href="#cb20-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-172"><a href="#cb20-172" aria-hidden="true" tabindex="-1"></a><span class="do">################### Join Together with Trend Tables ############</span></span>
<span id="cb20-173"><a href="#cb20-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-174"><a href="#cb20-174" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine long-term and short-term results</span></span>
<span id="cb20-175"><a href="#cb20-175" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> <span class="fu">left_join</span>(long_trend_results, </span>
<span id="cb20-176"><a href="#cb20-176" aria-hidden="true" tabindex="-1"></a>                                    short_trend_results, </span>
<span id="cb20-177"><a href="#cb20-177" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">by =</span> <span class="st">"ROI_Indicator_Code"</span>)</span>
<span id="cb20-178"><a href="#cb20-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-179"><a href="#cb20-179" aria-hidden="true" tabindex="-1"></a><span class="co">#head(combined_trend_results)</span></span>
<span id="cb20-180"><a href="#cb20-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-181"><a href="#cb20-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-182"><a href="#cb20-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-183"><a href="#cb20-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-184"><a href="#cb20-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-185"><a href="#cb20-185" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge Long_Term_Trend into yrbs_master_stwd_grade based on matching ROI_Indicator_Code and Trend_Category</span></span>
<span id="cb20-186"><a href="#cb20-186" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> yrbs_master_analysis_stwd_trend <span class="sc">%&gt;%</span></span>
<span id="cb20-187"><a href="#cb20-187" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(combined_trend_results <span class="sc">%&gt;%</span> <span class="fu">select</span>(ROI_Indicator_Code, Long_Term_Trend, Short_Term_Trend),</span>
<span id="cb20-188"><a href="#cb20-188" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ROI_Indicator_Code"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb20-189"><a href="#cb20-189" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(School_Type,</span>
<span id="cb20-190"><a href="#cb20-190" aria-hidden="true" tabindex="-1"></a>         Health_Topic, </span>
<span id="cb20-191"><a href="#cb20-191" aria-hidden="true" tabindex="-1"></a>         ROI_Indicator_Code, </span>
<span id="cb20-192"><a href="#cb20-192" aria-hidden="true" tabindex="-1"></a>         Indicator_Long_Description, </span>
<span id="cb20-193"><a href="#cb20-193" aria-hidden="true" tabindex="-1"></a>         Trend_Category, </span>
<span id="cb20-194"><a href="#cb20-194" aria-hidden="true" tabindex="-1"></a>         <span class="fu">everything</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb20-195"><a href="#cb20-195" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, </span>
<span id="cb20-196"><a href="#cb20-196" aria-hidden="true" tabindex="-1"></a>          ROI_Indicator_Code, </span>
<span id="cb20-197"><a href="#cb20-197" aria-hidden="true" tabindex="-1"></a>          Trend_Category)</span>
<span id="cb20-198"><a href="#cb20-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-199"><a href="#cb20-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-200"><a href="#cb20-200" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to check for three consecutive NAs in a set of columns</span></span>
<span id="cb20-201"><a href="#cb20-201" aria-hidden="true" tabindex="-1"></a>check_consecutive_nas <span class="ot">&lt;-</span> <span class="cf">function</span>(year_values) {</span>
<span id="cb20-202"><a href="#cb20-202" aria-hidden="true" tabindex="-1"></a>  na_run_lengths <span class="ot">&lt;-</span> <span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>lengths[<span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>values]</span>
<span id="cb20-203"><a href="#cb20-203" aria-hidden="true" tabindex="-1"></a>  <span class="fu">any</span>(na_run_lengths <span class="sc">&gt;=</span> <span class="dv">3</span>)</span>
<span id="cb20-204"><a href="#cb20-204" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-205"><a href="#cb20-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-206"><a href="#cb20-206" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert all columns representing years to numeric</span></span>
<span id="cb20-207"><a href="#cb20-207" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb20-208"><a href="#cb20-208" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">d+$"</span>), as.numeric))</span>
<span id="cb20-209"><a href="#cb20-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-210"><a href="#cb20-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-211"><a href="#cb20-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-212"><a href="#cb20-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-213"><a href="#cb20-213" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge and mutate Long_Term_Trend</span></span>
<span id="cb20-214"><a href="#cb20-214" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb20-215"><a href="#cb20-215" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb20-216"><a href="#cb20-216" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Long_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">check_consecutive_nas</span>(<span class="fu">c_across</span>(<span class="st">`</span><span class="at">2011</span><span class="st">`</span><span class="sc">:</span><span class="st">`</span><span class="at">2023</span><span class="st">`</span>)), </span>
<span id="cb20-217"><a href="#cb20-217" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb20-218"><a href="#cb20-218" aria-hidden="true" tabindex="-1"></a>                                  Long_Term_Trend),</span>
<span id="cb20-219"><a href="#cb20-219" aria-hidden="true" tabindex="-1"></a>         <span class="at">Short_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(<span class="st">`</span><span class="at">2019</span><span class="st">`</span>) <span class="sc">|</span> <span class="fu">is.na</span>(<span class="st">`</span><span class="at">2023</span><span class="st">`</span>), </span>
<span id="cb20-220"><a href="#cb20-220" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb20-221"><a href="#cb20-221" aria-hidden="true" tabindex="-1"></a>                                   Short_Term_Trend)) <span class="sc">%&gt;%</span></span>
<span id="cb20-222"><a href="#cb20-222" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb20-223"><a href="#cb20-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-224"><a href="#cb20-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-225"><a href="#cb20-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-226"><a href="#cb20-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-227"><a href="#cb20-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-228"><a href="#cb20-228" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results)</span>
<span id="cb20-229"><a href="#cb20-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-230"><a href="#cb20-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-231"><a href="#cb20-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-232"><a href="#cb20-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-233"><a href="#cb20-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-234"><a href="#cb20-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-235"><a href="#cb20-235" aria-hidden="true" tabindex="-1"></a>trend_results_race_4_white <span class="ot">&lt;-</span> trend_results</span>
<span id="cb20-236"><a href="#cb20-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-237"><a href="#cb20-237" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results_race_4_white)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="othermultiple-1" class="level4">
<h4 class="anchored" data-anchor-id="othermultiple-1">*4.4 - Other/Multiple</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="do">######## Import Raw and Analyzed Excel Files ###############</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>yrbs_master_analysis_stwd_trend <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Race_Group_4 Trend"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Trend_Category <span class="sc">==</span> <span class="st">"Other/Multiple"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="st">"Suppressed"</span>, <span class="cn">NA</span>, .)))</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the raw data set to be used in trend analyis</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>raw_stwd_general <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"raw_yrbs_allyears_statewide_trad_cleaned.xlsx"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Race_Group_4 <span class="sc">==</span> <span class="st">"Other/Multiple"</span>,</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>         Survey_Year <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2011</span>,</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2013</span>, </span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2015</span>, </span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2017</span>,</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2019</span>, </span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2023</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>                            )) <span class="sc">%&gt;%</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">2</span>, <span class="dv">0</span>, <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="cn">NA</span>))))</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine which survey questions (ROI - Response of Interest) have data across at least two distinct survey years</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>roi_years <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), Survey_Year) <span class="sc">%&gt;%</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>Survey_Year, </span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"ROI_Indicator_Code"</span>, </span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ROI_Indicator_Code) <span class="sc">%&gt;%</span></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">unique_years =</span> <span class="fu">n_distinct</span>(Survey_Year), </span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(unique_years <span class="sc">&gt;=</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(ROI_Indicator_Code)</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the main data set to include only those ROIs, also ensuring to keep necessary demographic variables</span></span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>filtered_raw_stwd_general <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Survey_Year, <span class="fu">all_of</span>(roi_years), Sex, Grade, Primary_Samp_Unit,Stratum,Final_Weight)</span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a><span class="do">############ Long Term Trend ###############</span></span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a><span class="co">#Trend Analysis Function</span></span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>analyze_trend_logistic <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Survey Design for YRBS Statewide</span></span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_survey_design</span>(<span class="at">ids =</span> Primary_Samp_Unit,</span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a>                     <span class="at">strata =</span> Stratum,</span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>                     <span class="at">weights =</span> Final_Weight,</span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span></span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Sex =</span> <span class="fu">factor</span>(Sex), <span class="at">Grade =</span> <span class="fu">factor</span>(Grade))</span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(data_filtered) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">length</span>(<span class="fu">unique</span>(data_filtered<span class="sc">$</span>variables<span class="sc">$</span>Survey_Year)) <span class="sc">&lt;</span> <span class="dv">4</span>) {</span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a>  base_formula <span class="ot">&lt;-</span> <span class="fu">paste</span>(column_name, <span class="st">"~ Sex + Grade + Survey_Year"</span>) </span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit the model using logistic regression</span></span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">svyglm</span>(<span class="fu">as.formula</span>(base_formula), <span class="at">design =</span> data_filtered, <span class="at">family =</span> <span class="fu">quasibinomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Error fitting model: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb21-68"><a href="#cb21-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb21-69"><a href="#cb21-69" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb21-70"><a href="#cb21-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-71"><a href="#cb21-71" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if model fitting was successful</span></span>
<span id="cb21-72"><a href="#cb21-72" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(model)) {</span>
<span id="cb21-73"><a href="#cb21-73" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error"</span>))</span>
<span id="cb21-74"><a href="#cb21-74" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-75"><a href="#cb21-75" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-76"><a href="#cb21-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check for coefficients</span></span>
<span id="cb21-77"><a href="#cb21-77" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>(<span class="st">"Survey_Year"</span> <span class="sc">%in%</span> <span class="fu">names</span>(<span class="fu">coef</span>(model)))) {</span>
<span id="cb21-78"><a href="#cb21-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No valid coefficient for Survey_Year"</span>))</span>
<span id="cb21-79"><a href="#cb21-79" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-80"><a href="#cb21-80" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-81"><a href="#cb21-81" aria-hidden="true" tabindex="-1"></a>  coef_summary <span class="ot">=</span> <span class="fu">summary</span>(model)<span class="sc">$</span>coefficients</span>
<span id="cb21-82"><a href="#cb21-82" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(coef_summary) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb21-83"><a href="#cb21-83" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error: No coefficients"</span>))</span>
<span id="cb21-84"><a href="#cb21-84" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-85"><a href="#cb21-85" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-86"><a href="#cb21-86" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Determine the significance and direction of the trend</span></span>
<span id="cb21-87"><a href="#cb21-87" aria-hidden="true" tabindex="-1"></a>  p_value <span class="ot">=</span> coef_summary[<span class="st">"Survey_Year"</span>, <span class="st">"Pr(&gt;|t|)"</span>]</span>
<span id="cb21-88"><a href="#cb21-88" aria-hidden="true" tabindex="-1"></a>  coefficient <span class="ot">=</span> <span class="fu">coef</span>(model)[<span class="st">"Survey_Year"</span>]</span>
<span id="cb21-89"><a href="#cb21-89" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-90"><a href="#cb21-90" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(p_value)) {</span>
<span id="cb21-91"><a href="#cb21-91" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"P-value is NA"</span>))</span>
<span id="cb21-92"><a href="#cb21-92" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-93"><a href="#cb21-93" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-94"><a href="#cb21-94" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (p_value <span class="sc">&lt;=</span> <span class="fl">0.05</span>) {</span>
<span id="cb21-95"><a href="#cb21-95" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (coefficient <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb21-96"><a href="#cb21-96" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Increase"</span>))</span>
<span id="cb21-97"><a href="#cb21-97" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb21-98"><a href="#cb21-98" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Decrease"</span>))</span>
<span id="cb21-99"><a href="#cb21-99" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb21-100"><a href="#cb21-100" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb21-101"><a href="#cb21-101" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No Change"</span>))</span>
<span id="cb21-102"><a href="#cb21-102" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-103"><a href="#cb21-103" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-104"><a href="#cb21-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-105"><a href="#cb21-105" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the function to each ROI_Indicator_Code that has sufficient data</span></span>
<span id="cb21-106"><a href="#cb21-106" aria-hidden="true" tabindex="-1"></a>long_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(filtered_raw_stwd_general)[<span class="sc">-</span><span class="dv">1</span>], <span class="cf">function</span>(column_name) {</span>
<span id="cb21-107"><a href="#cb21-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_trend_logistic</span>(filtered_raw_stwd_general, column_name)</span>
<span id="cb21-108"><a href="#cb21-108" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb21-109"><a href="#cb21-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-110"><a href="#cb21-110" aria-hidden="true" tabindex="-1"></a><span class="co"># Show results</span></span>
<span id="cb21-111"><a href="#cb21-111" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(long_trend_results)</span>
<span id="cb21-112"><a href="#cb21-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-113"><a href="#cb21-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-114"><a href="#cb21-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-115"><a href="#cb21-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-116"><a href="#cb21-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-117"><a href="#cb21-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-118"><a href="#cb21-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-119"><a href="#cb21-119" aria-hidden="true" tabindex="-1"></a><span class="do">######### Short Term Trend ###############</span></span>
<span id="cb21-120"><a href="#cb21-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-121"><a href="#cb21-121" aria-hidden="true" tabindex="-1"></a>analyze_short_term_trend_ttest <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb21-122"><a href="#cb21-122" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the short-term years</span></span>
<span id="cb21-123"><a href="#cb21-123" aria-hidden="true" tabindex="-1"></a>    short_term_years <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2019</span>, <span class="dv">2023</span>)</span>
<span id="cb21-124"><a href="#cb21-124" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-125"><a href="#cb21-125" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter for short-term years and ensure all necessary variables are selected</span></span>
<span id="cb21-126"><a href="#cb21-126" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb21-127"><a href="#cb21-127" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(Survey_Year <span class="sc">%in%</span> short_term_years) <span class="sc">%&gt;%</span></span>
<span id="cb21-128"><a href="#cb21-128" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(Primary_Samp_Unit, Stratum, Final_Weight, Survey_Year, <span class="fu">all_of</span>(column_name)) <span class="sc">%&gt;%</span></span>
<span id="cb21-129"><a href="#cb21-129" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">response =</span> <span class="fu">get</span>(column_name) <span class="sc">==</span> <span class="dv">1</span>)  <span class="co"># Create a binary response variable for the analysis</span></span>
<span id="cb21-130"><a href="#cb21-130" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-131"><a href="#cb21-131" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if data is available for both years</span></span>
<span id="cb21-132"><a href="#cb21-132" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(short_term_years <span class="sc">%in%</span> <span class="fu">unique</span>(data_filtered<span class="sc">$</span>Survey_Year[<span class="sc">!</span><span class="fu">is.na</span>(data_filtered<span class="sc">$</span>response)]))) {</span>
<span id="cb21-133"><a href="#cb21-133" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb21-134"><a href="#cb21-134" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb21-135"><a href="#cb21-135" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-136"><a href="#cb21-136" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Continue with data that doesn't have NA responses</span></span>
<span id="cb21-137"><a href="#cb21-137" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(response))</span>
<span id="cb21-138"><a href="#cb21-138" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-139"><a href="#cb21-139" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create survey design object including the response variable</span></span>
<span id="cb21-140"><a href="#cb21-140" aria-hidden="true" tabindex="-1"></a>    survey_design <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="sc">~</span>Primary_Samp_Unit,</span>
<span id="cb21-141"><a href="#cb21-141" aria-hidden="true" tabindex="-1"></a>                               <span class="at">strata =</span> <span class="sc">~</span>Stratum,</span>
<span id="cb21-142"><a href="#cb21-142" aria-hidden="true" tabindex="-1"></a>                               <span class="at">weights =</span> <span class="sc">~</span>Final_Weight,</span>
<span id="cb21-143"><a href="#cb21-143" aria-hidden="true" tabindex="-1"></a>                               <span class="at">data =</span> data_filtered,</span>
<span id="cb21-144"><a href="#cb21-144" aria-hidden="true" tabindex="-1"></a>                               <span class="at">nest =</span> <span class="cn">TRUE</span>) </span>
<span id="cb21-145"><a href="#cb21-145" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-146"><a href="#cb21-146" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Perform Welch's t-test using the survey design object</span></span>
<span id="cb21-147"><a href="#cb21-147" aria-hidden="true" tabindex="-1"></a>    ttest_result <span class="ot">&lt;-</span> <span class="fu">svyttest</span>(response <span class="sc">~</span> <span class="fu">as.factor</span>(Survey_Year), survey_design)</span>
<span id="cb21-148"><a href="#cb21-148" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-149"><a href="#cb21-149" aria-hidden="true" tabindex="-1"></a>    <span class="co"># head t-test results</span></span>
<span id="cb21-150"><a href="#cb21-150" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(ttest_result)</span>
<span id="cb21-151"><a href="#cb21-151" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-152"><a href="#cb21-152" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check significance and interpret the results</span></span>
<span id="cb21-153"><a href="#cb21-153" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(ttest_result<span class="sc">$</span>p.value) <span class="sc">&amp;&amp;</span> ttest_result<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>) {</span>
<span id="cb21-154"><a href="#cb21-154" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(ttest_result<span class="sc">$</span>estimate <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Significant Increase"</span>, <span class="st">"Significant Decrease"</span>)</span>
<span id="cb21-155"><a href="#cb21-155" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb21-156"><a href="#cb21-156" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="st">"No Change"</span></span>
<span id="cb21-157"><a href="#cb21-157" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb21-158"><a href="#cb21-158" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-159"><a href="#cb21-159" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> trend))</span>
<span id="cb21-160"><a href="#cb21-160" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-161"><a href="#cb21-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-162"><a href="#cb21-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-163"><a href="#cb21-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-164"><a href="#cb21-164" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the short-term function to each ROI_Indicator_Code</span></span>
<span id="cb21-165"><a href="#cb21-165" aria-hidden="true" tabindex="-1"></a>short_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(raw_stwd_general)[<span class="fu">grep</span>(<span class="st">"^(QN|V).*[RP]"</span>, <span class="fu">names</span>(raw_stwd_general))], <span class="cf">function</span>(column_name) {</span>
<span id="cb21-166"><a href="#cb21-166" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_short_term_trend_ttest</span>(raw_stwd_general, column_name)</span>
<span id="cb21-167"><a href="#cb21-167" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb21-168"><a href="#cb21-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-169"><a href="#cb21-169" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(short_trend_results)</span>
<span id="cb21-170"><a href="#cb21-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-171"><a href="#cb21-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-172"><a href="#cb21-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-173"><a href="#cb21-173" aria-hidden="true" tabindex="-1"></a><span class="do">################### Join Together with Trend Tables ############</span></span>
<span id="cb21-174"><a href="#cb21-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-175"><a href="#cb21-175" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine long-term and short-term results</span></span>
<span id="cb21-176"><a href="#cb21-176" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> <span class="fu">left_join</span>(long_trend_results, </span>
<span id="cb21-177"><a href="#cb21-177" aria-hidden="true" tabindex="-1"></a>                                    short_trend_results, </span>
<span id="cb21-178"><a href="#cb21-178" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">by =</span> <span class="st">"ROI_Indicator_Code"</span>)</span>
<span id="cb21-179"><a href="#cb21-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-180"><a href="#cb21-180" aria-hidden="true" tabindex="-1"></a><span class="co">#head(combined_trend_results)</span></span>
<span id="cb21-181"><a href="#cb21-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-182"><a href="#cb21-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-183"><a href="#cb21-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-184"><a href="#cb21-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-185"><a href="#cb21-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-186"><a href="#cb21-186" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge Long_Term_Trend into yrbs_master_stwd_grade based on matching ROI_Indicator_Code and Trend_Category</span></span>
<span id="cb21-187"><a href="#cb21-187" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> yrbs_master_analysis_stwd_trend <span class="sc">%&gt;%</span></span>
<span id="cb21-188"><a href="#cb21-188" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(combined_trend_results <span class="sc">%&gt;%</span> <span class="fu">select</span>(ROI_Indicator_Code, Long_Term_Trend, Short_Term_Trend),</span>
<span id="cb21-189"><a href="#cb21-189" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ROI_Indicator_Code"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb21-190"><a href="#cb21-190" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(School_Type,</span>
<span id="cb21-191"><a href="#cb21-191" aria-hidden="true" tabindex="-1"></a>         Health_Topic, </span>
<span id="cb21-192"><a href="#cb21-192" aria-hidden="true" tabindex="-1"></a>         ROI_Indicator_Code, </span>
<span id="cb21-193"><a href="#cb21-193" aria-hidden="true" tabindex="-1"></a>         Indicator_Long_Description, </span>
<span id="cb21-194"><a href="#cb21-194" aria-hidden="true" tabindex="-1"></a>         Trend_Category, </span>
<span id="cb21-195"><a href="#cb21-195" aria-hidden="true" tabindex="-1"></a>         <span class="fu">everything</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb21-196"><a href="#cb21-196" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, </span>
<span id="cb21-197"><a href="#cb21-197" aria-hidden="true" tabindex="-1"></a>          ROI_Indicator_Code, </span>
<span id="cb21-198"><a href="#cb21-198" aria-hidden="true" tabindex="-1"></a>          Trend_Category)</span>
<span id="cb21-199"><a href="#cb21-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-200"><a href="#cb21-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-201"><a href="#cb21-201" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to check for three consecutive NAs in a set of columns</span></span>
<span id="cb21-202"><a href="#cb21-202" aria-hidden="true" tabindex="-1"></a>check_consecutive_nas <span class="ot">&lt;-</span> <span class="cf">function</span>(year_values) {</span>
<span id="cb21-203"><a href="#cb21-203" aria-hidden="true" tabindex="-1"></a>  na_run_lengths <span class="ot">&lt;-</span> <span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>lengths[<span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>values]</span>
<span id="cb21-204"><a href="#cb21-204" aria-hidden="true" tabindex="-1"></a>  <span class="fu">any</span>(na_run_lengths <span class="sc">&gt;=</span> <span class="dv">3</span>)</span>
<span id="cb21-205"><a href="#cb21-205" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-206"><a href="#cb21-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-207"><a href="#cb21-207" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert all columns representing years to numeric</span></span>
<span id="cb21-208"><a href="#cb21-208" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb21-209"><a href="#cb21-209" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">d+$"</span>), as.numeric))</span>
<span id="cb21-210"><a href="#cb21-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-211"><a href="#cb21-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-212"><a href="#cb21-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-213"><a href="#cb21-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-214"><a href="#cb21-214" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge and mutate Long_Term_Trend</span></span>
<span id="cb21-215"><a href="#cb21-215" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb21-216"><a href="#cb21-216" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb21-217"><a href="#cb21-217" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Long_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">check_consecutive_nas</span>(<span class="fu">c_across</span>(<span class="st">`</span><span class="at">2011</span><span class="st">`</span><span class="sc">:</span><span class="st">`</span><span class="at">2023</span><span class="st">`</span>)), </span>
<span id="cb21-218"><a href="#cb21-218" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb21-219"><a href="#cb21-219" aria-hidden="true" tabindex="-1"></a>                                  Long_Term_Trend),</span>
<span id="cb21-220"><a href="#cb21-220" aria-hidden="true" tabindex="-1"></a>         <span class="at">Short_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(<span class="st">`</span><span class="at">2019</span><span class="st">`</span>) <span class="sc">|</span> <span class="fu">is.na</span>(<span class="st">`</span><span class="at">2023</span><span class="st">`</span>), </span>
<span id="cb21-221"><a href="#cb21-221" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb21-222"><a href="#cb21-222" aria-hidden="true" tabindex="-1"></a>                                   Short_Term_Trend)) <span class="sc">%&gt;%</span></span>
<span id="cb21-223"><a href="#cb21-223" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb21-224"><a href="#cb21-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-225"><a href="#cb21-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-226"><a href="#cb21-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-227"><a href="#cb21-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-228"><a href="#cb21-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-229"><a href="#cb21-229" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results)</span>
<span id="cb21-230"><a href="#cb21-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-231"><a href="#cb21-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-232"><a href="#cb21-232" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb21-233"><a href="#cb21-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-234"><a href="#cb21-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-235"><a href="#cb21-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-236"><a href="#cb21-236" aria-hidden="true" tabindex="-1"></a>trend_results_race_4_other_race_mult <span class="ot">&lt;-</span> trend_results</span>
<span id="cb21-237"><a href="#cb21-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-238"><a href="#cb21-238" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results_race_4_other_race_mult)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="trend-by-race_group_8" class="level3">
<h3 class="anchored" data-anchor-id="trend-by-race_group_8">Trend By Race_Group_8</h3>
<section id="alaska-nativeamerican-indian-3" class="level4">
<h4 class="anchored" data-anchor-id="alaska-nativeamerican-indian-3">8.1 - Alaska Native/American Indian</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="do">######## Import Raw and Analyzed Excel Files ###############</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>yrbs_master_analysis_stwd_trend <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Race_Group_8 Trend"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Trend_Category <span class="sc">==</span> <span class="st">"Alaska Native/American Indian"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="st">"Suppressed"</span>, <span class="cn">NA</span>, .)))</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the raw data set to be used in trend analyis</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>raw_stwd_general <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"raw_yrbs_allyears_statewide_trad_cleaned.xlsx"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Race_Group_8 <span class="sc">==</span> <span class="st">"Alaska Native/American Indian"</span>,</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>         Survey_Year <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2011</span>,</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2013</span>, </span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2015</span>, </span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2017</span>,</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2019</span>, </span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2023</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>                            )) <span class="sc">%&gt;%</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">2</span>, <span class="dv">0</span>, <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="cn">NA</span>))))</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine which survey questions (ROI - Response of Interest) have data across at least two distinct survey years</span></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>roi_years <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), Survey_Year) <span class="sc">%&gt;%</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>Survey_Year, </span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"ROI_Indicator_Code"</span>, </span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ROI_Indicator_Code) <span class="sc">%&gt;%</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">unique_years =</span> <span class="fu">n_distinct</span>(Survey_Year), </span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(unique_years <span class="sc">&gt;=</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(ROI_Indicator_Code)</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the main data set to include only those ROIs, also ensuring to keep necessary demographic variables</span></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>filtered_raw_stwd_general <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Survey_Year, <span class="fu">all_of</span>(roi_years), Sex, Grade, Primary_Samp_Unit,Stratum,Final_Weight)</span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a><span class="do">############ Long Term Trend ###############</span></span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a><span class="co">#Trend Analysis Function</span></span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>analyze_trend_logistic <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Survey Design for YRBS Statewide</span></span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_survey_design</span>(<span class="at">ids =</span> Primary_Samp_Unit,</span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>                     <span class="at">strata =</span> Stratum,</span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a>                     <span class="at">weights =</span> Final_Weight,</span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span></span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Sex =</span> <span class="fu">factor</span>(Sex), <span class="at">Grade =</span> <span class="fu">factor</span>(Grade))</span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(data_filtered) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">length</span>(<span class="fu">unique</span>(data_filtered<span class="sc">$</span>variables<span class="sc">$</span>Survey_Year)) <span class="sc">&lt;</span> <span class="dv">4</span>) {</span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a>  base_formula <span class="ot">&lt;-</span> <span class="fu">paste</span>(column_name, <span class="st">"~ Sex + Grade + Survey_Year"</span>) </span>
<span id="cb22-62"><a href="#cb22-62" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit the model using logistic regression</span></span>
<span id="cb22-63"><a href="#cb22-63" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb22-64"><a href="#cb22-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">svyglm</span>(<span class="fu">as.formula</span>(base_formula), <span class="at">design =</span> data_filtered, <span class="at">family =</span> <span class="fu">quasibinomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb22-65"><a href="#cb22-65" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb22-66"><a href="#cb22-66" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Error fitting model: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb22-67"><a href="#cb22-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb22-68"><a href="#cb22-68" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb22-69"><a href="#cb22-69" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-70"><a href="#cb22-70" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if model fitting was successful</span></span>
<span id="cb22-71"><a href="#cb22-71" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(model)) {</span>
<span id="cb22-72"><a href="#cb22-72" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error"</span>))</span>
<span id="cb22-73"><a href="#cb22-73" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb22-74"><a href="#cb22-74" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-75"><a href="#cb22-75" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check for coefficients</span></span>
<span id="cb22-76"><a href="#cb22-76" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>(<span class="st">"Survey_Year"</span> <span class="sc">%in%</span> <span class="fu">names</span>(<span class="fu">coef</span>(model)))) {</span>
<span id="cb22-77"><a href="#cb22-77" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No valid coefficient for Survey_Year"</span>))</span>
<span id="cb22-78"><a href="#cb22-78" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb22-79"><a href="#cb22-79" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-80"><a href="#cb22-80" aria-hidden="true" tabindex="-1"></a>  coef_summary <span class="ot">=</span> <span class="fu">summary</span>(model)<span class="sc">$</span>coefficients</span>
<span id="cb22-81"><a href="#cb22-81" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(coef_summary) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb22-82"><a href="#cb22-82" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error: No coefficients"</span>))</span>
<span id="cb22-83"><a href="#cb22-83" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb22-84"><a href="#cb22-84" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-85"><a href="#cb22-85" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Determine the significance and direction of the trend</span></span>
<span id="cb22-86"><a href="#cb22-86" aria-hidden="true" tabindex="-1"></a>  p_value <span class="ot">=</span> coef_summary[<span class="st">"Survey_Year"</span>, <span class="st">"Pr(&gt;|t|)"</span>]</span>
<span id="cb22-87"><a href="#cb22-87" aria-hidden="true" tabindex="-1"></a>  coefficient <span class="ot">=</span> <span class="fu">coef</span>(model)[<span class="st">"Survey_Year"</span>]</span>
<span id="cb22-88"><a href="#cb22-88" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-89"><a href="#cb22-89" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(p_value)) {</span>
<span id="cb22-90"><a href="#cb22-90" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"P-value is NA"</span>))</span>
<span id="cb22-91"><a href="#cb22-91" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb22-92"><a href="#cb22-92" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-93"><a href="#cb22-93" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (p_value <span class="sc">&lt;=</span> <span class="fl">0.05</span>) {</span>
<span id="cb22-94"><a href="#cb22-94" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (coefficient <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb22-95"><a href="#cb22-95" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Increase"</span>))</span>
<span id="cb22-96"><a href="#cb22-96" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb22-97"><a href="#cb22-97" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Decrease"</span>))</span>
<span id="cb22-98"><a href="#cb22-98" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb22-99"><a href="#cb22-99" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb22-100"><a href="#cb22-100" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No Change"</span>))</span>
<span id="cb22-101"><a href="#cb22-101" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb22-102"><a href="#cb22-102" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-103"><a href="#cb22-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-104"><a href="#cb22-104" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the function to each ROI_Indicator_Code that has sufficient data</span></span>
<span id="cb22-105"><a href="#cb22-105" aria-hidden="true" tabindex="-1"></a>long_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(filtered_raw_stwd_general)[<span class="sc">-</span><span class="dv">1</span>], <span class="cf">function</span>(column_name) {</span>
<span id="cb22-106"><a href="#cb22-106" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_trend_logistic</span>(filtered_raw_stwd_general, column_name)</span>
<span id="cb22-107"><a href="#cb22-107" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb22-108"><a href="#cb22-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-109"><a href="#cb22-109" aria-hidden="true" tabindex="-1"></a><span class="co"># Show results</span></span>
<span id="cb22-110"><a href="#cb22-110" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(long_trend_results)</span>
<span id="cb22-111"><a href="#cb22-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-112"><a href="#cb22-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-113"><a href="#cb22-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-114"><a href="#cb22-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-115"><a href="#cb22-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-116"><a href="#cb22-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-117"><a href="#cb22-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-118"><a href="#cb22-118" aria-hidden="true" tabindex="-1"></a><span class="do">######### Short Term Trend ###############</span></span>
<span id="cb22-119"><a href="#cb22-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-120"><a href="#cb22-120" aria-hidden="true" tabindex="-1"></a>analyze_short_term_trend_ttest <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb22-121"><a href="#cb22-121" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the short-term years</span></span>
<span id="cb22-122"><a href="#cb22-122" aria-hidden="true" tabindex="-1"></a>    short_term_years <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2019</span>, <span class="dv">2023</span>)</span>
<span id="cb22-123"><a href="#cb22-123" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-124"><a href="#cb22-124" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter for short-term years and ensure all necessary variables are selected</span></span>
<span id="cb22-125"><a href="#cb22-125" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb22-126"><a href="#cb22-126" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(Survey_Year <span class="sc">%in%</span> short_term_years) <span class="sc">%&gt;%</span></span>
<span id="cb22-127"><a href="#cb22-127" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(Primary_Samp_Unit, Stratum, Final_Weight, Survey_Year, <span class="fu">all_of</span>(column_name)) <span class="sc">%&gt;%</span></span>
<span id="cb22-128"><a href="#cb22-128" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">response =</span> <span class="fu">get</span>(column_name) <span class="sc">==</span> <span class="dv">1</span>)  <span class="co"># Create a binary response variable for the analysis</span></span>
<span id="cb22-129"><a href="#cb22-129" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-130"><a href="#cb22-130" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if data is available for both years</span></span>
<span id="cb22-131"><a href="#cb22-131" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(short_term_years <span class="sc">%in%</span> <span class="fu">unique</span>(data_filtered<span class="sc">$</span>Survey_Year[<span class="sc">!</span><span class="fu">is.na</span>(data_filtered<span class="sc">$</span>response)]))) {</span>
<span id="cb22-132"><a href="#cb22-132" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb22-133"><a href="#cb22-133" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb22-134"><a href="#cb22-134" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-135"><a href="#cb22-135" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Continue with data that doesn't have NA responses</span></span>
<span id="cb22-136"><a href="#cb22-136" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(response))</span>
<span id="cb22-137"><a href="#cb22-137" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-138"><a href="#cb22-138" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create survey design object including the response variable</span></span>
<span id="cb22-139"><a href="#cb22-139" aria-hidden="true" tabindex="-1"></a>    survey_design <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="sc">~</span>Primary_Samp_Unit,</span>
<span id="cb22-140"><a href="#cb22-140" aria-hidden="true" tabindex="-1"></a>                               <span class="at">strata =</span> <span class="sc">~</span>Stratum,</span>
<span id="cb22-141"><a href="#cb22-141" aria-hidden="true" tabindex="-1"></a>                               <span class="at">weights =</span> <span class="sc">~</span>Final_Weight,</span>
<span id="cb22-142"><a href="#cb22-142" aria-hidden="true" tabindex="-1"></a>                               <span class="at">data =</span> data_filtered,</span>
<span id="cb22-143"><a href="#cb22-143" aria-hidden="true" tabindex="-1"></a>                               <span class="at">nest =</span> <span class="cn">TRUE</span>) </span>
<span id="cb22-144"><a href="#cb22-144" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-145"><a href="#cb22-145" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Perform Welch's t-test using the survey design object</span></span>
<span id="cb22-146"><a href="#cb22-146" aria-hidden="true" tabindex="-1"></a>    ttest_result <span class="ot">&lt;-</span> <span class="fu">svyttest</span>(response <span class="sc">~</span> <span class="fu">as.factor</span>(Survey_Year), survey_design)</span>
<span id="cb22-147"><a href="#cb22-147" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-148"><a href="#cb22-148" aria-hidden="true" tabindex="-1"></a>    <span class="co"># head t-test results</span></span>
<span id="cb22-149"><a href="#cb22-149" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(ttest_result)</span>
<span id="cb22-150"><a href="#cb22-150" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-151"><a href="#cb22-151" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check significance and interpret the results</span></span>
<span id="cb22-152"><a href="#cb22-152" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(ttest_result<span class="sc">$</span>p.value) <span class="sc">&amp;&amp;</span> ttest_result<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>) {</span>
<span id="cb22-153"><a href="#cb22-153" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(ttest_result<span class="sc">$</span>estimate <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Significant Increase"</span>, <span class="st">"Significant Decrease"</span>)</span>
<span id="cb22-154"><a href="#cb22-154" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb22-155"><a href="#cb22-155" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="st">"No Change"</span></span>
<span id="cb22-156"><a href="#cb22-156" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb22-157"><a href="#cb22-157" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-158"><a href="#cb22-158" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> trend))</span>
<span id="cb22-159"><a href="#cb22-159" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-160"><a href="#cb22-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-161"><a href="#cb22-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-162"><a href="#cb22-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-163"><a href="#cb22-163" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the short-term function to each ROI_Indicator_Code</span></span>
<span id="cb22-164"><a href="#cb22-164" aria-hidden="true" tabindex="-1"></a>short_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(raw_stwd_general)[<span class="fu">grep</span>(<span class="st">"^(QN|V).*[RP]"</span>, <span class="fu">names</span>(raw_stwd_general))], <span class="cf">function</span>(column_name) {</span>
<span id="cb22-165"><a href="#cb22-165" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_short_term_trend_ttest</span>(raw_stwd_general, column_name)</span>
<span id="cb22-166"><a href="#cb22-166" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb22-167"><a href="#cb22-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-168"><a href="#cb22-168" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(short_trend_results)</span>
<span id="cb22-169"><a href="#cb22-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-170"><a href="#cb22-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-171"><a href="#cb22-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-172"><a href="#cb22-172" aria-hidden="true" tabindex="-1"></a><span class="do">################### Join Together with Trend Tables ############</span></span>
<span id="cb22-173"><a href="#cb22-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-174"><a href="#cb22-174" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine long-term and short-term results</span></span>
<span id="cb22-175"><a href="#cb22-175" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> <span class="fu">left_join</span>(long_trend_results, </span>
<span id="cb22-176"><a href="#cb22-176" aria-hidden="true" tabindex="-1"></a>                                    short_trend_results, </span>
<span id="cb22-177"><a href="#cb22-177" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">by =</span> <span class="st">"ROI_Indicator_Code"</span>)</span>
<span id="cb22-178"><a href="#cb22-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-179"><a href="#cb22-179" aria-hidden="true" tabindex="-1"></a><span class="co">#head(combined_trend_results)</span></span>
<span id="cb22-180"><a href="#cb22-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-181"><a href="#cb22-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-182"><a href="#cb22-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-183"><a href="#cb22-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-184"><a href="#cb22-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-185"><a href="#cb22-185" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge Long_Term_Trend into yrbs_master_stwd_grade based on matching ROI_Indicator_Code and Trend_Category</span></span>
<span id="cb22-186"><a href="#cb22-186" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> yrbs_master_analysis_stwd_trend <span class="sc">%&gt;%</span></span>
<span id="cb22-187"><a href="#cb22-187" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(combined_trend_results <span class="sc">%&gt;%</span> <span class="fu">select</span>(ROI_Indicator_Code, Long_Term_Trend, Short_Term_Trend),</span>
<span id="cb22-188"><a href="#cb22-188" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ROI_Indicator_Code"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb22-189"><a href="#cb22-189" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(School_Type,</span>
<span id="cb22-190"><a href="#cb22-190" aria-hidden="true" tabindex="-1"></a>         Health_Topic, </span>
<span id="cb22-191"><a href="#cb22-191" aria-hidden="true" tabindex="-1"></a>         ROI_Indicator_Code, </span>
<span id="cb22-192"><a href="#cb22-192" aria-hidden="true" tabindex="-1"></a>         Indicator_Long_Description, </span>
<span id="cb22-193"><a href="#cb22-193" aria-hidden="true" tabindex="-1"></a>         Trend_Category, </span>
<span id="cb22-194"><a href="#cb22-194" aria-hidden="true" tabindex="-1"></a>         <span class="fu">everything</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb22-195"><a href="#cb22-195" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, </span>
<span id="cb22-196"><a href="#cb22-196" aria-hidden="true" tabindex="-1"></a>          ROI_Indicator_Code, </span>
<span id="cb22-197"><a href="#cb22-197" aria-hidden="true" tabindex="-1"></a>          Trend_Category)</span>
<span id="cb22-198"><a href="#cb22-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-199"><a href="#cb22-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-200"><a href="#cb22-200" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to check for three consecutive NAs in a set of columns</span></span>
<span id="cb22-201"><a href="#cb22-201" aria-hidden="true" tabindex="-1"></a>check_consecutive_nas <span class="ot">&lt;-</span> <span class="cf">function</span>(year_values) {</span>
<span id="cb22-202"><a href="#cb22-202" aria-hidden="true" tabindex="-1"></a>  na_run_lengths <span class="ot">&lt;-</span> <span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>lengths[<span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>values]</span>
<span id="cb22-203"><a href="#cb22-203" aria-hidden="true" tabindex="-1"></a>  <span class="fu">any</span>(na_run_lengths <span class="sc">&gt;=</span> <span class="dv">3</span>)</span>
<span id="cb22-204"><a href="#cb22-204" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-205"><a href="#cb22-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-206"><a href="#cb22-206" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert all columns representing years to numeric</span></span>
<span id="cb22-207"><a href="#cb22-207" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb22-208"><a href="#cb22-208" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">d+$"</span>), as.numeric))</span>
<span id="cb22-209"><a href="#cb22-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-210"><a href="#cb22-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-211"><a href="#cb22-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-212"><a href="#cb22-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-213"><a href="#cb22-213" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge and mutate Long_Term_Trend</span></span>
<span id="cb22-214"><a href="#cb22-214" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb22-215"><a href="#cb22-215" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb22-216"><a href="#cb22-216" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Long_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">check_consecutive_nas</span>(<span class="fu">c_across</span>(<span class="st">`</span><span class="at">2011</span><span class="st">`</span><span class="sc">:</span><span class="st">`</span><span class="at">2023</span><span class="st">`</span>)), </span>
<span id="cb22-217"><a href="#cb22-217" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb22-218"><a href="#cb22-218" aria-hidden="true" tabindex="-1"></a>                                  Long_Term_Trend),</span>
<span id="cb22-219"><a href="#cb22-219" aria-hidden="true" tabindex="-1"></a>         <span class="at">Short_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(<span class="st">`</span><span class="at">2019</span><span class="st">`</span>) <span class="sc">|</span> <span class="fu">is.na</span>(<span class="st">`</span><span class="at">2023</span><span class="st">`</span>), </span>
<span id="cb22-220"><a href="#cb22-220" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb22-221"><a href="#cb22-221" aria-hidden="true" tabindex="-1"></a>                                   Short_Term_Trend)) <span class="sc">%&gt;%</span></span>
<span id="cb22-222"><a href="#cb22-222" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb22-223"><a href="#cb22-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-224"><a href="#cb22-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-225"><a href="#cb22-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-226"><a href="#cb22-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-227"><a href="#cb22-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-228"><a href="#cb22-228" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results)</span>
<span id="cb22-229"><a href="#cb22-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-230"><a href="#cb22-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-231"><a href="#cb22-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-232"><a href="#cb22-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-233"><a href="#cb22-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-234"><a href="#cb22-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-235"><a href="#cb22-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-236"><a href="#cb22-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-237"><a href="#cb22-237" aria-hidden="true" tabindex="-1"></a>trend_results_race_8_ANAI <span class="ot">&lt;-</span> trend_results</span>
<span id="cb22-238"><a href="#cb22-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-239"><a href="#cb22-239" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results_race_8_ANAI)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="asian" class="level4">
<h4 class="anchored" data-anchor-id="asian">8.2 - Asian</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Please note for this demographic, the sample size was too small and is only adjusted for sex and NOT grade, as the rest are.</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="do">######## Import Raw and Analyzed Excel Files ###############</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>yrbs_master_analysis_stwd_trend <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Race_Group_8 Trend"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Trend_Category <span class="sc">==</span> <span class="st">"Asian"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="st">"Suppressed"</span>, <span class="cn">NA</span>, .)))</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the raw data set to be used in trend analyis</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>raw_stwd_general <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"raw_yrbs_allyears_statewide_trad_cleaned.xlsx"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Race_Group_8 <span class="sc">==</span> <span class="st">"Asian"</span>,</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>         Survey_Year <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2011</span>,</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2013</span>, </span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2015</span>, </span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2017</span>,</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2019</span>, </span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2023</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>                            )) <span class="sc">%&gt;%</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">2</span>, <span class="dv">0</span>, <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="cn">NA</span>))))</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine which survey questions (ROI - Response of Interest) have data across at least two distinct survey years</span></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>roi_years <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), Survey_Year) <span class="sc">%&gt;%</span></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>Survey_Year, </span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"ROI_Indicator_Code"</span>, </span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ROI_Indicator_Code) <span class="sc">%&gt;%</span></span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">unique_years =</span> <span class="fu">n_distinct</span>(Survey_Year), </span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(unique_years <span class="sc">&gt;=</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(ROI_Indicator_Code)</span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the main data set to include only those ROIs, also ensuring to keep necessary demographic variables</span></span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>filtered_raw_stwd_general <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Survey_Year, <span class="fu">all_of</span>(roi_years), Sex, Grade, Primary_Samp_Unit,Stratum,Final_Weight)</span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a><span class="do">############ Long Term Trend ###############</span></span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a><span class="co">#Trend Analysis Function</span></span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a>analyze_trend_logistic <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Survey Design for YRBS Statewide</span></span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_survey_design</span>(<span class="at">ids =</span> Primary_Samp_Unit,</span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a>                     <span class="at">strata =</span> Stratum,</span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a>                     <span class="at">weights =</span> Final_Weight,</span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb23-55"><a href="#cb23-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-56"><a href="#cb23-56" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span></span>
<span id="cb23-57"><a href="#cb23-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Sex =</span> <span class="fu">factor</span>(Sex), <span class="at">Grade =</span> <span class="fu">factor</span>(Grade))</span>
<span id="cb23-58"><a href="#cb23-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-59"><a href="#cb23-59" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(data_filtered) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">length</span>(<span class="fu">unique</span>(data_filtered<span class="sc">$</span>variables<span class="sc">$</span>Survey_Year)) <span class="sc">&lt;</span> <span class="dv">4</span>) {</span>
<span id="cb23-60"><a href="#cb23-60" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb23-61"><a href="#cb23-61" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb23-62"><a href="#cb23-62" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-63"><a href="#cb23-63" aria-hidden="true" tabindex="-1"></a>  base_formula <span class="ot">&lt;-</span> <span class="fu">paste</span>(column_name, <span class="st">"~ Sex + Grade + Survey_Year"</span>) </span>
<span id="cb23-64"><a href="#cb23-64" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit the model using logistic regression</span></span>
<span id="cb23-65"><a href="#cb23-65" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb23-66"><a href="#cb23-66" aria-hidden="true" tabindex="-1"></a>    <span class="fu">svyglm</span>(<span class="fu">as.formula</span>(base_formula), <span class="at">design =</span> data_filtered, <span class="at">family =</span> <span class="fu">quasibinomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb23-67"><a href="#cb23-67" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb23-68"><a href="#cb23-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Error fitting model: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb23-69"><a href="#cb23-69" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb23-70"><a href="#cb23-70" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb23-71"><a href="#cb23-71" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-72"><a href="#cb23-72" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if model fitting was successful</span></span>
<span id="cb23-73"><a href="#cb23-73" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(model)) {</span>
<span id="cb23-74"><a href="#cb23-74" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error"</span>))</span>
<span id="cb23-75"><a href="#cb23-75" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb23-76"><a href="#cb23-76" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-77"><a href="#cb23-77" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check for coefficients</span></span>
<span id="cb23-78"><a href="#cb23-78" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>(<span class="st">"Survey_Year"</span> <span class="sc">%in%</span> <span class="fu">names</span>(<span class="fu">coef</span>(model)))) {</span>
<span id="cb23-79"><a href="#cb23-79" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No valid coefficient for Survey_Year"</span>))</span>
<span id="cb23-80"><a href="#cb23-80" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb23-81"><a href="#cb23-81" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-82"><a href="#cb23-82" aria-hidden="true" tabindex="-1"></a>  coef_summary <span class="ot">=</span> <span class="fu">summary</span>(model)<span class="sc">$</span>coefficients</span>
<span id="cb23-83"><a href="#cb23-83" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(coef_summary) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb23-84"><a href="#cb23-84" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error: No coefficients"</span>))</span>
<span id="cb23-85"><a href="#cb23-85" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb23-86"><a href="#cb23-86" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-87"><a href="#cb23-87" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Determine the significance and direction of the trend</span></span>
<span id="cb23-88"><a href="#cb23-88" aria-hidden="true" tabindex="-1"></a>  p_value <span class="ot">=</span> coef_summary[<span class="st">"Survey_Year"</span>, <span class="st">"Pr(&gt;|t|)"</span>]</span>
<span id="cb23-89"><a href="#cb23-89" aria-hidden="true" tabindex="-1"></a>  coefficient <span class="ot">=</span> <span class="fu">coef</span>(model)[<span class="st">"Survey_Year"</span>]</span>
<span id="cb23-90"><a href="#cb23-90" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-91"><a href="#cb23-91" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(p_value)) {</span>
<span id="cb23-92"><a href="#cb23-92" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"P-value is NA"</span>))</span>
<span id="cb23-93"><a href="#cb23-93" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb23-94"><a href="#cb23-94" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-95"><a href="#cb23-95" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (p_value <span class="sc">&lt;=</span> <span class="fl">0.05</span>) {</span>
<span id="cb23-96"><a href="#cb23-96" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (coefficient <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb23-97"><a href="#cb23-97" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Increase"</span>))</span>
<span id="cb23-98"><a href="#cb23-98" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb23-99"><a href="#cb23-99" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Decrease"</span>))</span>
<span id="cb23-100"><a href="#cb23-100" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb23-101"><a href="#cb23-101" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb23-102"><a href="#cb23-102" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No Change"</span>))</span>
<span id="cb23-103"><a href="#cb23-103" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb23-104"><a href="#cb23-104" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-105"><a href="#cb23-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-106"><a href="#cb23-106" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the function to each ROI_Indicator_Code that has sufficient data</span></span>
<span id="cb23-107"><a href="#cb23-107" aria-hidden="true" tabindex="-1"></a>long_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(filtered_raw_stwd_general)[<span class="sc">-</span><span class="dv">1</span>], <span class="cf">function</span>(column_name) {</span>
<span id="cb23-108"><a href="#cb23-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_trend_logistic</span>(filtered_raw_stwd_general, column_name)</span>
<span id="cb23-109"><a href="#cb23-109" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb23-110"><a href="#cb23-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-111"><a href="#cb23-111" aria-hidden="true" tabindex="-1"></a><span class="co"># Show results</span></span>
<span id="cb23-112"><a href="#cb23-112" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(long_trend_results)</span>
<span id="cb23-113"><a href="#cb23-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-114"><a href="#cb23-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-115"><a href="#cb23-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-116"><a href="#cb23-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-117"><a href="#cb23-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-118"><a href="#cb23-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-119"><a href="#cb23-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-120"><a href="#cb23-120" aria-hidden="true" tabindex="-1"></a><span class="do">######### Short Term Trend ###############</span></span>
<span id="cb23-121"><a href="#cb23-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-122"><a href="#cb23-122" aria-hidden="true" tabindex="-1"></a>analyze_short_term_trend_ttest <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb23-123"><a href="#cb23-123" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the short-term years</span></span>
<span id="cb23-124"><a href="#cb23-124" aria-hidden="true" tabindex="-1"></a>    short_term_years <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2019</span>, <span class="dv">2023</span>)</span>
<span id="cb23-125"><a href="#cb23-125" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-126"><a href="#cb23-126" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter for short-term years and ensure all necessary variables are selected</span></span>
<span id="cb23-127"><a href="#cb23-127" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb23-128"><a href="#cb23-128" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(Survey_Year <span class="sc">%in%</span> short_term_years) <span class="sc">%&gt;%</span></span>
<span id="cb23-129"><a href="#cb23-129" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(Primary_Samp_Unit, Stratum, Final_Weight, Survey_Year, <span class="fu">all_of</span>(column_name)) <span class="sc">%&gt;%</span></span>
<span id="cb23-130"><a href="#cb23-130" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">response =</span> <span class="fu">get</span>(column_name) <span class="sc">==</span> <span class="dv">1</span>)  <span class="co"># Create a binary response variable for the analysis</span></span>
<span id="cb23-131"><a href="#cb23-131" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-132"><a href="#cb23-132" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if data is available for both years</span></span>
<span id="cb23-133"><a href="#cb23-133" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(short_term_years <span class="sc">%in%</span> <span class="fu">unique</span>(data_filtered<span class="sc">$</span>Survey_Year[<span class="sc">!</span><span class="fu">is.na</span>(data_filtered<span class="sc">$</span>response)]))) {</span>
<span id="cb23-134"><a href="#cb23-134" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb23-135"><a href="#cb23-135" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb23-136"><a href="#cb23-136" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-137"><a href="#cb23-137" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Continue with data that doesn't have NA responses</span></span>
<span id="cb23-138"><a href="#cb23-138" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(response))</span>
<span id="cb23-139"><a href="#cb23-139" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-140"><a href="#cb23-140" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create survey design object including the response variable</span></span>
<span id="cb23-141"><a href="#cb23-141" aria-hidden="true" tabindex="-1"></a>    survey_design <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="sc">~</span>Primary_Samp_Unit,</span>
<span id="cb23-142"><a href="#cb23-142" aria-hidden="true" tabindex="-1"></a>                               <span class="at">strata =</span> <span class="sc">~</span>Stratum,</span>
<span id="cb23-143"><a href="#cb23-143" aria-hidden="true" tabindex="-1"></a>                               <span class="at">weights =</span> <span class="sc">~</span>Final_Weight,</span>
<span id="cb23-144"><a href="#cb23-144" aria-hidden="true" tabindex="-1"></a>                               <span class="at">data =</span> data_filtered,</span>
<span id="cb23-145"><a href="#cb23-145" aria-hidden="true" tabindex="-1"></a>                               <span class="at">nest =</span> <span class="cn">TRUE</span>) </span>
<span id="cb23-146"><a href="#cb23-146" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-147"><a href="#cb23-147" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Perform Welch's t-test using the survey design object</span></span>
<span id="cb23-148"><a href="#cb23-148" aria-hidden="true" tabindex="-1"></a>    ttest_result <span class="ot">&lt;-</span> <span class="fu">svyttest</span>(response <span class="sc">~</span> <span class="fu">as.factor</span>(Survey_Year), survey_design)</span>
<span id="cb23-149"><a href="#cb23-149" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-150"><a href="#cb23-150" aria-hidden="true" tabindex="-1"></a>    <span class="co"># head t-test results</span></span>
<span id="cb23-151"><a href="#cb23-151" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(ttest_result)</span>
<span id="cb23-152"><a href="#cb23-152" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-153"><a href="#cb23-153" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check significance and interpret the results</span></span>
<span id="cb23-154"><a href="#cb23-154" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(ttest_result<span class="sc">$</span>p.value) <span class="sc">&amp;&amp;</span> ttest_result<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>) {</span>
<span id="cb23-155"><a href="#cb23-155" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(ttest_result<span class="sc">$</span>estimate <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Significant Increase"</span>, <span class="st">"Significant Decrease"</span>)</span>
<span id="cb23-156"><a href="#cb23-156" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb23-157"><a href="#cb23-157" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="st">"No Change"</span></span>
<span id="cb23-158"><a href="#cb23-158" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb23-159"><a href="#cb23-159" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-160"><a href="#cb23-160" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> trend))</span>
<span id="cb23-161"><a href="#cb23-161" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-162"><a href="#cb23-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-163"><a href="#cb23-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-164"><a href="#cb23-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-165"><a href="#cb23-165" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the short-term function to each ROI_Indicator_Code</span></span>
<span id="cb23-166"><a href="#cb23-166" aria-hidden="true" tabindex="-1"></a>short_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(raw_stwd_general)[<span class="fu">grep</span>(<span class="st">"^(QN|V).*[RP]"</span>, <span class="fu">names</span>(raw_stwd_general))], <span class="cf">function</span>(column_name) {</span>
<span id="cb23-167"><a href="#cb23-167" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_short_term_trend_ttest</span>(raw_stwd_general, column_name)</span>
<span id="cb23-168"><a href="#cb23-168" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb23-169"><a href="#cb23-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-170"><a href="#cb23-170" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(short_trend_results)</span>
<span id="cb23-171"><a href="#cb23-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-172"><a href="#cb23-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-173"><a href="#cb23-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-174"><a href="#cb23-174" aria-hidden="true" tabindex="-1"></a><span class="do">################### Join Together with Trend Tables ############</span></span>
<span id="cb23-175"><a href="#cb23-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-176"><a href="#cb23-176" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine long-term and short-term results</span></span>
<span id="cb23-177"><a href="#cb23-177" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> <span class="fu">left_join</span>(long_trend_results, </span>
<span id="cb23-178"><a href="#cb23-178" aria-hidden="true" tabindex="-1"></a>                                    short_trend_results, </span>
<span id="cb23-179"><a href="#cb23-179" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">by =</span> <span class="st">"ROI_Indicator_Code"</span>)</span>
<span id="cb23-180"><a href="#cb23-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-181"><a href="#cb23-181" aria-hidden="true" tabindex="-1"></a><span class="co">#head(combined_trend_results)</span></span>
<span id="cb23-182"><a href="#cb23-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-183"><a href="#cb23-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-184"><a href="#cb23-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-185"><a href="#cb23-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-186"><a href="#cb23-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-187"><a href="#cb23-187" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge Long_Term_Trend into yrbs_master_stwd_grade based on matching ROI_Indicator_Code and Trend_Category</span></span>
<span id="cb23-188"><a href="#cb23-188" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> yrbs_master_analysis_stwd_trend <span class="sc">%&gt;%</span></span>
<span id="cb23-189"><a href="#cb23-189" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(combined_trend_results <span class="sc">%&gt;%</span> <span class="fu">select</span>(ROI_Indicator_Code, Long_Term_Trend, Short_Term_Trend),</span>
<span id="cb23-190"><a href="#cb23-190" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ROI_Indicator_Code"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb23-191"><a href="#cb23-191" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(School_Type,</span>
<span id="cb23-192"><a href="#cb23-192" aria-hidden="true" tabindex="-1"></a>         Health_Topic, </span>
<span id="cb23-193"><a href="#cb23-193" aria-hidden="true" tabindex="-1"></a>         ROI_Indicator_Code, </span>
<span id="cb23-194"><a href="#cb23-194" aria-hidden="true" tabindex="-1"></a>         Indicator_Long_Description, </span>
<span id="cb23-195"><a href="#cb23-195" aria-hidden="true" tabindex="-1"></a>         Trend_Category, </span>
<span id="cb23-196"><a href="#cb23-196" aria-hidden="true" tabindex="-1"></a>         <span class="fu">everything</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb23-197"><a href="#cb23-197" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, </span>
<span id="cb23-198"><a href="#cb23-198" aria-hidden="true" tabindex="-1"></a>          ROI_Indicator_Code, </span>
<span id="cb23-199"><a href="#cb23-199" aria-hidden="true" tabindex="-1"></a>          Trend_Category)</span>
<span id="cb23-200"><a href="#cb23-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-201"><a href="#cb23-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-202"><a href="#cb23-202" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to check for three consecutive NAs in a set of columns</span></span>
<span id="cb23-203"><a href="#cb23-203" aria-hidden="true" tabindex="-1"></a>check_consecutive_nas <span class="ot">&lt;-</span> <span class="cf">function</span>(year_values) {</span>
<span id="cb23-204"><a href="#cb23-204" aria-hidden="true" tabindex="-1"></a>  na_run_lengths <span class="ot">&lt;-</span> <span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>lengths[<span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>values]</span>
<span id="cb23-205"><a href="#cb23-205" aria-hidden="true" tabindex="-1"></a>  <span class="fu">any</span>(na_run_lengths <span class="sc">&gt;=</span> <span class="dv">3</span>)</span>
<span id="cb23-206"><a href="#cb23-206" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-207"><a href="#cb23-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-208"><a href="#cb23-208" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert all columns representing years to numeric</span></span>
<span id="cb23-209"><a href="#cb23-209" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb23-210"><a href="#cb23-210" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">d+$"</span>), as.numeric))</span>
<span id="cb23-211"><a href="#cb23-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-212"><a href="#cb23-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-213"><a href="#cb23-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-214"><a href="#cb23-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-215"><a href="#cb23-215" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge and mutate Long_Term_Trend</span></span>
<span id="cb23-216"><a href="#cb23-216" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb23-217"><a href="#cb23-217" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb23-218"><a href="#cb23-218" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Long_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">check_consecutive_nas</span>(<span class="fu">c_across</span>(<span class="st">`</span><span class="at">2011</span><span class="st">`</span><span class="sc">:</span><span class="st">`</span><span class="at">2023</span><span class="st">`</span>)), </span>
<span id="cb23-219"><a href="#cb23-219" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb23-220"><a href="#cb23-220" aria-hidden="true" tabindex="-1"></a>                                  Long_Term_Trend),</span>
<span id="cb23-221"><a href="#cb23-221" aria-hidden="true" tabindex="-1"></a>         <span class="at">Short_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(<span class="st">`</span><span class="at">2019</span><span class="st">`</span>) <span class="sc">|</span> <span class="fu">is.na</span>(<span class="st">`</span><span class="at">2023</span><span class="st">`</span>), </span>
<span id="cb23-222"><a href="#cb23-222" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb23-223"><a href="#cb23-223" aria-hidden="true" tabindex="-1"></a>                                   Short_Term_Trend)) <span class="sc">%&gt;%</span></span>
<span id="cb23-224"><a href="#cb23-224" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb23-225"><a href="#cb23-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-226"><a href="#cb23-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-227"><a href="#cb23-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-228"><a href="#cb23-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-229"><a href="#cb23-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-230"><a href="#cb23-230" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results)</span>
<span id="cb23-231"><a href="#cb23-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-232"><a href="#cb23-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-233"><a href="#cb23-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-234"><a href="#cb23-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-235"><a href="#cb23-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-236"><a href="#cb23-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-237"><a href="#cb23-237" aria-hidden="true" tabindex="-1"></a>trend_results_race_8_asian <span class="ot">&lt;-</span> trend_results</span>
<span id="cb23-238"><a href="#cb23-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-239"><a href="#cb23-239" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results_race_8_asian)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="blackafrican-american-1" class="level4">
<h4 class="anchored" data-anchor-id="blackafrican-american-1">8.3 - Black/African American</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Please note for this demographic, the sample size was too small and is only adjusted for sex and NOT grade, as the rest are.</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="do">######## Import Raw and Analyzed Excel Files ###############</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>yrbs_master_analysis_stwd_trend <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Race_Group_8 Trend"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Trend_Category <span class="sc">==</span> <span class="st">"Black/African American"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="st">"Suppressed"</span>, <span class="cn">NA</span>, .)))</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the raw data set to be used in trend analyis</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>raw_stwd_general <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"raw_yrbs_allyears_statewide_trad_cleaned.xlsx"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Race_Group_8 <span class="sc">==</span> <span class="st">"Black/African American"</span>,</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>         Survey_Year <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2011</span>,</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2013</span>, </span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2015</span>, </span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2017</span>,</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2019</span>, </span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2023</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>                            )) <span class="sc">%&gt;%</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">2</span>, <span class="dv">0</span>, <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="cn">NA</span>))))</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine which survey questions (ROI - Response of Interest) have data across at least two distinct survey years</span></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>roi_years <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), Survey_Year) <span class="sc">%&gt;%</span></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>Survey_Year, </span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"ROI_Indicator_Code"</span>, </span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ROI_Indicator_Code) <span class="sc">%&gt;%</span></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">unique_years =</span> <span class="fu">n_distinct</span>(Survey_Year), </span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(unique_years <span class="sc">&gt;=</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(ROI_Indicator_Code)</span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the main data set to include only those ROIs, also ensuring to keep necessary demographic variables</span></span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>filtered_raw_stwd_general <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Survey_Year, <span class="fu">all_of</span>(roi_years), Sex, Grade, Primary_Samp_Unit,Stratum,Final_Weight)</span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a><span class="do">############ Long Term Trend ###############</span></span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a><span class="co">#Trend Analysis Function</span></span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a>analyze_trend_logistic <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Survey Design for YRBS Statewide</span></span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_survey_design</span>(<span class="at">ids =</span> Primary_Samp_Unit,</span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a>                     <span class="at">strata =</span> Stratum,</span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a>                     <span class="at">weights =</span> Final_Weight,</span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span></span>
<span id="cb24-58"><a href="#cb24-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Sex =</span> <span class="fu">factor</span>(Sex), <span class="at">Grade =</span> <span class="fu">factor</span>(Grade))</span>
<span id="cb24-59"><a href="#cb24-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-60"><a href="#cb24-60" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(data_filtered) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">length</span>(<span class="fu">unique</span>(data_filtered<span class="sc">$</span>variables<span class="sc">$</span>Survey_Year)) <span class="sc">&lt;</span> <span class="dv">4</span>) {</span>
<span id="cb24-61"><a href="#cb24-61" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb24-62"><a href="#cb24-62" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-63"><a href="#cb24-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-64"><a href="#cb24-64" aria-hidden="true" tabindex="-1"></a>  base_formula <span class="ot">&lt;-</span> <span class="fu">paste</span>(column_name, <span class="st">"~ Sex + Grade + Survey_Year"</span>) </span>
<span id="cb24-65"><a href="#cb24-65" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit the model using logistic regression</span></span>
<span id="cb24-66"><a href="#cb24-66" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb24-67"><a href="#cb24-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">svyglm</span>(<span class="fu">as.formula</span>(base_formula), <span class="at">design =</span> data_filtered, <span class="at">family =</span> <span class="fu">quasibinomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb24-68"><a href="#cb24-68" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb24-69"><a href="#cb24-69" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Error fitting model: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb24-70"><a href="#cb24-70" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb24-71"><a href="#cb24-71" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb24-72"><a href="#cb24-72" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-73"><a href="#cb24-73" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if model fitting was successful</span></span>
<span id="cb24-74"><a href="#cb24-74" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(model)) {</span>
<span id="cb24-75"><a href="#cb24-75" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error"</span>))</span>
<span id="cb24-76"><a href="#cb24-76" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-77"><a href="#cb24-77" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-78"><a href="#cb24-78" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check for coefficients</span></span>
<span id="cb24-79"><a href="#cb24-79" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>(<span class="st">"Survey_Year"</span> <span class="sc">%in%</span> <span class="fu">names</span>(<span class="fu">coef</span>(model)))) {</span>
<span id="cb24-80"><a href="#cb24-80" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No valid coefficient for Survey_Year"</span>))</span>
<span id="cb24-81"><a href="#cb24-81" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-82"><a href="#cb24-82" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-83"><a href="#cb24-83" aria-hidden="true" tabindex="-1"></a>  coef_summary <span class="ot">=</span> <span class="fu">summary</span>(model)<span class="sc">$</span>coefficients</span>
<span id="cb24-84"><a href="#cb24-84" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(coef_summary) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb24-85"><a href="#cb24-85" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error: No coefficients"</span>))</span>
<span id="cb24-86"><a href="#cb24-86" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-87"><a href="#cb24-87" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-88"><a href="#cb24-88" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Determine the significance and direction of the trend</span></span>
<span id="cb24-89"><a href="#cb24-89" aria-hidden="true" tabindex="-1"></a>  p_value <span class="ot">=</span> coef_summary[<span class="st">"Survey_Year"</span>, <span class="st">"Pr(&gt;|t|)"</span>]</span>
<span id="cb24-90"><a href="#cb24-90" aria-hidden="true" tabindex="-1"></a>  coefficient <span class="ot">=</span> <span class="fu">coef</span>(model)[<span class="st">"Survey_Year"</span>]</span>
<span id="cb24-91"><a href="#cb24-91" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-92"><a href="#cb24-92" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(p_value)) {</span>
<span id="cb24-93"><a href="#cb24-93" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"P-value is NA"</span>))</span>
<span id="cb24-94"><a href="#cb24-94" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-95"><a href="#cb24-95" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-96"><a href="#cb24-96" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (p_value <span class="sc">&lt;=</span> <span class="fl">0.05</span>) {</span>
<span id="cb24-97"><a href="#cb24-97" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (coefficient <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb24-98"><a href="#cb24-98" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Increase"</span>))</span>
<span id="cb24-99"><a href="#cb24-99" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb24-100"><a href="#cb24-100" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Decrease"</span>))</span>
<span id="cb24-101"><a href="#cb24-101" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb24-102"><a href="#cb24-102" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb24-103"><a href="#cb24-103" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No Change"</span>))</span>
<span id="cb24-104"><a href="#cb24-104" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-105"><a href="#cb24-105" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-106"><a href="#cb24-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-107"><a href="#cb24-107" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the function to each ROI_Indicator_Code that has sufficient data</span></span>
<span id="cb24-108"><a href="#cb24-108" aria-hidden="true" tabindex="-1"></a>long_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(filtered_raw_stwd_general)[<span class="sc">-</span><span class="dv">1</span>], <span class="cf">function</span>(column_name) {</span>
<span id="cb24-109"><a href="#cb24-109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_trend_logistic</span>(filtered_raw_stwd_general, column_name)</span>
<span id="cb24-110"><a href="#cb24-110" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb24-111"><a href="#cb24-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-112"><a href="#cb24-112" aria-hidden="true" tabindex="-1"></a><span class="co"># Show results</span></span>
<span id="cb24-113"><a href="#cb24-113" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(long_trend_results)</span>
<span id="cb24-114"><a href="#cb24-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-115"><a href="#cb24-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-116"><a href="#cb24-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-117"><a href="#cb24-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-118"><a href="#cb24-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-119"><a href="#cb24-119" aria-hidden="true" tabindex="-1"></a><span class="do">######### Short Term Trend ###############</span></span>
<span id="cb24-120"><a href="#cb24-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-121"><a href="#cb24-121" aria-hidden="true" tabindex="-1"></a>analyze_short_term_trend_ttest <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb24-122"><a href="#cb24-122" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the short-term years</span></span>
<span id="cb24-123"><a href="#cb24-123" aria-hidden="true" tabindex="-1"></a>    short_term_years <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2019</span>, <span class="dv">2023</span>)</span>
<span id="cb24-124"><a href="#cb24-124" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-125"><a href="#cb24-125" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter for short-term years and ensure all necessary variables are selected</span></span>
<span id="cb24-126"><a href="#cb24-126" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb24-127"><a href="#cb24-127" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(Survey_Year <span class="sc">%in%</span> short_term_years) <span class="sc">%&gt;%</span></span>
<span id="cb24-128"><a href="#cb24-128" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(Primary_Samp_Unit, Stratum, Final_Weight, Survey_Year, <span class="fu">all_of</span>(column_name)) <span class="sc">%&gt;%</span></span>
<span id="cb24-129"><a href="#cb24-129" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">response =</span> <span class="fu">get</span>(column_name) <span class="sc">==</span> <span class="dv">1</span>)  <span class="co"># Create a binary response variable for the analysis</span></span>
<span id="cb24-130"><a href="#cb24-130" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-131"><a href="#cb24-131" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if data is available for both years</span></span>
<span id="cb24-132"><a href="#cb24-132" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(short_term_years <span class="sc">%in%</span> <span class="fu">unique</span>(data_filtered<span class="sc">$</span>Survey_Year[<span class="sc">!</span><span class="fu">is.na</span>(data_filtered<span class="sc">$</span>response)]))) {</span>
<span id="cb24-133"><a href="#cb24-133" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb24-134"><a href="#cb24-134" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb24-135"><a href="#cb24-135" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-136"><a href="#cb24-136" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Continue with data that doesn't have NA responses</span></span>
<span id="cb24-137"><a href="#cb24-137" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(response))</span>
<span id="cb24-138"><a href="#cb24-138" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-139"><a href="#cb24-139" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create survey design object including the response variable</span></span>
<span id="cb24-140"><a href="#cb24-140" aria-hidden="true" tabindex="-1"></a>    survey_design <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="sc">~</span>Primary_Samp_Unit,</span>
<span id="cb24-141"><a href="#cb24-141" aria-hidden="true" tabindex="-1"></a>                               <span class="at">strata =</span> <span class="sc">~</span>Stratum,</span>
<span id="cb24-142"><a href="#cb24-142" aria-hidden="true" tabindex="-1"></a>                               <span class="at">weights =</span> <span class="sc">~</span>Final_Weight,</span>
<span id="cb24-143"><a href="#cb24-143" aria-hidden="true" tabindex="-1"></a>                               <span class="at">data =</span> data_filtered,</span>
<span id="cb24-144"><a href="#cb24-144" aria-hidden="true" tabindex="-1"></a>                               <span class="at">nest =</span> <span class="cn">TRUE</span>) </span>
<span id="cb24-145"><a href="#cb24-145" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-146"><a href="#cb24-146" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Perform Welch's t-test using the survey design object</span></span>
<span id="cb24-147"><a href="#cb24-147" aria-hidden="true" tabindex="-1"></a>    ttest_result <span class="ot">&lt;-</span> <span class="fu">svyttest</span>(response <span class="sc">~</span> <span class="fu">as.factor</span>(Survey_Year), survey_design)</span>
<span id="cb24-148"><a href="#cb24-148" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-149"><a href="#cb24-149" aria-hidden="true" tabindex="-1"></a>    <span class="co"># head t-test results</span></span>
<span id="cb24-150"><a href="#cb24-150" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(ttest_result)</span>
<span id="cb24-151"><a href="#cb24-151" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-152"><a href="#cb24-152" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check significance and interpret the results</span></span>
<span id="cb24-153"><a href="#cb24-153" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(ttest_result<span class="sc">$</span>p.value) <span class="sc">&amp;&amp;</span> ttest_result<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>) {</span>
<span id="cb24-154"><a href="#cb24-154" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(ttest_result<span class="sc">$</span>estimate <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Significant Increase"</span>, <span class="st">"Significant Decrease"</span>)</span>
<span id="cb24-155"><a href="#cb24-155" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb24-156"><a href="#cb24-156" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="st">"No Change"</span></span>
<span id="cb24-157"><a href="#cb24-157" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb24-158"><a href="#cb24-158" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-159"><a href="#cb24-159" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> trend))</span>
<span id="cb24-160"><a href="#cb24-160" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-161"><a href="#cb24-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-162"><a href="#cb24-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-163"><a href="#cb24-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-164"><a href="#cb24-164" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the short-term function to each ROI_Indicator_Code</span></span>
<span id="cb24-165"><a href="#cb24-165" aria-hidden="true" tabindex="-1"></a>short_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(raw_stwd_general)[<span class="fu">grep</span>(<span class="st">"^(QN|V).*[RP]"</span>, <span class="fu">names</span>(raw_stwd_general))], <span class="cf">function</span>(column_name) {</span>
<span id="cb24-166"><a href="#cb24-166" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_short_term_trend_ttest</span>(raw_stwd_general, column_name)</span>
<span id="cb24-167"><a href="#cb24-167" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb24-168"><a href="#cb24-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-169"><a href="#cb24-169" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(short_trend_results)</span>
<span id="cb24-170"><a href="#cb24-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-171"><a href="#cb24-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-172"><a href="#cb24-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-173"><a href="#cb24-173" aria-hidden="true" tabindex="-1"></a><span class="do">################### Join Together with Trend Tables ############</span></span>
<span id="cb24-174"><a href="#cb24-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-175"><a href="#cb24-175" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine long-term and short-term results</span></span>
<span id="cb24-176"><a href="#cb24-176" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> <span class="fu">left_join</span>(long_trend_results, </span>
<span id="cb24-177"><a href="#cb24-177" aria-hidden="true" tabindex="-1"></a>                                    short_trend_results, </span>
<span id="cb24-178"><a href="#cb24-178" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">by =</span> <span class="st">"ROI_Indicator_Code"</span>)</span>
<span id="cb24-179"><a href="#cb24-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-180"><a href="#cb24-180" aria-hidden="true" tabindex="-1"></a><span class="co">#head(combined_trend_results)</span></span>
<span id="cb24-181"><a href="#cb24-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-182"><a href="#cb24-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-183"><a href="#cb24-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-184"><a href="#cb24-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-185"><a href="#cb24-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-186"><a href="#cb24-186" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge Long_Term_Trend into yrbs_master_stwd_grade based on matching ROI_Indicator_Code and Trend_Category</span></span>
<span id="cb24-187"><a href="#cb24-187" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> yrbs_master_analysis_stwd_trend <span class="sc">%&gt;%</span></span>
<span id="cb24-188"><a href="#cb24-188" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(combined_trend_results <span class="sc">%&gt;%</span> <span class="fu">select</span>(ROI_Indicator_Code, Long_Term_Trend, Short_Term_Trend),</span>
<span id="cb24-189"><a href="#cb24-189" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ROI_Indicator_Code"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb24-190"><a href="#cb24-190" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(School_Type,</span>
<span id="cb24-191"><a href="#cb24-191" aria-hidden="true" tabindex="-1"></a>         Health_Topic, </span>
<span id="cb24-192"><a href="#cb24-192" aria-hidden="true" tabindex="-1"></a>         ROI_Indicator_Code, </span>
<span id="cb24-193"><a href="#cb24-193" aria-hidden="true" tabindex="-1"></a>         Indicator_Long_Description, </span>
<span id="cb24-194"><a href="#cb24-194" aria-hidden="true" tabindex="-1"></a>         Trend_Category, </span>
<span id="cb24-195"><a href="#cb24-195" aria-hidden="true" tabindex="-1"></a>         <span class="fu">everything</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb24-196"><a href="#cb24-196" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, </span>
<span id="cb24-197"><a href="#cb24-197" aria-hidden="true" tabindex="-1"></a>          ROI_Indicator_Code, </span>
<span id="cb24-198"><a href="#cb24-198" aria-hidden="true" tabindex="-1"></a>          Trend_Category)</span>
<span id="cb24-199"><a href="#cb24-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-200"><a href="#cb24-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-201"><a href="#cb24-201" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to check for three consecutive NAs in a set of columns</span></span>
<span id="cb24-202"><a href="#cb24-202" aria-hidden="true" tabindex="-1"></a>check_consecutive_nas <span class="ot">&lt;-</span> <span class="cf">function</span>(year_values) {</span>
<span id="cb24-203"><a href="#cb24-203" aria-hidden="true" tabindex="-1"></a>  na_run_lengths <span class="ot">&lt;-</span> <span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>lengths[<span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>values]</span>
<span id="cb24-204"><a href="#cb24-204" aria-hidden="true" tabindex="-1"></a>  <span class="fu">any</span>(na_run_lengths <span class="sc">&gt;=</span> <span class="dv">3</span>)</span>
<span id="cb24-205"><a href="#cb24-205" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-206"><a href="#cb24-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-207"><a href="#cb24-207" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert all columns representing years to numeric</span></span>
<span id="cb24-208"><a href="#cb24-208" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb24-209"><a href="#cb24-209" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">d+$"</span>), as.numeric))</span>
<span id="cb24-210"><a href="#cb24-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-211"><a href="#cb24-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-212"><a href="#cb24-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-213"><a href="#cb24-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-214"><a href="#cb24-214" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge and mutate Long_Term_Trend</span></span>
<span id="cb24-215"><a href="#cb24-215" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb24-216"><a href="#cb24-216" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb24-217"><a href="#cb24-217" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Long_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">check_consecutive_nas</span>(<span class="fu">c_across</span>(<span class="st">`</span><span class="at">2011</span><span class="st">`</span><span class="sc">:</span><span class="st">`</span><span class="at">2023</span><span class="st">`</span>)), </span>
<span id="cb24-218"><a href="#cb24-218" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb24-219"><a href="#cb24-219" aria-hidden="true" tabindex="-1"></a>                                  Long_Term_Trend),</span>
<span id="cb24-220"><a href="#cb24-220" aria-hidden="true" tabindex="-1"></a>         <span class="at">Short_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(<span class="st">`</span><span class="at">2019</span><span class="st">`</span>) <span class="sc">|</span> <span class="fu">is.na</span>(<span class="st">`</span><span class="at">2023</span><span class="st">`</span>), </span>
<span id="cb24-221"><a href="#cb24-221" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb24-222"><a href="#cb24-222" aria-hidden="true" tabindex="-1"></a>                                   Short_Term_Trend)) <span class="sc">%&gt;%</span></span>
<span id="cb24-223"><a href="#cb24-223" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb24-224"><a href="#cb24-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-225"><a href="#cb24-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-226"><a href="#cb24-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-227"><a href="#cb24-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-228"><a href="#cb24-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-229"><a href="#cb24-229" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results)</span>
<span id="cb24-230"><a href="#cb24-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-231"><a href="#cb24-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-232"><a href="#cb24-232" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb24-233"><a href="#cb24-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-234"><a href="#cb24-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-235"><a href="#cb24-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-236"><a href="#cb24-236" aria-hidden="true" tabindex="-1"></a>trend_results_race_8_BlkAA <span class="ot">&lt;-</span> trend_results</span>
<span id="cb24-237"><a href="#cb24-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-238"><a href="#cb24-238" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results_race_8_BlkAA)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="hispaniclatino-2" class="level4">
<h4 class="anchored" data-anchor-id="hispaniclatino-2">8.4 - Hispanic/Latino</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Please note for this demographic, the sample size was too small to adjusted for sex and grade, as the rest are.</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="do">######## Import Raw and Analyzed Excel Files ###############</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>yrbs_master_analysis_stwd_trend <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Race_Group_8 Trend"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Trend_Category <span class="sc">==</span> <span class="st">"Hispanic/Latino"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="st">"Suppressed"</span>, <span class="cn">NA</span>, .)))</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the raw data set to be used in trend analyis</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>raw_stwd_general <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"raw_yrbs_allyears_statewide_trad_cleaned.xlsx"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Race_Group_8 <span class="sc">==</span> <span class="st">"Hispanic/Latino"</span>,</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>         Survey_Year <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2011</span>,</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2013</span>, </span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2015</span>, </span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2017</span>,</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2019</span>, </span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2023</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>                            )) <span class="sc">%&gt;%</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">2</span>, <span class="dv">0</span>, <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="cn">NA</span>))))</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine which survey questions (ROI - Response of Interest) have data across at least two distinct survey years</span></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>roi_years <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), Survey_Year) <span class="sc">%&gt;%</span></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>Survey_Year, </span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"ROI_Indicator_Code"</span>, </span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ROI_Indicator_Code) <span class="sc">%&gt;%</span></span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">unique_years =</span> <span class="fu">n_distinct</span>(Survey_Year), </span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(unique_years <span class="sc">&gt;=</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(ROI_Indicator_Code)</span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the main data set to include only those ROIs, also ensuring to keep necessary demographic variables</span></span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>filtered_raw_stwd_general <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Survey_Year, <span class="fu">all_of</span>(roi_years), Sex, Grade, Primary_Samp_Unit,Stratum,Final_Weight)</span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a><span class="do">############ Long Term Trend ###############</span></span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a><span class="co">#Trend Analysis Function</span></span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a>analyze_trend_logistic <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Survey Design for YRBS Statewide</span></span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_survey_design</span>(<span class="at">ids =</span> Primary_Samp_Unit,</span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a>                     <span class="at">strata =</span> Stratum,</span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true" tabindex="-1"></a>                     <span class="at">weights =</span> Final_Weight,</span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb25-57"><a href="#cb25-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-58"><a href="#cb25-58" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span></span>
<span id="cb25-59"><a href="#cb25-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Sex =</span> <span class="fu">factor</span>(Sex), <span class="at">Grade =</span> <span class="fu">factor</span>(Grade))</span>
<span id="cb25-60"><a href="#cb25-60" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-61"><a href="#cb25-61" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(data_filtered) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">length</span>(<span class="fu">unique</span>(data_filtered<span class="sc">$</span>variables<span class="sc">$</span>Survey_Year)) <span class="sc">&lt;</span> <span class="dv">4</span>) {</span>
<span id="cb25-62"><a href="#cb25-62" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb25-63"><a href="#cb25-63" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-64"><a href="#cb25-64" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-65"><a href="#cb25-65" aria-hidden="true" tabindex="-1"></a>  base_formula <span class="ot">&lt;-</span> <span class="fu">paste</span>(column_name, <span class="st">"~ Sex + Grade + Survey_Year"</span>) </span>
<span id="cb25-66"><a href="#cb25-66" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit the model using logistic regression</span></span>
<span id="cb25-67"><a href="#cb25-67" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb25-68"><a href="#cb25-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">svyglm</span>(<span class="fu">as.formula</span>(base_formula), <span class="at">design =</span> data_filtered, <span class="at">family =</span> <span class="fu">quasibinomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb25-69"><a href="#cb25-69" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb25-70"><a href="#cb25-70" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Error fitting model: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb25-71"><a href="#cb25-71" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb25-72"><a href="#cb25-72" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb25-73"><a href="#cb25-73" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-74"><a href="#cb25-74" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if model fitting was successful</span></span>
<span id="cb25-75"><a href="#cb25-75" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(model)) {</span>
<span id="cb25-76"><a href="#cb25-76" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error"</span>))</span>
<span id="cb25-77"><a href="#cb25-77" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-78"><a href="#cb25-78" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-79"><a href="#cb25-79" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check for coefficients</span></span>
<span id="cb25-80"><a href="#cb25-80" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>(<span class="st">"Survey_Year"</span> <span class="sc">%in%</span> <span class="fu">names</span>(<span class="fu">coef</span>(model)))) {</span>
<span id="cb25-81"><a href="#cb25-81" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No valid coefficient for Survey_Year"</span>))</span>
<span id="cb25-82"><a href="#cb25-82" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-83"><a href="#cb25-83" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-84"><a href="#cb25-84" aria-hidden="true" tabindex="-1"></a>  coef_summary <span class="ot">=</span> <span class="fu">summary</span>(model)<span class="sc">$</span>coefficients</span>
<span id="cb25-85"><a href="#cb25-85" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(coef_summary) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb25-86"><a href="#cb25-86" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error: No coefficients"</span>))</span>
<span id="cb25-87"><a href="#cb25-87" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-88"><a href="#cb25-88" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-89"><a href="#cb25-89" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Determine the significance and direction of the trend</span></span>
<span id="cb25-90"><a href="#cb25-90" aria-hidden="true" tabindex="-1"></a>  p_value <span class="ot">=</span> coef_summary[<span class="st">"Survey_Year"</span>, <span class="st">"Pr(&gt;|t|)"</span>]</span>
<span id="cb25-91"><a href="#cb25-91" aria-hidden="true" tabindex="-1"></a>  coefficient <span class="ot">=</span> <span class="fu">coef</span>(model)[<span class="st">"Survey_Year"</span>]</span>
<span id="cb25-92"><a href="#cb25-92" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-93"><a href="#cb25-93" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(p_value)) {</span>
<span id="cb25-94"><a href="#cb25-94" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"P-value is NA"</span>))</span>
<span id="cb25-95"><a href="#cb25-95" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-96"><a href="#cb25-96" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-97"><a href="#cb25-97" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (p_value <span class="sc">&lt;=</span> <span class="fl">0.05</span>) {</span>
<span id="cb25-98"><a href="#cb25-98" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (coefficient <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb25-99"><a href="#cb25-99" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Increase"</span>))</span>
<span id="cb25-100"><a href="#cb25-100" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb25-101"><a href="#cb25-101" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Decrease"</span>))</span>
<span id="cb25-102"><a href="#cb25-102" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb25-103"><a href="#cb25-103" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb25-104"><a href="#cb25-104" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No Change"</span>))</span>
<span id="cb25-105"><a href="#cb25-105" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-106"><a href="#cb25-106" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-107"><a href="#cb25-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-108"><a href="#cb25-108" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the function to each ROI_Indicator_Code that has sufficient data</span></span>
<span id="cb25-109"><a href="#cb25-109" aria-hidden="true" tabindex="-1"></a>long_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(filtered_raw_stwd_general)[<span class="sc">-</span><span class="dv">1</span>], <span class="cf">function</span>(column_name) {</span>
<span id="cb25-110"><a href="#cb25-110" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_trend_logistic</span>(filtered_raw_stwd_general, column_name)</span>
<span id="cb25-111"><a href="#cb25-111" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb25-112"><a href="#cb25-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-113"><a href="#cb25-113" aria-hidden="true" tabindex="-1"></a><span class="co"># Show results</span></span>
<span id="cb25-114"><a href="#cb25-114" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(long_trend_results)</span>
<span id="cb25-115"><a href="#cb25-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-116"><a href="#cb25-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-117"><a href="#cb25-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-118"><a href="#cb25-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-119"><a href="#cb25-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-120"><a href="#cb25-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-121"><a href="#cb25-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-122"><a href="#cb25-122" aria-hidden="true" tabindex="-1"></a><span class="do">######### Short Term Trend ###############</span></span>
<span id="cb25-123"><a href="#cb25-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-124"><a href="#cb25-124" aria-hidden="true" tabindex="-1"></a>analyze_short_term_trend_ttest <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb25-125"><a href="#cb25-125" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the short-term years</span></span>
<span id="cb25-126"><a href="#cb25-126" aria-hidden="true" tabindex="-1"></a>    short_term_years <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2019</span>, <span class="dv">2023</span>)</span>
<span id="cb25-127"><a href="#cb25-127" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-128"><a href="#cb25-128" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter for short-term years and ensure all necessary variables are selected</span></span>
<span id="cb25-129"><a href="#cb25-129" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb25-130"><a href="#cb25-130" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(Survey_Year <span class="sc">%in%</span> short_term_years) <span class="sc">%&gt;%</span></span>
<span id="cb25-131"><a href="#cb25-131" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(Primary_Samp_Unit, Stratum, Final_Weight, Survey_Year, <span class="fu">all_of</span>(column_name)) <span class="sc">%&gt;%</span></span>
<span id="cb25-132"><a href="#cb25-132" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">response =</span> <span class="fu">get</span>(column_name) <span class="sc">==</span> <span class="dv">1</span>)  <span class="co"># Create a binary response variable for the analysis</span></span>
<span id="cb25-133"><a href="#cb25-133" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-134"><a href="#cb25-134" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if data is available for both years</span></span>
<span id="cb25-135"><a href="#cb25-135" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(short_term_years <span class="sc">%in%</span> <span class="fu">unique</span>(data_filtered<span class="sc">$</span>Survey_Year[<span class="sc">!</span><span class="fu">is.na</span>(data_filtered<span class="sc">$</span>response)]))) {</span>
<span id="cb25-136"><a href="#cb25-136" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb25-137"><a href="#cb25-137" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb25-138"><a href="#cb25-138" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-139"><a href="#cb25-139" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Continue with data that doesn't have NA responses</span></span>
<span id="cb25-140"><a href="#cb25-140" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(response))</span>
<span id="cb25-141"><a href="#cb25-141" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-142"><a href="#cb25-142" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create survey design object including the response variable</span></span>
<span id="cb25-143"><a href="#cb25-143" aria-hidden="true" tabindex="-1"></a>    survey_design <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="sc">~</span>Primary_Samp_Unit,</span>
<span id="cb25-144"><a href="#cb25-144" aria-hidden="true" tabindex="-1"></a>                               <span class="at">strata =</span> <span class="sc">~</span>Stratum,</span>
<span id="cb25-145"><a href="#cb25-145" aria-hidden="true" tabindex="-1"></a>                               <span class="at">weights =</span> <span class="sc">~</span>Final_Weight,</span>
<span id="cb25-146"><a href="#cb25-146" aria-hidden="true" tabindex="-1"></a>                               <span class="at">data =</span> data_filtered,</span>
<span id="cb25-147"><a href="#cb25-147" aria-hidden="true" tabindex="-1"></a>                               <span class="at">nest =</span> <span class="cn">TRUE</span>) </span>
<span id="cb25-148"><a href="#cb25-148" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-149"><a href="#cb25-149" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Perform Welch's t-test using the survey design object</span></span>
<span id="cb25-150"><a href="#cb25-150" aria-hidden="true" tabindex="-1"></a>    ttest_result <span class="ot">&lt;-</span> <span class="fu">svyttest</span>(response <span class="sc">~</span> <span class="fu">as.factor</span>(Survey_Year), survey_design)</span>
<span id="cb25-151"><a href="#cb25-151" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-152"><a href="#cb25-152" aria-hidden="true" tabindex="-1"></a>    <span class="co"># head t-test results</span></span>
<span id="cb25-153"><a href="#cb25-153" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(ttest_result)</span>
<span id="cb25-154"><a href="#cb25-154" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-155"><a href="#cb25-155" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check significance and interpret the results</span></span>
<span id="cb25-156"><a href="#cb25-156" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(ttest_result<span class="sc">$</span>p.value) <span class="sc">&amp;&amp;</span> ttest_result<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>) {</span>
<span id="cb25-157"><a href="#cb25-157" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(ttest_result<span class="sc">$</span>estimate <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Significant Increase"</span>, <span class="st">"Significant Decrease"</span>)</span>
<span id="cb25-158"><a href="#cb25-158" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb25-159"><a href="#cb25-159" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="st">"No Change"</span></span>
<span id="cb25-160"><a href="#cb25-160" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb25-161"><a href="#cb25-161" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-162"><a href="#cb25-162" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> trend))</span>
<span id="cb25-163"><a href="#cb25-163" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-164"><a href="#cb25-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-165"><a href="#cb25-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-166"><a href="#cb25-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-167"><a href="#cb25-167" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the short-term function to each ROI_Indicator_Code</span></span>
<span id="cb25-168"><a href="#cb25-168" aria-hidden="true" tabindex="-1"></a>short_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(raw_stwd_general)[<span class="fu">grep</span>(<span class="st">"^(QN|V).*[RP]"</span>, <span class="fu">names</span>(raw_stwd_general))], <span class="cf">function</span>(column_name) {</span>
<span id="cb25-169"><a href="#cb25-169" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_short_term_trend_ttest</span>(raw_stwd_general, column_name)</span>
<span id="cb25-170"><a href="#cb25-170" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb25-171"><a href="#cb25-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-172"><a href="#cb25-172" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(short_trend_results)</span>
<span id="cb25-173"><a href="#cb25-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-174"><a href="#cb25-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-175"><a href="#cb25-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-176"><a href="#cb25-176" aria-hidden="true" tabindex="-1"></a><span class="do">################### Join Together with Trend Tables ############</span></span>
<span id="cb25-177"><a href="#cb25-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-178"><a href="#cb25-178" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine long-term and short-term results</span></span>
<span id="cb25-179"><a href="#cb25-179" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> <span class="fu">left_join</span>(long_trend_results, </span>
<span id="cb25-180"><a href="#cb25-180" aria-hidden="true" tabindex="-1"></a>                                    short_trend_results, </span>
<span id="cb25-181"><a href="#cb25-181" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">by =</span> <span class="st">"ROI_Indicator_Code"</span>)</span>
<span id="cb25-182"><a href="#cb25-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-183"><a href="#cb25-183" aria-hidden="true" tabindex="-1"></a><span class="co">#head(combined_trend_results)</span></span>
<span id="cb25-184"><a href="#cb25-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-185"><a href="#cb25-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-186"><a href="#cb25-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-187"><a href="#cb25-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-188"><a href="#cb25-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-189"><a href="#cb25-189" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge Long_Term_Trend into yrbs_master_stwd_grade based on matching ROI_Indicator_Code and Trend_Category</span></span>
<span id="cb25-190"><a href="#cb25-190" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> yrbs_master_analysis_stwd_trend <span class="sc">%&gt;%</span></span>
<span id="cb25-191"><a href="#cb25-191" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(combined_trend_results <span class="sc">%&gt;%</span> <span class="fu">select</span>(ROI_Indicator_Code, Long_Term_Trend, Short_Term_Trend),</span>
<span id="cb25-192"><a href="#cb25-192" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ROI_Indicator_Code"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb25-193"><a href="#cb25-193" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(School_Type,</span>
<span id="cb25-194"><a href="#cb25-194" aria-hidden="true" tabindex="-1"></a>         Health_Topic, </span>
<span id="cb25-195"><a href="#cb25-195" aria-hidden="true" tabindex="-1"></a>         ROI_Indicator_Code, </span>
<span id="cb25-196"><a href="#cb25-196" aria-hidden="true" tabindex="-1"></a>         Indicator_Long_Description, </span>
<span id="cb25-197"><a href="#cb25-197" aria-hidden="true" tabindex="-1"></a>         Trend_Category, </span>
<span id="cb25-198"><a href="#cb25-198" aria-hidden="true" tabindex="-1"></a>         <span class="fu">everything</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb25-199"><a href="#cb25-199" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, </span>
<span id="cb25-200"><a href="#cb25-200" aria-hidden="true" tabindex="-1"></a>          ROI_Indicator_Code, </span>
<span id="cb25-201"><a href="#cb25-201" aria-hidden="true" tabindex="-1"></a>          Trend_Category)</span>
<span id="cb25-202"><a href="#cb25-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-203"><a href="#cb25-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-204"><a href="#cb25-204" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to check for three consecutive NAs in a set of columns</span></span>
<span id="cb25-205"><a href="#cb25-205" aria-hidden="true" tabindex="-1"></a>check_consecutive_nas <span class="ot">&lt;-</span> <span class="cf">function</span>(year_values) {</span>
<span id="cb25-206"><a href="#cb25-206" aria-hidden="true" tabindex="-1"></a>  na_run_lengths <span class="ot">&lt;-</span> <span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>lengths[<span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>values]</span>
<span id="cb25-207"><a href="#cb25-207" aria-hidden="true" tabindex="-1"></a>  <span class="fu">any</span>(na_run_lengths <span class="sc">&gt;=</span> <span class="dv">3</span>)</span>
<span id="cb25-208"><a href="#cb25-208" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-209"><a href="#cb25-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-210"><a href="#cb25-210" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert all columns representing years to numeric</span></span>
<span id="cb25-211"><a href="#cb25-211" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb25-212"><a href="#cb25-212" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">d+$"</span>), as.numeric))</span>
<span id="cb25-213"><a href="#cb25-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-214"><a href="#cb25-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-215"><a href="#cb25-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-216"><a href="#cb25-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-217"><a href="#cb25-217" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge and mutate Long_Term_Trend</span></span>
<span id="cb25-218"><a href="#cb25-218" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb25-219"><a href="#cb25-219" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb25-220"><a href="#cb25-220" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Long_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">check_consecutive_nas</span>(<span class="fu">c_across</span>(<span class="st">`</span><span class="at">2011</span><span class="st">`</span><span class="sc">:</span><span class="st">`</span><span class="at">2023</span><span class="st">`</span>)), </span>
<span id="cb25-221"><a href="#cb25-221" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb25-222"><a href="#cb25-222" aria-hidden="true" tabindex="-1"></a>                                  Long_Term_Trend),</span>
<span id="cb25-223"><a href="#cb25-223" aria-hidden="true" tabindex="-1"></a>         <span class="at">Short_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(<span class="st">`</span><span class="at">2019</span><span class="st">`</span>) <span class="sc">|</span> <span class="fu">is.na</span>(<span class="st">`</span><span class="at">2023</span><span class="st">`</span>), </span>
<span id="cb25-224"><a href="#cb25-224" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb25-225"><a href="#cb25-225" aria-hidden="true" tabindex="-1"></a>                                   Short_Term_Trend)) <span class="sc">%&gt;%</span></span>
<span id="cb25-226"><a href="#cb25-226" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb25-227"><a href="#cb25-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-228"><a href="#cb25-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-229"><a href="#cb25-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-230"><a href="#cb25-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-231"><a href="#cb25-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-232"><a href="#cb25-232" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results)</span>
<span id="cb25-233"><a href="#cb25-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-234"><a href="#cb25-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-235"><a href="#cb25-235" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb25-236"><a href="#cb25-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-237"><a href="#cb25-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-238"><a href="#cb25-238" aria-hidden="true" tabindex="-1"></a>trend_results_race_8_HispLat <span class="ot">&lt;-</span> trend_results</span>
<span id="cb25-239"><a href="#cb25-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-240"><a href="#cb25-240" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results_race_8_HispLat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="hisplat-mult-race" class="level4">
<h4 class="anchored" data-anchor-id="hisplat-mult-race">8.5 - Hisp/Lat Mult Race</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="do">######## Import Raw and Analyzed Excel Files ###############</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>yrbs_master_analysis_stwd_trend <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Race_Group_8 Trend"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Trend_Category <span class="sc">==</span> <span class="st">"Hisp/Lat Mult Race"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="st">"Suppressed"</span>, <span class="cn">NA</span>, .)))</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the raw data set to be used in trend analyis</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>raw_stwd_general <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"raw_yrbs_allyears_statewide_trad_cleaned.xlsx"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Race_Group_8 <span class="sc">==</span> <span class="st">"Hisp/Lat Mult Race"</span>,</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>         Survey_Year <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2011</span>,</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2013</span>, </span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2015</span>, </span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2017</span>,</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2019</span>, </span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2023</span></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>                            )) <span class="sc">%&gt;%</span></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">2</span>, <span class="dv">0</span>, <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="cn">NA</span>))))</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine which survey questions (ROI - Response of Interest) have data across at least two distinct survey years</span></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>roi_years <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), Survey_Year) <span class="sc">%&gt;%</span></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>Survey_Year, </span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"ROI_Indicator_Code"</span>, </span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ROI_Indicator_Code) <span class="sc">%&gt;%</span></span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">unique_years =</span> <span class="fu">n_distinct</span>(Survey_Year), </span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(unique_years <span class="sc">&gt;=</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(ROI_Indicator_Code)</span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the main data set to include only those ROIs, also ensuring to keep necessary demographic variables</span></span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a>filtered_raw_stwd_general <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Survey_Year, <span class="fu">all_of</span>(roi_years), Sex, Grade, Primary_Samp_Unit,Stratum,Final_Weight)</span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a><span class="do">############ Long Term Trend ###############</span></span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a><span class="do">##Trend Analysis Function</span></span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a>analyze_trend_logistic <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb26-48"><a href="#cb26-48" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb26-49"><a href="#cb26-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Survey Design for YRBS Statewide</span></span>
<span id="cb26-50"><a href="#cb26-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_survey_design</span>(<span class="at">ids =</span> Primary_Samp_Unit,</span>
<span id="cb26-51"><a href="#cb26-51" aria-hidden="true" tabindex="-1"></a>                     <span class="at">strata =</span> Stratum,</span>
<span id="cb26-52"><a href="#cb26-52" aria-hidden="true" tabindex="-1"></a>                     <span class="at">weights =</span> Final_Weight,</span>
<span id="cb26-53"><a href="#cb26-53" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb26-54"><a href="#cb26-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-55"><a href="#cb26-55" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span></span>
<span id="cb26-56"><a href="#cb26-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Sex =</span> <span class="fu">factor</span>(Sex), <span class="at">Grade =</span> <span class="fu">factor</span>(Grade))</span>
<span id="cb26-57"><a href="#cb26-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-58"><a href="#cb26-58" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(data_filtered) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">length</span>(<span class="fu">unique</span>(data_filtered<span class="sc">$</span>variables<span class="sc">$</span>Survey_Year)) <span class="sc">&lt;</span> <span class="dv">4</span>) {</span>
<span id="cb26-59"><a href="#cb26-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb26-60"><a href="#cb26-60" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb26-61"><a href="#cb26-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-62"><a href="#cb26-62" aria-hidden="true" tabindex="-1"></a>  base_formula <span class="ot">&lt;-</span> <span class="fu">paste</span>(column_name, <span class="st">"~ Sex + Grade + Survey_Year"</span>) </span>
<span id="cb26-63"><a href="#cb26-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit the model using logistic regression</span></span>
<span id="cb26-64"><a href="#cb26-64" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb26-65"><a href="#cb26-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">svyglm</span>(<span class="fu">as.formula</span>(base_formula), <span class="at">design =</span> data_filtered, <span class="at">family =</span> <span class="fu">quasibinomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb26-66"><a href="#cb26-66" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb26-67"><a href="#cb26-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Error fitting model: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb26-68"><a href="#cb26-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb26-69"><a href="#cb26-69" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb26-70"><a href="#cb26-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-71"><a href="#cb26-71" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if model fitting was successful</span></span>
<span id="cb26-72"><a href="#cb26-72" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(model)) {</span>
<span id="cb26-73"><a href="#cb26-73" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error"</span>))</span>
<span id="cb26-74"><a href="#cb26-74" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb26-75"><a href="#cb26-75" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-76"><a href="#cb26-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check for coefficients</span></span>
<span id="cb26-77"><a href="#cb26-77" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>(<span class="st">"Survey_Year"</span> <span class="sc">%in%</span> <span class="fu">names</span>(<span class="fu">coef</span>(model)))) {</span>
<span id="cb26-78"><a href="#cb26-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No valid coefficient for Survey_Year"</span>))</span>
<span id="cb26-79"><a href="#cb26-79" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb26-80"><a href="#cb26-80" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-81"><a href="#cb26-81" aria-hidden="true" tabindex="-1"></a>  coef_summary <span class="ot">=</span> <span class="fu">summary</span>(model)<span class="sc">$</span>coefficients</span>
<span id="cb26-82"><a href="#cb26-82" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(coef_summary) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb26-83"><a href="#cb26-83" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error: No coefficients"</span>))</span>
<span id="cb26-84"><a href="#cb26-84" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb26-85"><a href="#cb26-85" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-86"><a href="#cb26-86" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Determine the significance and direction of the trend</span></span>
<span id="cb26-87"><a href="#cb26-87" aria-hidden="true" tabindex="-1"></a>  p_value <span class="ot">=</span> coef_summary[<span class="st">"Survey_Year"</span>, <span class="st">"Pr(&gt;|t|)"</span>]</span>
<span id="cb26-88"><a href="#cb26-88" aria-hidden="true" tabindex="-1"></a>  coefficient <span class="ot">=</span> <span class="fu">coef</span>(model)[<span class="st">"Survey_Year"</span>]</span>
<span id="cb26-89"><a href="#cb26-89" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-90"><a href="#cb26-90" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(p_value)) {</span>
<span id="cb26-91"><a href="#cb26-91" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"P-value is NA"</span>))</span>
<span id="cb26-92"><a href="#cb26-92" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb26-93"><a href="#cb26-93" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-94"><a href="#cb26-94" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (p_value <span class="sc">&lt;=</span> <span class="fl">0.05</span>) {</span>
<span id="cb26-95"><a href="#cb26-95" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (coefficient <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb26-96"><a href="#cb26-96" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Increase"</span>))</span>
<span id="cb26-97"><a href="#cb26-97" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb26-98"><a href="#cb26-98" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Decrease"</span>))</span>
<span id="cb26-99"><a href="#cb26-99" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb26-100"><a href="#cb26-100" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb26-101"><a href="#cb26-101" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No Change"</span>))</span>
<span id="cb26-102"><a href="#cb26-102" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb26-103"><a href="#cb26-103" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-104"><a href="#cb26-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-105"><a href="#cb26-105" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the function to each ROI_Indicator_Code that has sufficient data</span></span>
<span id="cb26-106"><a href="#cb26-106" aria-hidden="true" tabindex="-1"></a>long_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(filtered_raw_stwd_general)[<span class="sc">-</span><span class="dv">1</span>], <span class="cf">function</span>(column_name) {</span>
<span id="cb26-107"><a href="#cb26-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_trend_logistic</span>(filtered_raw_stwd_general, column_name)</span>
<span id="cb26-108"><a href="#cb26-108" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb26-109"><a href="#cb26-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-110"><a href="#cb26-110" aria-hidden="true" tabindex="-1"></a><span class="co"># Show results</span></span>
<span id="cb26-111"><a href="#cb26-111" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(long_trend_results)</span>
<span id="cb26-112"><a href="#cb26-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-113"><a href="#cb26-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-114"><a href="#cb26-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-115"><a href="#cb26-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-116"><a href="#cb26-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-117"><a href="#cb26-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-118"><a href="#cb26-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-119"><a href="#cb26-119" aria-hidden="true" tabindex="-1"></a><span class="do">######### Short Term Trend ###############</span></span>
<span id="cb26-120"><a href="#cb26-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-121"><a href="#cb26-121" aria-hidden="true" tabindex="-1"></a>analyze_short_term_trend_ttest <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb26-122"><a href="#cb26-122" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the short-term years</span></span>
<span id="cb26-123"><a href="#cb26-123" aria-hidden="true" tabindex="-1"></a>    short_term_years <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2019</span>, <span class="dv">2023</span>)</span>
<span id="cb26-124"><a href="#cb26-124" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-125"><a href="#cb26-125" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter for short-term years and ensure all necessary variables are selected</span></span>
<span id="cb26-126"><a href="#cb26-126" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb26-127"><a href="#cb26-127" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(Survey_Year <span class="sc">%in%</span> short_term_years) <span class="sc">%&gt;%</span></span>
<span id="cb26-128"><a href="#cb26-128" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(Primary_Samp_Unit, Stratum, Final_Weight, Survey_Year, <span class="fu">all_of</span>(column_name)) <span class="sc">%&gt;%</span></span>
<span id="cb26-129"><a href="#cb26-129" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">response =</span> <span class="fu">get</span>(column_name) <span class="sc">==</span> <span class="dv">1</span>)  <span class="co"># Create a binary response variable for the analysis</span></span>
<span id="cb26-130"><a href="#cb26-130" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-131"><a href="#cb26-131" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if data is available for both years</span></span>
<span id="cb26-132"><a href="#cb26-132" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(short_term_years <span class="sc">%in%</span> <span class="fu">unique</span>(data_filtered<span class="sc">$</span>Survey_Year[<span class="sc">!</span><span class="fu">is.na</span>(data_filtered<span class="sc">$</span>response)]))) {</span>
<span id="cb26-133"><a href="#cb26-133" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb26-134"><a href="#cb26-134" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb26-135"><a href="#cb26-135" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-136"><a href="#cb26-136" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Continue with data that doesn't have NA responses</span></span>
<span id="cb26-137"><a href="#cb26-137" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(response))</span>
<span id="cb26-138"><a href="#cb26-138" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-139"><a href="#cb26-139" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create survey design object including the response variable</span></span>
<span id="cb26-140"><a href="#cb26-140" aria-hidden="true" tabindex="-1"></a>    survey_design <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="sc">~</span>Primary_Samp_Unit,</span>
<span id="cb26-141"><a href="#cb26-141" aria-hidden="true" tabindex="-1"></a>                               <span class="at">strata =</span> <span class="sc">~</span>Stratum,</span>
<span id="cb26-142"><a href="#cb26-142" aria-hidden="true" tabindex="-1"></a>                               <span class="at">weights =</span> <span class="sc">~</span>Final_Weight,</span>
<span id="cb26-143"><a href="#cb26-143" aria-hidden="true" tabindex="-1"></a>                               <span class="at">data =</span> data_filtered,</span>
<span id="cb26-144"><a href="#cb26-144" aria-hidden="true" tabindex="-1"></a>                               <span class="at">nest =</span> <span class="cn">TRUE</span>) </span>
<span id="cb26-145"><a href="#cb26-145" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-146"><a href="#cb26-146" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Perform Welch's t-test using the survey design object</span></span>
<span id="cb26-147"><a href="#cb26-147" aria-hidden="true" tabindex="-1"></a>    ttest_result <span class="ot">&lt;-</span> <span class="fu">svyttest</span>(response <span class="sc">~</span> <span class="fu">as.factor</span>(Survey_Year), survey_design)</span>
<span id="cb26-148"><a href="#cb26-148" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-149"><a href="#cb26-149" aria-hidden="true" tabindex="-1"></a>    <span class="co"># head t-test results</span></span>
<span id="cb26-150"><a href="#cb26-150" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(ttest_result)</span>
<span id="cb26-151"><a href="#cb26-151" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-152"><a href="#cb26-152" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check significance and interpret the results</span></span>
<span id="cb26-153"><a href="#cb26-153" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(ttest_result<span class="sc">$</span>p.value) <span class="sc">&amp;&amp;</span> ttest_result<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>) {</span>
<span id="cb26-154"><a href="#cb26-154" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(ttest_result<span class="sc">$</span>estimate <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Significant Increase"</span>, <span class="st">"Significant Decrease"</span>)</span>
<span id="cb26-155"><a href="#cb26-155" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb26-156"><a href="#cb26-156" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="st">"No Change"</span></span>
<span id="cb26-157"><a href="#cb26-157" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb26-158"><a href="#cb26-158" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-159"><a href="#cb26-159" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> trend))</span>
<span id="cb26-160"><a href="#cb26-160" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-161"><a href="#cb26-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-162"><a href="#cb26-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-163"><a href="#cb26-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-164"><a href="#cb26-164" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the short-term function to each ROI_Indicator_Code</span></span>
<span id="cb26-165"><a href="#cb26-165" aria-hidden="true" tabindex="-1"></a>short_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(raw_stwd_general)[<span class="fu">grep</span>(<span class="st">"^(QN|V).*[RP]"</span>, <span class="fu">names</span>(raw_stwd_general))], <span class="cf">function</span>(column_name) {</span>
<span id="cb26-166"><a href="#cb26-166" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_short_term_trend_ttest</span>(raw_stwd_general, column_name)</span>
<span id="cb26-167"><a href="#cb26-167" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb26-168"><a href="#cb26-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-169"><a href="#cb26-169" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(short_trend_results)</span>
<span id="cb26-170"><a href="#cb26-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-171"><a href="#cb26-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-172"><a href="#cb26-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-173"><a href="#cb26-173" aria-hidden="true" tabindex="-1"></a><span class="do">################### Join Together with Trend Tables ############</span></span>
<span id="cb26-174"><a href="#cb26-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-175"><a href="#cb26-175" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine long-term and short-term results</span></span>
<span id="cb26-176"><a href="#cb26-176" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> <span class="fu">left_join</span>(long_trend_results, </span>
<span id="cb26-177"><a href="#cb26-177" aria-hidden="true" tabindex="-1"></a>                                    short_trend_results, </span>
<span id="cb26-178"><a href="#cb26-178" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">by =</span> <span class="st">"ROI_Indicator_Code"</span>)</span>
<span id="cb26-179"><a href="#cb26-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-180"><a href="#cb26-180" aria-hidden="true" tabindex="-1"></a><span class="co">#head(combined_trend_results)</span></span>
<span id="cb26-181"><a href="#cb26-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-182"><a href="#cb26-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-183"><a href="#cb26-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-184"><a href="#cb26-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-185"><a href="#cb26-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-186"><a href="#cb26-186" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge Long_Term_Trend into yrbs_master_stwd_grade based on matching ROI_Indicator_Code and Trend_Category</span></span>
<span id="cb26-187"><a href="#cb26-187" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> yrbs_master_analysis_stwd_trend <span class="sc">%&gt;%</span></span>
<span id="cb26-188"><a href="#cb26-188" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(combined_trend_results <span class="sc">%&gt;%</span> <span class="fu">select</span>(ROI_Indicator_Code, Long_Term_Trend, Short_Term_Trend),</span>
<span id="cb26-189"><a href="#cb26-189" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ROI_Indicator_Code"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb26-190"><a href="#cb26-190" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(School_Type,</span>
<span id="cb26-191"><a href="#cb26-191" aria-hidden="true" tabindex="-1"></a>         Health_Topic, </span>
<span id="cb26-192"><a href="#cb26-192" aria-hidden="true" tabindex="-1"></a>         ROI_Indicator_Code, </span>
<span id="cb26-193"><a href="#cb26-193" aria-hidden="true" tabindex="-1"></a>         Indicator_Long_Description, </span>
<span id="cb26-194"><a href="#cb26-194" aria-hidden="true" tabindex="-1"></a>         Trend_Category, </span>
<span id="cb26-195"><a href="#cb26-195" aria-hidden="true" tabindex="-1"></a>         <span class="fu">everything</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb26-196"><a href="#cb26-196" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, </span>
<span id="cb26-197"><a href="#cb26-197" aria-hidden="true" tabindex="-1"></a>          ROI_Indicator_Code, </span>
<span id="cb26-198"><a href="#cb26-198" aria-hidden="true" tabindex="-1"></a>          Trend_Category)</span>
<span id="cb26-199"><a href="#cb26-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-200"><a href="#cb26-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-201"><a href="#cb26-201" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to check for three consecutive NAs in a set of columns</span></span>
<span id="cb26-202"><a href="#cb26-202" aria-hidden="true" tabindex="-1"></a>check_consecutive_nas <span class="ot">&lt;-</span> <span class="cf">function</span>(year_values) {</span>
<span id="cb26-203"><a href="#cb26-203" aria-hidden="true" tabindex="-1"></a>  na_run_lengths <span class="ot">&lt;-</span> <span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>lengths[<span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>values]</span>
<span id="cb26-204"><a href="#cb26-204" aria-hidden="true" tabindex="-1"></a>  <span class="fu">any</span>(na_run_lengths <span class="sc">&gt;=</span> <span class="dv">3</span>)</span>
<span id="cb26-205"><a href="#cb26-205" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-206"><a href="#cb26-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-207"><a href="#cb26-207" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert all columns representing years to numeric</span></span>
<span id="cb26-208"><a href="#cb26-208" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb26-209"><a href="#cb26-209" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">d+$"</span>), as.numeric))</span>
<span id="cb26-210"><a href="#cb26-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-211"><a href="#cb26-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-212"><a href="#cb26-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-213"><a href="#cb26-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-214"><a href="#cb26-214" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge and mutate Long_Term_Trend</span></span>
<span id="cb26-215"><a href="#cb26-215" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb26-216"><a href="#cb26-216" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb26-217"><a href="#cb26-217" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Long_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">check_consecutive_nas</span>(<span class="fu">c_across</span>(<span class="st">`</span><span class="at">2011</span><span class="st">`</span><span class="sc">:</span><span class="st">`</span><span class="at">2023</span><span class="st">`</span>)), </span>
<span id="cb26-218"><a href="#cb26-218" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb26-219"><a href="#cb26-219" aria-hidden="true" tabindex="-1"></a>                                  Long_Term_Trend),</span>
<span id="cb26-220"><a href="#cb26-220" aria-hidden="true" tabindex="-1"></a>         <span class="at">Short_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(<span class="st">`</span><span class="at">2019</span><span class="st">`</span>) <span class="sc">|</span> <span class="fu">is.na</span>(<span class="st">`</span><span class="at">2023</span><span class="st">`</span>), </span>
<span id="cb26-221"><a href="#cb26-221" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb26-222"><a href="#cb26-222" aria-hidden="true" tabindex="-1"></a>                                   Short_Term_Trend)) <span class="sc">%&gt;%</span></span>
<span id="cb26-223"><a href="#cb26-223" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb26-224"><a href="#cb26-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-225"><a href="#cb26-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-226"><a href="#cb26-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-227"><a href="#cb26-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-228"><a href="#cb26-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-229"><a href="#cb26-229" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results)</span>
<span id="cb26-230"><a href="#cb26-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-231"><a href="#cb26-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-232"><a href="#cb26-232" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb26-233"><a href="#cb26-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-234"><a href="#cb26-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-235"><a href="#cb26-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-236"><a href="#cb26-236" aria-hidden="true" tabindex="-1"></a>trend_results_race_8_HispLat_Mult <span class="ot">&lt;-</span> trend_results</span>
<span id="cb26-237"><a href="#cb26-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-238"><a href="#cb26-238" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results_race_8_HispLat_Mult)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="native-hawother-pi" class="level4">
<h4 class="anchored" data-anchor-id="native-hawother-pi">8.6 - Native Haw/Other PI</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Please note for this demographic, the sample size was too small and is only adjusted for sex and NOT grade, as the rest are.</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="do">######## Import Raw and Analyzed Excel Files ###############</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>yrbs_master_analysis_stwd_trend <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Race_Group_8 Trend"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Trend_Category <span class="sc">==</span> <span class="st">"Native Haw/Other PI"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="st">"Suppressed"</span>, <span class="cn">NA</span>, .)))</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the raw data set to be used in trend analyis</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>raw_stwd_general <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"raw_yrbs_allyears_statewide_trad_cleaned.xlsx"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Race_Group_8 <span class="sc">==</span> <span class="st">"Native Haw/Other PI"</span>,</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>         Survey_Year <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2011</span>,</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2013</span>, </span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2015</span>, </span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2017</span>,</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2019</span>, </span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2023</span></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>                            )) <span class="sc">%&gt;%</span></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">2</span>, <span class="dv">0</span>, <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="cn">NA</span>))))</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine which survey questions (ROI - Response of Interest) have data across at least two distinct survey years</span></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>roi_years <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), Survey_Year) <span class="sc">%&gt;%</span></span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>Survey_Year, </span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"ROI_Indicator_Code"</span>, </span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ROI_Indicator_Code) <span class="sc">%&gt;%</span></span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">unique_years =</span> <span class="fu">n_distinct</span>(Survey_Year), </span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(unique_years <span class="sc">&gt;=</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(ROI_Indicator_Code)</span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the main data set to include only those ROIs, also ensuring to keep necessary demographic variables</span></span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a>filtered_raw_stwd_general <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Survey_Year, <span class="fu">all_of</span>(roi_years), Sex, Grade, Primary_Samp_Unit,Stratum,Final_Weight)</span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-43"><a href="#cb27-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-44"><a href="#cb27-44" aria-hidden="true" tabindex="-1"></a><span class="do">############ Long Term Trend ###############</span></span>
<span id="cb27-45"><a href="#cb27-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-46"><a href="#cb27-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-47"><a href="#cb27-47" aria-hidden="true" tabindex="-1"></a><span class="co">#Trend Analysis Function</span></span>
<span id="cb27-48"><a href="#cb27-48" aria-hidden="true" tabindex="-1"></a>analyze_trend_logistic <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb27-49"><a href="#cb27-49" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb27-50"><a href="#cb27-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Survey Design for YRBS Statewide</span></span>
<span id="cb27-51"><a href="#cb27-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_survey_design</span>(<span class="at">ids =</span> Primary_Samp_Unit,</span>
<span id="cb27-52"><a href="#cb27-52" aria-hidden="true" tabindex="-1"></a>                     <span class="at">strata =</span> Stratum,</span>
<span id="cb27-53"><a href="#cb27-53" aria-hidden="true" tabindex="-1"></a>                     <span class="at">weights =</span> Final_Weight,</span>
<span id="cb27-54"><a href="#cb27-54" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb27-55"><a href="#cb27-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-56"><a href="#cb27-56" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span></span>
<span id="cb27-57"><a href="#cb27-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Sex =</span> <span class="fu">factor</span>(Sex), <span class="at">Grade =</span> <span class="fu">factor</span>(Grade))</span>
<span id="cb27-58"><a href="#cb27-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-59"><a href="#cb27-59" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(data_filtered) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">length</span>(<span class="fu">unique</span>(data_filtered<span class="sc">$</span>variables<span class="sc">$</span>Survey_Year)) <span class="sc">&lt;</span> <span class="dv">4</span>) {</span>
<span id="cb27-60"><a href="#cb27-60" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb27-61"><a href="#cb27-61" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb27-62"><a href="#cb27-62" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-63"><a href="#cb27-63" aria-hidden="true" tabindex="-1"></a>  base_formula <span class="ot">&lt;-</span> <span class="fu">paste</span>(column_name, <span class="st">"~ Sex + Grade + Survey_Year"</span>) </span>
<span id="cb27-64"><a href="#cb27-64" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit the model using logistic regression</span></span>
<span id="cb27-65"><a href="#cb27-65" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb27-66"><a href="#cb27-66" aria-hidden="true" tabindex="-1"></a>    <span class="fu">svyglm</span>(<span class="fu">as.formula</span>(base_formula), <span class="at">design =</span> data_filtered, <span class="at">family =</span> <span class="fu">quasibinomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb27-67"><a href="#cb27-67" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb27-68"><a href="#cb27-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Error fitting model: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb27-69"><a href="#cb27-69" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb27-70"><a href="#cb27-70" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb27-71"><a href="#cb27-71" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-72"><a href="#cb27-72" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if model fitting was successful</span></span>
<span id="cb27-73"><a href="#cb27-73" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(model)) {</span>
<span id="cb27-74"><a href="#cb27-74" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error"</span>))</span>
<span id="cb27-75"><a href="#cb27-75" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb27-76"><a href="#cb27-76" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-77"><a href="#cb27-77" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check for coefficients</span></span>
<span id="cb27-78"><a href="#cb27-78" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>(<span class="st">"Survey_Year"</span> <span class="sc">%in%</span> <span class="fu">names</span>(<span class="fu">coef</span>(model)))) {</span>
<span id="cb27-79"><a href="#cb27-79" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No valid coefficient for Survey_Year"</span>))</span>
<span id="cb27-80"><a href="#cb27-80" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb27-81"><a href="#cb27-81" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-82"><a href="#cb27-82" aria-hidden="true" tabindex="-1"></a>  coef_summary <span class="ot">=</span> <span class="fu">summary</span>(model)<span class="sc">$</span>coefficients</span>
<span id="cb27-83"><a href="#cb27-83" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(coef_summary) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb27-84"><a href="#cb27-84" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error: No coefficients"</span>))</span>
<span id="cb27-85"><a href="#cb27-85" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb27-86"><a href="#cb27-86" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-87"><a href="#cb27-87" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Determine the significance and direction of the trend</span></span>
<span id="cb27-88"><a href="#cb27-88" aria-hidden="true" tabindex="-1"></a>  p_value <span class="ot">=</span> coef_summary[<span class="st">"Survey_Year"</span>, <span class="st">"Pr(&gt;|t|)"</span>]</span>
<span id="cb27-89"><a href="#cb27-89" aria-hidden="true" tabindex="-1"></a>  coefficient <span class="ot">=</span> <span class="fu">coef</span>(model)[<span class="st">"Survey_Year"</span>]</span>
<span id="cb27-90"><a href="#cb27-90" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-91"><a href="#cb27-91" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(p_value)) {</span>
<span id="cb27-92"><a href="#cb27-92" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"P-value is NA"</span>))</span>
<span id="cb27-93"><a href="#cb27-93" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb27-94"><a href="#cb27-94" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-95"><a href="#cb27-95" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (p_value <span class="sc">&lt;=</span> <span class="fl">0.05</span>) {</span>
<span id="cb27-96"><a href="#cb27-96" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (coefficient <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb27-97"><a href="#cb27-97" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Increase"</span>))</span>
<span id="cb27-98"><a href="#cb27-98" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb27-99"><a href="#cb27-99" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Decrease"</span>))</span>
<span id="cb27-100"><a href="#cb27-100" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb27-101"><a href="#cb27-101" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb27-102"><a href="#cb27-102" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No Change"</span>))</span>
<span id="cb27-103"><a href="#cb27-103" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb27-104"><a href="#cb27-104" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb27-105"><a href="#cb27-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-106"><a href="#cb27-106" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the function to each ROI_Indicator_Code that has sufficient data</span></span>
<span id="cb27-107"><a href="#cb27-107" aria-hidden="true" tabindex="-1"></a>long_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(filtered_raw_stwd_general)[<span class="sc">-</span><span class="dv">1</span>], <span class="cf">function</span>(column_name) {</span>
<span id="cb27-108"><a href="#cb27-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_trend_logistic</span>(filtered_raw_stwd_general, column_name)</span>
<span id="cb27-109"><a href="#cb27-109" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb27-110"><a href="#cb27-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-111"><a href="#cb27-111" aria-hidden="true" tabindex="-1"></a><span class="co"># Show results</span></span>
<span id="cb27-112"><a href="#cb27-112" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(long_trend_results)</span>
<span id="cb27-113"><a href="#cb27-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-114"><a href="#cb27-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-115"><a href="#cb27-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-116"><a href="#cb27-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-117"><a href="#cb27-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-118"><a href="#cb27-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-119"><a href="#cb27-119" aria-hidden="true" tabindex="-1"></a><span class="do">######### Short Term Trend ###############</span></span>
<span id="cb27-120"><a href="#cb27-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-121"><a href="#cb27-121" aria-hidden="true" tabindex="-1"></a>analyze_short_term_trend_ttest <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb27-122"><a href="#cb27-122" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the short-term years</span></span>
<span id="cb27-123"><a href="#cb27-123" aria-hidden="true" tabindex="-1"></a>    short_term_years <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2019</span>, <span class="dv">2023</span>)</span>
<span id="cb27-124"><a href="#cb27-124" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-125"><a href="#cb27-125" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter for short-term years and ensure all necessary variables are selected</span></span>
<span id="cb27-126"><a href="#cb27-126" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb27-127"><a href="#cb27-127" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(Survey_Year <span class="sc">%in%</span> short_term_years) <span class="sc">%&gt;%</span></span>
<span id="cb27-128"><a href="#cb27-128" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(Primary_Samp_Unit, Stratum, Final_Weight, Survey_Year, <span class="fu">all_of</span>(column_name)) <span class="sc">%&gt;%</span></span>
<span id="cb27-129"><a href="#cb27-129" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">response =</span> <span class="fu">get</span>(column_name) <span class="sc">==</span> <span class="dv">1</span>)  <span class="co"># Create a binary response variable for the analysis</span></span>
<span id="cb27-130"><a href="#cb27-130" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-131"><a href="#cb27-131" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if data is available for both years</span></span>
<span id="cb27-132"><a href="#cb27-132" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(short_term_years <span class="sc">%in%</span> <span class="fu">unique</span>(data_filtered<span class="sc">$</span>Survey_Year[<span class="sc">!</span><span class="fu">is.na</span>(data_filtered<span class="sc">$</span>response)]))) {</span>
<span id="cb27-133"><a href="#cb27-133" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb27-134"><a href="#cb27-134" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb27-135"><a href="#cb27-135" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-136"><a href="#cb27-136" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Continue with data that doesn't have NA responses</span></span>
<span id="cb27-137"><a href="#cb27-137" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(response))</span>
<span id="cb27-138"><a href="#cb27-138" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-139"><a href="#cb27-139" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create survey design object including the response variable</span></span>
<span id="cb27-140"><a href="#cb27-140" aria-hidden="true" tabindex="-1"></a>    survey_design <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="sc">~</span>Primary_Samp_Unit,</span>
<span id="cb27-141"><a href="#cb27-141" aria-hidden="true" tabindex="-1"></a>                               <span class="at">strata =</span> <span class="sc">~</span>Stratum,</span>
<span id="cb27-142"><a href="#cb27-142" aria-hidden="true" tabindex="-1"></a>                               <span class="at">weights =</span> <span class="sc">~</span>Final_Weight,</span>
<span id="cb27-143"><a href="#cb27-143" aria-hidden="true" tabindex="-1"></a>                               <span class="at">data =</span> data_filtered,</span>
<span id="cb27-144"><a href="#cb27-144" aria-hidden="true" tabindex="-1"></a>                               <span class="at">nest =</span> <span class="cn">TRUE</span>) </span>
<span id="cb27-145"><a href="#cb27-145" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-146"><a href="#cb27-146" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Perform Welch's t-test using the survey design object</span></span>
<span id="cb27-147"><a href="#cb27-147" aria-hidden="true" tabindex="-1"></a>    ttest_result <span class="ot">&lt;-</span> <span class="fu">svyttest</span>(response <span class="sc">~</span> <span class="fu">as.factor</span>(Survey_Year), survey_design)</span>
<span id="cb27-148"><a href="#cb27-148" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-149"><a href="#cb27-149" aria-hidden="true" tabindex="-1"></a>    <span class="co"># head t-test results</span></span>
<span id="cb27-150"><a href="#cb27-150" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(ttest_result)</span>
<span id="cb27-151"><a href="#cb27-151" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-152"><a href="#cb27-152" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check significance and interpret the results</span></span>
<span id="cb27-153"><a href="#cb27-153" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(ttest_result<span class="sc">$</span>p.value) <span class="sc">&amp;&amp;</span> ttest_result<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>) {</span>
<span id="cb27-154"><a href="#cb27-154" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(ttest_result<span class="sc">$</span>estimate <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Significant Increase"</span>, <span class="st">"Significant Decrease"</span>)</span>
<span id="cb27-155"><a href="#cb27-155" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb27-156"><a href="#cb27-156" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="st">"No Change"</span></span>
<span id="cb27-157"><a href="#cb27-157" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb27-158"><a href="#cb27-158" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-159"><a href="#cb27-159" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> trend))</span>
<span id="cb27-160"><a href="#cb27-160" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb27-161"><a href="#cb27-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-162"><a href="#cb27-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-163"><a href="#cb27-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-164"><a href="#cb27-164" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the short-term function to each ROI_Indicator_Code</span></span>
<span id="cb27-165"><a href="#cb27-165" aria-hidden="true" tabindex="-1"></a>short_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(raw_stwd_general)[<span class="fu">grep</span>(<span class="st">"^(QN|V).*[RP]"</span>, <span class="fu">names</span>(raw_stwd_general))], <span class="cf">function</span>(column_name) {</span>
<span id="cb27-166"><a href="#cb27-166" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_short_term_trend_ttest</span>(raw_stwd_general, column_name)</span>
<span id="cb27-167"><a href="#cb27-167" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb27-168"><a href="#cb27-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-169"><a href="#cb27-169" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(short_trend_results)</span>
<span id="cb27-170"><a href="#cb27-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-171"><a href="#cb27-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-172"><a href="#cb27-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-173"><a href="#cb27-173" aria-hidden="true" tabindex="-1"></a><span class="do">################### Join Together with Trend Tables ############</span></span>
<span id="cb27-174"><a href="#cb27-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-175"><a href="#cb27-175" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine long-term and short-term results</span></span>
<span id="cb27-176"><a href="#cb27-176" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> <span class="fu">left_join</span>(long_trend_results, </span>
<span id="cb27-177"><a href="#cb27-177" aria-hidden="true" tabindex="-1"></a>                                    short_trend_results, </span>
<span id="cb27-178"><a href="#cb27-178" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">by =</span> <span class="st">"ROI_Indicator_Code"</span>)</span>
<span id="cb27-179"><a href="#cb27-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-180"><a href="#cb27-180" aria-hidden="true" tabindex="-1"></a><span class="co">#head(combined_trend_results)</span></span>
<span id="cb27-181"><a href="#cb27-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-182"><a href="#cb27-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-183"><a href="#cb27-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-184"><a href="#cb27-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-185"><a href="#cb27-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-186"><a href="#cb27-186" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge Long_Term_Trend into yrbs_master_stwd_grade based on matching ROI_Indicator_Code and Trend_Category</span></span>
<span id="cb27-187"><a href="#cb27-187" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> yrbs_master_analysis_stwd_trend <span class="sc">%&gt;%</span></span>
<span id="cb27-188"><a href="#cb27-188" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(combined_trend_results <span class="sc">%&gt;%</span> <span class="fu">select</span>(ROI_Indicator_Code, Long_Term_Trend, Short_Term_Trend),</span>
<span id="cb27-189"><a href="#cb27-189" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ROI_Indicator_Code"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb27-190"><a href="#cb27-190" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(School_Type,</span>
<span id="cb27-191"><a href="#cb27-191" aria-hidden="true" tabindex="-1"></a>         Health_Topic, </span>
<span id="cb27-192"><a href="#cb27-192" aria-hidden="true" tabindex="-1"></a>         ROI_Indicator_Code, </span>
<span id="cb27-193"><a href="#cb27-193" aria-hidden="true" tabindex="-1"></a>         Indicator_Long_Description, </span>
<span id="cb27-194"><a href="#cb27-194" aria-hidden="true" tabindex="-1"></a>         Trend_Category, </span>
<span id="cb27-195"><a href="#cb27-195" aria-hidden="true" tabindex="-1"></a>         <span class="fu">everything</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb27-196"><a href="#cb27-196" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, </span>
<span id="cb27-197"><a href="#cb27-197" aria-hidden="true" tabindex="-1"></a>          ROI_Indicator_Code, </span>
<span id="cb27-198"><a href="#cb27-198" aria-hidden="true" tabindex="-1"></a>          Trend_Category)</span>
<span id="cb27-199"><a href="#cb27-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-200"><a href="#cb27-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-201"><a href="#cb27-201" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to check for three consecutive NAs in a set of columns</span></span>
<span id="cb27-202"><a href="#cb27-202" aria-hidden="true" tabindex="-1"></a>check_consecutive_nas <span class="ot">&lt;-</span> <span class="cf">function</span>(year_values) {</span>
<span id="cb27-203"><a href="#cb27-203" aria-hidden="true" tabindex="-1"></a>  na_run_lengths <span class="ot">&lt;-</span> <span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>lengths[<span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>values]</span>
<span id="cb27-204"><a href="#cb27-204" aria-hidden="true" tabindex="-1"></a>  <span class="fu">any</span>(na_run_lengths <span class="sc">&gt;=</span> <span class="dv">3</span>)</span>
<span id="cb27-205"><a href="#cb27-205" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb27-206"><a href="#cb27-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-207"><a href="#cb27-207" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert all columns representing years to numeric</span></span>
<span id="cb27-208"><a href="#cb27-208" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb27-209"><a href="#cb27-209" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">d+$"</span>), as.numeric))</span>
<span id="cb27-210"><a href="#cb27-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-211"><a href="#cb27-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-212"><a href="#cb27-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-213"><a href="#cb27-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-214"><a href="#cb27-214" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge and mutate Long_Term_Trend</span></span>
<span id="cb27-215"><a href="#cb27-215" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb27-216"><a href="#cb27-216" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb27-217"><a href="#cb27-217" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Long_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">check_consecutive_nas</span>(<span class="fu">c_across</span>(<span class="st">`</span><span class="at">2011</span><span class="st">`</span><span class="sc">:</span><span class="st">`</span><span class="at">2023</span><span class="st">`</span>)), </span>
<span id="cb27-218"><a href="#cb27-218" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb27-219"><a href="#cb27-219" aria-hidden="true" tabindex="-1"></a>                                  Long_Term_Trend),</span>
<span id="cb27-220"><a href="#cb27-220" aria-hidden="true" tabindex="-1"></a>         <span class="at">Short_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(<span class="st">`</span><span class="at">2019</span><span class="st">`</span>) <span class="sc">|</span> <span class="fu">is.na</span>(<span class="st">`</span><span class="at">2023</span><span class="st">`</span>), </span>
<span id="cb27-221"><a href="#cb27-221" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb27-222"><a href="#cb27-222" aria-hidden="true" tabindex="-1"></a>                                   Short_Term_Trend)) <span class="sc">%&gt;%</span></span>
<span id="cb27-223"><a href="#cb27-223" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb27-224"><a href="#cb27-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-225"><a href="#cb27-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-226"><a href="#cb27-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-227"><a href="#cb27-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-228"><a href="#cb27-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-229"><a href="#cb27-229" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results)</span>
<span id="cb27-230"><a href="#cb27-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-231"><a href="#cb27-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-232"><a href="#cb27-232" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb27-233"><a href="#cb27-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-234"><a href="#cb27-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-235"><a href="#cb27-235" aria-hidden="true" tabindex="-1"></a>trend_results_race_8_NWPI <span class="ot">&lt;-</span> trend_results</span>
<span id="cb27-236"><a href="#cb27-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-237"><a href="#cb27-237" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results_race_8_NWPI)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="non-hisplat-mult-race" class="level4">
<h4 class="anchored" data-anchor-id="non-hisplat-mult-race">8.7 - Non Hisp/Lat Mult Race</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="do">######## Import Raw and Analyzed Excel Files ###############</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>yrbs_master_analysis_stwd_trend <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Race_Group_8 Trend"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Trend_Category <span class="sc">==</span> <span class="st">"Non Hisp/Lat Mult Race"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="st">"Suppressed"</span>, <span class="cn">NA</span>, .)))</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the raw data set to be used in trend analyis</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>raw_stwd_general <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"raw_yrbs_allyears_statewide_trad_cleaned.xlsx"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Race_Group_8 <span class="sc">==</span> <span class="st">"Non Hisp/Lat Mult Race"</span>,</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>         Survey_Year <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2011</span>,</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2013</span>, </span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2015</span>, </span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2017</span>,</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2019</span>, </span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2023</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>                            )) <span class="sc">%&gt;%</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">2</span>, <span class="dv">0</span>, <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="cn">NA</span>))))</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine which survey questions (ROI - Response of Interest) have data across at least two distinct survey years</span></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>roi_years <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), Survey_Year) <span class="sc">%&gt;%</span></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>Survey_Year, </span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"ROI_Indicator_Code"</span>, </span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ROI_Indicator_Code) <span class="sc">%&gt;%</span></span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">unique_years =</span> <span class="fu">n_distinct</span>(Survey_Year), </span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(unique_years <span class="sc">&gt;=</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(ROI_Indicator_Code)</span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the main data set to include only those ROIs, also ensuring to keep necessary demographic variables</span></span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>filtered_raw_stwd_general <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Survey_Year, <span class="fu">all_of</span>(roi_years), Sex, Grade, Primary_Samp_Unit,Stratum,Final_Weight)</span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a><span class="do">############ Long Term Trend ###############</span></span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a><span class="co">#Trend Analysis Function</span></span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a>analyze_trend_logistic <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Survey Design for YRBS Statewide</span></span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_survey_design</span>(<span class="at">ids =</span> Primary_Samp_Unit,</span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a>                     <span class="at">strata =</span> Stratum,</span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a>                     <span class="at">weights =</span> Final_Weight,</span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span></span>
<span id="cb28-56"><a href="#cb28-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Sex =</span> <span class="fu">factor</span>(Sex), <span class="at">Grade =</span> <span class="fu">factor</span>(Grade))</span>
<span id="cb28-57"><a href="#cb28-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-58"><a href="#cb28-58" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(data_filtered) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">length</span>(<span class="fu">unique</span>(data_filtered<span class="sc">$</span>variables<span class="sc">$</span>Survey_Year)) <span class="sc">&lt;</span> <span class="dv">4</span>) {</span>
<span id="cb28-59"><a href="#cb28-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb28-60"><a href="#cb28-60" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-61"><a href="#cb28-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-62"><a href="#cb28-62" aria-hidden="true" tabindex="-1"></a>  base_formula <span class="ot">&lt;-</span> <span class="fu">paste</span>(column_name, <span class="st">"~ Sex + Grade + Survey_Year"</span>) </span>
<span id="cb28-63"><a href="#cb28-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit the model using logistic regression</span></span>
<span id="cb28-64"><a href="#cb28-64" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb28-65"><a href="#cb28-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">svyglm</span>(<span class="fu">as.formula</span>(base_formula), <span class="at">design =</span> data_filtered, <span class="at">family =</span> <span class="fu">quasibinomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb28-66"><a href="#cb28-66" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb28-67"><a href="#cb28-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Error fitting model: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb28-68"><a href="#cb28-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb28-69"><a href="#cb28-69" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb28-70"><a href="#cb28-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-71"><a href="#cb28-71" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if model fitting was successful</span></span>
<span id="cb28-72"><a href="#cb28-72" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(model)) {</span>
<span id="cb28-73"><a href="#cb28-73" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error"</span>))</span>
<span id="cb28-74"><a href="#cb28-74" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-75"><a href="#cb28-75" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-76"><a href="#cb28-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check for coefficients</span></span>
<span id="cb28-77"><a href="#cb28-77" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>(<span class="st">"Survey_Year"</span> <span class="sc">%in%</span> <span class="fu">names</span>(<span class="fu">coef</span>(model)))) {</span>
<span id="cb28-78"><a href="#cb28-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No valid coefficient for Survey_Year"</span>))</span>
<span id="cb28-79"><a href="#cb28-79" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-80"><a href="#cb28-80" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-81"><a href="#cb28-81" aria-hidden="true" tabindex="-1"></a>  coef_summary <span class="ot">=</span> <span class="fu">summary</span>(model)<span class="sc">$</span>coefficients</span>
<span id="cb28-82"><a href="#cb28-82" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(coef_summary) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb28-83"><a href="#cb28-83" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error: No coefficients"</span>))</span>
<span id="cb28-84"><a href="#cb28-84" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-85"><a href="#cb28-85" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-86"><a href="#cb28-86" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Determine the significance and direction of the trend</span></span>
<span id="cb28-87"><a href="#cb28-87" aria-hidden="true" tabindex="-1"></a>  p_value <span class="ot">=</span> coef_summary[<span class="st">"Survey_Year"</span>, <span class="st">"Pr(&gt;|t|)"</span>]</span>
<span id="cb28-88"><a href="#cb28-88" aria-hidden="true" tabindex="-1"></a>  coefficient <span class="ot">=</span> <span class="fu">coef</span>(model)[<span class="st">"Survey_Year"</span>]</span>
<span id="cb28-89"><a href="#cb28-89" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-90"><a href="#cb28-90" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(p_value)) {</span>
<span id="cb28-91"><a href="#cb28-91" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"P-value is NA"</span>))</span>
<span id="cb28-92"><a href="#cb28-92" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-93"><a href="#cb28-93" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-94"><a href="#cb28-94" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (p_value <span class="sc">&lt;=</span> <span class="fl">0.05</span>) {</span>
<span id="cb28-95"><a href="#cb28-95" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (coefficient <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb28-96"><a href="#cb28-96" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Increase"</span>))</span>
<span id="cb28-97"><a href="#cb28-97" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb28-98"><a href="#cb28-98" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Decrease"</span>))</span>
<span id="cb28-99"><a href="#cb28-99" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-100"><a href="#cb28-100" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb28-101"><a href="#cb28-101" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No Change"</span>))</span>
<span id="cb28-102"><a href="#cb28-102" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-103"><a href="#cb28-103" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-104"><a href="#cb28-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-105"><a href="#cb28-105" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the function to each ROI_Indicator_Code that has sufficient data</span></span>
<span id="cb28-106"><a href="#cb28-106" aria-hidden="true" tabindex="-1"></a>long_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(filtered_raw_stwd_general)[<span class="sc">-</span><span class="dv">1</span>], <span class="cf">function</span>(column_name) {</span>
<span id="cb28-107"><a href="#cb28-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_trend_logistic</span>(filtered_raw_stwd_general, column_name)</span>
<span id="cb28-108"><a href="#cb28-108" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb28-109"><a href="#cb28-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-110"><a href="#cb28-110" aria-hidden="true" tabindex="-1"></a><span class="co"># Show results</span></span>
<span id="cb28-111"><a href="#cb28-111" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(long_trend_results)</span>
<span id="cb28-112"><a href="#cb28-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-113"><a href="#cb28-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-114"><a href="#cb28-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-115"><a href="#cb28-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-116"><a href="#cb28-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-117"><a href="#cb28-117" aria-hidden="true" tabindex="-1"></a><span class="do">######### Short Term Trend ###############</span></span>
<span id="cb28-118"><a href="#cb28-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-119"><a href="#cb28-119" aria-hidden="true" tabindex="-1"></a>analyze_short_term_trend_ttest <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb28-120"><a href="#cb28-120" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the short-term years</span></span>
<span id="cb28-121"><a href="#cb28-121" aria-hidden="true" tabindex="-1"></a>    short_term_years <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2019</span>, <span class="dv">2023</span>)</span>
<span id="cb28-122"><a href="#cb28-122" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-123"><a href="#cb28-123" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter for short-term years and ensure all necessary variables are selected</span></span>
<span id="cb28-124"><a href="#cb28-124" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb28-125"><a href="#cb28-125" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(Survey_Year <span class="sc">%in%</span> short_term_years) <span class="sc">%&gt;%</span></span>
<span id="cb28-126"><a href="#cb28-126" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(Primary_Samp_Unit, Stratum, Final_Weight, Survey_Year, <span class="fu">all_of</span>(column_name)) <span class="sc">%&gt;%</span></span>
<span id="cb28-127"><a href="#cb28-127" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">response =</span> <span class="fu">get</span>(column_name) <span class="sc">==</span> <span class="dv">1</span>)  <span class="co"># Create a binary response variable for the analysis</span></span>
<span id="cb28-128"><a href="#cb28-128" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-129"><a href="#cb28-129" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if data is available for both years</span></span>
<span id="cb28-130"><a href="#cb28-130" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(short_term_years <span class="sc">%in%</span> <span class="fu">unique</span>(data_filtered<span class="sc">$</span>Survey_Year[<span class="sc">!</span><span class="fu">is.na</span>(data_filtered<span class="sc">$</span>response)]))) {</span>
<span id="cb28-131"><a href="#cb28-131" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb28-132"><a href="#cb28-132" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-133"><a href="#cb28-133" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-134"><a href="#cb28-134" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Continue with data that doesn't have NA responses</span></span>
<span id="cb28-135"><a href="#cb28-135" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(response))</span>
<span id="cb28-136"><a href="#cb28-136" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-137"><a href="#cb28-137" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create survey design object including the response variable</span></span>
<span id="cb28-138"><a href="#cb28-138" aria-hidden="true" tabindex="-1"></a>    survey_design <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="sc">~</span>Primary_Samp_Unit,</span>
<span id="cb28-139"><a href="#cb28-139" aria-hidden="true" tabindex="-1"></a>                               <span class="at">strata =</span> <span class="sc">~</span>Stratum,</span>
<span id="cb28-140"><a href="#cb28-140" aria-hidden="true" tabindex="-1"></a>                               <span class="at">weights =</span> <span class="sc">~</span>Final_Weight,</span>
<span id="cb28-141"><a href="#cb28-141" aria-hidden="true" tabindex="-1"></a>                               <span class="at">data =</span> data_filtered,</span>
<span id="cb28-142"><a href="#cb28-142" aria-hidden="true" tabindex="-1"></a>                               <span class="at">nest =</span> <span class="cn">TRUE</span>) </span>
<span id="cb28-143"><a href="#cb28-143" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-144"><a href="#cb28-144" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Perform Welch's t-test using the survey design object</span></span>
<span id="cb28-145"><a href="#cb28-145" aria-hidden="true" tabindex="-1"></a>    ttest_result <span class="ot">&lt;-</span> <span class="fu">svyttest</span>(response <span class="sc">~</span> <span class="fu">as.factor</span>(Survey_Year), survey_design)</span>
<span id="cb28-146"><a href="#cb28-146" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-147"><a href="#cb28-147" aria-hidden="true" tabindex="-1"></a>    <span class="co"># head t-test results</span></span>
<span id="cb28-148"><a href="#cb28-148" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(ttest_result)</span>
<span id="cb28-149"><a href="#cb28-149" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-150"><a href="#cb28-150" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check significance and interpret the results</span></span>
<span id="cb28-151"><a href="#cb28-151" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(ttest_result<span class="sc">$</span>p.value) <span class="sc">&amp;&amp;</span> ttest_result<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>) {</span>
<span id="cb28-152"><a href="#cb28-152" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(ttest_result<span class="sc">$</span>estimate <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Significant Increase"</span>, <span class="st">"Significant Decrease"</span>)</span>
<span id="cb28-153"><a href="#cb28-153" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb28-154"><a href="#cb28-154" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="st">"No Change"</span></span>
<span id="cb28-155"><a href="#cb28-155" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-156"><a href="#cb28-156" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-157"><a href="#cb28-157" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> trend))</span>
<span id="cb28-158"><a href="#cb28-158" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-159"><a href="#cb28-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-160"><a href="#cb28-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-161"><a href="#cb28-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-162"><a href="#cb28-162" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the short-term function to each ROI_Indicator_Code</span></span>
<span id="cb28-163"><a href="#cb28-163" aria-hidden="true" tabindex="-1"></a>short_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(raw_stwd_general)[<span class="fu">grep</span>(<span class="st">"^(QN|V).*[RP]"</span>, <span class="fu">names</span>(raw_stwd_general))], <span class="cf">function</span>(column_name) {</span>
<span id="cb28-164"><a href="#cb28-164" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_short_term_trend_ttest</span>(raw_stwd_general, column_name)</span>
<span id="cb28-165"><a href="#cb28-165" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb28-166"><a href="#cb28-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-167"><a href="#cb28-167" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(short_trend_results)</span>
<span id="cb28-168"><a href="#cb28-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-169"><a href="#cb28-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-170"><a href="#cb28-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-171"><a href="#cb28-171" aria-hidden="true" tabindex="-1"></a><span class="do">################### Join Together with Trend Tables ############</span></span>
<span id="cb28-172"><a href="#cb28-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-173"><a href="#cb28-173" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine long-term and short-term results</span></span>
<span id="cb28-174"><a href="#cb28-174" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> <span class="fu">left_join</span>(long_trend_results, </span>
<span id="cb28-175"><a href="#cb28-175" aria-hidden="true" tabindex="-1"></a>                                    short_trend_results, </span>
<span id="cb28-176"><a href="#cb28-176" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">by =</span> <span class="st">"ROI_Indicator_Code"</span>)</span>
<span id="cb28-177"><a href="#cb28-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-178"><a href="#cb28-178" aria-hidden="true" tabindex="-1"></a><span class="co">#head(combined_trend_results)</span></span>
<span id="cb28-179"><a href="#cb28-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-180"><a href="#cb28-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-181"><a href="#cb28-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-182"><a href="#cb28-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-183"><a href="#cb28-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-184"><a href="#cb28-184" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge Long_Term_Trend into yrbs_master_stwd_grade based on matching ROI_Indicator_Code and Trend_Category</span></span>
<span id="cb28-185"><a href="#cb28-185" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> yrbs_master_analysis_stwd_trend <span class="sc">%&gt;%</span></span>
<span id="cb28-186"><a href="#cb28-186" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(combined_trend_results <span class="sc">%&gt;%</span> <span class="fu">select</span>(ROI_Indicator_Code, Long_Term_Trend, Short_Term_Trend),</span>
<span id="cb28-187"><a href="#cb28-187" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ROI_Indicator_Code"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb28-188"><a href="#cb28-188" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(School_Type,</span>
<span id="cb28-189"><a href="#cb28-189" aria-hidden="true" tabindex="-1"></a>         Health_Topic, </span>
<span id="cb28-190"><a href="#cb28-190" aria-hidden="true" tabindex="-1"></a>         ROI_Indicator_Code, </span>
<span id="cb28-191"><a href="#cb28-191" aria-hidden="true" tabindex="-1"></a>         Indicator_Long_Description, </span>
<span id="cb28-192"><a href="#cb28-192" aria-hidden="true" tabindex="-1"></a>         Trend_Category, </span>
<span id="cb28-193"><a href="#cb28-193" aria-hidden="true" tabindex="-1"></a>         <span class="fu">everything</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb28-194"><a href="#cb28-194" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, </span>
<span id="cb28-195"><a href="#cb28-195" aria-hidden="true" tabindex="-1"></a>          ROI_Indicator_Code, </span>
<span id="cb28-196"><a href="#cb28-196" aria-hidden="true" tabindex="-1"></a>          Trend_Category)</span>
<span id="cb28-197"><a href="#cb28-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-198"><a href="#cb28-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-199"><a href="#cb28-199" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to check for three consecutive NAs in a set of columns</span></span>
<span id="cb28-200"><a href="#cb28-200" aria-hidden="true" tabindex="-1"></a>check_consecutive_nas <span class="ot">&lt;-</span> <span class="cf">function</span>(year_values) {</span>
<span id="cb28-201"><a href="#cb28-201" aria-hidden="true" tabindex="-1"></a>  na_run_lengths <span class="ot">&lt;-</span> <span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>lengths[<span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>values]</span>
<span id="cb28-202"><a href="#cb28-202" aria-hidden="true" tabindex="-1"></a>  <span class="fu">any</span>(na_run_lengths <span class="sc">&gt;=</span> <span class="dv">3</span>)</span>
<span id="cb28-203"><a href="#cb28-203" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-204"><a href="#cb28-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-205"><a href="#cb28-205" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert all columns representing years to numeric</span></span>
<span id="cb28-206"><a href="#cb28-206" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb28-207"><a href="#cb28-207" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">d+$"</span>), as.numeric))</span>
<span id="cb28-208"><a href="#cb28-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-209"><a href="#cb28-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-210"><a href="#cb28-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-211"><a href="#cb28-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-212"><a href="#cb28-212" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge and mutate Long_Term_Trend</span></span>
<span id="cb28-213"><a href="#cb28-213" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb28-214"><a href="#cb28-214" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb28-215"><a href="#cb28-215" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Long_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">check_consecutive_nas</span>(<span class="fu">c_across</span>(<span class="st">`</span><span class="at">2011</span><span class="st">`</span><span class="sc">:</span><span class="st">`</span><span class="at">2023</span><span class="st">`</span>)), </span>
<span id="cb28-216"><a href="#cb28-216" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb28-217"><a href="#cb28-217" aria-hidden="true" tabindex="-1"></a>                                  Long_Term_Trend),</span>
<span id="cb28-218"><a href="#cb28-218" aria-hidden="true" tabindex="-1"></a>         <span class="at">Short_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(<span class="st">`</span><span class="at">2019</span><span class="st">`</span>) <span class="sc">|</span> <span class="fu">is.na</span>(<span class="st">`</span><span class="at">2023</span><span class="st">`</span>), </span>
<span id="cb28-219"><a href="#cb28-219" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb28-220"><a href="#cb28-220" aria-hidden="true" tabindex="-1"></a>                                   Short_Term_Trend)) <span class="sc">%&gt;%</span></span>
<span id="cb28-221"><a href="#cb28-221" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb28-222"><a href="#cb28-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-223"><a href="#cb28-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-224"><a href="#cb28-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-225"><a href="#cb28-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-226"><a href="#cb28-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-227"><a href="#cb28-227" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results)</span>
<span id="cb28-228"><a href="#cb28-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-229"><a href="#cb28-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-230"><a href="#cb28-230" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb28-231"><a href="#cb28-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-232"><a href="#cb28-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-233"><a href="#cb28-233" aria-hidden="true" tabindex="-1"></a>trend_results_race_8_Non_HispLat_Mult <span class="ot">&lt;-</span> trend_results</span>
<span id="cb28-234"><a href="#cb28-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-235"><a href="#cb28-235" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results_race_8_Non_HispLat_Mult)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="white-3" class="level4">
<h4 class="anchored" data-anchor-id="white-3">8.8 - White</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="do">######## Import Raw and Analyzed Excel Files ###############</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>yrbs_master_analysis_stwd_trend <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Race_Group_8 Trend"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Trend_Category <span class="sc">==</span> <span class="st">"White"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="st">"Suppressed"</span>, <span class="cn">NA</span>, .)))</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the raw data set to be used in trend analyis</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>raw_stwd_general <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"raw_yrbs_allyears_statewide_trad_cleaned.xlsx"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Race_Group_8 <span class="sc">==</span> <span class="st">"White"</span>,</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>         Survey_Year <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2011</span>,</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2013</span>, </span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2015</span>, </span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2017</span>,</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2019</span>, </span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2023</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>                            )) <span class="sc">%&gt;%</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">2</span>, <span class="dv">0</span>, <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="cn">NA</span>))))</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine which survey questions (ROI - Response of Interest) have data across at least two distinct survey years</span></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>roi_years <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), Survey_Year) <span class="sc">%&gt;%</span></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>Survey_Year, </span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"ROI_Indicator_Code"</span>, </span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ROI_Indicator_Code) <span class="sc">%&gt;%</span></span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">unique_years =</span> <span class="fu">n_distinct</span>(Survey_Year), </span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(unique_years <span class="sc">&gt;=</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(ROI_Indicator_Code)</span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the main data set to include only those ROIs, also ensuring to keep necessary demographic variables</span></span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a>filtered_raw_stwd_general <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Survey_Year, <span class="fu">all_of</span>(roi_years), Sex, Grade, Primary_Samp_Unit,Stratum,Final_Weight)</span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a><span class="do">############ Long Term Trend ###############</span></span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a><span class="co">#Trend Analysis Function</span></span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true" tabindex="-1"></a>analyze_trend_logistic <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb29-49"><a href="#cb29-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Survey Design for YRBS Statewide</span></span>
<span id="cb29-50"><a href="#cb29-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_survey_design</span>(<span class="at">ids =</span> Primary_Samp_Unit,</span>
<span id="cb29-51"><a href="#cb29-51" aria-hidden="true" tabindex="-1"></a>                     <span class="at">strata =</span> Stratum,</span>
<span id="cb29-52"><a href="#cb29-52" aria-hidden="true" tabindex="-1"></a>                     <span class="at">weights =</span> Final_Weight,</span>
<span id="cb29-53"><a href="#cb29-53" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb29-54"><a href="#cb29-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-55"><a href="#cb29-55" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span></span>
<span id="cb29-56"><a href="#cb29-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Sex =</span> <span class="fu">factor</span>(Sex), <span class="at">Grade =</span> <span class="fu">factor</span>(Grade))</span>
<span id="cb29-57"><a href="#cb29-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-58"><a href="#cb29-58" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(data_filtered) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">length</span>(<span class="fu">unique</span>(data_filtered<span class="sc">$</span>variables<span class="sc">$</span>Survey_Year)) <span class="sc">&lt;</span> <span class="dv">4</span>) {</span>
<span id="cb29-59"><a href="#cb29-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb29-60"><a href="#cb29-60" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-61"><a href="#cb29-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-62"><a href="#cb29-62" aria-hidden="true" tabindex="-1"></a>  base_formula <span class="ot">&lt;-</span> <span class="fu">paste</span>(column_name, <span class="st">"~ Sex + Grade + Survey_Year"</span>) </span>
<span id="cb29-63"><a href="#cb29-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit the model using logistic regression</span></span>
<span id="cb29-64"><a href="#cb29-64" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb29-65"><a href="#cb29-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">svyglm</span>(<span class="fu">as.formula</span>(base_formula), <span class="at">design =</span> data_filtered, <span class="at">family =</span> <span class="fu">quasibinomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb29-66"><a href="#cb29-66" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb29-67"><a href="#cb29-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Error fitting model: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb29-68"><a href="#cb29-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb29-69"><a href="#cb29-69" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb29-70"><a href="#cb29-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-71"><a href="#cb29-71" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if model fitting was successful</span></span>
<span id="cb29-72"><a href="#cb29-72" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(model)) {</span>
<span id="cb29-73"><a href="#cb29-73" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error"</span>))</span>
<span id="cb29-74"><a href="#cb29-74" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-75"><a href="#cb29-75" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-76"><a href="#cb29-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check for coefficients</span></span>
<span id="cb29-77"><a href="#cb29-77" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>(<span class="st">"Survey_Year"</span> <span class="sc">%in%</span> <span class="fu">names</span>(<span class="fu">coef</span>(model)))) {</span>
<span id="cb29-78"><a href="#cb29-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No valid coefficient for Survey_Year"</span>))</span>
<span id="cb29-79"><a href="#cb29-79" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-80"><a href="#cb29-80" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-81"><a href="#cb29-81" aria-hidden="true" tabindex="-1"></a>  coef_summary <span class="ot">=</span> <span class="fu">summary</span>(model)<span class="sc">$</span>coefficients</span>
<span id="cb29-82"><a href="#cb29-82" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(coef_summary) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb29-83"><a href="#cb29-83" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error: No coefficients"</span>))</span>
<span id="cb29-84"><a href="#cb29-84" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-85"><a href="#cb29-85" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-86"><a href="#cb29-86" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Determine the significance and direction of the trend</span></span>
<span id="cb29-87"><a href="#cb29-87" aria-hidden="true" tabindex="-1"></a>  p_value <span class="ot">=</span> coef_summary[<span class="st">"Survey_Year"</span>, <span class="st">"Pr(&gt;|t|)"</span>]</span>
<span id="cb29-88"><a href="#cb29-88" aria-hidden="true" tabindex="-1"></a>  coefficient <span class="ot">=</span> <span class="fu">coef</span>(model)[<span class="st">"Survey_Year"</span>]</span>
<span id="cb29-89"><a href="#cb29-89" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-90"><a href="#cb29-90" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(p_value)) {</span>
<span id="cb29-91"><a href="#cb29-91" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"P-value is NA"</span>))</span>
<span id="cb29-92"><a href="#cb29-92" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-93"><a href="#cb29-93" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-94"><a href="#cb29-94" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (p_value <span class="sc">&lt;=</span> <span class="fl">0.05</span>) {</span>
<span id="cb29-95"><a href="#cb29-95" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (coefficient <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb29-96"><a href="#cb29-96" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Increase"</span>))</span>
<span id="cb29-97"><a href="#cb29-97" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb29-98"><a href="#cb29-98" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Decrease"</span>))</span>
<span id="cb29-99"><a href="#cb29-99" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb29-100"><a href="#cb29-100" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb29-101"><a href="#cb29-101" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No Change"</span>))</span>
<span id="cb29-102"><a href="#cb29-102" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-103"><a href="#cb29-103" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-104"><a href="#cb29-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-105"><a href="#cb29-105" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the function to each ROI_Indicator_Code that has sufficient data</span></span>
<span id="cb29-106"><a href="#cb29-106" aria-hidden="true" tabindex="-1"></a>long_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(filtered_raw_stwd_general)[<span class="sc">-</span><span class="dv">1</span>], <span class="cf">function</span>(column_name) {</span>
<span id="cb29-107"><a href="#cb29-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_trend_logistic</span>(filtered_raw_stwd_general, column_name)</span>
<span id="cb29-108"><a href="#cb29-108" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb29-109"><a href="#cb29-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-110"><a href="#cb29-110" aria-hidden="true" tabindex="-1"></a><span class="co"># Show results</span></span>
<span id="cb29-111"><a href="#cb29-111" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(long_trend_results)</span>
<span id="cb29-112"><a href="#cb29-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-113"><a href="#cb29-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-114"><a href="#cb29-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-115"><a href="#cb29-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-116"><a href="#cb29-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-117"><a href="#cb29-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-118"><a href="#cb29-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-119"><a href="#cb29-119" aria-hidden="true" tabindex="-1"></a><span class="do">######### Short Term Trend ###############</span></span>
<span id="cb29-120"><a href="#cb29-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-121"><a href="#cb29-121" aria-hidden="true" tabindex="-1"></a>analyze_short_term_trend_ttest <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb29-122"><a href="#cb29-122" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the short-term years</span></span>
<span id="cb29-123"><a href="#cb29-123" aria-hidden="true" tabindex="-1"></a>    short_term_years <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2019</span>, <span class="dv">2023</span>)</span>
<span id="cb29-124"><a href="#cb29-124" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-125"><a href="#cb29-125" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter for short-term years and ensure all necessary variables are selected</span></span>
<span id="cb29-126"><a href="#cb29-126" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb29-127"><a href="#cb29-127" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(Survey_Year <span class="sc">%in%</span> short_term_years) <span class="sc">%&gt;%</span></span>
<span id="cb29-128"><a href="#cb29-128" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(Primary_Samp_Unit, Stratum, Final_Weight, Survey_Year, <span class="fu">all_of</span>(column_name)) <span class="sc">%&gt;%</span></span>
<span id="cb29-129"><a href="#cb29-129" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">response =</span> <span class="fu">get</span>(column_name) <span class="sc">==</span> <span class="dv">1</span>)  <span class="co"># Create a binary response variable for the analysis</span></span>
<span id="cb29-130"><a href="#cb29-130" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-131"><a href="#cb29-131" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if data is available for both years</span></span>
<span id="cb29-132"><a href="#cb29-132" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(short_term_years <span class="sc">%in%</span> <span class="fu">unique</span>(data_filtered<span class="sc">$</span>Survey_Year[<span class="sc">!</span><span class="fu">is.na</span>(data_filtered<span class="sc">$</span>response)]))) {</span>
<span id="cb29-133"><a href="#cb29-133" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb29-134"><a href="#cb29-134" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb29-135"><a href="#cb29-135" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-136"><a href="#cb29-136" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Continue with data that doesn't have NA responses</span></span>
<span id="cb29-137"><a href="#cb29-137" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(response))</span>
<span id="cb29-138"><a href="#cb29-138" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-139"><a href="#cb29-139" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create survey design object including the response variable</span></span>
<span id="cb29-140"><a href="#cb29-140" aria-hidden="true" tabindex="-1"></a>    survey_design <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="sc">~</span>Primary_Samp_Unit,</span>
<span id="cb29-141"><a href="#cb29-141" aria-hidden="true" tabindex="-1"></a>                               <span class="at">strata =</span> <span class="sc">~</span>Stratum,</span>
<span id="cb29-142"><a href="#cb29-142" aria-hidden="true" tabindex="-1"></a>                               <span class="at">weights =</span> <span class="sc">~</span>Final_Weight,</span>
<span id="cb29-143"><a href="#cb29-143" aria-hidden="true" tabindex="-1"></a>                               <span class="at">data =</span> data_filtered,</span>
<span id="cb29-144"><a href="#cb29-144" aria-hidden="true" tabindex="-1"></a>                               <span class="at">nest =</span> <span class="cn">TRUE</span>) </span>
<span id="cb29-145"><a href="#cb29-145" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-146"><a href="#cb29-146" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Perform Welch's t-test using the survey design object</span></span>
<span id="cb29-147"><a href="#cb29-147" aria-hidden="true" tabindex="-1"></a>    ttest_result <span class="ot">&lt;-</span> <span class="fu">svyttest</span>(response <span class="sc">~</span> <span class="fu">as.factor</span>(Survey_Year), survey_design)</span>
<span id="cb29-148"><a href="#cb29-148" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-149"><a href="#cb29-149" aria-hidden="true" tabindex="-1"></a>    <span class="co"># head t-test results</span></span>
<span id="cb29-150"><a href="#cb29-150" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(ttest_result)</span>
<span id="cb29-151"><a href="#cb29-151" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-152"><a href="#cb29-152" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check significance and interpret the results</span></span>
<span id="cb29-153"><a href="#cb29-153" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(ttest_result<span class="sc">$</span>p.value) <span class="sc">&amp;&amp;</span> ttest_result<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>) {</span>
<span id="cb29-154"><a href="#cb29-154" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(ttest_result<span class="sc">$</span>estimate <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Significant Increase"</span>, <span class="st">"Significant Decrease"</span>)</span>
<span id="cb29-155"><a href="#cb29-155" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb29-156"><a href="#cb29-156" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="st">"No Change"</span></span>
<span id="cb29-157"><a href="#cb29-157" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb29-158"><a href="#cb29-158" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-159"><a href="#cb29-159" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> trend))</span>
<span id="cb29-160"><a href="#cb29-160" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-161"><a href="#cb29-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-162"><a href="#cb29-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-163"><a href="#cb29-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-164"><a href="#cb29-164" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the short-term function to each ROI_Indicator_Code</span></span>
<span id="cb29-165"><a href="#cb29-165" aria-hidden="true" tabindex="-1"></a>short_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(raw_stwd_general)[<span class="fu">grep</span>(<span class="st">"^(QN|V).*[RP]"</span>, <span class="fu">names</span>(raw_stwd_general))], <span class="cf">function</span>(column_name) {</span>
<span id="cb29-166"><a href="#cb29-166" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_short_term_trend_ttest</span>(raw_stwd_general, column_name)</span>
<span id="cb29-167"><a href="#cb29-167" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb29-168"><a href="#cb29-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-169"><a href="#cb29-169" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(short_trend_results)</span>
<span id="cb29-170"><a href="#cb29-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-171"><a href="#cb29-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-172"><a href="#cb29-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-173"><a href="#cb29-173" aria-hidden="true" tabindex="-1"></a><span class="do">################### Join Together with Trend Tables ############</span></span>
<span id="cb29-174"><a href="#cb29-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-175"><a href="#cb29-175" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine long-term and short-term results</span></span>
<span id="cb29-176"><a href="#cb29-176" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> <span class="fu">left_join</span>(long_trend_results, </span>
<span id="cb29-177"><a href="#cb29-177" aria-hidden="true" tabindex="-1"></a>                                    short_trend_results, </span>
<span id="cb29-178"><a href="#cb29-178" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">by =</span> <span class="st">"ROI_Indicator_Code"</span>)</span>
<span id="cb29-179"><a href="#cb29-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-180"><a href="#cb29-180" aria-hidden="true" tabindex="-1"></a><span class="co">#head(combined_trend_results)</span></span>
<span id="cb29-181"><a href="#cb29-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-182"><a href="#cb29-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-183"><a href="#cb29-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-184"><a href="#cb29-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-185"><a href="#cb29-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-186"><a href="#cb29-186" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge Long_Term_Trend into yrbs_master_stwd_grade based on matching ROI_Indicator_Code and Trend_Category</span></span>
<span id="cb29-187"><a href="#cb29-187" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> yrbs_master_analysis_stwd_trend <span class="sc">%&gt;%</span></span>
<span id="cb29-188"><a href="#cb29-188" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(combined_trend_results <span class="sc">%&gt;%</span> <span class="fu">select</span>(ROI_Indicator_Code, Long_Term_Trend, Short_Term_Trend),</span>
<span id="cb29-189"><a href="#cb29-189" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ROI_Indicator_Code"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb29-190"><a href="#cb29-190" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(School_Type,</span>
<span id="cb29-191"><a href="#cb29-191" aria-hidden="true" tabindex="-1"></a>         Health_Topic, </span>
<span id="cb29-192"><a href="#cb29-192" aria-hidden="true" tabindex="-1"></a>         ROI_Indicator_Code, </span>
<span id="cb29-193"><a href="#cb29-193" aria-hidden="true" tabindex="-1"></a>         Indicator_Long_Description, </span>
<span id="cb29-194"><a href="#cb29-194" aria-hidden="true" tabindex="-1"></a>         Trend_Category, </span>
<span id="cb29-195"><a href="#cb29-195" aria-hidden="true" tabindex="-1"></a>         <span class="fu">everything</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb29-196"><a href="#cb29-196" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, </span>
<span id="cb29-197"><a href="#cb29-197" aria-hidden="true" tabindex="-1"></a>          ROI_Indicator_Code, </span>
<span id="cb29-198"><a href="#cb29-198" aria-hidden="true" tabindex="-1"></a>          Trend_Category)</span>
<span id="cb29-199"><a href="#cb29-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-200"><a href="#cb29-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-201"><a href="#cb29-201" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to check for three consecutive NAs in a set of columns</span></span>
<span id="cb29-202"><a href="#cb29-202" aria-hidden="true" tabindex="-1"></a>check_consecutive_nas <span class="ot">&lt;-</span> <span class="cf">function</span>(year_values) {</span>
<span id="cb29-203"><a href="#cb29-203" aria-hidden="true" tabindex="-1"></a>  na_run_lengths <span class="ot">&lt;-</span> <span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>lengths[<span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>values]</span>
<span id="cb29-204"><a href="#cb29-204" aria-hidden="true" tabindex="-1"></a>  <span class="fu">any</span>(na_run_lengths <span class="sc">&gt;=</span> <span class="dv">3</span>)</span>
<span id="cb29-205"><a href="#cb29-205" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-206"><a href="#cb29-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-207"><a href="#cb29-207" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert all columns representing years to numeric</span></span>
<span id="cb29-208"><a href="#cb29-208" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb29-209"><a href="#cb29-209" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">d+$"</span>), as.numeric))</span>
<span id="cb29-210"><a href="#cb29-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-211"><a href="#cb29-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-212"><a href="#cb29-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-213"><a href="#cb29-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-214"><a href="#cb29-214" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge and mutate Long_Term_Trend</span></span>
<span id="cb29-215"><a href="#cb29-215" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb29-216"><a href="#cb29-216" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb29-217"><a href="#cb29-217" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Long_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">check_consecutive_nas</span>(<span class="fu">c_across</span>(<span class="st">`</span><span class="at">2011</span><span class="st">`</span><span class="sc">:</span><span class="st">`</span><span class="at">2023</span><span class="st">`</span>)), </span>
<span id="cb29-218"><a href="#cb29-218" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb29-219"><a href="#cb29-219" aria-hidden="true" tabindex="-1"></a>                                  Long_Term_Trend),</span>
<span id="cb29-220"><a href="#cb29-220" aria-hidden="true" tabindex="-1"></a>         <span class="at">Short_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(<span class="st">`</span><span class="at">2019</span><span class="st">`</span>) <span class="sc">|</span> <span class="fu">is.na</span>(<span class="st">`</span><span class="at">2023</span><span class="st">`</span>), </span>
<span id="cb29-221"><a href="#cb29-221" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb29-222"><a href="#cb29-222" aria-hidden="true" tabindex="-1"></a>                                   Short_Term_Trend)) <span class="sc">%&gt;%</span></span>
<span id="cb29-223"><a href="#cb29-223" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb29-224"><a href="#cb29-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-225"><a href="#cb29-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-226"><a href="#cb29-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-227"><a href="#cb29-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-228"><a href="#cb29-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-229"><a href="#cb29-229" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results)</span>
<span id="cb29-230"><a href="#cb29-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-231"><a href="#cb29-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-232"><a href="#cb29-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-233"><a href="#cb29-233" aria-hidden="true" tabindex="-1"></a>trend_results_race_8_white <span class="ot">&lt;-</span> trend_results</span>
<span id="cb29-234"><a href="#cb29-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-235"><a href="#cb29-235" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results_race_8_white)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="trend-by-race_anai" class="level3">
<h3 class="anchored" data-anchor-id="trend-by-race_anai">Trend By Race_ANAI</h3>
<section id="anai.1---alaska-nativeamerican-indian" class="level4">
<h4 class="anchored" data-anchor-id="anai.1---alaska-nativeamerican-indian">ANAI.1 - Alaska Native/American Indian</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="do">######## Import Raw and Analyzed Excel Files ###############</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>yrbs_master_analysis_stwd_trend <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Race_ANAI Trend"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Trend_Category <span class="sc">==</span> <span class="st">"Alaska Native/American Indian"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="st">"Suppressed"</span>, <span class="cn">NA</span>, .)))</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the raw data set to be used in trend analyis</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>raw_stwd_general <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"raw_yrbs_allyears_statewide_trad_cleaned.xlsx"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Race_ANAI <span class="sc">==</span> <span class="st">"Alaska Native/American Indian"</span>,</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>         Survey_Year <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2011</span>,</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2013</span>, </span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2015</span>, </span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2017</span>,</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2019</span>, </span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2023</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>                            )) <span class="sc">%&gt;%</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">2</span>, <span class="dv">0</span>, <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="cn">NA</span>))))</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine which survey questions (ROI - Response of Interest) have data across at least two distinct survey years</span></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>roi_years <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), Survey_Year) <span class="sc">%&gt;%</span></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>Survey_Year, </span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"ROI_Indicator_Code"</span>, </span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ROI_Indicator_Code) <span class="sc">%&gt;%</span></span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">unique_years =</span> <span class="fu">n_distinct</span>(Survey_Year), </span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(unique_years <span class="sc">&gt;=</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(ROI_Indicator_Code)</span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the main data set to include only those ROIs, also ensuring to keep necessary demographic variables</span></span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>filtered_raw_stwd_general <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Survey_Year, <span class="fu">all_of</span>(roi_years), Sex, Grade, Primary_Samp_Unit,Stratum,Final_Weight)</span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a><span class="do">############ Long Term Trend ###############</span></span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a><span class="co">#Trend Analysis Function</span></span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a>analyze_trend_logistic <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Survey Design for YRBS Statewide</span></span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_survey_design</span>(<span class="at">ids =</span> Primary_Samp_Unit,</span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a>                     <span class="at">strata =</span> Stratum,</span>
<span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a>                     <span class="at">weights =</span> Final_Weight,</span>
<span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb30-52"><a href="#cb30-52" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-53"><a href="#cb30-53" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span></span>
<span id="cb30-54"><a href="#cb30-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Sex =</span> <span class="fu">factor</span>(Sex), <span class="at">Grade =</span> <span class="fu">factor</span>(Grade))</span>
<span id="cb30-55"><a href="#cb30-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-56"><a href="#cb30-56" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(data_filtered) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">length</span>(<span class="fu">unique</span>(data_filtered<span class="sc">$</span>variables<span class="sc">$</span>Survey_Year)) <span class="sc">&lt;</span> <span class="dv">4</span>) {</span>
<span id="cb30-57"><a href="#cb30-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb30-58"><a href="#cb30-58" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb30-59"><a href="#cb30-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-60"><a href="#cb30-60" aria-hidden="true" tabindex="-1"></a>  base_formula <span class="ot">&lt;-</span> <span class="fu">paste</span>(column_name, <span class="st">"~ Sex + Grade + Survey_Year"</span>) </span>
<span id="cb30-61"><a href="#cb30-61" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit the model using logistic regression</span></span>
<span id="cb30-62"><a href="#cb30-62" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb30-63"><a href="#cb30-63" aria-hidden="true" tabindex="-1"></a>    <span class="fu">svyglm</span>(<span class="fu">as.formula</span>(base_formula), <span class="at">design =</span> data_filtered, <span class="at">family =</span> <span class="fu">quasibinomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb30-64"><a href="#cb30-64" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb30-65"><a href="#cb30-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Error fitting model: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb30-66"><a href="#cb30-66" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb30-67"><a href="#cb30-67" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb30-68"><a href="#cb30-68" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-69"><a href="#cb30-69" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if model fitting was successful</span></span>
<span id="cb30-70"><a href="#cb30-70" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(model)) {</span>
<span id="cb30-71"><a href="#cb30-71" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error"</span>))</span>
<span id="cb30-72"><a href="#cb30-72" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb30-73"><a href="#cb30-73" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-74"><a href="#cb30-74" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check for coefficients</span></span>
<span id="cb30-75"><a href="#cb30-75" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>(<span class="st">"Survey_Year"</span> <span class="sc">%in%</span> <span class="fu">names</span>(<span class="fu">coef</span>(model)))) {</span>
<span id="cb30-76"><a href="#cb30-76" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No valid coefficient for Survey_Year"</span>))</span>
<span id="cb30-77"><a href="#cb30-77" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb30-78"><a href="#cb30-78" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-79"><a href="#cb30-79" aria-hidden="true" tabindex="-1"></a>  coef_summary <span class="ot">=</span> <span class="fu">summary</span>(model)<span class="sc">$</span>coefficients</span>
<span id="cb30-80"><a href="#cb30-80" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(coef_summary) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb30-81"><a href="#cb30-81" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error: No coefficients"</span>))</span>
<span id="cb30-82"><a href="#cb30-82" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb30-83"><a href="#cb30-83" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-84"><a href="#cb30-84" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Determine the significance and direction of the trend</span></span>
<span id="cb30-85"><a href="#cb30-85" aria-hidden="true" tabindex="-1"></a>  p_value <span class="ot">=</span> coef_summary[<span class="st">"Survey_Year"</span>, <span class="st">"Pr(&gt;|t|)"</span>]</span>
<span id="cb30-86"><a href="#cb30-86" aria-hidden="true" tabindex="-1"></a>  coefficient <span class="ot">=</span> <span class="fu">coef</span>(model)[<span class="st">"Survey_Year"</span>]</span>
<span id="cb30-87"><a href="#cb30-87" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-88"><a href="#cb30-88" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(p_value)) {</span>
<span id="cb30-89"><a href="#cb30-89" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"P-value is NA"</span>))</span>
<span id="cb30-90"><a href="#cb30-90" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb30-91"><a href="#cb30-91" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-92"><a href="#cb30-92" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (p_value <span class="sc">&lt;=</span> <span class="fl">0.05</span>) {</span>
<span id="cb30-93"><a href="#cb30-93" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (coefficient <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb30-94"><a href="#cb30-94" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Increase"</span>))</span>
<span id="cb30-95"><a href="#cb30-95" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb30-96"><a href="#cb30-96" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Decrease"</span>))</span>
<span id="cb30-97"><a href="#cb30-97" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb30-98"><a href="#cb30-98" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb30-99"><a href="#cb30-99" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No Change"</span>))</span>
<span id="cb30-100"><a href="#cb30-100" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb30-101"><a href="#cb30-101" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb30-102"><a href="#cb30-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-103"><a href="#cb30-103" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the function to each ROI_Indicator_Code that has sufficient data</span></span>
<span id="cb30-104"><a href="#cb30-104" aria-hidden="true" tabindex="-1"></a>long_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(filtered_raw_stwd_general)[<span class="sc">-</span><span class="dv">1</span>], <span class="cf">function</span>(column_name) {</span>
<span id="cb30-105"><a href="#cb30-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_trend_logistic</span>(filtered_raw_stwd_general, column_name)</span>
<span id="cb30-106"><a href="#cb30-106" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb30-107"><a href="#cb30-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-108"><a href="#cb30-108" aria-hidden="true" tabindex="-1"></a><span class="co"># Show results</span></span>
<span id="cb30-109"><a href="#cb30-109" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(long_trend_results)</span>
<span id="cb30-110"><a href="#cb30-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-111"><a href="#cb30-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-112"><a href="#cb30-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-113"><a href="#cb30-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-114"><a href="#cb30-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-115"><a href="#cb30-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-116"><a href="#cb30-116" aria-hidden="true" tabindex="-1"></a><span class="do">######### Short Term Trend ###############</span></span>
<span id="cb30-117"><a href="#cb30-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-118"><a href="#cb30-118" aria-hidden="true" tabindex="-1"></a>analyze_short_term_trend_ttest <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb30-119"><a href="#cb30-119" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the short-term years</span></span>
<span id="cb30-120"><a href="#cb30-120" aria-hidden="true" tabindex="-1"></a>    short_term_years <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2019</span>, <span class="dv">2023</span>)</span>
<span id="cb30-121"><a href="#cb30-121" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-122"><a href="#cb30-122" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter for short-term years and ensure all necessary variables are selected</span></span>
<span id="cb30-123"><a href="#cb30-123" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb30-124"><a href="#cb30-124" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(Survey_Year <span class="sc">%in%</span> short_term_years) <span class="sc">%&gt;%</span></span>
<span id="cb30-125"><a href="#cb30-125" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(Primary_Samp_Unit, Stratum, Final_Weight, Survey_Year, <span class="fu">all_of</span>(column_name)) <span class="sc">%&gt;%</span></span>
<span id="cb30-126"><a href="#cb30-126" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">response =</span> <span class="fu">get</span>(column_name) <span class="sc">==</span> <span class="dv">1</span>)  <span class="co"># Create a binary response variable for the analysis</span></span>
<span id="cb30-127"><a href="#cb30-127" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-128"><a href="#cb30-128" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if data is available for both years</span></span>
<span id="cb30-129"><a href="#cb30-129" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(short_term_years <span class="sc">%in%</span> <span class="fu">unique</span>(data_filtered<span class="sc">$</span>Survey_Year[<span class="sc">!</span><span class="fu">is.na</span>(data_filtered<span class="sc">$</span>response)]))) {</span>
<span id="cb30-130"><a href="#cb30-130" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb30-131"><a href="#cb30-131" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb30-132"><a href="#cb30-132" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-133"><a href="#cb30-133" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Continue with data that doesn't have NA responses</span></span>
<span id="cb30-134"><a href="#cb30-134" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(response))</span>
<span id="cb30-135"><a href="#cb30-135" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-136"><a href="#cb30-136" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create survey design object including the response variable</span></span>
<span id="cb30-137"><a href="#cb30-137" aria-hidden="true" tabindex="-1"></a>    survey_design <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="sc">~</span>Primary_Samp_Unit,</span>
<span id="cb30-138"><a href="#cb30-138" aria-hidden="true" tabindex="-1"></a>                               <span class="at">strata =</span> <span class="sc">~</span>Stratum,</span>
<span id="cb30-139"><a href="#cb30-139" aria-hidden="true" tabindex="-1"></a>                               <span class="at">weights =</span> <span class="sc">~</span>Final_Weight,</span>
<span id="cb30-140"><a href="#cb30-140" aria-hidden="true" tabindex="-1"></a>                               <span class="at">data =</span> data_filtered,</span>
<span id="cb30-141"><a href="#cb30-141" aria-hidden="true" tabindex="-1"></a>                               <span class="at">nest =</span> <span class="cn">TRUE</span>) </span>
<span id="cb30-142"><a href="#cb30-142" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-143"><a href="#cb30-143" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Perform Welch's t-test using the survey design object</span></span>
<span id="cb30-144"><a href="#cb30-144" aria-hidden="true" tabindex="-1"></a>    ttest_result <span class="ot">&lt;-</span> <span class="fu">svyttest</span>(response <span class="sc">~</span> <span class="fu">as.factor</span>(Survey_Year), survey_design)</span>
<span id="cb30-145"><a href="#cb30-145" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-146"><a href="#cb30-146" aria-hidden="true" tabindex="-1"></a>    <span class="co"># head t-test results</span></span>
<span id="cb30-147"><a href="#cb30-147" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(ttest_result)</span>
<span id="cb30-148"><a href="#cb30-148" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-149"><a href="#cb30-149" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check significance and interpret the results</span></span>
<span id="cb30-150"><a href="#cb30-150" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(ttest_result<span class="sc">$</span>p.value) <span class="sc">&amp;&amp;</span> ttest_result<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>) {</span>
<span id="cb30-151"><a href="#cb30-151" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(ttest_result<span class="sc">$</span>estimate <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Significant Increase"</span>, <span class="st">"Significant Decrease"</span>)</span>
<span id="cb30-152"><a href="#cb30-152" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb30-153"><a href="#cb30-153" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="st">"No Change"</span></span>
<span id="cb30-154"><a href="#cb30-154" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb30-155"><a href="#cb30-155" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-156"><a href="#cb30-156" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> trend))</span>
<span id="cb30-157"><a href="#cb30-157" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb30-158"><a href="#cb30-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-159"><a href="#cb30-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-160"><a href="#cb30-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-161"><a href="#cb30-161" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the short-term function to each ROI_Indicator_Code</span></span>
<span id="cb30-162"><a href="#cb30-162" aria-hidden="true" tabindex="-1"></a>short_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(raw_stwd_general)[<span class="fu">grep</span>(<span class="st">"^(QN|V).*[RP]"</span>, <span class="fu">names</span>(raw_stwd_general))], <span class="cf">function</span>(column_name) {</span>
<span id="cb30-163"><a href="#cb30-163" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_short_term_trend_ttest</span>(raw_stwd_general, column_name)</span>
<span id="cb30-164"><a href="#cb30-164" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb30-165"><a href="#cb30-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-166"><a href="#cb30-166" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(short_trend_results)</span>
<span id="cb30-167"><a href="#cb30-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-168"><a href="#cb30-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-169"><a href="#cb30-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-170"><a href="#cb30-170" aria-hidden="true" tabindex="-1"></a><span class="do">################### Join Together with Trend Tables ############</span></span>
<span id="cb30-171"><a href="#cb30-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-172"><a href="#cb30-172" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine long-term and short-term results</span></span>
<span id="cb30-173"><a href="#cb30-173" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> <span class="fu">left_join</span>(long_trend_results, </span>
<span id="cb30-174"><a href="#cb30-174" aria-hidden="true" tabindex="-1"></a>                                    short_trend_results, </span>
<span id="cb30-175"><a href="#cb30-175" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">by =</span> <span class="st">"ROI_Indicator_Code"</span>)</span>
<span id="cb30-176"><a href="#cb30-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-177"><a href="#cb30-177" aria-hidden="true" tabindex="-1"></a><span class="co">#head(combined_trend_results)</span></span>
<span id="cb30-178"><a href="#cb30-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-179"><a href="#cb30-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-180"><a href="#cb30-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-181"><a href="#cb30-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-182"><a href="#cb30-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-183"><a href="#cb30-183" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge Long_Term_Trend into yrbs_master_stwd_grade based on matching ROI_Indicator_Code and Trend_Category</span></span>
<span id="cb30-184"><a href="#cb30-184" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> yrbs_master_analysis_stwd_trend <span class="sc">%&gt;%</span></span>
<span id="cb30-185"><a href="#cb30-185" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(combined_trend_results <span class="sc">%&gt;%</span> <span class="fu">select</span>(ROI_Indicator_Code, Long_Term_Trend, Short_Term_Trend),</span>
<span id="cb30-186"><a href="#cb30-186" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ROI_Indicator_Code"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb30-187"><a href="#cb30-187" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(School_Type,</span>
<span id="cb30-188"><a href="#cb30-188" aria-hidden="true" tabindex="-1"></a>         Health_Topic, </span>
<span id="cb30-189"><a href="#cb30-189" aria-hidden="true" tabindex="-1"></a>         ROI_Indicator_Code, </span>
<span id="cb30-190"><a href="#cb30-190" aria-hidden="true" tabindex="-1"></a>         Indicator_Long_Description, </span>
<span id="cb30-191"><a href="#cb30-191" aria-hidden="true" tabindex="-1"></a>         Trend_Category, </span>
<span id="cb30-192"><a href="#cb30-192" aria-hidden="true" tabindex="-1"></a>         <span class="fu">everything</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb30-193"><a href="#cb30-193" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, </span>
<span id="cb30-194"><a href="#cb30-194" aria-hidden="true" tabindex="-1"></a>          ROI_Indicator_Code, </span>
<span id="cb30-195"><a href="#cb30-195" aria-hidden="true" tabindex="-1"></a>          Trend_Category)</span>
<span id="cb30-196"><a href="#cb30-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-197"><a href="#cb30-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-198"><a href="#cb30-198" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to check for three consecutive NAs in a set of columns</span></span>
<span id="cb30-199"><a href="#cb30-199" aria-hidden="true" tabindex="-1"></a>check_consecutive_nas <span class="ot">&lt;-</span> <span class="cf">function</span>(year_values) {</span>
<span id="cb30-200"><a href="#cb30-200" aria-hidden="true" tabindex="-1"></a>  na_run_lengths <span class="ot">&lt;-</span> <span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>lengths[<span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>values]</span>
<span id="cb30-201"><a href="#cb30-201" aria-hidden="true" tabindex="-1"></a>  <span class="fu">any</span>(na_run_lengths <span class="sc">&gt;=</span> <span class="dv">3</span>)</span>
<span id="cb30-202"><a href="#cb30-202" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb30-203"><a href="#cb30-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-204"><a href="#cb30-204" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert all columns representing years to numeric</span></span>
<span id="cb30-205"><a href="#cb30-205" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb30-206"><a href="#cb30-206" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">d+$"</span>), as.numeric))</span>
<span id="cb30-207"><a href="#cb30-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-208"><a href="#cb30-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-209"><a href="#cb30-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-210"><a href="#cb30-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-211"><a href="#cb30-211" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge and mutate Long_Term_Trend</span></span>
<span id="cb30-212"><a href="#cb30-212" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb30-213"><a href="#cb30-213" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb30-214"><a href="#cb30-214" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Long_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">check_consecutive_nas</span>(<span class="fu">c_across</span>(<span class="st">`</span><span class="at">2011</span><span class="st">`</span><span class="sc">:</span><span class="st">`</span><span class="at">2023</span><span class="st">`</span>)), </span>
<span id="cb30-215"><a href="#cb30-215" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb30-216"><a href="#cb30-216" aria-hidden="true" tabindex="-1"></a>                                  Long_Term_Trend),</span>
<span id="cb30-217"><a href="#cb30-217" aria-hidden="true" tabindex="-1"></a>         <span class="at">Short_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(<span class="st">`</span><span class="at">2019</span><span class="st">`</span>) <span class="sc">|</span> <span class="fu">is.na</span>(<span class="st">`</span><span class="at">2023</span><span class="st">`</span>), </span>
<span id="cb30-218"><a href="#cb30-218" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb30-219"><a href="#cb30-219" aria-hidden="true" tabindex="-1"></a>                                   Short_Term_Trend)) <span class="sc">%&gt;%</span></span>
<span id="cb30-220"><a href="#cb30-220" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb30-221"><a href="#cb30-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-222"><a href="#cb30-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-223"><a href="#cb30-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-224"><a href="#cb30-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-225"><a href="#cb30-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-226"><a href="#cb30-226" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results)</span>
<span id="cb30-227"><a href="#cb30-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-228"><a href="#cb30-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-229"><a href="#cb30-229" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb30-230"><a href="#cb30-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-231"><a href="#cb30-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-232"><a href="#cb30-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-233"><a href="#cb30-233" aria-hidden="true" tabindex="-1"></a>trend_results_race_ANAI <span class="ot">&lt;-</span> trend_results</span>
<span id="cb30-234"><a href="#cb30-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-235"><a href="#cb30-235" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results_race_ANAI)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="anai.2---non-anai" class="level4">
<h4 class="anchored" data-anchor-id="anai.2---non-anai">ANAI.2 - Non AN/AI</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="do">######## Import Raw and Analyzed Excel Files ###############</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>yrbs_master_analysis_stwd_trend <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Race_ANAI Trend"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Trend_Category <span class="sc">==</span> <span class="st">"Non AN/AI"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="st">"Suppressed"</span>, <span class="cn">NA</span>, .)))</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the raw data set to be used in trend analyis</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>raw_stwd_general <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"raw_yrbs_allyears_statewide_trad_cleaned.xlsx"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Race_ANAI <span class="sc">==</span> <span class="st">"Non AN/AI"</span>,</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>         Survey_Year <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2011</span>,</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2013</span>, </span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2015</span>, </span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2017</span>,</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2019</span>, </span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2023</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>                            )) <span class="sc">%&gt;%</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">2</span>, <span class="dv">0</span>, <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="cn">NA</span>))))</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove whitespcae</span></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>remove_whitespace_from_all_columns <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>  df[] <span class="ot">&lt;-</span> <span class="fu">lapply</span>(df, <span class="cf">function</span>(x) {</span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.character</span>(x)) {</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">trimws</span>(x, <span class="at">which =</span> <span class="st">"both"</span>))</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(x)</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df)</span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the function to your dataframe</span></span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a>raw_stwd_general <span class="ot">&lt;-</span> <span class="fu">remove_whitespace_from_all_columns</span>(raw_stwd_general)</span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a>yrbs_master_analysis_stwd_trend <span class="ot">&lt;-</span> <span class="fu">remove_whitespace_from_all_columns</span>(yrbs_master_analysis_stwd_trend)</span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a><span class="co">#head(yrbs_master_analysis_stwd_trend)</span></span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a><span class="co">#head(raw_stwd_general)</span></span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine which survey questions (ROI - Response of Interest) have data across at least two distinct survey years</span></span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a>roi_years <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), Survey_Year) <span class="sc">%&gt;%</span></span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>Survey_Year, </span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"ROI_Indicator_Code"</span>, </span>
<span id="cb31-50"><a href="#cb31-50" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-51"><a href="#cb31-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ROI_Indicator_Code) <span class="sc">%&gt;%</span></span>
<span id="cb31-52"><a href="#cb31-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">unique_years =</span> <span class="fu">n_distinct</span>(Survey_Year), </span>
<span id="cb31-53"><a href="#cb31-53" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-54"><a href="#cb31-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(unique_years <span class="sc">&gt;=</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-55"><a href="#cb31-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(ROI_Indicator_Code)</span>
<span id="cb31-56"><a href="#cb31-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-57"><a href="#cb31-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the main data set to include only those ROIs, also ensuring to keep necessary demographic variables</span></span>
<span id="cb31-58"><a href="#cb31-58" aria-hidden="true" tabindex="-1"></a>filtered_raw_stwd_general <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb31-59"><a href="#cb31-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Survey_Year, <span class="fu">all_of</span>(roi_years), Sex, Grade, Primary_Samp_Unit,Stratum,Final_Weight)</span>
<span id="cb31-60"><a href="#cb31-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-61"><a href="#cb31-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-62"><a href="#cb31-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-63"><a href="#cb31-63" aria-hidden="true" tabindex="-1"></a><span class="do">############ Long Term Trend ###############</span></span>
<span id="cb31-64"><a href="#cb31-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-65"><a href="#cb31-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-66"><a href="#cb31-66" aria-hidden="true" tabindex="-1"></a><span class="co">#Trend Analysis Function</span></span>
<span id="cb31-67"><a href="#cb31-67" aria-hidden="true" tabindex="-1"></a>analyze_trend_logistic <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb31-68"><a href="#cb31-68" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb31-69"><a href="#cb31-69" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Survey Design for YRBS Statewide</span></span>
<span id="cb31-70"><a href="#cb31-70" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_survey_design</span>(<span class="at">ids =</span> Primary_Samp_Unit,</span>
<span id="cb31-71"><a href="#cb31-71" aria-hidden="true" tabindex="-1"></a>                     <span class="at">strata =</span> Stratum,</span>
<span id="cb31-72"><a href="#cb31-72" aria-hidden="true" tabindex="-1"></a>                     <span class="at">weights =</span> Final_Weight,</span>
<span id="cb31-73"><a href="#cb31-73" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-74"><a href="#cb31-74" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-75"><a href="#cb31-75" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span></span>
<span id="cb31-76"><a href="#cb31-76" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Sex =</span> <span class="fu">factor</span>(Sex), <span class="at">Grade =</span> <span class="fu">factor</span>(Grade))</span>
<span id="cb31-77"><a href="#cb31-77" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-78"><a href="#cb31-78" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(data_filtered) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">length</span>(<span class="fu">unique</span>(data_filtered<span class="sc">$</span>variables<span class="sc">$</span>Survey_Year)) <span class="sc">&lt;</span> <span class="dv">4</span>) {</span>
<span id="cb31-79"><a href="#cb31-79" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb31-80"><a href="#cb31-80" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-81"><a href="#cb31-81" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-82"><a href="#cb31-82" aria-hidden="true" tabindex="-1"></a>  base_formula <span class="ot">&lt;-</span> <span class="fu">paste</span>(column_name, <span class="st">"~ Sex + Grade + Survey_Year"</span>) </span>
<span id="cb31-83"><a href="#cb31-83" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit the model using logistic regression</span></span>
<span id="cb31-84"><a href="#cb31-84" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb31-85"><a href="#cb31-85" aria-hidden="true" tabindex="-1"></a>    <span class="fu">svyglm</span>(<span class="fu">as.formula</span>(base_formula), <span class="at">design =</span> data_filtered, <span class="at">family =</span> <span class="fu">quasibinomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb31-86"><a href="#cb31-86" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb31-87"><a href="#cb31-87" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Error fitting model: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb31-88"><a href="#cb31-88" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb31-89"><a href="#cb31-89" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb31-90"><a href="#cb31-90" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-91"><a href="#cb31-91" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if model fitting was successful</span></span>
<span id="cb31-92"><a href="#cb31-92" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(model)) {</span>
<span id="cb31-93"><a href="#cb31-93" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error"</span>))</span>
<span id="cb31-94"><a href="#cb31-94" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-95"><a href="#cb31-95" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-96"><a href="#cb31-96" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check for coefficients</span></span>
<span id="cb31-97"><a href="#cb31-97" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>(<span class="st">"Survey_Year"</span> <span class="sc">%in%</span> <span class="fu">names</span>(<span class="fu">coef</span>(model)))) {</span>
<span id="cb31-98"><a href="#cb31-98" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No valid coefficient for Survey_Year"</span>))</span>
<span id="cb31-99"><a href="#cb31-99" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-100"><a href="#cb31-100" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-101"><a href="#cb31-101" aria-hidden="true" tabindex="-1"></a>  coef_summary <span class="ot">=</span> <span class="fu">summary</span>(model)<span class="sc">$</span>coefficients</span>
<span id="cb31-102"><a href="#cb31-102" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(coef_summary) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb31-103"><a href="#cb31-103" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error: No coefficients"</span>))</span>
<span id="cb31-104"><a href="#cb31-104" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-105"><a href="#cb31-105" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-106"><a href="#cb31-106" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Determine the significance and direction of the trend</span></span>
<span id="cb31-107"><a href="#cb31-107" aria-hidden="true" tabindex="-1"></a>  p_value <span class="ot">=</span> coef_summary[<span class="st">"Survey_Year"</span>, <span class="st">"Pr(&gt;|t|)"</span>]</span>
<span id="cb31-108"><a href="#cb31-108" aria-hidden="true" tabindex="-1"></a>  coefficient <span class="ot">=</span> <span class="fu">coef</span>(model)[<span class="st">"Survey_Year"</span>]</span>
<span id="cb31-109"><a href="#cb31-109" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-110"><a href="#cb31-110" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(p_value)) {</span>
<span id="cb31-111"><a href="#cb31-111" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"P-value is NA"</span>))</span>
<span id="cb31-112"><a href="#cb31-112" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-113"><a href="#cb31-113" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-114"><a href="#cb31-114" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (p_value <span class="sc">&lt;=</span> <span class="fl">0.05</span>) {</span>
<span id="cb31-115"><a href="#cb31-115" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (coefficient <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb31-116"><a href="#cb31-116" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Increase"</span>))</span>
<span id="cb31-117"><a href="#cb31-117" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb31-118"><a href="#cb31-118" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Decrease"</span>))</span>
<span id="cb31-119"><a href="#cb31-119" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb31-120"><a href="#cb31-120" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb31-121"><a href="#cb31-121" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No Change"</span>))</span>
<span id="cb31-122"><a href="#cb31-122" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-123"><a href="#cb31-123" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-124"><a href="#cb31-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-125"><a href="#cb31-125" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the function to each ROI_Indicator_Code that has sufficient data</span></span>
<span id="cb31-126"><a href="#cb31-126" aria-hidden="true" tabindex="-1"></a>long_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(filtered_raw_stwd_general)[<span class="sc">-</span><span class="dv">1</span>], <span class="cf">function</span>(column_name) {</span>
<span id="cb31-127"><a href="#cb31-127" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_trend_logistic</span>(filtered_raw_stwd_general, column_name)</span>
<span id="cb31-128"><a href="#cb31-128" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb31-129"><a href="#cb31-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-130"><a href="#cb31-130" aria-hidden="true" tabindex="-1"></a><span class="co"># Show results</span></span>
<span id="cb31-131"><a href="#cb31-131" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(long_trend_results)</span>
<span id="cb31-132"><a href="#cb31-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-133"><a href="#cb31-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-134"><a href="#cb31-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-135"><a href="#cb31-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-136"><a href="#cb31-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-137"><a href="#cb31-137" aria-hidden="true" tabindex="-1"></a><span class="do">######### Short Term Trend ###############</span></span>
<span id="cb31-138"><a href="#cb31-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-139"><a href="#cb31-139" aria-hidden="true" tabindex="-1"></a>analyze_short_term_trend_ttest <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb31-140"><a href="#cb31-140" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the short-term years</span></span>
<span id="cb31-141"><a href="#cb31-141" aria-hidden="true" tabindex="-1"></a>    short_term_years <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2019</span>, <span class="dv">2023</span>)</span>
<span id="cb31-142"><a href="#cb31-142" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-143"><a href="#cb31-143" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter for short-term years and ensure all necessary variables are selected</span></span>
<span id="cb31-144"><a href="#cb31-144" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb31-145"><a href="#cb31-145" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(Survey_Year <span class="sc">%in%</span> short_term_years) <span class="sc">%&gt;%</span></span>
<span id="cb31-146"><a href="#cb31-146" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(Primary_Samp_Unit, Stratum, Final_Weight, Survey_Year, <span class="fu">all_of</span>(column_name)) <span class="sc">%&gt;%</span></span>
<span id="cb31-147"><a href="#cb31-147" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">response =</span> <span class="fu">get</span>(column_name) <span class="sc">==</span> <span class="dv">1</span>)  <span class="co"># Create a binary response variable for the analysis</span></span>
<span id="cb31-148"><a href="#cb31-148" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-149"><a href="#cb31-149" aria-hidden="true" tabindex="-1"></a>   <span class="co"># Check if data is available for both years</span></span>
<span id="cb31-150"><a href="#cb31-150" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(short_term_years <span class="sc">%in%</span> <span class="fu">unique</span>(data_filtered<span class="sc">$</span>Survey_Year[<span class="sc">!</span><span class="fu">is.na</span>(data_filtered<span class="sc">$</span>response)]))) {</span>
<span id="cb31-151"><a href="#cb31-151" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb31-152"><a href="#cb31-152" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb31-153"><a href="#cb31-153" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-154"><a href="#cb31-154" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Continue with data that doesn't have NA responses</span></span>
<span id="cb31-155"><a href="#cb31-155" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(response))</span>
<span id="cb31-156"><a href="#cb31-156" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-157"><a href="#cb31-157" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create survey design object including the response variable</span></span>
<span id="cb31-158"><a href="#cb31-158" aria-hidden="true" tabindex="-1"></a>    survey_design <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="sc">~</span>Primary_Samp_Unit,</span>
<span id="cb31-159"><a href="#cb31-159" aria-hidden="true" tabindex="-1"></a>                               <span class="at">strata =</span> <span class="sc">~</span>Stratum,</span>
<span id="cb31-160"><a href="#cb31-160" aria-hidden="true" tabindex="-1"></a>                               <span class="at">weights =</span> <span class="sc">~</span>Final_Weight,</span>
<span id="cb31-161"><a href="#cb31-161" aria-hidden="true" tabindex="-1"></a>                               <span class="at">data =</span> data_filtered,</span>
<span id="cb31-162"><a href="#cb31-162" aria-hidden="true" tabindex="-1"></a>                               <span class="at">nest =</span> <span class="cn">TRUE</span>) </span>
<span id="cb31-163"><a href="#cb31-163" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-164"><a href="#cb31-164" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Perform Welch's t-test using the survey design object</span></span>
<span id="cb31-165"><a href="#cb31-165" aria-hidden="true" tabindex="-1"></a>    ttest_result <span class="ot">&lt;-</span> <span class="fu">svyttest</span>(response <span class="sc">~</span> <span class="fu">as.factor</span>(Survey_Year), survey_design)</span>
<span id="cb31-166"><a href="#cb31-166" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-167"><a href="#cb31-167" aria-hidden="true" tabindex="-1"></a>    <span class="co"># head t-test results</span></span>
<span id="cb31-168"><a href="#cb31-168" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(ttest_result)</span>
<span id="cb31-169"><a href="#cb31-169" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-170"><a href="#cb31-170" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check significance and interpret the results</span></span>
<span id="cb31-171"><a href="#cb31-171" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(ttest_result<span class="sc">$</span>p.value) <span class="sc">&amp;&amp;</span> ttest_result<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>) {</span>
<span id="cb31-172"><a href="#cb31-172" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(ttest_result<span class="sc">$</span>estimate <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Significant Increase"</span>, <span class="st">"Significant Decrease"</span>)</span>
<span id="cb31-173"><a href="#cb31-173" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb31-174"><a href="#cb31-174" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="st">"No Change"</span></span>
<span id="cb31-175"><a href="#cb31-175" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb31-176"><a href="#cb31-176" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-177"><a href="#cb31-177" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> trend))</span>
<span id="cb31-178"><a href="#cb31-178" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-179"><a href="#cb31-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-180"><a href="#cb31-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-181"><a href="#cb31-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-182"><a href="#cb31-182" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the short-term function to each ROI_Indicator_Code</span></span>
<span id="cb31-183"><a href="#cb31-183" aria-hidden="true" tabindex="-1"></a>short_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(raw_stwd_general)[<span class="fu">grep</span>(<span class="st">"^(QN|V).*[RP]"</span>, <span class="fu">names</span>(raw_stwd_general))], <span class="cf">function</span>(column_name) {</span>
<span id="cb31-184"><a href="#cb31-184" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_short_term_trend_ttest</span>(raw_stwd_general, column_name)</span>
<span id="cb31-185"><a href="#cb31-185" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb31-186"><a href="#cb31-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-187"><a href="#cb31-187" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(short_trend_results)</span>
<span id="cb31-188"><a href="#cb31-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-189"><a href="#cb31-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-190"><a href="#cb31-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-191"><a href="#cb31-191" aria-hidden="true" tabindex="-1"></a><span class="do">################### Join Together with Trend Tables ############</span></span>
<span id="cb31-192"><a href="#cb31-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-193"><a href="#cb31-193" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine long-term and short-term results</span></span>
<span id="cb31-194"><a href="#cb31-194" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> <span class="fu">left_join</span>(long_trend_results, </span>
<span id="cb31-195"><a href="#cb31-195" aria-hidden="true" tabindex="-1"></a>                                    short_trend_results, </span>
<span id="cb31-196"><a href="#cb31-196" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">by =</span> <span class="st">"ROI_Indicator_Code"</span>)</span>
<span id="cb31-197"><a href="#cb31-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-198"><a href="#cb31-198" aria-hidden="true" tabindex="-1"></a><span class="co">#head(combined_trend_results)</span></span>
<span id="cb31-199"><a href="#cb31-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-200"><a href="#cb31-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-201"><a href="#cb31-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-202"><a href="#cb31-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-203"><a href="#cb31-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-204"><a href="#cb31-204" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge Long_Term_Trend into yrbs_master_stwd_grade based on matching ROI_Indicator_Code and Trend_Category</span></span>
<span id="cb31-205"><a href="#cb31-205" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> yrbs_master_analysis_stwd_trend <span class="sc">%&gt;%</span></span>
<span id="cb31-206"><a href="#cb31-206" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(combined_trend_results <span class="sc">%&gt;%</span> <span class="fu">select</span>(ROI_Indicator_Code, Long_Term_Trend, Short_Term_Trend),</span>
<span id="cb31-207"><a href="#cb31-207" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ROI_Indicator_Code"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-208"><a href="#cb31-208" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(School_Type,</span>
<span id="cb31-209"><a href="#cb31-209" aria-hidden="true" tabindex="-1"></a>         Health_Topic, </span>
<span id="cb31-210"><a href="#cb31-210" aria-hidden="true" tabindex="-1"></a>         ROI_Indicator_Code, </span>
<span id="cb31-211"><a href="#cb31-211" aria-hidden="true" tabindex="-1"></a>         Indicator_Long_Description, </span>
<span id="cb31-212"><a href="#cb31-212" aria-hidden="true" tabindex="-1"></a>         Trend_Category, </span>
<span id="cb31-213"><a href="#cb31-213" aria-hidden="true" tabindex="-1"></a>         <span class="fu">everything</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb31-214"><a href="#cb31-214" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, </span>
<span id="cb31-215"><a href="#cb31-215" aria-hidden="true" tabindex="-1"></a>          ROI_Indicator_Code, </span>
<span id="cb31-216"><a href="#cb31-216" aria-hidden="true" tabindex="-1"></a>          Trend_Category)</span>
<span id="cb31-217"><a href="#cb31-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-218"><a href="#cb31-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-219"><a href="#cb31-219" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to check for three consecutive NAs in a set of columns</span></span>
<span id="cb31-220"><a href="#cb31-220" aria-hidden="true" tabindex="-1"></a>check_consecutive_nas <span class="ot">&lt;-</span> <span class="cf">function</span>(year_values) {</span>
<span id="cb31-221"><a href="#cb31-221" aria-hidden="true" tabindex="-1"></a>  na_run_lengths <span class="ot">&lt;-</span> <span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>lengths[<span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>values]</span>
<span id="cb31-222"><a href="#cb31-222" aria-hidden="true" tabindex="-1"></a>  <span class="fu">any</span>(na_run_lengths <span class="sc">&gt;=</span> <span class="dv">3</span>)</span>
<span id="cb31-223"><a href="#cb31-223" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-224"><a href="#cb31-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-225"><a href="#cb31-225" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert all columns representing years to numeric</span></span>
<span id="cb31-226"><a href="#cb31-226" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb31-227"><a href="#cb31-227" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">d+$"</span>), as.numeric))</span>
<span id="cb31-228"><a href="#cb31-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-229"><a href="#cb31-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-230"><a href="#cb31-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-231"><a href="#cb31-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-232"><a href="#cb31-232" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge and mutate Long_Term_Trend</span></span>
<span id="cb31-233"><a href="#cb31-233" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb31-234"><a href="#cb31-234" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb31-235"><a href="#cb31-235" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Long_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">check_consecutive_nas</span>(<span class="fu">c_across</span>(<span class="st">`</span><span class="at">2011</span><span class="st">`</span><span class="sc">:</span><span class="st">`</span><span class="at">2023</span><span class="st">`</span>)), </span>
<span id="cb31-236"><a href="#cb31-236" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb31-237"><a href="#cb31-237" aria-hidden="true" tabindex="-1"></a>                                  Long_Term_Trend),</span>
<span id="cb31-238"><a href="#cb31-238" aria-hidden="true" tabindex="-1"></a>          <span class="at">Short_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(<span class="st">`</span><span class="at">2019</span><span class="st">`</span>) <span class="sc">|</span> <span class="fu">is.na</span>(<span class="st">`</span><span class="at">2023</span><span class="st">`</span>),</span>
<span id="cb31-239"><a href="#cb31-239" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"Too few data points for analysis"</span>,</span>
<span id="cb31-240"><a href="#cb31-240" aria-hidden="true" tabindex="-1"></a>                                    Short_Term_Trend)</span>
<span id="cb31-241"><a href="#cb31-241" aria-hidden="true" tabindex="-1"></a>         ) <span class="sc">%&gt;%</span></span>
<span id="cb31-242"><a href="#cb31-242" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb31-243"><a href="#cb31-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-244"><a href="#cb31-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-245"><a href="#cb31-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-246"><a href="#cb31-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-247"><a href="#cb31-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-248"><a href="#cb31-248" aria-hidden="true" tabindex="-1"></a><span class="co">#head(trend_results)</span></span>
<span id="cb31-249"><a href="#cb31-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-250"><a href="#cb31-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-251"><a href="#cb31-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-252"><a href="#cb31-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-253"><a href="#cb31-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-254"><a href="#cb31-254" aria-hidden="true" tabindex="-1"></a>trend_results_race_non_ANAI <span class="ot">&lt;-</span> trend_results</span>
<span id="cb31-255"><a href="#cb31-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-256"><a href="#cb31-256" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results_race_non_ANAI)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="trend-by-race_hisplat" class="level3">
<h3 class="anchored" data-anchor-id="trend-by-race_hisplat">Trend By Race_HispLat</h3>
<section id="hisp.1---hispaniclatino" class="level4">
<h4 class="anchored" data-anchor-id="hisp.1---hispaniclatino">Hisp.1 - Hispanic/Latino</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="do">######## Import Raw and Analyzed Excel Files ###############</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>yrbs_master_analysis_stwd_trend <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Race_HispLat Trend"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Trend_Category <span class="sc">==</span> <span class="st">"Hispanic/Latino"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="st">"Suppressed"</span>, <span class="cn">NA</span>, .)))</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the raw data set to be used in trend analyis</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>raw_stwd_general <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"raw_yrbs_allyears_statewide_trad_cleaned.xlsx"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Race_HispLat <span class="sc">==</span> <span class="st">"Hispanic/Latino"</span>,</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>         Survey_Year <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2011</span>,</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2013</span>, </span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2015</span>, </span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2017</span>,</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2019</span>, </span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2023</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>                            )) <span class="sc">%&gt;%</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">2</span>, <span class="dv">0</span>, <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="cn">NA</span>))))</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine which survey questions (ROI - Response of Interest) have data across at least two distinct survey years</span></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>roi_years <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), Survey_Year) <span class="sc">%&gt;%</span></span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>Survey_Year, </span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"ROI_Indicator_Code"</span>, </span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ROI_Indicator_Code) <span class="sc">%&gt;%</span></span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">unique_years =</span> <span class="fu">n_distinct</span>(Survey_Year), </span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(unique_years <span class="sc">&gt;=</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(ROI_Indicator_Code)</span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the main data set to include only those ROIs, also ensuring to keep necessary demographic variables</span></span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>filtered_raw_stwd_general <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Survey_Year, <span class="fu">all_of</span>(roi_years), Sex, Grade, Primary_Samp_Unit,Stratum,Final_Weight)</span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a><span class="do">############ Long Term Trend ###############</span></span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a><span class="co">#Trend Analysis Function</span></span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a>analyze_trend_logistic <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Survey Design for YRBS Statewide</span></span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_survey_design</span>(<span class="at">ids =</span> Primary_Samp_Unit,</span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a>                     <span class="at">strata =</span> Stratum,</span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a>                     <span class="at">weights =</span> Final_Weight,</span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span></span>
<span id="cb32-56"><a href="#cb32-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Sex =</span> <span class="fu">factor</span>(Sex), <span class="at">Grade =</span> <span class="fu">factor</span>(Grade))</span>
<span id="cb32-57"><a href="#cb32-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-58"><a href="#cb32-58" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(data_filtered) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">length</span>(<span class="fu">unique</span>(data_filtered<span class="sc">$</span>variables<span class="sc">$</span>Survey_Year)) <span class="sc">&lt;</span> <span class="dv">4</span>) {</span>
<span id="cb32-59"><a href="#cb32-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb32-60"><a href="#cb32-60" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-61"><a href="#cb32-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-62"><a href="#cb32-62" aria-hidden="true" tabindex="-1"></a>  base_formula <span class="ot">&lt;-</span> <span class="fu">paste</span>(column_name, <span class="st">"~ Sex + Grade + Survey_Year"</span>) </span>
<span id="cb32-63"><a href="#cb32-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit the model using logistic regression</span></span>
<span id="cb32-64"><a href="#cb32-64" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb32-65"><a href="#cb32-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">svyglm</span>(<span class="fu">as.formula</span>(base_formula), <span class="at">design =</span> data_filtered, <span class="at">family =</span> <span class="fu">quasibinomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb32-66"><a href="#cb32-66" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb32-67"><a href="#cb32-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Error fitting model: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb32-68"><a href="#cb32-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb32-69"><a href="#cb32-69" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb32-70"><a href="#cb32-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-71"><a href="#cb32-71" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if model fitting was successful</span></span>
<span id="cb32-72"><a href="#cb32-72" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(model)) {</span>
<span id="cb32-73"><a href="#cb32-73" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error"</span>))</span>
<span id="cb32-74"><a href="#cb32-74" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-75"><a href="#cb32-75" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-76"><a href="#cb32-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check for coefficients</span></span>
<span id="cb32-77"><a href="#cb32-77" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>(<span class="st">"Survey_Year"</span> <span class="sc">%in%</span> <span class="fu">names</span>(<span class="fu">coef</span>(model)))) {</span>
<span id="cb32-78"><a href="#cb32-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No valid coefficient for Survey_Year"</span>))</span>
<span id="cb32-79"><a href="#cb32-79" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-80"><a href="#cb32-80" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-81"><a href="#cb32-81" aria-hidden="true" tabindex="-1"></a>  coef_summary <span class="ot">=</span> <span class="fu">summary</span>(model)<span class="sc">$</span>coefficients</span>
<span id="cb32-82"><a href="#cb32-82" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(coef_summary) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb32-83"><a href="#cb32-83" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error: No coefficients"</span>))</span>
<span id="cb32-84"><a href="#cb32-84" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-85"><a href="#cb32-85" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-86"><a href="#cb32-86" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Determine the significance and direction of the trend</span></span>
<span id="cb32-87"><a href="#cb32-87" aria-hidden="true" tabindex="-1"></a>  p_value <span class="ot">=</span> coef_summary[<span class="st">"Survey_Year"</span>, <span class="st">"Pr(&gt;|t|)"</span>]</span>
<span id="cb32-88"><a href="#cb32-88" aria-hidden="true" tabindex="-1"></a>  coefficient <span class="ot">=</span> <span class="fu">coef</span>(model)[<span class="st">"Survey_Year"</span>]</span>
<span id="cb32-89"><a href="#cb32-89" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-90"><a href="#cb32-90" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(p_value)) {</span>
<span id="cb32-91"><a href="#cb32-91" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"P-value is NA"</span>))</span>
<span id="cb32-92"><a href="#cb32-92" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-93"><a href="#cb32-93" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb32-94"><a href="#cb32-94" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (p_value <span class="sc">&lt;=</span> <span class="fl">0.05</span>) {</span>
<span id="cb32-95"><a href="#cb32-95" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (coefficient <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb32-96"><a href="#cb32-96" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Increase"</span>))</span>
<span id="cb32-97"><a href="#cb32-97" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb32-98"><a href="#cb32-98" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Decrease"</span>))</span>
<span id="cb32-99"><a href="#cb32-99" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb32-100"><a href="#cb32-100" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb32-101"><a href="#cb32-101" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No Change"</span>))</span>
<span id="cb32-102"><a href="#cb32-102" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-103"><a href="#cb32-103" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-104"><a href="#cb32-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-105"><a href="#cb32-105" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the function to each ROI_Indicator_Code that has sufficient data</span></span>
<span id="cb32-106"><a href="#cb32-106" aria-hidden="true" tabindex="-1"></a>long_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(filtered_raw_stwd_general)[<span class="sc">-</span><span class="dv">1</span>], <span class="cf">function</span>(column_name) {</span>
<span id="cb32-107"><a href="#cb32-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_trend_logistic</span>(filtered_raw_stwd_general, column_name)</span>
<span id="cb32-108"><a href="#cb32-108" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb32-109"><a href="#cb32-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-110"><a href="#cb32-110" aria-hidden="true" tabindex="-1"></a><span class="co"># Show results</span></span>
<span id="cb32-111"><a href="#cb32-111" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(long_trend_results)</span>
<span id="cb32-112"><a href="#cb32-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-113"><a href="#cb32-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-114"><a href="#cb32-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-115"><a href="#cb32-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-116"><a href="#cb32-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-117"><a href="#cb32-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-118"><a href="#cb32-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-119"><a href="#cb32-119" aria-hidden="true" tabindex="-1"></a><span class="do">######### Short Term Trend ###############</span></span>
<span id="cb32-120"><a href="#cb32-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-121"><a href="#cb32-121" aria-hidden="true" tabindex="-1"></a>analyze_short_term_trend_ttest <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb32-122"><a href="#cb32-122" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the short-term years</span></span>
<span id="cb32-123"><a href="#cb32-123" aria-hidden="true" tabindex="-1"></a>    short_term_years <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2019</span>, <span class="dv">2023</span>)</span>
<span id="cb32-124"><a href="#cb32-124" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-125"><a href="#cb32-125" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter for short-term years and ensure all necessary variables are selected</span></span>
<span id="cb32-126"><a href="#cb32-126" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb32-127"><a href="#cb32-127" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(Survey_Year <span class="sc">%in%</span> short_term_years) <span class="sc">%&gt;%</span></span>
<span id="cb32-128"><a href="#cb32-128" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(Primary_Samp_Unit, Stratum, Final_Weight, Survey_Year, <span class="fu">all_of</span>(column_name)) <span class="sc">%&gt;%</span></span>
<span id="cb32-129"><a href="#cb32-129" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">response =</span> <span class="fu">get</span>(column_name) <span class="sc">==</span> <span class="dv">1</span>)  <span class="co"># Create a binary response variable for the analysis</span></span>
<span id="cb32-130"><a href="#cb32-130" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-131"><a href="#cb32-131" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if data is available for both years</span></span>
<span id="cb32-132"><a href="#cb32-132" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(short_term_years <span class="sc">%in%</span> <span class="fu">unique</span>(data_filtered<span class="sc">$</span>Survey_Year[<span class="sc">!</span><span class="fu">is.na</span>(data_filtered<span class="sc">$</span>response)]))) {</span>
<span id="cb32-133"><a href="#cb32-133" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb32-134"><a href="#cb32-134" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb32-135"><a href="#cb32-135" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-136"><a href="#cb32-136" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Continue with data that doesn't have NA responses</span></span>
<span id="cb32-137"><a href="#cb32-137" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(response))</span>
<span id="cb32-138"><a href="#cb32-138" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-139"><a href="#cb32-139" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create survey design object including the response variable</span></span>
<span id="cb32-140"><a href="#cb32-140" aria-hidden="true" tabindex="-1"></a>    survey_design <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="sc">~</span>Primary_Samp_Unit,</span>
<span id="cb32-141"><a href="#cb32-141" aria-hidden="true" tabindex="-1"></a>                               <span class="at">strata =</span> <span class="sc">~</span>Stratum,</span>
<span id="cb32-142"><a href="#cb32-142" aria-hidden="true" tabindex="-1"></a>                               <span class="at">weights =</span> <span class="sc">~</span>Final_Weight,</span>
<span id="cb32-143"><a href="#cb32-143" aria-hidden="true" tabindex="-1"></a>                               <span class="at">data =</span> data_filtered,</span>
<span id="cb32-144"><a href="#cb32-144" aria-hidden="true" tabindex="-1"></a>                               <span class="at">nest =</span> <span class="cn">TRUE</span>) </span>
<span id="cb32-145"><a href="#cb32-145" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-146"><a href="#cb32-146" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Perform Welch's t-test using the survey design object</span></span>
<span id="cb32-147"><a href="#cb32-147" aria-hidden="true" tabindex="-1"></a>    ttest_result <span class="ot">&lt;-</span> <span class="fu">svyttest</span>(response <span class="sc">~</span> <span class="fu">as.factor</span>(Survey_Year), survey_design)</span>
<span id="cb32-148"><a href="#cb32-148" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-149"><a href="#cb32-149" aria-hidden="true" tabindex="-1"></a>    <span class="co"># head t-test results</span></span>
<span id="cb32-150"><a href="#cb32-150" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(ttest_result)</span>
<span id="cb32-151"><a href="#cb32-151" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-152"><a href="#cb32-152" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check significance and interpret the results</span></span>
<span id="cb32-153"><a href="#cb32-153" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(ttest_result<span class="sc">$</span>p.value) <span class="sc">&amp;&amp;</span> ttest_result<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>) {</span>
<span id="cb32-154"><a href="#cb32-154" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(ttest_result<span class="sc">$</span>estimate <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Significant Increase"</span>, <span class="st">"Significant Decrease"</span>)</span>
<span id="cb32-155"><a href="#cb32-155" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb32-156"><a href="#cb32-156" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="st">"No Change"</span></span>
<span id="cb32-157"><a href="#cb32-157" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb32-158"><a href="#cb32-158" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-159"><a href="#cb32-159" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> trend))</span>
<span id="cb32-160"><a href="#cb32-160" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-161"><a href="#cb32-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-162"><a href="#cb32-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-163"><a href="#cb32-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-164"><a href="#cb32-164" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the short-term function to each ROI_Indicator_Code</span></span>
<span id="cb32-165"><a href="#cb32-165" aria-hidden="true" tabindex="-1"></a>short_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(raw_stwd_general)[<span class="fu">grep</span>(<span class="st">"^(QN|V).*[RP]"</span>, <span class="fu">names</span>(raw_stwd_general))], <span class="cf">function</span>(column_name) {</span>
<span id="cb32-166"><a href="#cb32-166" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_short_term_trend_ttest</span>(raw_stwd_general, column_name)</span>
<span id="cb32-167"><a href="#cb32-167" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb32-168"><a href="#cb32-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-169"><a href="#cb32-169" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(short_trend_results)</span>
<span id="cb32-170"><a href="#cb32-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-171"><a href="#cb32-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-172"><a href="#cb32-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-173"><a href="#cb32-173" aria-hidden="true" tabindex="-1"></a><span class="do">################### Join Together with Trend Tables ############</span></span>
<span id="cb32-174"><a href="#cb32-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-175"><a href="#cb32-175" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine long-term and short-term results</span></span>
<span id="cb32-176"><a href="#cb32-176" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> <span class="fu">left_join</span>(long_trend_results, </span>
<span id="cb32-177"><a href="#cb32-177" aria-hidden="true" tabindex="-1"></a>                                    short_trend_results, </span>
<span id="cb32-178"><a href="#cb32-178" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">by =</span> <span class="st">"ROI_Indicator_Code"</span>)</span>
<span id="cb32-179"><a href="#cb32-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-180"><a href="#cb32-180" aria-hidden="true" tabindex="-1"></a><span class="co">#head(combined_trend_results)</span></span>
<span id="cb32-181"><a href="#cb32-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-182"><a href="#cb32-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-183"><a href="#cb32-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-184"><a href="#cb32-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-185"><a href="#cb32-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-186"><a href="#cb32-186" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge Long_Term_Trend into yrbs_master_stwd_grade based on matching ROI_Indicator_Code and Trend_Category</span></span>
<span id="cb32-187"><a href="#cb32-187" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> yrbs_master_analysis_stwd_trend <span class="sc">%&gt;%</span></span>
<span id="cb32-188"><a href="#cb32-188" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(combined_trend_results <span class="sc">%&gt;%</span> <span class="fu">select</span>(ROI_Indicator_Code, Long_Term_Trend, Short_Term_Trend),</span>
<span id="cb32-189"><a href="#cb32-189" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ROI_Indicator_Code"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb32-190"><a href="#cb32-190" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(School_Type,</span>
<span id="cb32-191"><a href="#cb32-191" aria-hidden="true" tabindex="-1"></a>         Health_Topic, </span>
<span id="cb32-192"><a href="#cb32-192" aria-hidden="true" tabindex="-1"></a>         ROI_Indicator_Code, </span>
<span id="cb32-193"><a href="#cb32-193" aria-hidden="true" tabindex="-1"></a>         Indicator_Long_Description, </span>
<span id="cb32-194"><a href="#cb32-194" aria-hidden="true" tabindex="-1"></a>         Trend_Category, </span>
<span id="cb32-195"><a href="#cb32-195" aria-hidden="true" tabindex="-1"></a>         <span class="fu">everything</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb32-196"><a href="#cb32-196" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, </span>
<span id="cb32-197"><a href="#cb32-197" aria-hidden="true" tabindex="-1"></a>          ROI_Indicator_Code, </span>
<span id="cb32-198"><a href="#cb32-198" aria-hidden="true" tabindex="-1"></a>          Trend_Category)</span>
<span id="cb32-199"><a href="#cb32-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-200"><a href="#cb32-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-201"><a href="#cb32-201" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to check for three consecutive NAs in a set of columns</span></span>
<span id="cb32-202"><a href="#cb32-202" aria-hidden="true" tabindex="-1"></a>check_consecutive_nas <span class="ot">&lt;-</span> <span class="cf">function</span>(year_values) {</span>
<span id="cb32-203"><a href="#cb32-203" aria-hidden="true" tabindex="-1"></a>  na_run_lengths <span class="ot">&lt;-</span> <span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>lengths[<span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>values]</span>
<span id="cb32-204"><a href="#cb32-204" aria-hidden="true" tabindex="-1"></a>  <span class="fu">any</span>(na_run_lengths <span class="sc">&gt;=</span> <span class="dv">3</span>)</span>
<span id="cb32-205"><a href="#cb32-205" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-206"><a href="#cb32-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-207"><a href="#cb32-207" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert all columns representing years to numeric</span></span>
<span id="cb32-208"><a href="#cb32-208" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb32-209"><a href="#cb32-209" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">d+$"</span>), as.numeric))</span>
<span id="cb32-210"><a href="#cb32-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-211"><a href="#cb32-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-212"><a href="#cb32-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-213"><a href="#cb32-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-214"><a href="#cb32-214" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge and mutate Long_Term_Trend</span></span>
<span id="cb32-215"><a href="#cb32-215" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb32-216"><a href="#cb32-216" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb32-217"><a href="#cb32-217" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Long_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">check_consecutive_nas</span>(<span class="fu">c_across</span>(<span class="st">`</span><span class="at">2011</span><span class="st">`</span><span class="sc">:</span><span class="st">`</span><span class="at">2023</span><span class="st">`</span>)), </span>
<span id="cb32-218"><a href="#cb32-218" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb32-219"><a href="#cb32-219" aria-hidden="true" tabindex="-1"></a>                                  Long_Term_Trend),</span>
<span id="cb32-220"><a href="#cb32-220" aria-hidden="true" tabindex="-1"></a>         <span class="at">Short_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(<span class="st">`</span><span class="at">2019</span><span class="st">`</span>) <span class="sc">|</span> <span class="fu">is.na</span>(<span class="st">`</span><span class="at">2023</span><span class="st">`</span>), </span>
<span id="cb32-221"><a href="#cb32-221" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb32-222"><a href="#cb32-222" aria-hidden="true" tabindex="-1"></a>                                   Short_Term_Trend)) <span class="sc">%&gt;%</span></span>
<span id="cb32-223"><a href="#cb32-223" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb32-224"><a href="#cb32-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-225"><a href="#cb32-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-226"><a href="#cb32-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-227"><a href="#cb32-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-228"><a href="#cb32-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-229"><a href="#cb32-229" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results)</span>
<span id="cb32-230"><a href="#cb32-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-231"><a href="#cb32-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-232"><a href="#cb32-232" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb32-233"><a href="#cb32-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-234"><a href="#cb32-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-235"><a href="#cb32-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-236"><a href="#cb32-236" aria-hidden="true" tabindex="-1"></a>trend_results_race_HispLat <span class="ot">&lt;-</span> trend_results</span>
<span id="cb32-237"><a href="#cb32-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-238"><a href="#cb32-238" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results_race_HispLat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="hisp.2---non-hisplat" class="level4">
<h4 class="anchored" data-anchor-id="hisp.2---non-hisplat">Hisp.2 - Non Hisp/Lat</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="do">######## Import Raw and Analyzed Excel Files ###############</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>yrbs_master_analysis_stwd_trend <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Race_HispLat Trend"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Trend_Category <span class="sc">==</span> <span class="st">"Non Hisp/Lat"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="st">"Suppressed"</span>, <span class="cn">NA</span>, .)))</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the raw data set to be used in trend analyis</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>raw_stwd_general <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"raw_yrbs_allyears_statewide_trad_cleaned.xlsx"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Race_HispLat <span class="sc">==</span> <span class="st">"Non Hisp/Lat"</span>,</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>         Survey_Year <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2011</span>,</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2013</span>, </span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2015</span>, </span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2017</span>,</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2019</span>, </span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>                            <span class="dv">2023</span></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>                            )) <span class="sc">%&gt;%</span></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), <span class="sc">~</span> <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">2</span>, <span class="dv">0</span>, <span class="fu">ifelse</span>(. <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="cn">NA</span>))))</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine which survey questions (ROI - Response of Interest) have data across at least two distinct survey years</span></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>roi_years <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">"^(QN|V).*[RP]"</span>), Survey_Year) <span class="sc">%&gt;%</span></span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>Survey_Year, </span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"ROI_Indicator_Code"</span>, </span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ROI_Indicator_Code) <span class="sc">%&gt;%</span></span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">unique_years =</span> <span class="fu">n_distinct</span>(Survey_Year), </span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(unique_years <span class="sc">&gt;=</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(ROI_Indicator_Code)</span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the main data set to include only those ROIs, also ensuring to keep necessary demographic variables</span></span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a>filtered_raw_stwd_general <span class="ot">&lt;-</span> raw_stwd_general <span class="sc">%&gt;%</span></span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Survey_Year, <span class="fu">all_of</span>(roi_years), Sex, Grade, Primary_Samp_Unit,Stratum,Final_Weight)</span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-41"><a href="#cb33-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-42"><a href="#cb33-42" aria-hidden="true" tabindex="-1"></a><span class="do">############ Long Term Trend ###############</span></span>
<span id="cb33-43"><a href="#cb33-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-44"><a href="#cb33-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-45"><a href="#cb33-45" aria-hidden="true" tabindex="-1"></a><span class="co">#Trend Analysis Function</span></span>
<span id="cb33-46"><a href="#cb33-46" aria-hidden="true" tabindex="-1"></a>analyze_trend_logistic <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb33-47"><a href="#cb33-47" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb33-48"><a href="#cb33-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Survey Design for YRBS Statewide</span></span>
<span id="cb33-49"><a href="#cb33-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_survey_design</span>(<span class="at">ids =</span> Primary_Samp_Unit,</span>
<span id="cb33-50"><a href="#cb33-50" aria-hidden="true" tabindex="-1"></a>                     <span class="at">strata =</span> Stratum,</span>
<span id="cb33-51"><a href="#cb33-51" aria-hidden="true" tabindex="-1"></a>                     <span class="at">weights =</span> Final_Weight,</span>
<span id="cb33-52"><a href="#cb33-52" aria-hidden="true" tabindex="-1"></a>                     <span class="at">nest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb33-53"><a href="#cb33-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-54"><a href="#cb33-54" aria-hidden="true" tabindex="-1"></a>  data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span></span>
<span id="cb33-55"><a href="#cb33-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Sex =</span> <span class="fu">factor</span>(Sex), <span class="at">Grade =</span> <span class="fu">factor</span>(Grade))</span>
<span id="cb33-56"><a href="#cb33-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-57"><a href="#cb33-57" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(data_filtered) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">length</span>(<span class="fu">unique</span>(data_filtered<span class="sc">$</span>variables<span class="sc">$</span>Survey_Year)) <span class="sc">&lt;</span> <span class="dv">4</span>) {</span>
<span id="cb33-58"><a href="#cb33-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb33-59"><a href="#cb33-59" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb33-60"><a href="#cb33-60" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-61"><a href="#cb33-61" aria-hidden="true" tabindex="-1"></a>  base_formula <span class="ot">&lt;-</span> <span class="fu">paste</span>(column_name, <span class="st">"~ Sex + Grade + Survey_Year"</span>) </span>
<span id="cb33-62"><a href="#cb33-62" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit the model using logistic regression</span></span>
<span id="cb33-63"><a href="#cb33-63" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb33-64"><a href="#cb33-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">svyglm</span>(<span class="fu">as.formula</span>(base_formula), <span class="at">design =</span> data_filtered, <span class="at">family =</span> <span class="fu">quasibinomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb33-65"><a href="#cb33-65" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb33-66"><a href="#cb33-66" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Error fitting model: "</span>, e<span class="sc">$</span>message)</span>
<span id="cb33-67"><a href="#cb33-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb33-68"><a href="#cb33-68" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb33-69"><a href="#cb33-69" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-70"><a href="#cb33-70" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if model fitting was successful</span></span>
<span id="cb33-71"><a href="#cb33-71" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(model)) {</span>
<span id="cb33-72"><a href="#cb33-72" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error"</span>))</span>
<span id="cb33-73"><a href="#cb33-73" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb33-74"><a href="#cb33-74" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-75"><a href="#cb33-75" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check for coefficients</span></span>
<span id="cb33-76"><a href="#cb33-76" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>(<span class="st">"Survey_Year"</span> <span class="sc">%in%</span> <span class="fu">names</span>(<span class="fu">coef</span>(model)))) {</span>
<span id="cb33-77"><a href="#cb33-77" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No valid coefficient for Survey_Year"</span>))</span>
<span id="cb33-78"><a href="#cb33-78" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb33-79"><a href="#cb33-79" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-80"><a href="#cb33-80" aria-hidden="true" tabindex="-1"></a>  coef_summary <span class="ot">=</span> <span class="fu">summary</span>(model)<span class="sc">$</span>coefficients</span>
<span id="cb33-81"><a href="#cb33-81" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(coef_summary) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb33-82"><a href="#cb33-82" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Model fitting error: No coefficients"</span>))</span>
<span id="cb33-83"><a href="#cb33-83" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb33-84"><a href="#cb33-84" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-85"><a href="#cb33-85" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Determine the significance and direction of the trend</span></span>
<span id="cb33-86"><a href="#cb33-86" aria-hidden="true" tabindex="-1"></a>  p_value <span class="ot">=</span> coef_summary[<span class="st">"Survey_Year"</span>, <span class="st">"Pr(&gt;|t|)"</span>]</span>
<span id="cb33-87"><a href="#cb33-87" aria-hidden="true" tabindex="-1"></a>  coefficient <span class="ot">=</span> <span class="fu">coef</span>(model)[<span class="st">"Survey_Year"</span>]</span>
<span id="cb33-88"><a href="#cb33-88" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-89"><a href="#cb33-89" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(p_value)) {</span>
<span id="cb33-90"><a href="#cb33-90" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"P-value is NA"</span>))</span>
<span id="cb33-91"><a href="#cb33-91" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb33-92"><a href="#cb33-92" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb33-93"><a href="#cb33-93" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (p_value <span class="sc">&lt;=</span> <span class="fl">0.05</span>) {</span>
<span id="cb33-94"><a href="#cb33-94" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (coefficient <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb33-95"><a href="#cb33-95" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Increase"</span>))</span>
<span id="cb33-96"><a href="#cb33-96" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb33-97"><a href="#cb33-97" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"Significant Decrease"</span>))</span>
<span id="cb33-98"><a href="#cb33-98" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb33-99"><a href="#cb33-99" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb33-100"><a href="#cb33-100" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Long_Term_Trend =</span> <span class="st">"No Change"</span>))</span>
<span id="cb33-101"><a href="#cb33-101" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb33-102"><a href="#cb33-102" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb33-103"><a href="#cb33-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-104"><a href="#cb33-104" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the function to each ROI_Indicator_Code that has sufficient data</span></span>
<span id="cb33-105"><a href="#cb33-105" aria-hidden="true" tabindex="-1"></a>long_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(filtered_raw_stwd_general)[<span class="sc">-</span><span class="dv">1</span>], <span class="cf">function</span>(column_name) {</span>
<span id="cb33-106"><a href="#cb33-106" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_trend_logistic</span>(filtered_raw_stwd_general, column_name)</span>
<span id="cb33-107"><a href="#cb33-107" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb33-108"><a href="#cb33-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-109"><a href="#cb33-109" aria-hidden="true" tabindex="-1"></a><span class="co"># Show results</span></span>
<span id="cb33-110"><a href="#cb33-110" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(long_trend_results)</span>
<span id="cb33-111"><a href="#cb33-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-112"><a href="#cb33-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-113"><a href="#cb33-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-114"><a href="#cb33-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-115"><a href="#cb33-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-116"><a href="#cb33-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-117"><a href="#cb33-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-118"><a href="#cb33-118" aria-hidden="true" tabindex="-1"></a><span class="do">######### Short Term Trend ###############</span></span>
<span id="cb33-119"><a href="#cb33-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-120"><a href="#cb33-120" aria-hidden="true" tabindex="-1"></a>analyze_short_term_trend_ttest <span class="ot">&lt;-</span> <span class="cf">function</span>(data, column_name) {</span>
<span id="cb33-121"><a href="#cb33-121" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the short-term years</span></span>
<span id="cb33-122"><a href="#cb33-122" aria-hidden="true" tabindex="-1"></a>    short_term_years <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2019</span>, <span class="dv">2023</span>)</span>
<span id="cb33-123"><a href="#cb33-123" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-124"><a href="#cb33-124" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter for short-term years and ensure all necessary variables are selected</span></span>
<span id="cb33-125"><a href="#cb33-125" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb33-126"><a href="#cb33-126" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(Survey_Year <span class="sc">%in%</span> short_term_years) <span class="sc">%&gt;%</span></span>
<span id="cb33-127"><a href="#cb33-127" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(Primary_Samp_Unit, Stratum, Final_Weight, Survey_Year, <span class="fu">all_of</span>(column_name)) <span class="sc">%&gt;%</span></span>
<span id="cb33-128"><a href="#cb33-128" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">response =</span> <span class="fu">get</span>(column_name) <span class="sc">==</span> <span class="dv">1</span>)  <span class="co"># Create a binary response variable for the analysis</span></span>
<span id="cb33-129"><a href="#cb33-129" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-130"><a href="#cb33-130" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if data is available for both years</span></span>
<span id="cb33-131"><a href="#cb33-131" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(short_term_years <span class="sc">%in%</span> <span class="fu">unique</span>(data_filtered<span class="sc">$</span>Survey_Year[<span class="sc">!</span><span class="fu">is.na</span>(data_filtered<span class="sc">$</span>response)]))) {</span>
<span id="cb33-132"><a href="#cb33-132" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> <span class="st">"Too few data points for analysis"</span>))</span>
<span id="cb33-133"><a href="#cb33-133" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb33-134"><a href="#cb33-134" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-135"><a href="#cb33-135" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Continue with data that doesn't have NA responses</span></span>
<span id="cb33-136"><a href="#cb33-136" aria-hidden="true" tabindex="-1"></a>    data_filtered <span class="ot">&lt;-</span> data_filtered <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(response))</span>
<span id="cb33-137"><a href="#cb33-137" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-138"><a href="#cb33-138" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create survey design object including the response variable</span></span>
<span id="cb33-139"><a href="#cb33-139" aria-hidden="true" tabindex="-1"></a>    survey_design <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="sc">~</span>Primary_Samp_Unit,</span>
<span id="cb33-140"><a href="#cb33-140" aria-hidden="true" tabindex="-1"></a>                               <span class="at">strata =</span> <span class="sc">~</span>Stratum,</span>
<span id="cb33-141"><a href="#cb33-141" aria-hidden="true" tabindex="-1"></a>                               <span class="at">weights =</span> <span class="sc">~</span>Final_Weight,</span>
<span id="cb33-142"><a href="#cb33-142" aria-hidden="true" tabindex="-1"></a>                               <span class="at">data =</span> data_filtered,</span>
<span id="cb33-143"><a href="#cb33-143" aria-hidden="true" tabindex="-1"></a>                               <span class="at">nest =</span> <span class="cn">TRUE</span>) </span>
<span id="cb33-144"><a href="#cb33-144" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-145"><a href="#cb33-145" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Perform Welch's t-test using the survey design object</span></span>
<span id="cb33-146"><a href="#cb33-146" aria-hidden="true" tabindex="-1"></a>    ttest_result <span class="ot">&lt;-</span> <span class="fu">svyttest</span>(response <span class="sc">~</span> <span class="fu">as.factor</span>(Survey_Year), survey_design)</span>
<span id="cb33-147"><a href="#cb33-147" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-148"><a href="#cb33-148" aria-hidden="true" tabindex="-1"></a>    <span class="co"># head t-test results</span></span>
<span id="cb33-149"><a href="#cb33-149" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(ttest_result)</span>
<span id="cb33-150"><a href="#cb33-150" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-151"><a href="#cb33-151" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check significance and interpret the results</span></span>
<span id="cb33-152"><a href="#cb33-152" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(ttest_result<span class="sc">$</span>p.value) <span class="sc">&amp;&amp;</span> ttest_result<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>) {</span>
<span id="cb33-153"><a href="#cb33-153" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(ttest_result<span class="sc">$</span>estimate <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Significant Increase"</span>, <span class="st">"Significant Decrease"</span>)</span>
<span id="cb33-154"><a href="#cb33-154" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb33-155"><a href="#cb33-155" aria-hidden="true" tabindex="-1"></a>        trend <span class="ot">&lt;-</span> <span class="st">"No Change"</span></span>
<span id="cb33-156"><a href="#cb33-156" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb33-157"><a href="#cb33-157" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-158"><a href="#cb33-158" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(<span class="at">ROI_Indicator_Code =</span> column_name, <span class="at">Short_Term_Trend =</span> trend))</span>
<span id="cb33-159"><a href="#cb33-159" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb33-160"><a href="#cb33-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-161"><a href="#cb33-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-162"><a href="#cb33-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-163"><a href="#cb33-163" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the short-term function to each ROI_Indicator_Code</span></span>
<span id="cb33-164"><a href="#cb33-164" aria-hidden="true" tabindex="-1"></a>short_trend_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(raw_stwd_general)[<span class="fu">grep</span>(<span class="st">"^(QN|V).*[RP]"</span>, <span class="fu">names</span>(raw_stwd_general))], <span class="cf">function</span>(column_name) {</span>
<span id="cb33-165"><a href="#cb33-165" aria-hidden="true" tabindex="-1"></a>  <span class="fu">analyze_short_term_trend_ttest</span>(raw_stwd_general, column_name)</span>
<span id="cb33-166"><a href="#cb33-166" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb33-167"><a href="#cb33-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-168"><a href="#cb33-168" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(short_trend_results)</span>
<span id="cb33-169"><a href="#cb33-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-170"><a href="#cb33-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-171"><a href="#cb33-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-172"><a href="#cb33-172" aria-hidden="true" tabindex="-1"></a><span class="do">################### Join Together with Trend Tables ############</span></span>
<span id="cb33-173"><a href="#cb33-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-174"><a href="#cb33-174" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine long-term and short-term results</span></span>
<span id="cb33-175"><a href="#cb33-175" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> <span class="fu">left_join</span>(long_trend_results, </span>
<span id="cb33-176"><a href="#cb33-176" aria-hidden="true" tabindex="-1"></a>                                    short_trend_results, </span>
<span id="cb33-177"><a href="#cb33-177" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">by =</span> <span class="st">"ROI_Indicator_Code"</span>)</span>
<span id="cb33-178"><a href="#cb33-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-179"><a href="#cb33-179" aria-hidden="true" tabindex="-1"></a><span class="co">#head(combined_trend_results)</span></span>
<span id="cb33-180"><a href="#cb33-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-181"><a href="#cb33-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-182"><a href="#cb33-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-183"><a href="#cb33-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-184"><a href="#cb33-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-185"><a href="#cb33-185" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge Long_Term_Trend into yrbs_master_stwd_grade based on matching ROI_Indicator_Code and Trend_Category</span></span>
<span id="cb33-186"><a href="#cb33-186" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> yrbs_master_analysis_stwd_trend <span class="sc">%&gt;%</span></span>
<span id="cb33-187"><a href="#cb33-187" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(combined_trend_results <span class="sc">%&gt;%</span> <span class="fu">select</span>(ROI_Indicator_Code, Long_Term_Trend, Short_Term_Trend),</span>
<span id="cb33-188"><a href="#cb33-188" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ROI_Indicator_Code"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb33-189"><a href="#cb33-189" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(School_Type,</span>
<span id="cb33-190"><a href="#cb33-190" aria-hidden="true" tabindex="-1"></a>         Health_Topic, </span>
<span id="cb33-191"><a href="#cb33-191" aria-hidden="true" tabindex="-1"></a>         ROI_Indicator_Code, </span>
<span id="cb33-192"><a href="#cb33-192" aria-hidden="true" tabindex="-1"></a>         Indicator_Long_Description, </span>
<span id="cb33-193"><a href="#cb33-193" aria-hidden="true" tabindex="-1"></a>         Trend_Category, </span>
<span id="cb33-194"><a href="#cb33-194" aria-hidden="true" tabindex="-1"></a>         <span class="fu">everything</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb33-195"><a href="#cb33-195" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, </span>
<span id="cb33-196"><a href="#cb33-196" aria-hidden="true" tabindex="-1"></a>          ROI_Indicator_Code, </span>
<span id="cb33-197"><a href="#cb33-197" aria-hidden="true" tabindex="-1"></a>          Trend_Category)</span>
<span id="cb33-198"><a href="#cb33-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-199"><a href="#cb33-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-200"><a href="#cb33-200" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to check for three consecutive NAs in a set of columns</span></span>
<span id="cb33-201"><a href="#cb33-201" aria-hidden="true" tabindex="-1"></a>check_consecutive_nas <span class="ot">&lt;-</span> <span class="cf">function</span>(year_values) {</span>
<span id="cb33-202"><a href="#cb33-202" aria-hidden="true" tabindex="-1"></a>  na_run_lengths <span class="ot">&lt;-</span> <span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>lengths[<span class="fu">rle</span>(<span class="fu">is.na</span>(year_values))<span class="sc">$</span>values]</span>
<span id="cb33-203"><a href="#cb33-203" aria-hidden="true" tabindex="-1"></a>  <span class="fu">any</span>(na_run_lengths <span class="sc">&gt;=</span> <span class="dv">3</span>)</span>
<span id="cb33-204"><a href="#cb33-204" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb33-205"><a href="#cb33-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-206"><a href="#cb33-206" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert all columns representing years to numeric</span></span>
<span id="cb33-207"><a href="#cb33-207" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb33-208"><a href="#cb33-208" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">d+$"</span>), as.numeric))</span>
<span id="cb33-209"><a href="#cb33-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-210"><a href="#cb33-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-211"><a href="#cb33-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-212"><a href="#cb33-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-213"><a href="#cb33-213" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge and mutate Long_Term_Trend</span></span>
<span id="cb33-214"><a href="#cb33-214" aria-hidden="true" tabindex="-1"></a>trend_results <span class="ot">&lt;-</span> trend_results <span class="sc">%&gt;%</span></span>
<span id="cb33-215"><a href="#cb33-215" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb33-216"><a href="#cb33-216" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Long_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">check_consecutive_nas</span>(<span class="fu">c_across</span>(<span class="st">`</span><span class="at">2011</span><span class="st">`</span><span class="sc">:</span><span class="st">`</span><span class="at">2023</span><span class="st">`</span>)), </span>
<span id="cb33-217"><a href="#cb33-217" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb33-218"><a href="#cb33-218" aria-hidden="true" tabindex="-1"></a>                                  Long_Term_Trend),</span>
<span id="cb33-219"><a href="#cb33-219" aria-hidden="true" tabindex="-1"></a>         <span class="at">Short_Term_Trend =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(<span class="st">`</span><span class="at">2019</span><span class="st">`</span>) <span class="sc">|</span> <span class="fu">is.na</span>(<span class="st">`</span><span class="at">2023</span><span class="st">`</span>), </span>
<span id="cb33-220"><a href="#cb33-220" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"Too few data points for analysis"</span>, </span>
<span id="cb33-221"><a href="#cb33-221" aria-hidden="true" tabindex="-1"></a>                                   Short_Term_Trend)) <span class="sc">%&gt;%</span></span>
<span id="cb33-222"><a href="#cb33-222" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb33-223"><a href="#cb33-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-224"><a href="#cb33-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-225"><a href="#cb33-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-226"><a href="#cb33-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-227"><a href="#cb33-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-228"><a href="#cb33-228" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results)</span>
<span id="cb33-229"><a href="#cb33-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-230"><a href="#cb33-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-231"><a href="#cb33-231" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb33-232"><a href="#cb33-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-233"><a href="#cb33-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-234"><a href="#cb33-234" aria-hidden="true" tabindex="-1"></a>trend_results_race_non_HispLat <span class="ot">&lt;-</span> trend_results</span>
<span id="cb33-235"><a href="#cb33-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-236"><a href="#cb33-236" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(trend_results_race_non_HispLat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>
<section id="combine-export" class="level2">
<h2 class="anchored" data-anchor-id="combine-export">Combine &amp; Export</h2>
<section id="combine-overall" class="level4">
<h4 class="anchored" data-anchor-id="combine-overall">Combine Overall</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="do">################# EXPORT ###############</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the existing "XX Trend" sheet data</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>yrbs_master_analysis_stwd_trend <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Overall Trend"</span>)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="co">#head(yrbs_master_analysis_stwd_trend)</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge Long_Term_Trend into yrbs_master_stwd_trend based on matching ROI_Indicator_Code and Trend_Category</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>merged_data <span class="ot">&lt;-</span> yrbs_master_analysis_stwd_trend <span class="sc">%&gt;%</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(trend_results_overall <span class="sc">%&gt;%</span> <span class="fu">select</span>(ROI_Indicator_Code, Long_Term_Trend, Short_Term_Trend),</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ROI_Indicator_Code"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(School_Type,</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>         Health_Topic, </span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>         ROI_Indicator_Code, </span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>         Indicator_Long_Description, </span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>         Trend_Grouping,</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>         Trend_Category, </span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>         <span class="fu">everything</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, ROI_Indicator_Code)</span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(merged_data)</span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the workbook</span></span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>wb <span class="ot">&lt;-</span> <span class="fu">loadWorkbook</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>)</span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Overwrite the existing "XX Trend" sheet with the merged data</span></span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a><span class="fu">writeData</span>(wb, <span class="at">sheet =</span> <span class="st">"Overall Trend"</span>, merged_data)</span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the workbook</span></span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true" tabindex="-1"></a><span class="fu">saveWorkbook</span>(wb, <span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="combine-grade" class="level4">
<h4 class="anchored" data-anchor-id="combine-grade">Combine Grade</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="do">######################## Combine all together #######################</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine the data frames</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(trend_results_grade_12, </span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>                                    trend_results_grade_11, </span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>                                    trend_results_grade_10, </span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>                                    trend_results_grade_09)</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert Trend_Category to a factor with levels in the desired order</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>combined_trend_results<span class="sc">$</span>Trend_Category <span class="ot">&lt;-</span> <span class="fu">factor</span>(combined_trend_results<span class="sc">$</span>Trend_Category, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"9th"</span>, <span class="st">"10th"</span>, <span class="st">"11th"</span>, <span class="st">"12th"</span>))</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort the combined data frame</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> combined_trend_results <span class="sc">%&gt;%</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, ROI_Indicator_Code, Trend_Category)</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a><span class="co"># View the sorted combined dataframe</span></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(combined_trend_results)</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the existing "XX Trend" sheet data</span></span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>yrbs_master_analysis_stwd_trend <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Grade Trend"</span>)</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(yrbs_master_analysis_stwd_trend)</span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert Trend_Category to a factor with levels in the desired order</span></span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>combined_trend_results<span class="sc">$</span>Trend_Category <span class="ot">&lt;-</span> <span class="fu">factor</span>(combined_trend_results<span class="sc">$</span>Trend_Category, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"9th"</span>, <span class="st">"10th"</span>, <span class="st">"11th"</span>, <span class="st">"12th"</span>))</span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge Long_Term_Trend into yrbs_master_stwd_grade based on matching ROI_Indicator_Code and Trend_Category</span></span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>merged_data <span class="ot">&lt;-</span> yrbs_master_analysis_stwd_trend <span class="sc">%&gt;%</span></span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(combined_trend_results <span class="sc">%&gt;%</span> <span class="fu">select</span>(ROI_Indicator_Code, Trend_Category, Long_Term_Trend, Short_Term_Trend),</span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ROI_Indicator_Code"</span>, <span class="st">"Trend_Category"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(School_Type,</span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a>         Health_Topic, </span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a>         ROI_Indicator_Code, </span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a>         Indicator_Long_Description, </span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a>         Trend_Grouping,</span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a>         Trend_Category, </span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a>         <span class="fu">everything</span>()) </span>
<span id="cb35-46"><a href="#cb35-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-47"><a href="#cb35-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-48"><a href="#cb35-48" aria-hidden="true" tabindex="-1"></a>merged_data <span class="ot">&lt;-</span> merged_data <span class="sc">%&gt;%</span></span>
<span id="cb35-49"><a href="#cb35-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Trend_Category =</span> <span class="fu">factor</span>(Trend_Category,</span>
<span id="cb35-50"><a href="#cb35-50" aria-hidden="true" tabindex="-1"></a>                               <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"9th"</span>,</span>
<span id="cb35-51"><a href="#cb35-51" aria-hidden="true" tabindex="-1"></a>                                          <span class="st">"10th"</span>,</span>
<span id="cb35-52"><a href="#cb35-52" aria-hidden="true" tabindex="-1"></a>                                          <span class="st">"11th"</span>,</span>
<span id="cb35-53"><a href="#cb35-53" aria-hidden="true" tabindex="-1"></a>                                          <span class="st">"12th"</span>)</span>
<span id="cb35-54"><a href="#cb35-54" aria-hidden="true" tabindex="-1"></a>                               ))<span class="sc">%&gt;%</span></span>
<span id="cb35-55"><a href="#cb35-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, ROI_Indicator_Code, Trend_Category)</span>
<span id="cb35-56"><a href="#cb35-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-57"><a href="#cb35-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-58"><a href="#cb35-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-59"><a href="#cb35-59" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(merged_data)</span>
<span id="cb35-60"><a href="#cb35-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-61"><a href="#cb35-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-62"><a href="#cb35-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-63"><a href="#cb35-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-64"><a href="#cb35-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the workbook</span></span>
<span id="cb35-65"><a href="#cb35-65" aria-hidden="true" tabindex="-1"></a>wb <span class="ot">&lt;-</span> <span class="fu">loadWorkbook</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>)</span>
<span id="cb35-66"><a href="#cb35-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-67"><a href="#cb35-67" aria-hidden="true" tabindex="-1"></a><span class="co"># Overwrite the existing "XX Trend" sheet with the merged data</span></span>
<span id="cb35-68"><a href="#cb35-68" aria-hidden="true" tabindex="-1"></a><span class="fu">writeData</span>(wb, <span class="at">sheet =</span> <span class="st">"Grade Trend"</span>, merged_data)</span>
<span id="cb35-69"><a href="#cb35-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-70"><a href="#cb35-70" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the workbook</span></span>
<span id="cb35-71"><a href="#cb35-71" aria-hidden="true" tabindex="-1"></a><span class="fu">saveWorkbook</span>(wb, <span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="combine-sex" class="level4">
<h4 class="anchored" data-anchor-id="combine-sex">Combine Sex</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="do">######################## Combine all together #######################</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine the data frames</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(trend_results_sex_female, </span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>                                    trend_results_sex_male)</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort the combined data frame</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> combined_trend_results <span class="sc">%&gt;%</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, ROI_Indicator_Code, Trend_Category)</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="co"># View the sorted combined dataframe</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(combined_trend_results)</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the existing "XX Trend" sheet data</span></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>yrbs_master_analysis_stwd_trend <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Sex Trend"</span>)</span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(yrbs_master_analysis_stwd_trend)</span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge Long_Term_Trend into yrbs_master_stwd_trend based on matching ROI_Indicator_Code and Trend_Category</span></span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a>merged_data <span class="ot">&lt;-</span> yrbs_master_analysis_stwd_trend <span class="sc">%&gt;%</span></span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(combined_trend_results <span class="sc">%&gt;%</span> <span class="fu">select</span>(ROI_Indicator_Code, Trend_Category, Long_Term_Trend, Short_Term_Trend),</span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ROI_Indicator_Code"</span>, <span class="st">"Trend_Category"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(School_Type,</span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a>         Health_Topic, </span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a>         ROI_Indicator_Code, </span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a>         Indicator_Long_Description, </span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a>         Trend_Grouping,</span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a>         Trend_Category, </span>
<span id="cb36-38"><a href="#cb36-38" aria-hidden="true" tabindex="-1"></a>         <span class="fu">everything</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb36-39"><a href="#cb36-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, ROI_Indicator_Code, Trend_Category)</span>
<span id="cb36-40"><a href="#cb36-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-41"><a href="#cb36-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-42"><a href="#cb36-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-43"><a href="#cb36-43" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(merged_data)</span>
<span id="cb36-44"><a href="#cb36-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-45"><a href="#cb36-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-46"><a href="#cb36-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-47"><a href="#cb36-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-48"><a href="#cb36-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the workbook</span></span>
<span id="cb36-49"><a href="#cb36-49" aria-hidden="true" tabindex="-1"></a>wb <span class="ot">&lt;-</span> <span class="fu">loadWorkbook</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>)</span>
<span id="cb36-50"><a href="#cb36-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-51"><a href="#cb36-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Overwrite the existing "XX Trend" sheet with the merged data</span></span>
<span id="cb36-52"><a href="#cb36-52" aria-hidden="true" tabindex="-1"></a><span class="fu">writeData</span>(wb, <span class="at">sheet =</span> <span class="st">"Sex Trend"</span>, merged_data)</span>
<span id="cb36-53"><a href="#cb36-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-54"><a href="#cb36-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the workbook</span></span>
<span id="cb36-55"><a href="#cb36-55" aria-hidden="true" tabindex="-1"></a><span class="fu">saveWorkbook</span>(wb, <span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="combine-race_group_6" class="level4">
<h4 class="anchored" data-anchor-id="combine-race_group_6">Combine Race_Group_6</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="do">######################## Combine all together #######################</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine the data frames</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(trend_results_race_6_ANAI, </span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>                                    trend_results_race_6_BlkAA,</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>                                    trend_results_race_6_white,</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>                                    trend_results_race_6_HispLat,</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>                                    trend_results_race_6_other_race,</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>                                    trend_results_race_6_mult_race)</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert Trend_Category to a factor with levels in the desired order</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>combined_trend_results<span class="sc">$</span>Trend_Category <span class="ot">&lt;-</span> <span class="fu">factor</span>(combined_trend_results<span class="sc">$</span>Trend_Category, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Alaska Native/American Indian"</span>,</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>                                                           <span class="st">"Black/African American"</span>,</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>                                                           <span class="st">"Hispanic/Latino"</span>,</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>                                                           <span class="st">"Multiple Races"</span>,</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>                                                           <span class="st">"Other Races"</span>,</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>                                                           <span class="st">"White"</span>))</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort the combined data frame</span></span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> combined_trend_results <span class="sc">%&gt;%</span></span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, ROI_Indicator_Code, Trend_Category)</span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a><span class="co"># View the sorted combined dataframe</span></span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(combined_trend_results)</span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a><span class="do">################# EXPORT ###############</span></span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the existing "XX Trend" sheet data</span></span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true" tabindex="-1"></a>yrbs_master_analysis_stwd_trend <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Race_Group_6 Trend"</span>)</span>
<span id="cb37-38"><a href="#cb37-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-39"><a href="#cb37-39" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(yrbs_master_analysis_stwd_trend)</span>
<span id="cb37-40"><a href="#cb37-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-41"><a href="#cb37-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-42"><a href="#cb37-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert Trend_Category to a factor with levels in the desired order</span></span>
<span id="cb37-43"><a href="#cb37-43" aria-hidden="true" tabindex="-1"></a>combined_trend_results<span class="sc">$</span>Trend_Category <span class="ot">&lt;-</span> <span class="fu">factor</span>(combined_trend_results<span class="sc">$</span>Trend_Category, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Alaska Native/American Indian"</span>,</span>
<span id="cb37-44"><a href="#cb37-44" aria-hidden="true" tabindex="-1"></a>                                                           <span class="st">"Black/African American"</span>,</span>
<span id="cb37-45"><a href="#cb37-45" aria-hidden="true" tabindex="-1"></a>                                                           <span class="st">"Hispanic/Latino"</span>,</span>
<span id="cb37-46"><a href="#cb37-46" aria-hidden="true" tabindex="-1"></a>                                                           <span class="st">"Multiple Races"</span>,</span>
<span id="cb37-47"><a href="#cb37-47" aria-hidden="true" tabindex="-1"></a>                                                           <span class="st">"Other Races"</span>,</span>
<span id="cb37-48"><a href="#cb37-48" aria-hidden="true" tabindex="-1"></a>                                                           <span class="st">"White"</span>))</span>
<span id="cb37-49"><a href="#cb37-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-50"><a href="#cb37-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-51"><a href="#cb37-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge Long_Term_Trend into yrbs_master_stwd_grade based on matching ROI_Indicator_Code and Trend_Category</span></span>
<span id="cb37-52"><a href="#cb37-52" aria-hidden="true" tabindex="-1"></a>merged_data <span class="ot">&lt;-</span> yrbs_master_analysis_stwd_trend <span class="sc">%&gt;%</span></span>
<span id="cb37-53"><a href="#cb37-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(combined_trend_results <span class="sc">%&gt;%</span> <span class="fu">select</span>(ROI_Indicator_Code, Trend_Category, Long_Term_Trend, Short_Term_Trend),</span>
<span id="cb37-54"><a href="#cb37-54" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ROI_Indicator_Code"</span>, <span class="st">"Trend_Category"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb37-55"><a href="#cb37-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(School_Type,</span>
<span id="cb37-56"><a href="#cb37-56" aria-hidden="true" tabindex="-1"></a>         Health_Topic, </span>
<span id="cb37-57"><a href="#cb37-57" aria-hidden="true" tabindex="-1"></a>         ROI_Indicator_Code, </span>
<span id="cb37-58"><a href="#cb37-58" aria-hidden="true" tabindex="-1"></a>         Indicator_Long_Description, </span>
<span id="cb37-59"><a href="#cb37-59" aria-hidden="true" tabindex="-1"></a>         Trend_Grouping,</span>
<span id="cb37-60"><a href="#cb37-60" aria-hidden="true" tabindex="-1"></a>         Trend_Category, </span>
<span id="cb37-61"><a href="#cb37-61" aria-hidden="true" tabindex="-1"></a>         <span class="fu">everything</span>()) </span>
<span id="cb37-62"><a href="#cb37-62" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-63"><a href="#cb37-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-64"><a href="#cb37-64" aria-hidden="true" tabindex="-1"></a>merged_data <span class="ot">&lt;-</span> merged_data <span class="sc">%&gt;%</span></span>
<span id="cb37-65"><a href="#cb37-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Trend_Category =</span> <span class="fu">factor</span>(Trend_Category,</span>
<span id="cb37-66"><a href="#cb37-66" aria-hidden="true" tabindex="-1"></a>                               <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Alaska Native/American Indian"</span>,</span>
<span id="cb37-67"><a href="#cb37-67" aria-hidden="true" tabindex="-1"></a>                                                           <span class="st">"Black/African American"</span>,</span>
<span id="cb37-68"><a href="#cb37-68" aria-hidden="true" tabindex="-1"></a>                                                           <span class="st">"Hispanic/Latino"</span>,</span>
<span id="cb37-69"><a href="#cb37-69" aria-hidden="true" tabindex="-1"></a>                                                           <span class="st">"Multiple Races"</span>,</span>
<span id="cb37-70"><a href="#cb37-70" aria-hidden="true" tabindex="-1"></a>                                                           <span class="st">"Other Races"</span>,</span>
<span id="cb37-71"><a href="#cb37-71" aria-hidden="true" tabindex="-1"></a>                                                           <span class="st">"White"</span>)</span>
<span id="cb37-72"><a href="#cb37-72" aria-hidden="true" tabindex="-1"></a>                               ))<span class="sc">%&gt;%</span></span>
<span id="cb37-73"><a href="#cb37-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, ROI_Indicator_Code, Trend_Category)</span>
<span id="cb37-74"><a href="#cb37-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-75"><a href="#cb37-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-76"><a href="#cb37-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-77"><a href="#cb37-77" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(merged_data)</span>
<span id="cb37-78"><a href="#cb37-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-79"><a href="#cb37-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-80"><a href="#cb37-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-81"><a href="#cb37-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-82"><a href="#cb37-82" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the workbook</span></span>
<span id="cb37-83"><a href="#cb37-83" aria-hidden="true" tabindex="-1"></a>wb <span class="ot">&lt;-</span> <span class="fu">loadWorkbook</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>)</span>
<span id="cb37-84"><a href="#cb37-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-85"><a href="#cb37-85" aria-hidden="true" tabindex="-1"></a><span class="co"># Overwrite the existing "XX Trend" sheet with the merged data</span></span>
<span id="cb37-86"><a href="#cb37-86" aria-hidden="true" tabindex="-1"></a><span class="fu">writeData</span>(wb, <span class="at">sheet =</span> <span class="st">"Race_Group_6 Trend"</span>, merged_data)</span>
<span id="cb37-87"><a href="#cb37-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-88"><a href="#cb37-88" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the workbook</span></span>
<span id="cb37-89"><a href="#cb37-89" aria-hidden="true" tabindex="-1"></a><span class="fu">saveWorkbook</span>(wb, <span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="combine-race_group_3" class="level4">
<h4 class="anchored" data-anchor-id="combine-race_group_3">Combine Race_Group_3</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="do">######################## Combine all together #######################</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine the data frames</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(trend_results_race_3_ANAI, </span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>                                    trend_results_race_3_white,</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>                                    trend_results_race_3_other_race_mult)</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert Trend_Category to a factor with levels in the desired order</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>combined_trend_results<span class="sc">$</span>Trend_Category <span class="ot">&lt;-</span> <span class="fu">factor</span>(combined_trend_results<span class="sc">$</span>Trend_Category, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Alaska Native/American Indian"</span>,</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>                                                           <span class="st">"Other/Multiple"</span>,</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>                                                           <span class="st">"White"</span>))</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort the combined data frame</span></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> combined_trend_results <span class="sc">%&gt;%</span></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, ROI_Indicator_Code, Trend_Category)</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a><span class="co"># View the sorted combined dataframe</span></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(combined_trend_results)</span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a><span class="do">################# EXPORT ###############</span></span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the existing "XX Trend" sheet data</span></span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>yrbs_master_analysis_stwd_trend <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Race_Group_3 Trend"</span>)</span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(yrbs_master_analysis_stwd_trend)</span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert Trend_Category to a factor with levels in the desired order</span></span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a>combined_trend_results<span class="sc">$</span>Trend_Category <span class="ot">&lt;-</span> <span class="fu">factor</span>(combined_trend_results<span class="sc">$</span>Trend_Category, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Alaska Native/American Indian"</span>,</span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>                                                           <span class="st">"Other/Multiple"</span>,</span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a>                                                           <span class="st">"White"</span>))</span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge Long_Term_Trend into yrbs_master_stwd_grade based on matching ROI_Indicator_Code and Trend_Category</span></span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a>merged_data <span class="ot">&lt;-</span> yrbs_master_analysis_stwd_trend <span class="sc">%&gt;%</span></span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(combined_trend_results <span class="sc">%&gt;%</span> <span class="fu">select</span>(ROI_Indicator_Code, Trend_Category, Long_Term_Trend, Short_Term_Trend),</span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ROI_Indicator_Code"</span>, <span class="st">"Trend_Category"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(School_Type,</span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a>         Health_Topic, </span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a>         ROI_Indicator_Code, </span>
<span id="cb38-45"><a href="#cb38-45" aria-hidden="true" tabindex="-1"></a>         Indicator_Long_Description, </span>
<span id="cb38-46"><a href="#cb38-46" aria-hidden="true" tabindex="-1"></a>         Trend_Grouping,</span>
<span id="cb38-47"><a href="#cb38-47" aria-hidden="true" tabindex="-1"></a>         Trend_Category, </span>
<span id="cb38-48"><a href="#cb38-48" aria-hidden="true" tabindex="-1"></a>         <span class="fu">everything</span>()) </span>
<span id="cb38-49"><a href="#cb38-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-50"><a href="#cb38-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-51"><a href="#cb38-51" aria-hidden="true" tabindex="-1"></a>merged_data <span class="ot">&lt;-</span> merged_data <span class="sc">%&gt;%</span></span>
<span id="cb38-52"><a href="#cb38-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Trend_Category =</span> <span class="fu">factor</span>(Trend_Category,</span>
<span id="cb38-53"><a href="#cb38-53" aria-hidden="true" tabindex="-1"></a>                               <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Alaska Native/American Indian"</span>,</span>
<span id="cb38-54"><a href="#cb38-54" aria-hidden="true" tabindex="-1"></a>                                                           <span class="st">"Other/Multiple"</span>,</span>
<span id="cb38-55"><a href="#cb38-55" aria-hidden="true" tabindex="-1"></a>                                                           <span class="st">"White"</span>)</span>
<span id="cb38-56"><a href="#cb38-56" aria-hidden="true" tabindex="-1"></a>                               ))<span class="sc">%&gt;%</span></span>
<span id="cb38-57"><a href="#cb38-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, ROI_Indicator_Code, Trend_Category)</span>
<span id="cb38-58"><a href="#cb38-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-59"><a href="#cb38-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-60"><a href="#cb38-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-61"><a href="#cb38-61" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(merged_data)</span>
<span id="cb38-62"><a href="#cb38-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-63"><a href="#cb38-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-64"><a href="#cb38-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-65"><a href="#cb38-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-66"><a href="#cb38-66" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the workbook</span></span>
<span id="cb38-67"><a href="#cb38-67" aria-hidden="true" tabindex="-1"></a>wb <span class="ot">&lt;-</span> <span class="fu">loadWorkbook</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>)</span>
<span id="cb38-68"><a href="#cb38-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-69"><a href="#cb38-69" aria-hidden="true" tabindex="-1"></a><span class="co"># Overwrite the existing "XX Trend" sheet with the merged data</span></span>
<span id="cb38-70"><a href="#cb38-70" aria-hidden="true" tabindex="-1"></a><span class="fu">writeData</span>(wb, <span class="at">sheet =</span> <span class="st">"Race_Group_3 Trend"</span>, merged_data)</span>
<span id="cb38-71"><a href="#cb38-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-72"><a href="#cb38-72" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the workbook</span></span>
<span id="cb38-73"><a href="#cb38-73" aria-hidden="true" tabindex="-1"></a><span class="fu">saveWorkbook</span>(wb, <span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="combine-race_group_4" class="level4">
<h4 class="anchored" data-anchor-id="combine-race_group_4">Combine Race_Group_4</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="do">######################## Combine all together #######################</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine the data frames</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(trend_results_race_4_ANAI, </span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>                                    trend_results_race_4_HispLat,</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>                                    trend_results_race_4_white,</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>                                    trend_results_race_4_other_race_mult,</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>                                    )</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert Trend_Category to a factor with levels in the desired order</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>combined_trend_results<span class="sc">$</span>Trend_Category <span class="ot">&lt;-</span> <span class="fu">factor</span>(combined_trend_results<span class="sc">$</span>Trend_Category, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Alaska Native/American Indian"</span>,</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>                                                           <span class="st">"Hispanic/Latino"</span>,</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>                                                           <span class="st">"White"</span>,</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>                                                           <span class="st">"Other/Multiple"</span></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>                                                           ))</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort the combined data frame</span></span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> combined_trend_results <span class="sc">%&gt;%</span></span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, ROI_Indicator_Code, Trend_Category)</span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a><span class="co"># View the sorted combined dataframe</span></span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(combined_trend_results)</span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a><span class="do">################# EXPORT ###############</span></span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the existing "XX Trend" sheet data</span></span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a>yrbs_master_analysis_stwd_trend <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Race_Group_4 Trend"</span>)</span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-37"><a href="#cb39-37" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(yrbs_master_analysis_stwd_trend)</span>
<span id="cb39-38"><a href="#cb39-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-39"><a href="#cb39-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-40"><a href="#cb39-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert Trend_Category to a factor with levels in the desired order</span></span>
<span id="cb39-41"><a href="#cb39-41" aria-hidden="true" tabindex="-1"></a>combined_trend_results<span class="sc">$</span>Trend_Category <span class="ot">&lt;-</span> <span class="fu">factor</span>(combined_trend_results<span class="sc">$</span>Trend_Category, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Alaska Native/American Indian"</span>,</span>
<span id="cb39-42"><a href="#cb39-42" aria-hidden="true" tabindex="-1"></a>                                                           <span class="st">"Hispanic/Latino"</span>,</span>
<span id="cb39-43"><a href="#cb39-43" aria-hidden="true" tabindex="-1"></a>                                                           <span class="st">"White"</span>,</span>
<span id="cb39-44"><a href="#cb39-44" aria-hidden="true" tabindex="-1"></a>                                                           <span class="st">"Other/Multiple"</span>))</span>
<span id="cb39-45"><a href="#cb39-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-46"><a href="#cb39-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-47"><a href="#cb39-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge Long_Term_Trend into yrbs_master_stwd_grade based on matching ROI_Indicator_Code and Trend_Category</span></span>
<span id="cb39-48"><a href="#cb39-48" aria-hidden="true" tabindex="-1"></a>merged_data <span class="ot">&lt;-</span> yrbs_master_analysis_stwd_trend <span class="sc">%&gt;%</span></span>
<span id="cb39-49"><a href="#cb39-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(combined_trend_results <span class="sc">%&gt;%</span> <span class="fu">select</span>(ROI_Indicator_Code, Trend_Category, Long_Term_Trend, Short_Term_Trend),</span>
<span id="cb39-50"><a href="#cb39-50" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ROI_Indicator_Code"</span>, <span class="st">"Trend_Category"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb39-51"><a href="#cb39-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(School_Type,</span>
<span id="cb39-52"><a href="#cb39-52" aria-hidden="true" tabindex="-1"></a>         Health_Topic, </span>
<span id="cb39-53"><a href="#cb39-53" aria-hidden="true" tabindex="-1"></a>         ROI_Indicator_Code, </span>
<span id="cb39-54"><a href="#cb39-54" aria-hidden="true" tabindex="-1"></a>         Indicator_Long_Description, </span>
<span id="cb39-55"><a href="#cb39-55" aria-hidden="true" tabindex="-1"></a>         Trend_Grouping,</span>
<span id="cb39-56"><a href="#cb39-56" aria-hidden="true" tabindex="-1"></a>         Trend_Category, </span>
<span id="cb39-57"><a href="#cb39-57" aria-hidden="true" tabindex="-1"></a>         <span class="fu">everything</span>()) </span>
<span id="cb39-58"><a href="#cb39-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-59"><a href="#cb39-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-60"><a href="#cb39-60" aria-hidden="true" tabindex="-1"></a>merged_data <span class="ot">&lt;-</span> merged_data <span class="sc">%&gt;%</span></span>
<span id="cb39-61"><a href="#cb39-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Trend_Category =</span> <span class="fu">factor</span>(Trend_Category,</span>
<span id="cb39-62"><a href="#cb39-62" aria-hidden="true" tabindex="-1"></a>                               <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Alaska Native/American Indian"</span>,</span>
<span id="cb39-63"><a href="#cb39-63" aria-hidden="true" tabindex="-1"></a>                                                           <span class="st">"Hispanic/Latino"</span>,</span>
<span id="cb39-64"><a href="#cb39-64" aria-hidden="true" tabindex="-1"></a>                                                           <span class="st">"White"</span>,</span>
<span id="cb39-65"><a href="#cb39-65" aria-hidden="true" tabindex="-1"></a>                                                           <span class="st">"Other/Multiple"</span>)</span>
<span id="cb39-66"><a href="#cb39-66" aria-hidden="true" tabindex="-1"></a>                               ))<span class="sc">%&gt;%</span></span>
<span id="cb39-67"><a href="#cb39-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, ROI_Indicator_Code, Trend_Category)</span>
<span id="cb39-68"><a href="#cb39-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-69"><a href="#cb39-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-70"><a href="#cb39-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-71"><a href="#cb39-71" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(merged_data)</span>
<span id="cb39-72"><a href="#cb39-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-73"><a href="#cb39-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-74"><a href="#cb39-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-75"><a href="#cb39-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-76"><a href="#cb39-76" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the workbook</span></span>
<span id="cb39-77"><a href="#cb39-77" aria-hidden="true" tabindex="-1"></a>wb <span class="ot">&lt;-</span> <span class="fu">loadWorkbook</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>)</span>
<span id="cb39-78"><a href="#cb39-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-79"><a href="#cb39-79" aria-hidden="true" tabindex="-1"></a><span class="co"># Overwrite the existing "XX Trend" sheet with the merged data</span></span>
<span id="cb39-80"><a href="#cb39-80" aria-hidden="true" tabindex="-1"></a><span class="fu">writeData</span>(wb, <span class="at">sheet =</span> <span class="st">"Race_Group_4 Trend"</span>, merged_data)</span>
<span id="cb39-81"><a href="#cb39-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-82"><a href="#cb39-82" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the workbook</span></span>
<span id="cb39-83"><a href="#cb39-83" aria-hidden="true" tabindex="-1"></a><span class="fu">saveWorkbook</span>(wb, <span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="combine-race_group_8" class="level4">
<h4 class="anchored" data-anchor-id="combine-race_group_8">Combine Race_Group_8</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="do">######################## Combine all together #######################</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine the data frames</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(trend_results_race_8_ANAI, </span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>                                    trend_results_race_8_asian,</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>                                    trend_results_race_8_BlkAA,</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>                                    trend_results_race_8_HispLat,</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>                                    trend_results_race_8_HispLat_Mult,</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>                                    trend_results_race_8_NWPI,</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>                                    trend_results_race_8_Non_HispLat_Mult,</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>                                    trend_results_race_8_white,</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>                                    )</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert Trend_Category to a factor with levels in the desired order</span></span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>combined_trend_results<span class="sc">$</span>Trend_Category <span class="ot">&lt;-</span> <span class="fu">factor</span>(combined_trend_results<span class="sc">$</span>Trend_Category, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Alaska Native/American Indian"</span>,</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>                                                   <span class="st">"Asian"</span>,</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>                                                   <span class="st">"Black/African American"</span>,</span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>                                                   <span class="st">"Hispanic/Latino"</span>,</span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>                                                   <span class="st">"Hisp/Lat Mult Race"</span>,</span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>                                                   <span class="st">"Native Haw/Other PI"</span>,</span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>                                                   <span class="st">"Non Hisp/Lat Mult Race"</span>,</span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>                                                   <span class="st">"White"</span>))</span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort the combined data frame</span></span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> combined_trend_results <span class="sc">%&gt;%</span></span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, ROI_Indicator_Code, Trend_Category)</span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a><span class="co"># View the sorted combined dataframe</span></span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(combined_trend_results)</span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a><span class="do">################# EXPORT ###############</span></span>
<span id="cb40-40"><a href="#cb40-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-41"><a href="#cb40-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the existing "XX Trend" sheet data</span></span>
<span id="cb40-42"><a href="#cb40-42" aria-hidden="true" tabindex="-1"></a>yrbs_master_analysis_stwd_trend <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Race_Group_8 Trend"</span>)</span>
<span id="cb40-43"><a href="#cb40-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-44"><a href="#cb40-44" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(yrbs_master_analysis_stwd_trend)</span>
<span id="cb40-45"><a href="#cb40-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-46"><a href="#cb40-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-47"><a href="#cb40-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert Trend_Category to a factor with levels in the desired order</span></span>
<span id="cb40-48"><a href="#cb40-48" aria-hidden="true" tabindex="-1"></a>combined_trend_results<span class="sc">$</span>Trend_Category <span class="ot">&lt;-</span> <span class="fu">factor</span>(combined_trend_results<span class="sc">$</span>Trend_Category, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Alaska Native/American Indian"</span>,</span>
<span id="cb40-49"><a href="#cb40-49" aria-hidden="true" tabindex="-1"></a>                                                   <span class="st">"Asian"</span>,</span>
<span id="cb40-50"><a href="#cb40-50" aria-hidden="true" tabindex="-1"></a>                                                   <span class="st">"Black/African American"</span>,</span>
<span id="cb40-51"><a href="#cb40-51" aria-hidden="true" tabindex="-1"></a>                                                   <span class="st">"Hispanic/Latino"</span>,</span>
<span id="cb40-52"><a href="#cb40-52" aria-hidden="true" tabindex="-1"></a>                                                   <span class="st">"Hisp/Lat Mult Race"</span>,</span>
<span id="cb40-53"><a href="#cb40-53" aria-hidden="true" tabindex="-1"></a>                                                   <span class="st">"Native Haw/Other PI"</span>,</span>
<span id="cb40-54"><a href="#cb40-54" aria-hidden="true" tabindex="-1"></a>                                                   <span class="st">"Non Hisp/Lat Mult Race"</span>,</span>
<span id="cb40-55"><a href="#cb40-55" aria-hidden="true" tabindex="-1"></a>                                                   <span class="st">"White"</span>))</span>
<span id="cb40-56"><a href="#cb40-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-57"><a href="#cb40-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-58"><a href="#cb40-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge Long_Term_Trend into yrbs_master_stwd_grade based on matching ROI_Indicator_Code and Trend_Category</span></span>
<span id="cb40-59"><a href="#cb40-59" aria-hidden="true" tabindex="-1"></a>merged_data <span class="ot">&lt;-</span> yrbs_master_analysis_stwd_trend <span class="sc">%&gt;%</span></span>
<span id="cb40-60"><a href="#cb40-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(combined_trend_results <span class="sc">%&gt;%</span> <span class="fu">select</span>(ROI_Indicator_Code, Trend_Category, Long_Term_Trend, Short_Term_Trend),</span>
<span id="cb40-61"><a href="#cb40-61" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ROI_Indicator_Code"</span>, <span class="st">"Trend_Category"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb40-62"><a href="#cb40-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(School_Type,</span>
<span id="cb40-63"><a href="#cb40-63" aria-hidden="true" tabindex="-1"></a>         Health_Topic, </span>
<span id="cb40-64"><a href="#cb40-64" aria-hidden="true" tabindex="-1"></a>         ROI_Indicator_Code, </span>
<span id="cb40-65"><a href="#cb40-65" aria-hidden="true" tabindex="-1"></a>         Indicator_Long_Description, </span>
<span id="cb40-66"><a href="#cb40-66" aria-hidden="true" tabindex="-1"></a>         Trend_Grouping,</span>
<span id="cb40-67"><a href="#cb40-67" aria-hidden="true" tabindex="-1"></a>         Trend_Category, </span>
<span id="cb40-68"><a href="#cb40-68" aria-hidden="true" tabindex="-1"></a>         <span class="fu">everything</span>()) </span>
<span id="cb40-69"><a href="#cb40-69" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb40-70"><a href="#cb40-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-71"><a href="#cb40-71" aria-hidden="true" tabindex="-1"></a>merged_data <span class="ot">&lt;-</span> merged_data <span class="sc">%&gt;%</span></span>
<span id="cb40-72"><a href="#cb40-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Trend_Category =</span> <span class="fu">factor</span>(Trend_Category,</span>
<span id="cb40-73"><a href="#cb40-73" aria-hidden="true" tabindex="-1"></a>                               <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Alaska Native/American Indian"</span>,</span>
<span id="cb40-74"><a href="#cb40-74" aria-hidden="true" tabindex="-1"></a>                                                   <span class="st">"Asian"</span>,</span>
<span id="cb40-75"><a href="#cb40-75" aria-hidden="true" tabindex="-1"></a>                                                   <span class="st">"Black/African American"</span>,</span>
<span id="cb40-76"><a href="#cb40-76" aria-hidden="true" tabindex="-1"></a>                                                   <span class="st">"Hispanic/Latino"</span>,</span>
<span id="cb40-77"><a href="#cb40-77" aria-hidden="true" tabindex="-1"></a>                                                   <span class="st">"Hisp/Lat Mult Race"</span>,</span>
<span id="cb40-78"><a href="#cb40-78" aria-hidden="true" tabindex="-1"></a>                                                   <span class="st">"Native Haw/Other PI"</span>,</span>
<span id="cb40-79"><a href="#cb40-79" aria-hidden="true" tabindex="-1"></a>                                                   <span class="st">"Non Hisp/Lat Mult Race"</span>,</span>
<span id="cb40-80"><a href="#cb40-80" aria-hidden="true" tabindex="-1"></a>                                                   <span class="st">"White"</span>)</span>
<span id="cb40-81"><a href="#cb40-81" aria-hidden="true" tabindex="-1"></a>                               ))<span class="sc">%&gt;%</span></span>
<span id="cb40-82"><a href="#cb40-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, ROI_Indicator_Code, Trend_Category)</span>
<span id="cb40-83"><a href="#cb40-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-84"><a href="#cb40-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-85"><a href="#cb40-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-86"><a href="#cb40-86" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(merged_data)</span>
<span id="cb40-87"><a href="#cb40-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-88"><a href="#cb40-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-89"><a href="#cb40-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-90"><a href="#cb40-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-91"><a href="#cb40-91" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the workbook</span></span>
<span id="cb40-92"><a href="#cb40-92" aria-hidden="true" tabindex="-1"></a>wb <span class="ot">&lt;-</span> <span class="fu">loadWorkbook</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>)</span>
<span id="cb40-93"><a href="#cb40-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-94"><a href="#cb40-94" aria-hidden="true" tabindex="-1"></a><span class="co"># Overwrite the existing "XX Trend" sheet with the merged data</span></span>
<span id="cb40-95"><a href="#cb40-95" aria-hidden="true" tabindex="-1"></a><span class="fu">writeData</span>(wb, <span class="at">sheet =</span> <span class="st">"Race_Group_8 Trend"</span>, merged_data)</span>
<span id="cb40-96"><a href="#cb40-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-97"><a href="#cb40-97" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the workbook</span></span>
<span id="cb40-98"><a href="#cb40-98" aria-hidden="true" tabindex="-1"></a><span class="fu">saveWorkbook</span>(wb, <span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="combine-race_anai" class="level4">
<h4 class="anchored" data-anchor-id="combine-race_anai">Combine Race_ANAI</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="do">######################## Combine all together #######################</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine the data frames</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(trend_results_race_ANAI, </span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>                                    trend_results_race_non_ANAI)</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert Trend_Category to a factor with levels in the desired order</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>combined_trend_results<span class="sc">$</span>Trend_Category <span class="ot">&lt;-</span> <span class="fu">factor</span>(combined_trend_results<span class="sc">$</span>Trend_Category, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Alaska Native/American Indian"</span>,</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>                                                           <span class="st">"Non AN/AI"</span>))</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort the combined data frame</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> combined_trend_results <span class="sc">%&gt;%</span></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, ROI_Indicator_Code, Trend_Category)</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a><span class="co"># View the sorted combined dataframe</span></span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(combined_trend_results)</span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a><span class="do">################# EXPORT ###############</span></span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the existing "XX Trend" sheet data</span></span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a>yrbs_master_analysis_stwd_trend <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Race_ANAI Trend"</span>)</span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(yrbs_master_analysis_stwd_trend)</span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert Trend_Category to a factor with levels in the desired order</span></span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a>combined_trend_results<span class="sc">$</span>Trend_Category <span class="ot">&lt;-</span> <span class="fu">factor</span>(combined_trend_results<span class="sc">$</span>Trend_Category, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Alaska Native/American Indian"</span>,</span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a>                                                           <span class="st">"Non AN/AI"</span>))</span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge Long_Term_Trend into yrbs_master_stwd_grade based on matching ROI_Indicator_Code and Trend_Category</span></span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true" tabindex="-1"></a>merged_data <span class="ot">&lt;-</span> yrbs_master_analysis_stwd_trend <span class="sc">%&gt;%</span></span>
<span id="cb41-41"><a href="#cb41-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(combined_trend_results <span class="sc">%&gt;%</span> <span class="fu">select</span>(ROI_Indicator_Code, Trend_Category, Long_Term_Trend, Short_Term_Trend),</span>
<span id="cb41-42"><a href="#cb41-42" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ROI_Indicator_Code"</span>, <span class="st">"Trend_Category"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb41-43"><a href="#cb41-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(School_Type,</span>
<span id="cb41-44"><a href="#cb41-44" aria-hidden="true" tabindex="-1"></a>         Health_Topic, </span>
<span id="cb41-45"><a href="#cb41-45" aria-hidden="true" tabindex="-1"></a>         ROI_Indicator_Code, </span>
<span id="cb41-46"><a href="#cb41-46" aria-hidden="true" tabindex="-1"></a>         Indicator_Long_Description, </span>
<span id="cb41-47"><a href="#cb41-47" aria-hidden="true" tabindex="-1"></a>         Trend_Grouping,</span>
<span id="cb41-48"><a href="#cb41-48" aria-hidden="true" tabindex="-1"></a>         Trend_Category, </span>
<span id="cb41-49"><a href="#cb41-49" aria-hidden="true" tabindex="-1"></a>         <span class="fu">everything</span>()) </span>
<span id="cb41-50"><a href="#cb41-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-51"><a href="#cb41-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-52"><a href="#cb41-52" aria-hidden="true" tabindex="-1"></a>merged_data <span class="ot">&lt;-</span> merged_data <span class="sc">%&gt;%</span></span>
<span id="cb41-53"><a href="#cb41-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Trend_Category =</span> <span class="fu">factor</span>(Trend_Category,</span>
<span id="cb41-54"><a href="#cb41-54" aria-hidden="true" tabindex="-1"></a>                               <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Alaska Native/American Indian"</span>,</span>
<span id="cb41-55"><a href="#cb41-55" aria-hidden="true" tabindex="-1"></a>                                                           <span class="st">"Non AN/AI"</span>)</span>
<span id="cb41-56"><a href="#cb41-56" aria-hidden="true" tabindex="-1"></a>                               ))<span class="sc">%&gt;%</span></span>
<span id="cb41-57"><a href="#cb41-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, ROI_Indicator_Code, Trend_Category)</span>
<span id="cb41-58"><a href="#cb41-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-59"><a href="#cb41-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-60"><a href="#cb41-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-61"><a href="#cb41-61" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(merged_data)</span>
<span id="cb41-62"><a href="#cb41-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-63"><a href="#cb41-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-64"><a href="#cb41-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-65"><a href="#cb41-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-66"><a href="#cb41-66" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the workbook</span></span>
<span id="cb41-67"><a href="#cb41-67" aria-hidden="true" tabindex="-1"></a>wb <span class="ot">&lt;-</span> <span class="fu">loadWorkbook</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>)</span>
<span id="cb41-68"><a href="#cb41-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-69"><a href="#cb41-69" aria-hidden="true" tabindex="-1"></a><span class="co"># Overwrite the existing "XX Trend" sheet with the merged data</span></span>
<span id="cb41-70"><a href="#cb41-70" aria-hidden="true" tabindex="-1"></a><span class="fu">writeData</span>(wb, <span class="at">sheet =</span> <span class="st">"Race_ANAI Trend"</span>, merged_data)</span>
<span id="cb41-71"><a href="#cb41-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-72"><a href="#cb41-72" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the workbook</span></span>
<span id="cb41-73"><a href="#cb41-73" aria-hidden="true" tabindex="-1"></a><span class="fu">saveWorkbook</span>(wb, <span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="combine-race_hisplat" class="level4">
<h4 class="anchored" data-anchor-id="combine-race_hisplat">Combine Race_HispLat</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="do">######################## Combine all together #######################</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine the data frames</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(trend_results_race_HispLat, </span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>                                    trend_results_race_non_HispLat)</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert Trend_Category to a factor with levels in the desired order</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>combined_trend_results<span class="sc">$</span>Trend_Category <span class="ot">&lt;-</span> <span class="fu">factor</span>(combined_trend_results<span class="sc">$</span>Trend_Category, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Hispanic/Latino"</span>,</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>                                                           <span class="st">"Non Hisp/Lat"</span>))</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort the combined data frame</span></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>combined_trend_results <span class="ot">&lt;-</span> combined_trend_results <span class="sc">%&gt;%</span></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, ROI_Indicator_Code, Trend_Category)</span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a><span class="co"># View the sorted combined dataframe</span></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(combined_trend_results)</span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a><span class="do">################# EXPORT ###############</span></span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the existing "XX Trend" sheet data</span></span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a>yrbs_master_analysis_stwd_trend <span class="ot">&lt;-</span> <span class="fu">read.xlsx</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">sheet =</span> <span class="st">"Race_HispLat Trend"</span>)</span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(yrbs_master_analysis_stwd_trend)</span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert Trend_Category to a factor with levels in the desired order</span></span>
<span id="cb42-35"><a href="#cb42-35" aria-hidden="true" tabindex="-1"></a>combined_trend_results<span class="sc">$</span>Trend_Category <span class="ot">&lt;-</span> <span class="fu">factor</span>(combined_trend_results<span class="sc">$</span>Trend_Category, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Hispanic/Latino"</span>,</span>
<span id="cb42-36"><a href="#cb42-36" aria-hidden="true" tabindex="-1"></a>                                                           <span class="st">"Non Hisp/Lat"</span>))</span>
<span id="cb42-37"><a href="#cb42-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-38"><a href="#cb42-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-39"><a href="#cb42-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge Long_Term_Trend into yrbs_master_stwd_grade based on matching ROI_Indicator_Code and Trend_Category</span></span>
<span id="cb42-40"><a href="#cb42-40" aria-hidden="true" tabindex="-1"></a>merged_data <span class="ot">&lt;-</span> yrbs_master_analysis_stwd_trend <span class="sc">%&gt;%</span></span>
<span id="cb42-41"><a href="#cb42-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(combined_trend_results <span class="sc">%&gt;%</span> <span class="fu">select</span>(ROI_Indicator_Code, Trend_Category, Long_Term_Trend, Short_Term_Trend),</span>
<span id="cb42-42"><a href="#cb42-42" aria-hidden="true" tabindex="-1"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ROI_Indicator_Code"</span>, <span class="st">"Trend_Category"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb42-43"><a href="#cb42-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(School_Type,</span>
<span id="cb42-44"><a href="#cb42-44" aria-hidden="true" tabindex="-1"></a>         Health_Topic, </span>
<span id="cb42-45"><a href="#cb42-45" aria-hidden="true" tabindex="-1"></a>         ROI_Indicator_Code, </span>
<span id="cb42-46"><a href="#cb42-46" aria-hidden="true" tabindex="-1"></a>         Indicator_Long_Description, </span>
<span id="cb42-47"><a href="#cb42-47" aria-hidden="true" tabindex="-1"></a>         Trend_Grouping,</span>
<span id="cb42-48"><a href="#cb42-48" aria-hidden="true" tabindex="-1"></a>         Trend_Category, </span>
<span id="cb42-49"><a href="#cb42-49" aria-hidden="true" tabindex="-1"></a>         <span class="fu">everything</span>()) </span>
<span id="cb42-50"><a href="#cb42-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-51"><a href="#cb42-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-52"><a href="#cb42-52" aria-hidden="true" tabindex="-1"></a>merged_data <span class="ot">&lt;-</span> merged_data <span class="sc">%&gt;%</span></span>
<span id="cb42-53"><a href="#cb42-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Trend_Category =</span> <span class="fu">factor</span>(Trend_Category,</span>
<span id="cb42-54"><a href="#cb42-54" aria-hidden="true" tabindex="-1"></a>                               <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Hispanic/Latino"</span>,</span>
<span id="cb42-55"><a href="#cb42-55" aria-hidden="true" tabindex="-1"></a>                                          <span class="st">"Non Hisp/Lat"</span>)</span>
<span id="cb42-56"><a href="#cb42-56" aria-hidden="true" tabindex="-1"></a>                               ))<span class="sc">%&gt;%</span></span>
<span id="cb42-57"><a href="#cb42-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Health_Topic, ROI_Indicator_Code, Trend_Category)</span>
<span id="cb42-58"><a href="#cb42-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-59"><a href="#cb42-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-60"><a href="#cb42-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-61"><a href="#cb42-61" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(merged_data)</span>
<span id="cb42-62"><a href="#cb42-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-63"><a href="#cb42-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-64"><a href="#cb42-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-65"><a href="#cb42-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-66"><a href="#cb42-66" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the workbook</span></span>
<span id="cb42-67"><a href="#cb42-67" aria-hidden="true" tabindex="-1"></a>wb <span class="ot">&lt;-</span> <span class="fu">loadWorkbook</span>(<span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>)</span>
<span id="cb42-68"><a href="#cb42-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-69"><a href="#cb42-69" aria-hidden="true" tabindex="-1"></a><span class="co"># Overwrite the existing "XX Trend" sheet with the merged data</span></span>
<span id="cb42-70"><a href="#cb42-70" aria-hidden="true" tabindex="-1"></a><span class="fu">writeData</span>(wb, <span class="at">sheet =</span> <span class="st">"Race_HispLat Trend"</span>, merged_data)</span>
<span id="cb42-71"><a href="#cb42-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-72"><a href="#cb42-72" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the workbook</span></span>
<span id="cb42-73"><a href="#cb42-73" aria-hidden="true" tabindex="-1"></a><span class="fu">saveWorkbook</span>(wb, <span class="st">"yrbs_master_analysis_statewide_trad.xlsx"</span>, <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br>
</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>